<html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=Generator content="Microsoft Word 10 (filtered)">
<title>Thinking in Patterns with Java</title>

<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Helvetica;
	panose-1:2 11 6 4 2 2 2 3 2 4;}
@font-face
	{font-family:Courier;
	panose-1:2 7 4 9 2 2 5 2 4 4;}
@font-face
	{font-family:"Tms Rmn";
	panose-1:2 2 6 3 4 5 5 2 3 4;}
@font-face
	{font-family:Helv;
	panose-1:2 11 6 4 2 2 2 3 2 4;}
@font-face
	{font-family:"New York";
	panose-1:2 4 5 3 6 5 6 2 3 4;}
@font-face
	{font-family:System;
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"MS Mincho";
	panose-1:2 2 6 9 4 2 5 8 3 4;}
@font-face
	{font-family:Batang;
	panose-1:2 3 6 0 0 1 1 1 1 1;}
@font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:PMingLiU;
	panose-1:2 1 6 1 0 1 1 1 1 1;}
@font-face
	{font-family:"MS Gothic";
	panose-1:2 11 6 9 7 2 5 8 2 4;}
@font-face
	{font-family:Dotum;
	panose-1:2 11 6 0 0 1 1 1 1 1;}
@font-face
	{font-family:SimHei;
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:MingLiU;
	panose-1:2 1 6 9 0 1 1 1 1 1;}
@font-face
	{font-family:Mincho;
	panose-1:2 2 6 9 4 3 5 8 3 5;}
@font-face
	{font-family:Gulim;
	panose-1:2 11 6 0 0 1 1 1 1 1;}
@font-face
	{font-family:Century;
	panose-1:2 4 6 3 5 7 5 2 3 3;}
@font-face
	{font-family:"Angsana New";
	panose-1:2 2 6 3 5 4 5 2 3 4;}
@font-face
	{font-family:"Cordia New";
	panose-1:2 11 3 4 2 2 2 2 2 4;}
@font-face
	{font-family:Mangal;
	panose-1:0 0 4 0 0 0 0 0 0 0;}
@font-face
	{font-family:Latha;
	panose-1:0 0 4 0 0 0 0 0 0 0;}
@font-face
	{font-family:Sylfaen;
	panose-1:1 10 5 2 5 3 6 3 3 3;}
@font-face
	{font-family:Vrinda;
	panose-1:0 0 4 0 0 0 0 0 0 0;}
@font-face
	{font-family:Raavi;
	panose-1:0 0 4 0 0 0 0 0 0 0;}
@font-face
	{font-family:Shruti;
	panose-1:0 0 4 0 0 0 0 0 0 0;}
@font-face
	{font-family:Sendnya;
	panose-1:0 0 4 0 0 0 0 0 0 0;}
@font-face
	{font-family:Gautami;
	panose-1:0 0 4 0 0 0 0 0 0 0;}
@font-face
	{font-family:Tunga;
	panose-1:0 0 4 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Estrangella Edessa";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Arial Unicode MS";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:Tahoma;
	panose-1:2 11 6 4 3 5 4 4 2 4;}
@font-face
	{font-family:Marlett;
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Lucida Console";
	panose-1:2 11 6 9 4 5 4 2 2 4;}
@font-face
	{font-family:"Lucida Sans Unicode";
	panose-1:2 11 6 2 3 5 4 2 2 4;}
@font-face
	{font-family:Verdana;
	panose-1:2 11 6 4 3 5 4 4 2 4;}
@font-face
	{font-family:"Arial Black";
	panose-1:2 11 10 4 2 1 2 2 2 4;}
@font-face
	{font-family:"Comic Sans MS";
	panose-1:3 15 7 2 3 3 2 2 2 4;}
@font-face
	{font-family:Impact;
	panose-1:2 11 8 6 3 9 2 5 2 4;}
@font-face
	{font-family:Georgia;
	panose-1:2 4 5 2 5 4 5 2 3 3;}
@font-face
	{font-family:"Palatino Linotype";
	panose-1:2 4 5 2 5 5 5 3 3 4;}
@font-face
	{font-family:"Trebuchet MS";
	panose-1:2 11 6 3 2 2 2 2 2 4;}
@font-face
	{font-family:Webdings;
	panose-1:5 3 1 2 1 5 9 6 7 3;}
@font-face
	{font-family:"Microsoft Sans Serif";
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:"Arial Narrow";
	panose-1:2 11 5 6 2 2 2 3 2 4;}
@font-face
	{font-family:"Book Antiqua";
	panose-1:2 4 6 2 5 3 5 3 3 4;}
@font-face
	{font-family:"Bookman Old Style";
	panose-1:2 5 6 4 5 5 5 2 2 4;}
@font-face
	{font-family:"Century Gothic";
	panose-1:2 11 5 2 2 2 2 2 2 4;}
@font-face
	{font-family:Garamond;
	panose-1:2 2 4 4 3 3 1 1 8 3;}
@font-face
	{font-family:"Monotype Corsiva";
	panose-1:3 1 1 1 1 2 1 1 1 1;}
@font-face
	{font-family:"Wingdings 2";
	panose-1:5 2 1 2 1 5 7 7 7 7;}
@font-face
	{font-family:"Wingdings 3";
	panose-1:5 4 1 2 1 8 7 7 7 7;}
@font-face
	{font-family:"Clarendon Condensed";
	panose-1:2 4 7 6 4 7 5 4 2 4;}
@font-face
	{font-family:"CG Times";
	panose-1:2 2 6 3 5 4 5 2 3 4;}
@font-face
	{font-family:"CG Omega";
	panose-1:2 11 5 2 5 5 8 2 3 4;}
@font-face
	{font-family:"Albertus Extra Bold";
	panose-1:2 14 8 2 4 3 4 2 2 4;}
@font-face
	{font-family:"Albertus Medium";
	panose-1:2 14 6 2 3 3 4 2 3 4;}
@font-face
	{font-family:Times;
	panose-1:2 2 6 3 5 4 5 2 3 4;}
@font-face
	{font-family:SymbolPS;
	panose-1:5 5 1 2 1 6 7 2 6 7;}
@font-face
	{font-family:Palatino;
	panose-1:2 4 5 2 5 5 5 3 3 4;}
@font-face
	{font-family:"New Century Schoolbook";
	panose-1:2 4 6 3 5 7 5 2 3 4;}
@font-face
	{font-family:"Helvetica Narrow";
	panose-1:2 11 6 6 2 2 2 3 2 4;}
@font-face
	{font-family:"ITC Zapf Dingbats";
	panose-1:5 2 1 2 1 7 4 2 6 9;}
@font-face
	{font-family:CourierPS;
	panose-1:2 7 6 9 2 2 5 2 4 4;}
@font-face
	{font-family:"ITC Zapf Chancery";
	panose-1:3 2 7 2 4 4 3 8 8 4;}
@font-face
	{font-family:"ITC Bookman Demi";
	panose-1:2 5 8 4 4 5 5 2 2 4;}
@font-face
	{font-family:"ITC Bookman Light";
	panose-1:2 5 6 4 5 5 5 2 2 4;}
@font-face
	{font-family:"ITC Avant Garde Gothic Demi";
	panose-1:2 11 8 2 2 2 2 2 2 4;}
@font-face
	{font-family:"ITC Avant Garde Gothic";
	panose-1:2 11 6 2 2 2 2 2 2 4;}
@font-face
	{font-family:"Univers Condensed";
	panose-1:2 11 6 6 2 2 2 6 2 4;}
@font-face
	{font-family:Univers;
	panose-1:2 11 6 3 2 2 2 3 2 4;}
@font-face
	{font-family:"Antique Olive";
	panose-1:2 11 6 3 2 2 4 3 2 4;}
@font-face
	{font-family:Marigold;
	panose-1:3 2 7 2 4 4 2 2 5 4;}
@font-face
	{font-family:"Letter Gothic";
	panose-1:2 11 4 9 2 2 2 3 2 4;}
@font-face
	{font-family:Coronet;
	panose-1:3 3 5 2 4 4 6 7 6 5;}
@font-face
	{font-family:"Andale Mono";
	panose-1:2 11 5 9 0 0 0 0 0 4;}
@font-face
	{font-family:Haettenschweiler;
	panose-1:2 11 7 6 4 9 2 6 2 4;}
@font-face
	{font-family:"Letter Gothic MT";
	panose-1:2 11 5 9 2 1 2 2 2 4;}
@font-face
	{font-family:"Century Schoolbook";
	panose-1:2 4 6 4 5 5 5 2 3 4;}
@font-face
	{font-family:"Times New Roman MT Extra Bold";
	panose-1:2 2 10 6 6 3 1 2 3 3;}
@font-face
	{font-family:OpenSymbol;
	panose-1:0 0 4 0 0 0 0 0 0 0;}
@font-face
	{font-family:Sydnie;
	panose-1:0 0 4 0 0 0 0 0 0 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:.25in;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:Georgia;}
h1
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:.25in;
	margin-left:49.5pt;
	text-indent:-.75in;
	page-break-after:avoid;
	background:white;
	font-size:38.0pt;
	font-family:Verdana;
	color:black;
	font-weight:normal;}
h2
	{margin-top:6.0pt;
	margin-right:0in;
	margin-bottom:6.0pt;
	margin-left:.5in;
	text-indent:-40.5pt;
	line-height:32.0pt;
	page-break-after:avoid;
	font-size:28.0pt;
	font-family:Verdana;
	font-weight:normal;}
h3
	{margin-top:6.0pt;
	margin-right:0in;
	margin-bottom:3.0pt;
	margin-left:.25in;
	line-height:24.0pt;
	page-break-after:avoid;
	font-size:20.0pt;
	font-family:Verdana;
	font-weight:normal;}
h4
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:6.0pt;
	margin-left:.5in;
	page-break-after:avoid;
	font-size:15.0pt;
	font-family:Verdana;
	font-weight:normal;}
h5
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:6.0pt;
	margin-left:.5in;
	page-break-after:avoid;
	font-size:11.0pt;
	font-family:Verdana;
	font-weight:normal;}
h6
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:.5in;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:"Tms Rmn";
	font-weight:normal;
	text-decoration:underline;}
p.MsoHeading7, li.MsoHeading7, div.MsoHeading7
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:.5in;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:"Tms Rmn";
	font-style:italic;}
p.MsoHeading8, li.MsoHeading8, div.MsoHeading8
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:.5in;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:"Tms Rmn";
	font-style:italic;}
p.MsoHeading9, li.MsoHeading9, div.MsoHeading9
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:.5in;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:"Tms Rmn";
	font-style:italic;}
p.MsoIndex1, li.MsoIndex1, div.MsoIndex1
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:10.1pt;
	margin-bottom:.0001pt;
	text-indent:-10.1pt;
	font-size:9.0pt;
	font-family:Georgia;}
p.MsoIndex2, li.MsoIndex2, div.MsoIndex2
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:20.0pt;
	margin-bottom:.0001pt;
	text-indent:-10.0pt;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:Georgia;}
p.MsoIndex3, li.MsoIndex3, div.MsoIndex3
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:30.0pt;
	margin-bottom:.0001pt;
	text-indent:-10.0pt;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:Georgia;}
p.MsoIndex4, li.MsoIndex4, div.MsoIndex4
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:40.0pt;
	margin-bottom:.0001pt;
	text-indent:-10.0pt;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:Georgia;}
p.MsoIndex5, li.MsoIndex5, div.MsoIndex5
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:50.0pt;
	margin-bottom:.0001pt;
	text-indent:-10.0pt;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:Georgia;}
p.MsoIndex6, li.MsoIndex6, div.MsoIndex6
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:60.0pt;
	margin-bottom:.0001pt;
	text-indent:-10.0pt;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:Georgia;}
p.MsoIndex7, li.MsoIndex7, div.MsoIndex7
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:70.0pt;
	margin-bottom:.0001pt;
	text-indent:-10.0pt;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:Georgia;}
p.MsoIndex8, li.MsoIndex8, div.MsoIndex8
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:80.0pt;
	margin-bottom:.0001pt;
	text-indent:-10.0pt;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:Georgia;}
p.MsoIndex9, li.MsoIndex9, div.MsoIndex9
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:1.25in;
	margin-bottom:.0001pt;
	text-indent:-10.0pt;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:Georgia;}
p.MsoToc1, li.MsoToc1, div.MsoToc1
	{margin-top:6.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:0in;
	margin-bottom:.0001pt;
	page-break-after:avoid;
	background:#DFDFDF;
	font-size:14.0pt;
	font-family:Georgia;}
p.MsoToc2, li.MsoToc2, div.MsoToc2
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.5in;
	margin-bottom:.0001pt;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:Georgia;}
p.MsoToc3, li.MsoToc3, div.MsoToc3
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.7in;
	margin-bottom:.0001pt;
	line-height:12.0pt;
	font-size:8.0pt;
	font-family:Georgia;}
p.MsoToc4, li.MsoToc4, div.MsoToc4
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:30.0pt;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:Georgia;}
p.MsoToc5, li.MsoToc5, div.MsoToc5
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:40.0pt;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:Georgia;}
p.MsoToc6, li.MsoToc6, div.MsoToc6
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:50.0pt;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:Georgia;}
p.MsoToc7, li.MsoToc7, div.MsoToc7
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:60.0pt;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:Georgia;}
p.MsoToc8, li.MsoToc8, div.MsoToc8
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:70.0pt;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:Georgia;}
p.MsoToc9, li.MsoToc9, div.MsoToc9
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:80.0pt;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:Georgia;}
p.MsoFootnoteText, li.MsoFootnoteText, div.MsoFootnoteText
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:.25in;
	line-height:12.0pt;
	font-size:10.0pt;
	font-family:Georgia;}
p.MsoHeader, li.MsoHeader, div.MsoHeader
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:.25in;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:Georgia;}
p.MsoFooter, li.MsoFooter, div.MsoFooter
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:.25in;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:Georgia;}
p.MsoIndexHeading, li.MsoIndexHeading, div.MsoIndexHeading
	{margin-top:.25in;
	margin-right:0in;
	margin-bottom:12.0pt;
	margin-left:.25in;
	line-height:12.0pt;
	border:none;
	padding:0in;
	font-size:12.0pt;
	font-family:Georgia;
	font-weight:bold;
	font-style:italic;}
span.MsoFootnoteReference
	{vertical-align:super;}
p.MsoTitle, li.MsoTitle, div.MsoTitle
	{margin:0in;
	margin-bottom:.0001pt;
	text-align:center;
	line-height:72.0pt;
	font-size:80.0pt;
	font-family:Georgia;
	color:black;
	letter-spacing:-1.0pt;}
p.MsoBodyText, li.MsoBodyText, div.MsoBodyText
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:6.0pt;
	margin-left:0in;
	font-size:10.0pt;
	font-family:"Times New Roman";}
p.MsoBodyTextIndent, li.MsoBodyTextIndent, div.MsoBodyTextIndent
	{margin-top:.25in;
	margin-right:0in;
	margin-bottom:30.0pt;
	margin-left:.25in;
	text-align:center;
	font-size:30.0pt;
	font-family:Georgia;}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;}
p.MsoDocumentMap, li.MsoDocumentMap, div.MsoDocumentMap
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:.25in;
	line-height:12.0pt;
	background:navy;
	font-size:11.0pt;
	font-family:Tahoma;}
code
	{font-family:"Courier New";}
tt
	{font-family:"Courier New";}
p.Intro, li.Intro, div.Intro
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:.25in;
	font-size:14.0pt;
	font-family:Georgia;}
p.Code, li.Code, div.Code
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.25in;
	margin-bottom:.0001pt;
	line-height:12.0pt;
	border:none;
	padding:0in;
	font-size:10.0pt;
	font-family:"Andale Mono";}
p.CodeInline, li.CodeInline, div.CodeInline
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:3.0pt;
	margin-left:.25in;
	line-height:12.0pt;
	border:none;
	padding:0in;
	font-size:10.0pt;
	font-family:"Andale Mono";}
p.CodeInlineTrailer, li.CodeInlineTrailer, div.CodeInlineTrailer
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:1.0pt;
	margin-left:.85in;
	font-size:3.0pt;
	font-family:Georgia;}
p.Exercises, li.Exercises, div.Exercises
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:.75in;
	text-indent:-.25in;
	line-height:14.0pt;
	font-size:11.0pt;
	font-family:Georgia;}
p.h, li.h, div.h
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:.25in;
	line-height:12.0pt;
	font-size:11.0pt;
	font-family:Georgia;}
p.Numbered, li.Numbered, div.Numbered
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:.7in;
	text-indent:-.45in;
	line-height:14.0pt;
	font-size:11.0pt;
	font-family:Georgia;}
p.ContentsHeading, li.ContentsHeading, div.ContentsHeading
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:.25in;
	margin-left:49.7pt;
	text-indent:-.75in;
	page-break-after:avoid;
	background:white;
	font-size:38.0pt;
	font-family:Verdana;
	color:black;}
p.TitleSmall, li.TitleSmall, div.TitleSmall
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:.25in;
	text-align:center;
	font-size:32.0pt;
	font-family:Georgia;}
p.TitlePageSubtitle1, li.TitlePageSubtitle1, div.TitlePageSubtitle1
	{margin-top:.25in;
	margin-right:0in;
	margin-bottom:30.0pt;
	margin-left:.25in;
	text-align:center;
	font-size:30.0pt;
	font-family:Georgia;}
p.TitlePageSubtitle2, li.TitlePageSubtitle2, div.TitlePageSubtitle2
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:.25in;
	text-align:center;
	font-size:32.0pt;
	font-family:Georgia;}
p.TitlePageSubtitle3, li.TitlePageSubtitle3, div.TitlePageSubtitle3
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:9.0pt;
	margin-left:.25in;
	text-align:center;
	font-size:24.0pt;
	font-family:Georgia;}
ins
	{text-decoration:none;}
span.msoIns
	{text-decoration:underline;}
span.msoDel
	{text-decoration:line-through;
	color:red;}
 /* Page Definitions */
 @page Section1
	{size:8.5in 11.0in;
	margin:124.55pt 1.5in 128.15pt 1.75in;}
div.Section1
	{page:Section1;}
@page Section2
	{size:8.5in 11.0in;
	margin:124.55pt 1.5in 128.15pt 1.75in;}
div.Section2
	{page:Section2;}
@page Section3
	{size:8.5in 11.0in;
	margin:124.55pt 1.5in 128.15pt 1.75in;}
div.Section3
	{page:Section3;}
@page Section4
	{size:8.5in 11.0in;
	margin:124.55pt 1.5in 128.15pt 1.75in;}
div.Section4
	{page:Section4;}
@page Section5
	{size:8.5in 11.0in;
	margin:124.55pt 1.5in 128.15pt 1.75in;}
div.Section5
	{page:Section5;}
@page Section6
	{size:8.5in 11.0in;
	margin:124.55pt 1.5in 128.15pt 1.75in;}
div.Section6
	{page:Section6;}
@page Section7
	{size:8.5in 11.0in;
	margin:124.55pt 1.5in 128.15pt 1.75in;}
div.Section7
	{page:Section7;}
@page Section8
	{size:8.5in 11.0in;
	margin:124.55pt 1.5in 128.15pt 1.75in;}
div.Section8
	{page:Section8;}
@page Section9
	{size:8.5in 11.0in;
	margin:124.55pt 1.5in 128.15pt 1.75in;}
div.Section9
	{page:Section9;}
@page Section10
	{size:8.5in 11.0in;
	margin:124.55pt 1.5in 128.15pt 1.75in;}
div.Section10
	{page:Section10;}
@page Section11
	{size:8.5in 11.0in;
	margin:124.55pt 1.5in 128.15pt 1.75in;}
div.Section11
	{page:Section11;}
@page Section12
	{size:8.5in 11.0in;
	margin:124.55pt 1.5in 128.15pt 1.75in;}
div.Section12
	{page:Section12;}
@page Section13
	{size:8.5in 11.0in;
	margin:124.55pt 1.5in 128.15pt 1.75in;}
div.Section13
	{page:Section13;}
@page Section14
	{size:8.5in 11.0in;
	margin:124.55pt 1.5in 128.15pt 1.75in;}
div.Section14
	{page:Section14;}
@page Section15
	{size:8.5in 11.0in;
	margin:124.55pt 1.5in 128.15pt 1.75in;}
div.Section15
	{page:Section15;}
@page Section16
	{size:8.5in 11.0in;
	margin:124.55pt 1.5in 128.15pt 1.75in;}
div.Section16
	{page:Section16;}
@page Section17
	{size:8.5in 11.0in;
	margin:124.55pt 1.5in 128.15pt 1.75in;}
div.Section17
	{page:Section17;}
@page Section18
	{size:8.5in 11.0in;
	margin:124.55pt 1.5in 128.15pt 1.75in;}
div.Section18
	{page:Section18;}
@page Section19
	{size:8.5in 11.0in;
	margin:124.55pt 1.5in 128.15pt 1.75in;}
div.Section19
	{page:Section19;}
 /* List Definitions */
 ol
	{margin-bottom:0in;}
ul
	{margin-bottom:0in;}
-->
</style>

</head>

<body lang=EN-US link=blue vlink=purple>

<div class=Section1>

<h5><b>Thinking in Patterns by Bruce Eckel</b></h5>

<h5><b>Revision 0.9, </b><b>5-20-2003</b><b> (This version contains the
material that will be used in the Crested </b><b>Butte</b><b> seminar; see </b><b><span
style='font-size:10.0pt'><a href="http://www.amaio.com/seminars/">http://www.mindview.net/Seminars/ThinkingInPatterns/</a></span>)</b></h5>

<h5><b>Please note this document is under development and incomplete. Updates
to this document can be found at <a href="http://www.mindview.net/">http://www.Mindview.net</a>
<br>
<br>
Best viewed with Mozilla! (free at <a href="http://www.mozilla.org/">www.Mozilla.org</a>)
(Even though this document was created with MS Word, IE6 garbles lines with superscripts
on them. Mozilla seems to do a much better job).</b></h5>

<p class=MsoNormal><b>___________________________________________</b></p>

<p class=MsoNormal><b>Note</b>: This document requires the installation of the
fonts Georgia, Verdana and Andale Mono (code font) for proper viewing. These
can be found at: <span style='font-size:9.0pt'><a
href="http://sourceforge.net/project/showfiles.php?group_id=34153&amp;release_id=105355">http://sourceforge.net/project/showfiles.php?group_id=34153&amp;release_id=105355</a>
</span></p>

<p class=MsoNormal><span style='font-size:16.0pt'>Modifications in Revision 0.9:</span></p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Prose has still had little/no work. My current goal is to get the
structure and examples worked out so that the seminar works well. Once it has
been proven in the seminars, then I will spend time on the prose.</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Added proxy:PoolManager.java to make a more generic/customizeable
Pool Manager, and modified proxy:ConnectionPoolProxyDemo.java accordingly [[
Still need to decide what to return when you run out of objects in the pool ]]</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Changed PoolManager.java to use an ArrayList (and thus does not
require a fixed size at initialization)</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Added KissingPrincess.java to State description, as a
motivational example for the pattern</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Added a simple Flyweight example</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Simplified the enumeration in PaperScissorsRock.java</p>

<p class=MsoNormal><span style='font-size:16.0pt'>Modifications in Revision 0.8:</span></p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Changed Bridge example to improve clarity.</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Removed superscripts for better viewing with IE (see note above)</p>

<p class=MsoNormal><span style='font-size:16.0pt'>Modifications in Revision
0.7:</span></p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><b>NOTE primary changes have been made to structure of book and
code examples, but not to prose. Prose can be considered to be mostly a mess in
this revision.</b></p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Complete reorganization under headings that attempt to describe
the problems you are trying to solve with a pattern.</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Addition of placeholders for the remainder of the GoF patterns</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Addition of “Simplifying Idioms” section and examples</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Addition of Builder section and examples</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Removed unit-testing chapter; replaced with reference to “new”
JUnit (which uses reflection)</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>(4-30-2003) Added Ant build.xml files, and support files from TIJ
necessary to do a full standalone build. You should be able to type “ant” from
the code root directory and get a successful build.</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Dramatically simplified chainofresponsibility:FindMinima.java</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Added object pool/connection pool examples</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Refactored small things in many examples</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Some exercises may have been left behind when patterns were
moved.</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>For simplicity, saved from Word into a single HTML document,
using “filtered” version to remove Office stuff. Seems to work pretty well;
checked it with both IE and Mozilla (actually seems to work better on Mozilla
than on IE!).</p>

<p class=MsoNormal>TODO:</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Reconfigure for new backtalk system</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Replace references to TIJ2 with TIJ3</p>

</div>

<span style='font-size:11.0pt;font-family:Georgia'><br clear=all
style='page-break-before:always'>
</span>

<div class=Section2>

<p class=MsoTitle>Thinking</p>

<p class=TitleSmall>in</p>

<p class=MsoTitle>Patterns</p>

<p class=TitlePageSubtitle1>Problem-Solving  Techniques using Java</p>

<p class=TitlePageSubtitle2>Bruce Eckel</p>

<p class=TitlePageSubtitle3>President, MindView, Inc.</p>

<p class=MsoNormal style='margin-top:.25in'><span style='display:none'>#[BT_1]#</span>
</p>

</div>

<span style='font-size:11.0pt;font-family:Georgia'><br clear=all
style='page-break-before:right'>
</span>

<div class=Section3>

<p class=ContentsHeading style='margin-left:.75in'>Contents</p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169678">Preface<span
style='color:windowtext;display:none;text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>8</span></a></span></p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169679">Introduction<span
style='color:windowtext;display:none;text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>11</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169680">The Y2K
syndrome<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>11</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169681">Context and
composition<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>12</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169682">A word about
checked exceptions<span style='color:windowtext;display:none;text-decoration:
none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>13</span></a></span></p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169683">The pattern
concept<span style='color:windowtext;display:none;text-decoration:none'> </span><span
style='color:windowtext;display:none;text-decoration:none'>15</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169684">What is a
pattern?<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>15</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169685">Pattern
taxonomy<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>17</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169686">Design
principles<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>18</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169687">Classifying
patterns<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>19</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169688">The
development challenge<span style='color:windowtext;display:none;text-decoration:
none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>21</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169689">Unit testing<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>21</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169690">Location of
test code<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>22</span></a></span></p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169691">Simplifying
Idioms<span style='color:windowtext;display:none;text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>22</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169692">Messenger<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>22</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169693">Collecting Parameter<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>24</span></a></span></p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169694">Object
quantity<span style='color:windowtext;display:none;text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>25</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169695">Singleton<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>25</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169696">Exercises<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>27</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169697">Object pool<span
style='color:windowtext;display:none;text-decoration:none'> </span><span
style='color:windowtext;display:none;text-decoration:none'>27</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169698">Exercises<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>30</span></a></span></p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169699">Object
decoupling<span style='color:windowtext;display:none;text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>30</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169700">Proxy:
fronting for another object<span style='color:windowtext;display:none;
text-decoration:none'> </span><span
style='color:windowtext;display:none;text-decoration:none'>31</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169701">The
PoolManager using Proxy<span style='color:windowtext;display:none;text-decoration:
none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>33</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169702">Dynamic
Proxies<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>36</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169703">State:
changing object behavior<span style='color:windowtext;display:none;text-decoration:
none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>38</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169704">Iterators:
decoupling algorithms from containers<span style='color:windowtext;display:
none;text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>44</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169705">Type-safe
iterators<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>45</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169706">Exercises<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>46</span></a></span></p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169707">Factoring
commonality<span style='color:windowtext;display:none;text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>47</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169708">Strategy:
choosing the algorithm at run-time<span style='color:windowtext;display:none;
text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>48</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169709">Policy:
generalized strategy<span style='color:windowtext;display:none;text-decoration:
none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>50</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169710">Template
method<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>50</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169711">Exercises<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>52</span></a></span></p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169712">Encapsulating
creation<span style='color:windowtext;display:none;text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>52</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169713">Simple
Factory method<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>53</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169714">Polymorphic
factories<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>55</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169715">Abstract
factories<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>58</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169716">Exercises<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>61</span></a></span></p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169717">Specialized
creation<span style='color:windowtext;display:none;text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>61</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169718">Prototype<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>61</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169719">Builder<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>62</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169720">Exercises<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>66</span></a></span></p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169721">Too many<span
style='color:windowtext;display:none;text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>66</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169722">Flyweight:
too many objects<span style='color:windowtext;display:none;text-decoration:
none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>66</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169723">Decorator:
too many classes<span style='color:windowtext;display:none;text-decoration:
none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>69</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169724">Basic
decorator structure<span style='color:windowtext;display:none;text-decoration:
none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>70</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169725">A coffee
example<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>70</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169726">Class for
each combination<span style='color:windowtext;display:none;text-decoration:
none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>70</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169727">The decorator
approach<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>73</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169728">Compromise<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>78</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169729">Other
considerations<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>82</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169730">Exercises<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>83</span></a></span></p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169731">Connecting
different types<span style='color:windowtext;display:none;text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>84</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169732">Adapter<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>84</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169733">Bridge<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>87</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169734">Exercises<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>93</span></a></span></p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169735">Flexible
structure<span style='color:windowtext;display:none;text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>93</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169736">Composite<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>93</span></a></span></p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169737">System
decoupling<span style='color:windowtext;display:none;text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>95</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169738">Observer<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>95</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169739">Observing
flowers<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>97</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169740">A visual
example of observers<span style='color:windowtext;display:none;text-decoration:
none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>101</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169741">Mediator<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>103</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169742">Exercises<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>104</span></a></span></p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169743">Reducing
interface complexity<span style='color:windowtext;display:none;text-decoration:
none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>104</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169744">Façade<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>105</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169745">Package as a
variation of <i>Façade</i><span style='color:windowtext;display:none;
text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>106</span></a></span></p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169746">Algorithmic
partitioning<span style='color:windowtext;display:none;text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>106</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169747">Command:
choosing the operation at run-time<span style='color:windowtext;display:none;
text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>106</span><span
style='color:windowtext;display:none;text-decoration:none'></span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169748">Exercises<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>109</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169749">Chain of
responsibility<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>109</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169750">Exercises<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>112</span></a></span></p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169751">Externalizing
object state<span style='color:windowtext;display:none;text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>113</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169752">Memento<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>113</span></a></span></p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169753">Complex
interactions<span style='color:windowtext;display:none;text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>114</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169754">Multiple
dispatching<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>114</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169755">Visitor, a
type of multiple dispatching<span style='color:windowtext;display:none;
text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>117</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169756">Exercises<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>119</span></a></span></p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169757">Multiple
languages<span style='color:windowtext;display:none;text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>120</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169758">Interpreter
motivation<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>121</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169759">Python
overview<span style='color:windowtext;display:none;text-decoration:none'>.. </span><span
style='color:windowtext;display:none;text-decoration:none'>122</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169760">Built-in
containers<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>123</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169761">Functions<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>124</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169762">Strings<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>125</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169763">Classes<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>127</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169764">Creating a
language<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>130</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169765">Controlling
the interpreter<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>134</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169766">Putting data
in<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>134</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169767">Getting data
out<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>140</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169768">Multiple
interpreters<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>143</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169769">Controlling
Java from Jython<span style='color:windowtext;display:none;text-decoration:
none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>144</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169770">Inner Classes<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>148</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169771">Using Java
libraries<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>148</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169772">Inheriting
from Java library classes<span style='color:windowtext;display:none;text-decoration:
none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>150</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169773">Creating Java
classes with Jython<span style='color:windowtext;display:none;text-decoration:
none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>151</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169774">Building the
Java classes from the Python code<span style='color:windowtext;display:none;
text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>156</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169775">The
Java-Python Extension (JPE)<span style='color:windowtext;display:none;
text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>157</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169776">Summary<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>157</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169777">Exercises<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>158</span></a></span></p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169778">Complex
system states<span style='color:windowtext;display:none;text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>159</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169779">StateMachine<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>159</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169780">Exercises<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>169</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169781">Table-Driven
State Machine<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>169</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169782">The State
class<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>171</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169783">Conditions
for transition<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>172</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169784">Transition
actions<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>172</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169785">The table<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>172</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169786">The basic
machine<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>173</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169787">Simple
vending machine<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>174</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169788">Testing the
machine<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>179</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169789">Tools<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>180</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169790">Table-driven
code: configuration flexibility<span style='color:windowtext;display:none;
text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>180</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169791">Table-driven
code using anonymous inner classes<span style='color:windowtext;display:none;
text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>180</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169792">Exercises<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>180</span></a></span></p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169793">Pattern
refactoring<span style='color:windowtext;display:none;text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>181</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169794">Simulating
the trash recycler<span style='color:windowtext;display:none;text-decoration:
none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>182</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169795">Improving the
design<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>186</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169796">“Make more
objects”<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>186</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169797">A pattern for
prototyping creation<span style='color:windowtext;display:none;text-decoration:
none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>189</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169798"><b>Trash</b>
subclasses<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>193</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169799">Parsing <b>Trash</b>
from an external file<span style='color:windowtext;display:none;text-decoration:
none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>195</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169800">Recycling
with prototyping<span style='color:windowtext;display:none;text-decoration:
none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>198</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169801">Abstracting
usage<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>199</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169802">Multiple
dispatching<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>203</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169803">Implementing
the double dispatch<span style='color:windowtext;display:none;text-decoration:
none'>   </span><span
style='color:windowtext;display:none;text-decoration:none'>204</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169804">The <i>Visitor</i>
pattern<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>211</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169805">A Reflective
Decorator<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>214</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169806">More
coupling?<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>219</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169807">RTTI
considered harmful?<span style='color:windowtext;display:none;text-decoration:
none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>220</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169808">Summary<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>223</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169809">Exercises<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>224</span></a></span></p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169810">Projects<span
style='color:windowtext;display:none;text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>225</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169811">Rats &amp;
Mazes<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>225</span></a></span></p>

<p class=MsoToc3><span class=MsoHyperlink><a href="#_Toc41169812">Other maze
resources<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>230</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169813">XML Decorator<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>230</span></a></span></p>

<p class=MsoToc1><span class=MsoHyperlink><a href="#_Toc41169814">A: Tools<span
style='color:windowtext;display:none;text-decoration:none'>  </span><span
style='color:windowtext;display:none;text-decoration:none'>230</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169815">Ant
extensions<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>231</span></a></span></p>

<p class=MsoToc2><span class=MsoHyperlink><a href="#_Toc41169816">Array
utilities<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>232</span></a></span></p>

<p class=MsoNormal><a name=TOCOverview></a></p>

</div>

<span style='font-size:11.0pt;font-family:Georgia;display:none'><br clear=all
style='page-break-before:right'>
</span>

<div class=Section4>

<h1 style='margin-left:.75in'><a name="_Toc41169678">Preface</a></h1>

<p class=Intro>The material in this book has been developed in conjunction with
a seminar that I have given for several years, mostly with Bill Venners. Bill
and I have given many iterations of this seminar and we’ve changed it many
times over the years as we both have learned more about patterns and about
giving the seminar. </p>

<p class=MsoNormal>In the process we’ve both produced more than enough
information for us each to have our own seminars, an urge that we’ve both
strongly resisted because we have so much fun giving the seminar together.
We’ve given the seminar in numerous places in the US, as well as in Prague
(where we try to have a mini-conference every Spring together with a number of
other seminars). We’ve also given it as an on-site seminar.</p>

<p class=MsoNormal>A great deal of appreciation goes to the people who have
participated in these seminars over the years, as they have helped me work
through these ideas and to refine them. I hope to be able to continue to form
and develop these kinds of ideas through this book and seminar for many years
to come.</p>

<p class=MsoNormal>This book will not stop here, either. After much pondering,
I’ve realized that I want <i>Thinking in Python</i> to be, initially, a
translation of this book rather than an introduction to Python (there are
already plenty of fine introductions to that superb language). I find this
prospect to be much more exciting than the idea of struggling through another
language tutorial (my apologies to those who were hoping for that).</p>

</div>

<span style='font-size:11.0pt;font-family:Georgia;display:none'><br clear=all
style='page-break-before:right'>
</span>

<div class=Section5>

<p class=MsoNormal><span style='display:none'>#[BT_2]#</span></p>

</div>

<span style='font-size:11.0pt;font-family:Georgia;display:none'><br clear=all
style='page-break-before:right'>
</span>

<div class=Section6>

<h1 style='margin-left:.75in'><a name="_Toc41169679">Introduction</a></h1>

<p class=Intro>This is a book about design that I have been working on for
years, basically ever since I first started trying to read <i>Design Patterns</i>
(Gamma, Helm, Johnson &amp; Vlissides, Addison-Wesley, 1995), commonly referred
to as the <i>Gang of Four</i><a href="#_ftn1" name="_ftnref1" title=""><span
class=MsoFootnoteReference><i><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><b><span style='font-size:14.0pt;font-family:Georgia;
vertical-align:baseline'>[1]</span></b></span></span></i></span></a> or just
GoF).</p>

<p class=MsoNormal>There is a chapter on design patterns in the first edition
of <i>Thinking in C++</i>, which has evolved in Volume 2 of the second edition
of <i>Thinking in C++</i>, and you’ll also find a chapter on patterns in the
first edition of <i>Thinking in Java</i> (I took it out of the second edition
because that book was getting too big, and also because I had decided to write
this book).</p>

<p class=MsoNormal>This is not an introductory book. I am assuming that you
have worked your way through <i>Thinking in Java</i> or an equivalent text
before coming to this book.</p>

<p class=MsoNormal>In addition, I assume you have more than just a grasp of the
syntax of Java. You should have a good understanding of objects and what
they’re about, including polymorphism. Again, these are topics covered in <i>Thinking
in Java</i>.</p>

<p class=MsoNormal>On the other hand, by going through this book you’re going
to learn a <i>lot</i> about object-oriented programming by seeing objects used
in many different situations. If your knowledge of objects is rudimentary, it
will get much stronger in the process of understanding the designs in this
book.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169680">The Y2K syndrome</a></h2>

<p class=MsoNormal>In a book that has “problem-solving techniques” in its
subtitle, it’s worth mentioning one of the biggest pitfalls in programming:
premature optimization. Every time I bring this concept forward, virtually
everyone agrees to it. Also, everyone seems to reserve in their own mind a
special case “except for this thing that I happen to know is a particular
problem.”</p>

<p class=MsoNormal>The reason I call this the Y2K syndrome has to do with that
special knowledge. Computers are a mystery to most people, so when someone
announced that those silly computer programmers had forgotten to put in enough
digits to hold dates past the year 1999, then suddenly everyone became a
computer expert – “these things aren’t so difficult after all, if I can see
such an obvious problem.” For example, my background was originally in computer
engineering, and I started out by programming embedded systems. As a result, I
know that many embedded systems have no idea what the date or time is, and even
if they do that data often isn’t used in any important calculations. And yet I
was told in no uncertain terms that all the embedded systems were going to
crash on January 1, 2000. As far as I can tell the only memory that was lost on
that particular date was that of the people who were predicting doom – it’s as
if they had never said any of that stuff.</p>

<p class=MsoNormal>The point is that it’s very easy to fall into a habit of
thinking that the particular algorithm or piece of code that you happen to
partly or thoroughly understand is naturally going to be the bottleneck in your
system, simply because you can imagine what’s going on in that piece of code
and so you think that it must somehow be much less efficient than all the other
pieces of code that you don’t know about. But unless you’ve run actual tests,
typically with a profiler, you can’t really know what’s going on. And even if
you are right, that a piece of code is very inefficient, remember that most
programs spend something like 90% of their time in less than 10% of the code in
the program, so unless the piece of code you’re thinking about happens to fall
into that 10% it isn’t going to be important.</p>

<p class=MsoNormal><i>“We should forget about small efficiencies, say about 97%
of the time: Premature optimization is the root of all evil.”—Donald Knuth </i></p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169681">Context and composition</a></h2>

<p class=MsoNormal>One of the terms you will see used over and over in design
patterns literature is <i>context</i>. In fact, one common definition of a
design pattern is “a solution to a problem in a context.” The GoF patterns
often have a “context object” that the client programmer interacts with. At one
point it occurred to me that such objects seemed to dominate the landscape of
many patterns, and so I began asking what they were about.</p>

<p class=MsoNormal>The context object often acts as a little façade to hide the
complexity of the rest of the pattern, and in addition it will often be the
controller that manages the operation of the pattern. Initially, it seemed to
me that these were not really essential to the implementation, use and
understanding of the pattern. However, I remembered one of the more dramatic
statements made in the GoF: “prefer composition to inheritance.” The context
object allows you to use the pattern in a composition, and that may be it’s
primary value.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169682">A word about checked
exceptions</a></h2>

<p class=MsoNormal>1) The great value of exceptions is the unification of error
reporting: a standard mechanism by which to report errors, rather than the
popourri of ignorable approaches that we had in C (and thus, C++, which only
adds exceptions to the mix, and doesn't make it the exclusive approach). The
big advantage Java has over C++ is that exceptions are the only way to report
errors.</p>

<p class=MsoNormal>2) &quot;Ignorable&quot; in the previous paragraph is the
other issue. The theory is that if the compiler forces the programmer to either
handle the exception or pass it on in an exception specification, then the
programmer's attention will always be brought back to the possibility of errors
and they will thus properly take care of them. I think the problem is that this
is an untested assumption we're making as language designers that falls into
the field of psychology. My theory is that when someone is trying to do
something and you are constantly prodding them with annoyances, they will use
the quickest device available to make those annoyances go away so they can get
their thing done, perhaps assuming they'll go back and take out the device
later. I discovered I had done this in the first edition of Thinking in Java:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>...</p>

<p class=Code style='margin-left:0in'>} catch (SomeKindOfException e) {}</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>And then more or less forgot it until the rewrite. How many
people thought this was a good example and followed it? Martin Fowler began
seeing the same kind of code, and realized people were stubbing out exceptions
and then they were disappearing. The overhead of checked exceptions was having
the opposite effect of what was intended, something that can happen when you
experiment (and I now believe that checked exceptions were an experiment based
on what someone thought was a good idea, and which I believed was a good idea
until recently).</p>

<p class=MsoNormal>When I started using Python, all the exceptions appeared,
none were accidentally &quot;disappeared.&quot; If you *want* to catch an
exception, you can, but you aren't forced to write reams of code all the time
just to be passing the exceptions around. They go up to where you want to catch
them, or they go all the way out if you forget (and thus they remind you) but
they don't vanish, which is the worst of all possible cases. I now believe that
checked exceptions encourage people to make them vanish. Plus they make much
less readable code.</p>

<p class=MsoNormal>In the end, I think we must realize the experimental nature
of exceptions and look at them carefully before assuming that everything about
exceptions in Java are good. I believe that having a single mechanism for
handling errors is excellent, and I believe that using a separate channel (the
exception handling mechanism) for moving the exceptions around is good. But I
do remember one of the early arguments for exception handling in C++ was that
it would allow the programmer to separate the sections of code where you just
wanted to get work done from the sections where you handled errors, and it
seems to me that checked exceptions do not do this; instead, they tend to
intrude (a lot) into your &quot;normal working code&quot; and thus are a step
backwards. My experience with Python exceptions supports this, and unless I get
turned around on this issue I intend to put a lot more <b>RuntimeException</b>s
into my Java code.</p>

<p class=MsoNormal><span style='display:none'>#[BT_4]#</span></p>

</div>

<span style='font-size:11.0pt;font-family:Georgia;display:none'><br clear=all
style='page-break-before:right'>
</span>

<div class=Section7>

<h1 style='margin-left:0in;text-indent:0in'><a name="_Toc41169683">The pattern
concept</a></h1>

<p class=Intro>“Design patterns help you learn from others' successes instead
of your own failures<a href="#_ftn2" name="_ftnref2" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><span style='font-size:14.0pt;font-family:Georgia;
vertical-align:baseline'>[2]</span></span></span></span></a>.” </p>

<p class=MsoNormal><span style='display:none'>#[BT_6]#</span>Probably the most
important step forward in object-oriented design is the “design patterns”
movement, chronicled in <i>Design Patterns (ibid)</i><a href="#_ftn3"
name="_ftnref3" title=""><span class=MsoFootnoteReference><span
style='vertical-align:baseline'><span class=MsoFootnoteReference><span
style='font-size:11.0pt;font-family:Georgia;vertical-align:baseline'>[3]</span></span></span></span></a>.
That book shows 23 different solutions to particular classes of problems. In
this book, the basic concepts of design patterns will be introduced along with
examples. This should whet your appetite to read <i>Design Patterns</i> by
Gamma, et. al., a source of what has now become an essential, almost mandatory,
vocabulary for OOP programmers.</p>

<p class=MsoNormal><span style='display:none'>#[BT_7]#</span>The latter part of
this book contains an example of the design evolution process, starting with an
initial solution and moving through the logic and process of evolving the
solution to more appropriate designs. The program shown (a trash sorting
simulation) has evolved over time, and you can look at that evolution as a
prototype for the way your own design can start as an adequate solution to a
particular problem and evolve into a flexible approach to a class of problems.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169684">What is a pattern?</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_8]#</span>Initially, you can
think of a pattern as an especially clever and insightful way of solving a
particular class of problems. That is, it looks like a lot of people have
worked out all the angles of a problem and have come up with the most general,
flexible solution for it. The problem could be one you have seen and solved
before, but your solution probably didn’t have the kind of completeness you’ll
see embodied in a pattern.</p>

<p class=MsoNormal><span style='display:none'>#[BT_9]#</span>Although they’re
called “design patterns,” they really aren’t tied to the realm of design. A
pattern seems to stand apart from the traditional way of thinking about
analysis, design, and implementation. Instead, a pattern embodies a complete
idea within a program, and thus it can sometimes appear at the analysis phase
or high-level design phase. This is interesting because a pattern has a direct
implementation in code and so you might not expect it to show up before
low-level design or implementation (and in fact you might not realize that you
need a particular pattern until you get to those phases).</p>

<p class=MsoNormal><span style='display:none'>#[BT_10]#</span>The basic concept
of a pattern can also be seen as the basic concept of program design: adding a
layer of abstraction. Whenever you abstract something you’re isolating
particular details, and one of the most compelling motivations behind this is
to <i>separate things that change from things that stay the same</i>. Another
way to put this is that once you find some part of your program that’s likely
to change for one reason or another, you’ll want to keep those changes from
propagating other changes throughout your code. Not only does this make the
code much cheaper to maintain, but it also turns out that it is usually simpler
to understand (which results in lowered costs).</p>

<p class=MsoNormal><span style='display:none'>#[BT_11]#</span>Often, the most
difficult part of developing an elegant and cheap-to-maintain design is in
discovering what I call “the vector of change.” (Here, “vector” refers to the
maximum gradient and not a container class.) This means finding the most
important thing that changes in your system, or put another way, discovering
where your greatest cost is. Once you discover the vector of change, you have
the focal point around which to structure your design.</p>

<p class=MsoNormal><span style='display:none'>#[BT_12]#</span>So the goal of
design patterns is to isolate changes in your code. If you look at it this way,
you’ve been seeing some design patterns already in this book. For example, inheritance can be thought of as a design pattern (albeit one implemented by the
compiler). It allows you to express differences in behavior (that’s the thing
that changes) in objects that all have the same interface (that’s what stays
the same). Composition can also be considered a pattern, since it allows you to
change—dynamically or statically—the objects that implement your class, and
thus the way that class works.</p>

<p class=MsoNormal><span style='display:none'>#[BT_13]#</span>You’ve also
already seen another pattern that appears in <i>Design Patterns</i>: the <i>iterator</i> (Java 1.0 and 1.1 capriciously calls it the <b>Enumeration</b>; Java
2 containers use “iterator”). This hides the particular implementation of the
container as you’re stepping through and selecting the elements one by one. The
iterator allows you to write generic code that performs an operation on all of
the elements in a sequence without regard to the way that sequence is built.
Thus your generic code can be used with any container that can produce an
iterator.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169685">Pattern taxonomy</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_14]#</span>One of the events
that’s occurred with the rise of design patterns is what could be thought of as
the “pollution” of the term – people have begun to use the term to mean just
about anything synonymous with “good.” After some pondering, I’ve come up with
a sort of hierarchy describing a succession of different types of categories:</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><b>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></b><b><span
style='display:none'>#[BT_15]#</span>Idiom</b>: how we write code in a
particular language to do this particular type of thing. This could be
something as common as the way that you code the process of stepping through an
array in C (and not running off the end).</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><b>2.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp; </span></b><b><span
style='display:none'>#[BT_16]#</span>Specific Design</b>: the solution that we
came up with to solve this particular problem. This might be a clever design,
but it makes no attempt to be general.</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><b>3.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp; </span></b><b><span
style='display:none'>#[BT_17]#</span>Standard Design</b>: a way to solve this <i>kind</i>
of problem. A design that has become more general, typically through reuse.</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><b>4.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp; </span></b><b><span
style='display:none'>#[BT_18]#</span>Design Pattern</b>: how to solve an entire
class of similar problem. This usually only appears after applying a standard
design a number of times, and then seeing a common pattern throughout these
applications.</p>

<p class=MsoNormal><span style='display:none'>#[BT_19]#</span>I feel this helps
put things in perspective, and to show where something might fit. However, it
doesn’t say that one is better than another. It doesn’t make sense to try to
take every problem solution and generalize it to a design pattern – it’s not a
good use of your time, and you can’t force the discovery of patterns that way;
they tend to be subtle and appear over time.</p>

<p class=MsoNormal><span style='display:none'>#[BT_20]#</span>One could also
argue for the inclusion of <i>Analysis Pattern</i> and <i>Architectural Pattern</i>
in this taxonomy.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc476705894"></a><a
name="_Toc41169686">Design principles</a></h2>

<p class=MsoNormal>(Update from slides to here)</p>

<p class=MsoNormal>When I put out a call for ideas in my newsletter<a
href="#_ftn4" name="_ftnref4" title=""><span class=MsoFootnoteReference><span
style='vertical-align:baseline'><span class=MsoFootnoteReference><span
style='font-size:11.0pt;font-family:Georgia;vertical-align:baseline'>[4]</span></span></span></span></a>,
a number of suggestions came back which turned out to be very useful, but
different than the above classification, and I realized that a list of design
principles is at least as important as design structures, but for a different
reason: these allow you to ask questions about your proposed design, to apply
tests for quality.</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><b>Principle of least astonishment</b> (don’t be astonishing).</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><b>Make common things easy, and rare things possible</b></p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><b>Consistency</b>. One thing has become very clear to me,
especially because of Python: the more random rules you pile onto the
programmer, rules that have nothing to do with solving the problem at hand, the
slower the programmer can produce. And this does not appear to be a linear
factor, but an exponential one.</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><b>Law of Demeter</b>: a.k.a. “Don’t talk to strangers.” An
object should only reference itself, its attributes, and the arguments of its
methods.</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><b>Subtraction</b>: a design is finished when you cannot take
anything else away.</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><b>Simplicity before generality</b><a href="#_ftn5"
name="_ftnref5" title=""><span class=MsoFootnoteReference><b><span
style='vertical-align:baseline'><span class=MsoFootnoteReference><b><span
style='font-size:11.0pt;font-family:Georgia;vertical-align:baseline'>[5]</span></b></span></span></b></span></a>.
(A variation of <i>Occam’s Razor</i>, which says “the simplest solution is the
best”). A common problem we find in frameworks is that they are designed to be
general purpose without reference to actual systems. This leads to a dizzying
array of options that are often unused, misused or just not useful. However,
most developers work on specific systems, and the quest for generality does not
always serve them well. The best route to generality is through understanding
well-defined specific examples. So, this principle acts as the tie breaker
between otherwise equally viable design alternatives. Of course, it is entirely
possible that the simpler solution is the more general one.</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><b>Reflexivity</b> (my suggested term). One abstraction per
class, one class per abstraction. Might also be called <b>Isomorphism</b>.</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><b>Independence</b> or <b>Orthogonality</b>. Express independent
ideas independently. This complements Separation, Encapsulation and Variation,
and is part of the Low-Coupling-High-Cohesion message.</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><b>Once and once only</b>: Avoid duplication of logic and
structure where the duplication is not accidental, ie where both pieces of code
express the same intent for the same reason.</p>

<p class=MsoNormal>In the process of brainstorming this idea, I hope to come up
with a small handful of fundamental ideas that can be held in your head while
you analyze a problem. However, other ideas that come from this list may end up
being useful as a checklist while walking through and analyzing your design.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169687"></a><a
name="_Toc476705895">Classifying patterns</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_27]#</span>The <i>Design
Patterns</i> book discusses 23 different patterns, classified under three purposes
(all of which revolve around the particular aspect that can vary). The three
purposes are: </p>

<p class=Numbered><span style='font-family:Verdana'>1.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><b>Creational</b>: how an object can be created. This often
involves isolating the details of object creation so your code isn’t dependent
on what types of objects there are and thus doesn’t have to be changed when you
add a new type of object. The aforementioned <i>Singleton</i> is classified as
a creational pattern, and later in this book you’ll see examples of <i>Factory
Method</i> and <i>Prototype</i>.</p>

<p class=Numbered><span style='font-family:Verdana'>2.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><b>Structural</b>: designing objects to satisfy particular
project constraints. These work with the way objects are connected with other
objects to ensure that changes in the system don’t require changes to those
connections.</p>

<p class=Numbered><span style='font-family:Verdana'>3.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><b>Behavioral</b>: objects that handle particular types of
actions within a program. These encapsulate processes that you want to perform,
such as interpreting a language, fulfilling a request, moving through a
sequence (as in an iterator), or implementing an algorithm. This book contains
examples of the <i>Observer</i> and the <i>Visitor</i> patterns.</p>

<p class=MsoNormal><span style='display:none'>#[BT_28]#</span>The <i>Design
Patterns</i> book has a section on each of its 23 patterns along with one or
more examples for each, typically in C++ (rather restricted C++, at that) but
sometimes in Smalltalk. (You’ll find that this doesn’t matter too much since
you can easily translate the concepts from either language into Java.) This
book will revisit many of the patterns shown in <i>Design Patterns</i> but with
a Java orientation, since the language changes the expression and understanding
of the patterns. However, the GoF examples will not be repeated here, since I
believe that it’s possible to produce more illuminating examples given some
effort. The goal is to provide you with a decent feel for what patterns are
about and why they are so important.</p>

<p class=MsoNormal><span style='display:none'>#[BT_29]#</span>After years of
looking at these things, it began to occur to me that the patterns themselves
use basic principles of organization, other than (and more fundamental than)
those described in <i>Design Patterns</i>. These principles are based on the
structure of the implementations, which is where I have seen great similarities
between patterns (more than those expressed in <i>Design Patterns</i>).
Although we generally try to avoid implementation in favor of interface,<i> </i>for
awhile I thought that it was easier to understand the patterns in terms of
these structural principles, and tried reorganizing the book around the patterns
based on their structure instead of the categories presented in <i>Design
Patterns</i>.</p>

<p class=MsoNormal>However, a later insight made me realize that it’s more
useful to organize the patterns in terms of the problems they solve. I believe
this is a subtle but important distinction from the way Metsker organizes the
patterns by intent in <i>Design Patterns Java Workshop</i> (Addison-Wesley
2002), because I hope that you will then be able to recognize your problem and
search for a solution, if the patterns are organized this way.</p>

<p class=MsoNormal>In the process of doing all this “book refactoring” I
realized that if I changed it once, I would probably change it again (there’s
definitely a design maxim in there), so I removed all references to chapter numbers
in order to facilitate this change (the little-known “numberless chapter”
pattern <span style='font-family:Wingdings'>J</span>).<span style='display:
none'>HowHH</span></p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169688">The development challenge</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_30]#</span>Issues of
development, the UML process, Extreme Programming. </p>

<p class=MsoNormal><span style='display:none'>#[BT_31]#</span>Is evaluation
valuable? The Capability Immaturity Model:</p>

<p class=MsoNormal><span lang=IT style='display:none'>#[BT_32]#</span><span
lang=IT>Wiki Page: </span><u><span style='color:blue'><a
href="http://c2.com/cgi-bin/wiki?CapabilityImMaturityModel"><span lang=IT>http://c2.com/cgi-bin/wiki?CapabilityImMaturityModel</span></a></span></u><u><span
lang=IT style='color:blue'><br>
</span></u><span lang=IT>Article: </span><u><span style='color:blue'><a
href="http://www.embedded.com/98/9807br.htm"><span lang=IT>http://www.embedded.com/98/9807br.htm</span></a></span></u><u><span
lang=IT style='color:blue'> </span></u></p>

<p class=MsoNormal><i><span style='display:none'>#[BT_33]#</span>Pair
programming</i> research:</p>

<p class=MsoNormal><span style='display:none'>#[BT_34]#</span><a
href="http://collaboration.csc.ncsu.edu/laurie/">http://collaboration.csc.ncsu.edu/laurie/</a>
</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169689">Unit testing</a></h2>

<p class=MsoNormal>In an earlier version of this book I decided that unit
testing was essential (for all of my books) and that JUnit was too verbose and
clunky to consider. At that time I wrote my own unit testing framework using
Java reflection to simplify the syntax necessary to achieve unit testing. For
the third edition of <i>Thinking in Java</i>, we developed another unit testing
framework for that book which would test the output of examples.</p>

<p class=MsoNormal>In the meantime, JUnit has changed to add a syntax
remarkably similar to the one that I used in an earlier version of this book. I
don’t know how much influence I may have had on that change, but I’m simply
happy that it has happened, because I no longer feel the need to support my own
system (which you can still find &lt;some URL here&gt;) and can simply
recommend the defacto standard.</p>

<p class=MsoNormal>I have introduced and described the style of JUnit coding
that I consider a “best practice” (primarily because of simplicity), in <i>Thinking
in Java, 3<sup>rd</sup> edition</i>, chapter 15. That section provides an
adequate introduction to any of the unit testing you will see associated with
this book (however, the unit testing code will not normally be included in the
text of this book). When you download the code for this book, you will find (4/9/2003: Eventually, not yet) unit tests along with the code examples whenever possible.</p>

<h3><a name="_Toc41169690">Location of test code</a></h3>

<p class=MsoNormal>(From Bill):</p>

<p class=MsoNormal>Public: in <b>test</b> subdirectory; different package
(don’t include in jar).</p>

<p class=MsoNormal>Package access: same package, subdirectory path underneath
library code (don’t include in jar)</p>

<p class=MsoNormal>Private access: (white box testing). Nested class, strip
out, or Junit addons.</p>

<h1 style='margin-left:.75in'><a name="_Toc41169691">Simplifying Idioms</a></h1>

<p class=MsoNormal>Before getting into more complex techniques, it’s helpful to
look at some basic ways to keep code simple and straightforward. </p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169692">Messenger</a></h2>

<p class=MsoNormal>The most trivial of these is the <i>messenger</i>, which
simply packages information into an object to be passed around, instead of
passing all the pieces around separately. Note that without the messenger, the
code for <b>translate()</b> would be much more confusing to read:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: simplifying:MessengerDemo.java</p>

<p class=Code style='margin-left:0in'>package simplifying;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Point { // A messenger</p>

<p class=Code style='margin-left:0in'>  public int x, y, z; // Since it's just
a carrier</p>

<p class=Code style='margin-left:0in'>  public Point(int x, int y, int z) {</p>

<p class=Code style='margin-left:0in'>    this.x = x;</p>

<p class=Code style='margin-left:0in'>    this.y = y;</p>

<p class=Code style='margin-left:0in'>    this.z = z;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public Point(Point p) { //
Copy-constructor</p>

<p class=Code style='margin-left:0in'>    this.x = p.x;</p>

<p class=Code style='margin-left:0in'>    this.y = p.y;</p>

<p class=Code style='margin-left:0in'>    this.z = p.z;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String toString() {</p>

<p class=Code style='margin-left:0in'>    return &quot;x: &quot; + x + &quot;
y: &quot; + y + &quot; z: &quot; + z;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Vector { </p>

<p class=Code style='margin-left:0in'>  public int magnitude, direction;</p>

<p class=Code style='margin-left:0in'>  public Vector(int magnitude, int
direction) {</p>

<p class=Code style='margin-left:0in'>    this.magnitude = magnitude;</p>

<p class=Code style='margin-left:0in'>    this.direction = direction;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Space {</p>

<p class=Code style='margin-left:0in'>  public static Point translate(Point p,
Vector v) {</p>

<p class=Code style='margin-left:0in'>    p = new Point(p); // Don't modify the
original</p>

<p class=Code style='margin-left:0in'>    // Perform calculation using v. Dummy
calculation:</p>

<p class=Code style='margin-left:0in'>    p.x = p.x + 1;</p>

<p class=Code style='margin-left:0in'>    p.y = p.y + 1;</p>

<p class=Code style='margin-left:0in'>    p.z = p.z + 1;</p>

<p class=Code style='margin-left:0in'>    return p;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class MessengerDemo extends
TestCase {</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    Point p1 = new Point(1, 2, 3);</p>

<p class=Code style='margin-left:0in'>    Point p2 = Space.translate(p1, new
Vector(11, 47));</p>

<p class=Code style='margin-left:0in'>    String result = &quot;p1: &quot; + p1
+ &quot; p2: &quot; + p2;</p>

<p class=Code style='margin-left:0in'>    System.out.println(result);</p>

<p class=Code style='margin-left:0in'>    assertEquals(result, </p>

<p class=Code style='margin-left:0in'>      &quot;p1: x: 1 y: 2 z: 3 p2: x: 2
y: 3 z: 4&quot;);</p>

<p class=Code style='margin-left:0in'>  }   </p>

<p class=Code style='margin-left:0in'>  public static void main(String[] args)
{</p>

<p class=Code style='margin-left:0in'>   
junit.textui.TestRunner.run(MessengerDemo.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>Since the goal of a messenger is only to carry data, that
data is made <b>public</b> for easy access. However, you may also have reasons
to make the fields <b>private</b>.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169693">Collecting Parameter</a></h2>

<p class=MsoNormal>Messenger’s big brother is the <i>collecting parameter</i>,
whose job is to capture information from the method to which it is passed.
Generally, this is used when the collecting parameter is passed to multiple
methods, so it’s like a bee collecting pollen.</p>

<p class=MsoNormal>A container makes an especially useful collecting parameter,
since it is already set up to dynamically add objects:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//:
simplifying:CollectingParameterDemo.java</p>

<p class=Code style='margin-left:0in'>package simplifying;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class CollectingParameter extends
ArrayList {}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Filler {</p>

<p class=Code style='margin-left:0in'>  public void f(CollectingParameter cp) {</p>

<p class=Code style='margin-left:0in'>    cp.add(&quot;accumulating&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void g(CollectingParameter cp) {</p>

<p class=Code style='margin-left:0in'>    cp.add(&quot;items&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void h(CollectingParameter cp) {</p>

<p class=Code style='margin-left:0in'>    cp.add(&quot;as we go&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class CollectingParameterDemo
extends TestCase {</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    Filler filler = new Filler();</p>

<p class=Code style='margin-left:0in'>    CollectingParameter cp = new
CollectingParameter();</p>

<p class=Code style='margin-left:0in'>    filler.f(cp);</p>

<p class=Code style='margin-left:0in'>    filler.g(cp);</p>

<p class=Code style='margin-left:0in'>    filler.h(cp);</p>

<p class=Code style='margin-left:0in'>    String result = &quot;&quot; + cp;</p>

<p class=Code style='margin-left:0in'>    System.out.println(cp);</p>

<p class=Code style='margin-left:0in'>   
assertEquals(result,&quot;[accumulating, items, as we go]&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String[] args)
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(</p>

<p class=Code style='margin-left:0in'>      CollectingParameterDemo.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>The collecting parameter must have some way to set or insert
values. Note that by this definition, a messenger could be used as a collecting
parameter. The key is that a collecting parameter is passed about and modified
by the methods it is passed to.</p>

<h1 style='margin-left:.75in'><a name="_Toc41169694">Object quantity</a></h1>

<p class=Intro>The two patterns described here are solely used to control the
quantity of objects. </p>

<p class=MsoNormal><i>Singleton</i> could actually be thought of as a special
case of <i>Object Pool</i>, but the applications of the <i>Object Pool</i> tend
to be uniqe enough from <i>Singleton</i> that it’s worth treating the two
separately.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169695">Singleton</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_21]#</span>Possibly the
simplest design pattern is the <i>singleton</i>, which is a way to provide one
and only one object of a particular type.  An important aspect of Singleton is
that you provide a global access point, so singletons are often a solution for
what you would have used a global variable for in C. In addition, a singleton
often has the characteristics of a registry or lookup service – it’s a place
you go to find references to other objects.</p>

<p class=MsoNormal>Singletons can be found in the Java libraries, but here’s a
more direct example:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: singleton:SingletonPattern.java</p>

<p class=Code style='margin-left:0in'>// The Singleton design pattern: you can</p>

<p class=Code style='margin-left:0in'>// never instantiate more than one.</p>

<p class=Code style='margin-left:0in'>package singleton;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// Since this isn't inherited from a
Cloneable</p>

<p class=Code style='margin-left:0in'>// base class and cloneability isn't
added,</p>

<p class=Code style='margin-left:0in'>// making it final prevents cloneability
from</p>

<p class=Code style='margin-left:0in'>// being added through inheritance:</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>final class Singleton {</p>

<p class=Code style='margin-left:0in'>  private static Singleton s = new
Singleton(47);</p>

<p class=Code style='margin-left:0in'>  private int i;</p>

<p class=Code style='margin-left:0in'>  private Singleton(int x) { i = x; }</p>

<p class=Code style='margin-left:0in'>  public static Singleton getReference()
{ </p>

<p class=Code style='margin-left:0in'>    return s; </p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public int getValue() { return i; }</p>

<p class=Code style='margin-left:0in'>  public void setValue(int x) { i = x; }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class SingletonPattern extends
TestCase {</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    Singleton s =
Singleton.getReference();</p>

<p class=Code style='margin-left:0in'>    String result = &quot;&quot; +
s.getValue();</p>

<p class=Code style='margin-left:0in'>    System.out.println(result);</p>

<p class=Code style='margin-left:0in'>    assertEquals(result, &quot;47&quot;);</p>

<p class=Code style='margin-left:0in'>    Singleton s2 =
Singleton.getReference();</p>

<p class=Code style='margin-left:0in'>    s2.setValue(9);</p>

<p class=Code style='margin-left:0in'>    result = &quot;&quot; + s.getValue();</p>

<p class=Code style='margin-left:0in'>    System.out.println(result);</p>

<p class=Code style='margin-left:0in'>    assertEquals(result, &quot;9&quot;);</p>

<p class=Code style='margin-left:0in'>    try {</p>

<p class=Code style='margin-left:0in'>      // Can't do this: compile-time
error.</p>

<p class=Code style='margin-left:0in'>      // Singleton s3 =
(Singleton)s2.clone();</p>

<p class=Code style='margin-left:0in'>    } catch(Exception e) {</p>

<p class=Code style='margin-left:0in'>      throw new RuntimeException(e);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String[] args)
{</p>

<p class=Code style='margin-left:0in'>   
junit.textui.TestRunner.run(SingletonPattern.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span style='display:none'>#[BT_22]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_23]#</span>The key to
creating a singleton is to prevent the client programmer from having any way to
create an object except the ways you provide. You must make all constructors <b>private</b>, and you must<b> </b>create at least one constructor to
prevent the compiler from synthesizing a default constructor for you (which it will create using package access).</p>

<p class=MsoNormal><span style='display:none'>#[BT_24]#</span>At this point,
you decide how you’re going to create your object. Here, it’s created
statically, but you can also wait until the client programmer asks for one and
create it on demand. In any case, the object should be stored privately. You
provide access through <b>public</b> methods. Here, <b>getReference(&nbsp;)</b>
produces the reference to the <b>Singleton</b> object. The rest of the
interface (<b>getValue(&nbsp;)</b> and <b>setValue(&nbsp;)</b>) is the regular
class interface.</p>

<p class=MsoNormal><span style='display:none'>#[BT_25]#</span>Java also allows
the creation of objects through cloning. In this example, making the class <b>final</b>
prevents cloning. Since <b>Singleton</b> is inherited directly from <b>Object</b>,
the <b>clone(&nbsp;)</b> method remains <b>protected</b> so it cannot be used
(doing so produces a compile-time error). However, if you’re inheriting from a
class hierarchy that has already overridden <b>clone(&nbsp;)</b> as <b>public</b>
and implemented <b>Cloneable</b>, the way to prevent cloning is to override <b>clone(&nbsp;)</b>
and throw a <b>CloneNotSupportedException</b> as described in Appendix A of <i>Thinking
in Java, 2<sup>nd</sup> edition</i>. (You could also override <b>clone(&nbsp;)</b>
and simply return <b>this</b>, but that would be deceiving since the client
programmer would think they were cloning the object, but would instead still be
dealing with the original.) Actually, this isn’t precisely true, because even
in the above situation someone could still use reflection to invoke <b>clone( )</b>
[[is this true? <b>clone( )</b> is still protected so I’m not so sure. If it is
true, you’d have to throw <b>CloneNotSupportedException</b> as the only way to
guarantee un-cloneability ]]</p>

<h3><a name="_Toc41169696">Exercises</a></h3>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>1. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><b>SingletonPattern.java</b> always creates an object, even if
it’s never used. Modify this program to use <i>lazy initialization</i>, so the
singleton object is only created the first time that it is needed.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>2. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Create a registry/lookup service that accepts a Java interface
and produces a reference to an object that implements that interface.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169697">Object pool</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_26]#</span>Note that you
aren’t restricted to creating only one object. This is also a technique to
create a limited pool of objects. In that situation, however, you can be
confronted with the problem of sharing objects in the pool. If this is an issue,
you can create a solution involving a check-out and check-in of the shared
objects.<span style='display:none'>AsAAAAA</span></p>

<p class=MsoNormal>As an example, consider a database. Commercial databases
often restrict the number of connections that you can use at any one time. Here
is an implementation that uses an object pool to manage the connections. First,
the basic concept of managing a pool of objects is implemented as a separate
class:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: singleton:PoolManager.java</p>

<p class=Code style='margin-left:0in'>package singleton;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class PoolManager {</p>

<p class=Code style='margin-left:0in'>  private static class PoolItem {</p>

<p class=Code style='margin-left:0in'>    boolean inUse = false;</p>

<p class=Code style='margin-left:0in'>    Object item;</p>

<p class=Code style='margin-left:0in'>    PoolItem(Object item) { this.item =
item; }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  private ArrayList items = new
ArrayList();</p>

<p class=Code style='margin-left:0in'>  public void add(Object item) {</p>

<p class=Code style='margin-left:0in'>    items.add(new PoolItem(item));</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  static class EmptyPoolException extends
Exception {}</p>

<p class=Code style='margin-left:0in'>  public Object get() throws
EmptyPoolException {</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; items.size();
i++) {</p>

<p class=Code style='margin-left:0in'>      PoolItem pitem =
(PoolItem)items.get(i);</p>

<p class=Code style='margin-left:0in'>      if(pitem.inUse == false) {</p>

<p class=Code style='margin-left:0in'>        pitem.inUse = true;</p>

<p class=Code style='margin-left:0in'>        return pitem.item;</p>

<p class=Code style='margin-left:0in'>      }</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    // Fail early:</p>

<p class=Code style='margin-left:0in'>    throw new EmptyPoolException();</p>

<p class=Code style='margin-left:0in'>    // return null; // Delayed failure</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void release(Object item) {</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; items.size();
i++) {</p>

<p class=Code style='margin-left:0in'>      PoolItem pitem =
(PoolItem)items.get(i);</p>

<p class=Code style='margin-left:0in'>      if(item == pitem.item) {</p>

<p class=Code style='margin-left:0in'>        pitem.inUse = false;</p>

<p class=Code style='margin-left:0in'>        return;</p>

<p class=Code style='margin-left:0in'>      }</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    throw new RuntimeException(item +
&quot; not found&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=CodeInline style='margin-left:0in'>} ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: singleton:ConnectionPoolDemo.java</p>

<p class=Code style='margin-left:0in'>package singleton;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>interface Connection {</p>

<p class=Code style='margin-left:0in'>  Object get();</p>

<p class=Code style='margin-left:0in'>  void set(Object x);</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class ConnectionImplementation implements
Connection {</p>

<p class=Code style='margin-left:0in'>  public Object get() { return null; }</p>

<p class=Code style='margin-left:0in'>  public void set(Object s) {}</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class ConnectionPool { // A singleton</p>

<p class=Code style='margin-left:0in'>  private static PoolManager pool = new
PoolManager();</p>

<p class=Code style='margin-left:0in'>  public static void addConnections(int
number) {</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; number; i++)</p>

<p class=Code style='margin-left:0in'>      pool.add(new
ConnectionImplementation());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static Connection
getConnection() </p>

<p class=Code style='margin-left:0in'>  throws PoolManager.EmptyPoolException {</p>

<p class=Code style='margin-left:0in'>    return (Connection)pool.get();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void releaseConnection(Connection
c) {</p>

<p class=Code style='margin-left:0in'>    pool.release(c);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class ConnectionPoolDemo extends
TestCase  {</p>

<p class=Code style='margin-left:0in'>  static {</p>

<p class=Code style='margin-left:0in'>    ConnectionPool.addConnections(5);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    Connection c = null;</p>

<p class=Code style='margin-left:0in'>    try {</p>

<p class=Code style='margin-left:0in'>      c = ConnectionPool.getConnection();</p>

<p class=Code style='margin-left:0in'>    } catch
(PoolManager.EmptyPoolException e) {</p>

<p class=Code style='margin-left:0in'>      throw new RuntimeException(e);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    c.set(new Object());</p>

<p class=Code style='margin-left:0in'>    c.get();</p>

<p class=Code style='margin-left:0in'>    ConnectionPool.releaseConnection(c);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void test2() {</p>

<p class=Code style='margin-left:0in'>    Connection c = null;</p>

<p class=Code style='margin-left:0in'>    try {</p>

<p class=Code style='margin-left:0in'>      c = ConnectionPool.getConnection();</p>

<p class=Code style='margin-left:0in'>    } catch
(PoolManager.EmptyPoolException e) {</p>

<p class=Code style='margin-left:0in'>      throw new RuntimeException(e);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    c.set(new Object());</p>

<p class=Code style='margin-left:0in'>    c.get();</p>

<p class=Code style='margin-left:0in'>    ConnectionPool.releaseConnection(c);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(ConnectionPoolDemo.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=CodeInline style='margin-left:0in'>} ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<h3><a name="_Toc41169698">Exercises</a></h3>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>1. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Add unit tests to ConnectionPoolDemo.java to demonstrate the
problem that the client may release the connection but still continue to use
it.</p>

<p class=MsoNormal><span style='display:none'>#[BT_35]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_36]#</span></p>

</div>

<span style='font-size:11.0pt;font-family:Georgia;display:none'><br clear=all
style='page-break-before:right'>
</span>

<div class=Section8>

<h1 style='margin-left:.75in'><a name="_Toc41169699">Object decoupling</a></h1>

<p class=MsoNormal><span style='display:none'>#[BT_92]#</span>Both <i>Proxy</i>
and <i>State</i> provide a surrogate class that you use in your code; the real
class that does the work is hidden behind this surrogate class. When you call a
method in the surrogate, it simply turns around and calls the method in the
implementing class. These two patterns are so similar that the <i>Proxy</i> is
simply a special case of <i>State</i>. One is tempted to just lump the two
together into a pattern called <i>Surrogate</i>, but the term “proxy” has a
long-standing and specialized meaning, which probably explains the reason for
the two different patterns.</p>

<p class=MsoNormal><span style='display:none'>#[BT_93]#</span>The basic idea is
simple: from a base class, the surrogate is derived along with the class or
classes that provide the actual implementation: </p>

<p class=MsoNormal align=center style='text-align:center'><span
style='display:none'>#[BT_94]#</span><img border=0 width=448 height=184
src="TIPatterns_files/image001.gif"></p>

<p class=MsoNormal><span style='display:none'>#[BT_95]#</span>When a surrogate
object is created, it is given an implementation to which to send all of the
method calls.</p>

<p class=MsoNormal><span style='display:none'>#[BT_96]#</span>Structurally, the
difference between <i>Proxy</i> and <i>State</i> is simple: a <i>Proxy</i> has
only one implementation, while <i>State</i> has more than one. The application
of the patterns is considered (in <i>Design Patterns</i>) to be distinct: <i>Proxy</i>
is used to control access to its implementation, while <i>State</i> allows you
to change the implementation dynamically. However, if you expand your notion of
“controlling access to implementation” then the two fit neatly together.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169700"></a><a
name="_Toc476705899">Proxy</a>: fronting for another object</h2>

<p class=MsoNormal><span style='display:none'>#[BT_97]#</span>If we implement <i>Proxy</i>
by following the above diagram, it looks like this:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: proxy:ProxyDemo.java</p>

<p class=Code style='margin-left:0in'>// Simple demonstration of the Proxy
pattern.</p>

<p class=Code style='margin-left:0in'>package proxy;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>interface ProxyBase {</p>

<p class=Code style='margin-left:0in'>  void f();</p>

<p class=Code style='margin-left:0in'>  void g();</p>

<p class=Code style='margin-left:0in'>  void h();</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Proxy implements ProxyBase {</p>

<p class=Code style='margin-left:0in'>  private ProxyBase implementation;</p>

<p class=Code style='margin-left:0in'>  public Proxy() { </p>

<p class=Code style='margin-left:0in'>    implementation = new
Implementation(); </p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  // Pass method calls to the
implementation:</p>

<p class=Code style='margin-left:0in'>  public void f() { implementation.f(); }</p>

<p class=Code style='margin-left:0in'>  public void g() { implementation.g(); }</p>

<p class=Code style='margin-left:0in'>  public void h() { implementation.h(); }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Implementation implements ProxyBase
{</p>

<p class=Code style='margin-left:0in'>  public void f() { </p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Implementation.f()&quot;); </p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void g() { </p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Implementation.g()&quot;);
</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void h() { </p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Implementation.h()&quot;); </p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class ProxyDemo extends TestCase  {</p>

<p class=Code style='margin-left:0in'>  Proxy p = new Proxy();</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    // This just makes sure it will
complete </p>

<p class=Code style='margin-left:0in'>    // without throwing an exception.</p>

<p class=Code style='margin-left:0in'>    p.f();</p>

<p class=Code style='margin-left:0in'>    p.g();</p>

<p class=Code style='margin-left:0in'>    p.h();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(ProxyDemo.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_98]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_99]#</span>Of course, it
isn’t necessary that <b>Implementation</b> have the same interface as <b>Proxy</b>;
as long as <b>Proxy</b> is somehow “speaking for” the class that it is
referring method calls to then the basic idea is satisfied (note that this
statement is at odds with the definition for Proxy in GoF). However, it is
convenient to have a common interface so that <b>Implementation</b> is forced
to fulfill all the methods that <b>Proxy</b> needs to call.</p>

<h3><a name="_Toc41169701">The PoolManager using Proxy</a></h3>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: proxy:PoolManager.java</p>

<p class=Code style='margin-left:0in'>package proxy;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class PoolManager {</p>

<p class=Code style='margin-left:0in'>  private static class PoolItem {</p>

<p class=Code style='margin-left:0in'>    boolean inUse = false;</p>

<p class=Code style='margin-left:0in'>    Object item;</p>

<p class=Code style='margin-left:0in'>    PoolItem(Object item) { this.item =
item; }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public class ReleasableReference {  //
Used to build the proxy</p>

<p class=Code style='margin-left:0in'>    private PoolItem reference;</p>

<p class=Code style='margin-left:0in'>    private boolean released = false;</p>

<p class=Code style='margin-left:0in'>    public ReleasableReference(PoolItem
reference) {</p>

<p class=Code style='margin-left:0in'>      this.reference = reference;</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    public Object getReference() {</p>

<p class=Code style='margin-left:0in'>      if(released) </p>

<p class=Code style='margin-left:0in'>        throw new RuntimeException(</p>

<p class=Code style='margin-left:0in'>          &quot;Tried to use reference
after it was released&quot;);</p>

<p class=Code style='margin-left:0in'>      return reference.item;</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    public void release() { </p>

<p class=Code style='margin-left:0in'>      released = true;</p>

<p class=Code style='margin-left:0in'>      reference.inUse = false;</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  private ArrayList items = new
ArrayList();</p>

<p class=Code style='margin-left:0in'>  public void add(Object item) {</p>

<p class=Code style='margin-left:0in'>    items.add(new PoolItem(item));</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  // Different (better?) approach to
running out of items:</p>

<p class=Code style='margin-left:0in'>  public static class EmptyPoolItem {}</p>

<p class=Code style='margin-left:0in'>  public ReleasableReference get() {</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; items.size();
i++) {</p>

<p class=Code style='margin-left:0in'>      PoolItem pitem =
(PoolItem)items.get(i);</p>

<p class=Code style='margin-left:0in'>      if(pitem.inUse == false) {</p>

<p class=Code style='margin-left:0in'>        pitem.inUse = true;</p>

<p class=Code style='margin-left:0in'>        return new ReleasableReference(pitem);</p>

<p class=Code style='margin-left:0in'>      }</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    // Fail as soon as you try to cast
it:</p>

<p class=Code style='margin-left:0in'>    // return new EmptyPoolItem();</p>

<p class=Code style='margin-left:0in'>    return null; // temporary</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=CodeInline style='margin-left:0in'>} ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: proxy:ConnectionPoolProxyDemo.java</p>

<p class=Code style='margin-left:0in'>package proxy;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>interface Connection {</p>

<p class=Code style='margin-left:0in'>  Object get();</p>

<p class=Code style='margin-left:0in'>  void set(Object x);</p>

<p class=Code style='margin-left:0in'>  void release();</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class ConnectionImplementation implements
Connection {</p>

<p class=Code style='margin-left:0in'>  public Object get() { return null; }</p>

<p class=Code style='margin-left:0in'>  public void set(Object s) {}</p>

<p class=Code style='margin-left:0in'>  public void release() {} // Never
called directly</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class ConnectionPool { // A singleton</p>

<p class=Code style='margin-left:0in'>  private static PoolManager pool = new
PoolManager();</p>

<p class=Code style='margin-left:0in'>  private ConnectionPool() {} // Prevent
synthesized constructor</p>

<p class=Code style='margin-left:0in'>  public static void addConnections(int
number) {</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; number; i++)</p>

<p class=Code style='margin-left:0in'>      pool.add(new ConnectionImplementation());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static Connection
getConnection() {</p>

<p class=Code style='margin-left:0in'>    PoolManager.ReleasableReference rr = </p>

<p class=Code style='margin-left:0in'>     
(PoolManager.ReleasableReference)pool.get();</p>

<p class=Code style='margin-left:0in'>    if(rr == null) return null;</p>

<p class=Code style='margin-left:0in'>    return new ConnectionProxy(rr);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  // The proxy as a nested class:</p>

<p class=Code style='margin-left:0in'>  private static </p>

<p class=Code style='margin-left:0in'>  class ConnectionProxy implements
Connection {</p>

<p class=Code style='margin-left:0in'>    private
PoolManager.ReleasableReference implementation;</p>

<p class=Code style='margin-left:0in'>    public </p>

<p class=Code style='margin-left:0in'>   
ConnectionProxy(PoolManager.ReleasableReference rr) {</p>

<p class=Code style='margin-left:0in'>      implementation = rr;</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    public Object get() {</p>

<p class=Code style='margin-left:0in'>      return </p>

<p class=Code style='margin-left:0in'>       
((Connection)implementation.getReference()).get(); </p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    public void set(Object x) {</p>

<p class=Code style='margin-left:0in'>     
((Connection)implementation.getReference()).set(x); </p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    public void release() {
implementation.release(); }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class ConnectionPoolProxyDemo
extends TestCase {</p>

<p class=Code style='margin-left:0in'>  static {</p>

<p class=Code style='margin-left:0in'>    ConnectionPool.addConnections(5);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    Connection c =
ConnectionPool.getConnection();</p>

<p class=Code style='margin-left:0in'>    c.set(new Object());</p>

<p class=Code style='margin-left:0in'>    c.get();</p>

<p class=Code style='margin-left:0in'>    c.release();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void testDisable() {</p>

<p class=Code style='margin-left:0in'>    Connection c =
ConnectionPool.getConnection();</p>

<p class=Code style='margin-left:0in'>    String s = null;</p>

<p class=Code style='margin-left:0in'>    c.set(new Object());</p>

<p class=Code style='margin-left:0in'>    c.get();</p>

<p class=Code style='margin-left:0in'>    c.release();</p>

<p class=Code style='margin-left:0in'>    try {</p>

<p class=Code style='margin-left:0in'>      c.get();</p>

<p class=Code style='margin-left:0in'>    } catch(Exception e) {</p>

<p class=Code style='margin-left:0in'>      s = e.getMessage();</p>

<p class=Code style='margin-left:0in'>      System.out.println(s);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    assertEquals(s, </p>

<p class=Code style='margin-left:0in'>      &quot;Tried to use reference after
it was released&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(</p>

<p class=Code style='margin-left:0in'>      ConnectionPoolProxyDemo.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=CodeInline style='margin-left:0in'>} ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<h3><a name="_Toc41169702">Dynamic Proxies</a></h3>

<p class=MsoNormal>In JDK 1.3, the <i>Dynamic Proxy</i> was introduced.
Although a little complex at first, this is an intruiging tool. </p>

<p class=MsoNormal>Here's an interesting little starting example, which works
and proves that yes, indeed, the invocation handler is being called so the
proxying etc. is actually working. So it's pretty cool, and it's in my head
now, but I still have to figure out something reasonable to do with the
invocation handler to come up with a useful example...</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>// proxy:DynamicProxyDemo.java</p>

<p class=Code style='margin-left:0in'>// Broken in JDK 1.4.1_01</p>

<p class=Code style='margin-left:0in'>package proxy;</p>

<p class=Code style='margin-left:0in'>import java.lang.reflect.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>interface Foo {</p>

<p class=Code style='margin-left:0in'>  void f(String s);</p>

<p class=Code style='margin-left:0in'>  void g(int i);</p>

<p class=Code style='margin-left:0in'>  String h(int i, String s);</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class DynamicProxyDemo {</p>

<p class=Code style='margin-left:0in'>  public static void main(String[]
clargs) {</p>

<p class=Code style='margin-left:0in'>    Foo prox =
(Foo)Proxy.newProxyInstance(</p>

<p class=Code style='margin-left:0in'>       Foo.class.getClassLoader(), </p>

<p class=Code style='margin-left:0in'>       new Class[]{ Foo.class },</p>

<p class=Code style='margin-left:0in'>       new InvocationHandler() {</p>

<p class=Code style='margin-left:0in'>        public Object invoke(</p>

<p class=Code style='margin-left:0in'>          Object proxy, Method method,</p>

<p class=Code style='margin-left:0in'>          Object[] args) {</p>

<p class=Code style='margin-left:0in'>            System.out.println(</p>

<p class=Code style='margin-left:0in'>              &quot;InvocationHandler
called:&quot; +</p>

<p class=Code style='margin-left:0in'>              &quot;\n\tMethod = &quot; +
method);</p>

<p class=Code style='margin-left:0in'>            if (args != null) {</p>

<p class=Code style='margin-left:0in'>             
System.out.println(&quot;\targs = &quot;);</p>

<p class=Code style='margin-left:0in'>              for (int i = 0; i &lt;
args.length; i++)</p>

<p class=Code style='margin-left:0in'>               
System.out.println(&quot;\t\t&quot; + args[i]);</p>

<p class=Code style='margin-left:0in'>            }</p>

<p class=Code style='margin-left:0in'>          return null;</p>

<p class=Code style='margin-left:0in'>        }</p>

<p class=Code style='margin-left:0in'>      });</p>

<p class=Code style='margin-left:0in'>    prox.f(&quot;hello&quot;);</p>

<p class=Code style='margin-left:0in'>    prox.g(47);</p>

<p class=Code style='margin-left:0in'>    prox.h(47, &quot;hello&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><b>Exercise:</b> Use the Java dynamic proxy to create an
object that acts as a front end for a simple configuration file. For example,
in <b>good_stuff.txt </b>you can have entries like this:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>a=1</p>

<p class=Code style='margin-left:0in'>b=2</p>

<p class=Code style='margin-left:0in'>c=&quot;Hello World&quot;</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>A client programmer of this <b>NeatPropertyBundle</b> could
then write:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>NeatPropertyBundle p = </p>

<p class=Code style='margin-left:0in'>  new
NeatPropertyBundle(&quot;good_stuff&quot;);</p>

<p class=Code style='margin-left:0in'><span lang=SV>System.out.println(p.a);</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>System.out.println(p.b);</span></p>

<p class=Code style='margin-left:0in'>System.out.println(p.c);</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>The contents of the configuration file can contain anything,
with any variable names. The dynamic proxy will either map to the name or tell
you it doesn’t exist somehow (probably by returning <b>null</b>). If you set a
property and it doesn’t already exist, the dynamic proxy will create the new
entry. The <b>toString( )</b> method should display all the current entries.</p>

<p class=MsoNormal><b>Exercise:</b> similar to the previous exercise, use the
Java dynamic proxy to make a connection to the DOS Autoexec.bat file.</p>

<p class=MsoNormal><b>Exercise:</b> Accept an SQL query which returns data,
then read the DB metadata.  Now, for each record, provide an object which has
attributes corresponding to the column names and of appropriate data types.  </p>

<p class=MsoNormal><b>Exercise:</b> Create a simple server and client that uses
XML-RPC. Each object the client returns should use the dynamic proxy concept to
exercise the remote methods.</p>

<p class=MsoNormal style='margin-left:.5in'><b><i>Andrea writes:</i></b></p>

<p class=MsoNormal style='margin-left:.5in'>I'm not sure about the exercises
you suggest, except for the last one. The thing is that I like to think at
invocation handler as somthing providing features that are orthogonal to the
ones provided by the object being &quot;proxied&quot;.</p>

<p class=MsoNormal style='margin-left:.5in'>In other words: the implementation
of the invocation handler is completely independent from the interface(s) of
the object that the dynamically-generated proxy represent. Which means that
once you have implemented an invocation handler, you can use for any class that
exposes interfaces, even for classes and interfaces that were not present when
the handler was implemented.</p>

<p class=MsoNormal style='margin-left:.5in'>That's why I say the the handler
provides services that are orthogonal to the ones provided by the proxied
object. Rickard has a few handlers in his SmartWorld example, and they one I
like the best is a call-retry handler. It basically makes a call into the
actual object, and if the call generates an exception if waits for a while,
then makes the same call again for a total of three times. If all three calls
fails, it returns an exception. And you can use such a handler on _any_ class.</p>

<p class=MsoNormal style='margin-left:.5in'>The implementation is way too
complex for what you are trying to demonstrate. I'm using this example just to
explain what I mean by orthogonal services.</p>

<p class=MsoNormal style='margin-left:.5in'>In your list of exercises, the only
one that, in my opinion, makes sense to implement using dynamic proxies is the
last one, the one using XML-RPC to communicate with an object. And that's
because the mechanism you use to dispatch the message (XML-RPC) is orthogonal
to the services provided by the object you want to reach.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169703"></a><a
name="_Toc476705900">State</a>: changing object behavior</h2>

<p class=Intro>An object that appears to change its class.</p>

<p class=MsoNormal>Indications: conditional code in most or all methods.</p>

<p class=MsoNormal><span style='display:none'>#[BT_100]#</span>The <i>State</i>
pattern switches from one implementation to another during the lifetime of the
surrogate, in order to produce different behavior from the same method call(s).
It’s a way to improve the implementation of your code when you seem to be doing
a lot of testing inside each of your methods before deciding what to do for
that method. For example, the fairy tale of the frog-prince contains an object
(the creature) that behaves differently depending on what state it’s in. You
could implement this using a boolean that you test:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: state:KissingPrincess.java</p>

<p class=Code style='margin-left:0in'>package state;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Creature {</p>

<p class=Code style='margin-left:0in'>  private boolean isFrog = true;</p>

<p class=Code style='margin-left:0in'>  public void greet() {</p>

<p class=Code style='margin-left:0in'>    <span lang=SV>if(isFrog)</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>     
System.out.println(&quot;Ribbet!&quot;);</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>    else</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>     
System.out.println(&quot;Darling!&quot;);</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>  }</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>  public void kiss() {
isFrog = false; }</span></p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class KissingPrincess extends
TestCase  {</p>

<p class=Code style='margin-left:0in'>  Creature creature = new Creature();</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    creature.greet();</p>

<p class=Code style='margin-left:0in'>    creature.kiss();</p>

<p class=Code style='margin-left:0in'>    creature.greet();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>   
junit.textui.TestRunner.run(KissingPrincess.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=CodeInline style='margin-left:0in'>} ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<p class=MsoNormal>However, the <b>greet()</b> method, and any other methods
that must test <b>isFrog</b> before they perform their operations, ends up with
awkward code. By delegating the operations to a State object that can be
changed, this code is simplified. </p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: state:KissingPrincess2.java</p>

<p class=Code style='margin-left:0in'>package state;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Creature {</p>

<p class=Code style='margin-left:0in'>  private interface State {</p>

<p class=Code style='margin-left:0in'>    String response();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  private class Frog implements State {</p>

<p class=Code style='margin-left:0in'>    public String response() { return
&quot;Ribbet!&quot;; }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  private class Prince implements State {</p>

<p class=Code style='margin-left:0in'>    public String response() { return
&quot;Darling!&quot;; }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  private State state = new Frog();</p>

<p class=Code style='margin-left:0in'>  public void greet() { </p>

<p class=Code style='margin-left:0in'>    System.out.println(state.response());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void kiss() { state = new
Prince(); }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class KissingPrincess2 extends
TestCase  {</p>

<p class=Code style='margin-left:0in'>  Creature creature = new Creature();</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    creature.greet();</p>

<p class=Code style='margin-left:0in'>    creature.kiss();</p>

<p class=Code style='margin-left:0in'>    creature.greet();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>   
junit.textui.TestRunner.run(KissingPrincess2.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=CodeInline style='margin-left:0in'>} ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<p class=MsoNormal>In addition, changes to the State are automatically
propagated throughout, rather than requiring an edit across the class methods
in order to effect changes.</p>

<p class=MsoNormal>Here’s the basic structure of State:<span style='display:
none'>[[ [[</span></p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: state:StateDemo.java</p>

<p class=Code style='margin-left:0in'>// Simple demonstration of the State
pattern.</p>

<p class=Code style='margin-left:0in'>package state;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>interface State {</p>

<p class=Code style='margin-left:0in'>  void operation1();</p>

<p class=Code style='margin-left:0in'>  void operation2();</p>

<p class=Code style='margin-left:0in'>  void operation3();</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class ServiceProvider {</p>

<p class=Code style='margin-left:0in'>  private State state;</p>

<p class=Code style='margin-left:0in'>  public ServiceProvider(State state) {</p>

<p class=Code style='margin-left:0in'>    this.state = state;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void changeState(State newState)
{</p>

<p class=Code style='margin-left:0in'>    state = newState;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  // Pass method calls to the
implementation:</p>

<p class=Code style='margin-left:0in'>  public void service1() {</p>

<p class=Code style='margin-left:0in'>    // ...</p>

<p class=Code style='margin-left:0in'>    state.operation1();</p>

<p class=Code style='margin-left:0in'>    // ...</p>

<p class=Code style='margin-left:0in'>    state.operation3();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void service2() {</p>

<p class=Code style='margin-left:0in'>    // ...</p>

<p class=Code style='margin-left:0in'>    state.operation1();</p>

<p class=Code style='margin-left:0in'>    // ...</p>

<p class=Code style='margin-left:0in'>    state.operation2();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void service3() {</p>

<p class=Code style='margin-left:0in'>    // ...</p>

<p class=Code style='margin-left:0in'>    state.operation3();</p>

<p class=Code style='margin-left:0in'>    // ...</p>

<p class=Code style='margin-left:0in'>    state.operation2();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Implementation1 implements State {</p>

<p class=Code style='margin-left:0in'>  public void operation1() {</p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Implementation1.operation1()&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void operation2() {</p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Implementation1.operation2()&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void operation3() {</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Implementation1.operation3()&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Implementation2 implements State {</p>

<p class=Code style='margin-left:0in'>  public void operation1() {</p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Implementation2.operation1()&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void operation2() {</p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Implementation2.operation2()&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void operation3() {</p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Implementation2.operation3()&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class StateDemo extends TestCase 
{</p>

<p class=Code style='margin-left:0in'>  static void run(ServiceProvider sp) {</p>

<p class=Code style='margin-left:0in'>    sp.service1();</p>

<p class=Code style='margin-left:0in'>    sp.service2();</p>

<p class=Code style='margin-left:0in'>    sp.service3();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  ServiceProvider sp = </p>

<p class=Code style='margin-left:0in'>    new ServiceProvider(new
Implementation1());</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    run(sp);</p>

<p class=Code style='margin-left:0in'>    sp.changeState(new
Implementation2());</p>

<p class=Code style='margin-left:0in'>    run(sp);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>   
junit.textui.TestRunner.run(StateDemo.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=CodeInline style='margin-left:0in'>} ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span style='display:none'>#[BT_101]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_102]#</span>In <b>main(&nbsp;)</b>,
you can see that the first implementation is used for a bit, then the second
implementation is swapped in and that is used.</p>

<p class=MsoNormal>There are a number of details that are choices that you must
make according to the needs of your own implementation, such as whether the
fact that you are using State is exposed to the client, and how the changes to
State are made. Sometimes (as in the Swing LayoutManager) the client may pass
in the object directly, but in KissingPrincess2.java the fact that State is
used is invisible to the client. In addition, the mechanism for changing state
may be simple or complex – in State Machine, described later in this book,
larger sets of states and different mechanisms for changing are explored.</p>

<p class=MsoNormal>The Swing LayoutManager example mentioned above is an
interesting example because it show behavior of both Strategy and State.</p>

<p class=MsoNormal><span style='display:none'>#[BT_103]#</span>The difference
between <i>Proxy</i> and <i>State</i> is in the problems that are solved. The
common uses for <i>Proxy</i> as described in <i>Design Patterns</i> are:</p>

<p class=Numbered><span style='font-family:Verdana'>1.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><b>Remote proxy</b>. This proxies for an object in a different
address space. A remote proxy is created for you automatically by the RMI
compiler <b>rmic</b> as it creates stubs and skeletons.</p>

<p class=Numbered><span style='font-family:Verdana'>2.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><b>Virtual proxy</b>. This provides “lazy initialization” to
create expensive objects on demand.</p>

<p class=Numbered><span style='font-family:Verdana'>3.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><b>Protection proxy</b>. Used when you don’t want the client
programmer to have full access to the proxied object.</p>

<p class=Numbered><span style='font-family:Verdana'>4.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><b>Smart reference</b>. To add additional actions when the
proxied object is accessed. For example, or to keep track of the number of
references that are held for a particular object, in order to implement the <i>copy-on-write</i>
idiom and prevent object aliasing. A simpler example is keeping track of the
number of calls to a particular method.</p>

<p class=MsoNormal><span style='display:none'>#[BT_104]#</span>You could look
at a Java reference as a kind of protection proxy, since it controls access to
the actual object on the heap (and ensures, for example, that you don’t use a <b>null
</b>reference).</p>

<p class=MsoNormal><span style='display:none'>#[BT_105]#</span>[[ Rewrite this:
In <i>Design Patterns</i>, <i>Proxy</i> and <i>State</i> are not seen as
related to each other because the two are given (what I consider arbitrarily)
different structures. <i>State</i>, in particular, uses a separate
implementation hierarchy but this seems to me to be unnecessary unless you have
decided that the implementation is not under your control (certainly a
possibility, but if you own all the code there seems to be no reason not to
benefit from the elegance and helpfulness of the single base class). In
addition, <i>Proxy</i> need not use the same base class for its implementation,
as long as the proxy object is controlling access to the object it “fronting”
for. Regardless of the specifics, in both <i>Proxy </i>and <i>State</i> a
surrogate is passing method calls through to an implementation object.]]]</p>

<p class=MsoNormal>State can be found everywhere because it’s such a
fundamental idea. For example, in Builder, the “Director” uses a backend
Builder object to produce different behaviors.<span style='display:none'>Stat</span></p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169704">Iterators: decoupling
algorithms from containers</a></h2>

<p class=Intro>Alexander Stepanov thought for years about the problem of
generic programming techniques before creating the STL (along with Dave
Musser). He came to the conclusion that all algorithms are defined on algebraic
structures – what we would call containers.</p>

<p class=MsoNormal><span style='display:none'>#[BT_193]#</span>In the process,
he realized that iterators are central to the use of algorithms, because they decouple
the algorithms from the specific type of container that the algorithm might
currently be working with. This means that you can describe the algorithm
without worrying about the particular sequence it is operating on. More
generally, <i>any</i> code that you write using iterators is decoupled from the
data structure that the code is manipulating, and thus your code is more
general and reusable.</p>

<p class=MsoNormal><span style='display:none'>#[BT_194]#</span>The use of
iterators also extends your code into the realm of <i>functional programming</i>,
whose objective is to describe <i>what</i> a program is doing at every step
rather than <i>how</i> it is doing it. That is, you say “sort” rather than
describing the sort. The objective of the C++ STL was to provide this <i>generic
programming</i> approach for C++ (how successful this approach will actually be
remains to be seen).</p>

<p class=MsoNormal><span style='display:none'>#[BT_195]#</span>If you’ve used
containers in Java (and it’s hard to write code without using them), you’ve
used iterators – in the form of the <b>Enumeration</b> in Java 1.0/1.1 and the <b>Iterator</b>
in Java 2. So you should already be familiar with their general use. If not,
see Chapter 9, <i>Holding Your Objects</i>, under <i>Iterators</i> in <i>Thinking
in Java, 2<sup>nd</sup> edition</i> (freely downloadable from <i>www.BruceEckel.com</i>).</p>

<p class=MsoNormal><span style='display:none'>#[BT_196]#</span>Because the Java
2 containers rely heavily on iterators they become excellent candidates for
generic/functional programming techniques. This chapter will explore these
techniques by converting the STL algorithms to Java, for use with the Java 2
container library.</p>

<h3><a name="_Toc41169705">Type-safe iterators</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_197]#</span>In <i>Thinking
in Java, 2<sup>nd</sup> edition</i>, I show the creation of a type-safe
container that will only accept a particular type of object. A reader, Linda
Pazzaglia, asked for the other obvious type-safe component, an iterator that
would work with the basic <b>java.util</b> containers, but impose the constraint
that the type of objects that it iterates over be of a particular type.</p>

<p class=MsoNormal><span style='display:none'>#[BT_198]#</span>If Java ever
includes a template mechanism, this kind of iterator will have the added
advantage of being able to return a specific type of object, but without
templates you are forced to return generic <b>Object</b>s, or to require a bit
of hand-coding for every type that you want to iterate through. I will take the
former approach.</p>

<p class=MsoNormal><span style='display:none'>#[BT_199]#</span>A second design
decision involves the time that the type of object is determined. One approach
is to take the type of the first object that the iterator encounters, but this
is problematic because the containers may rearrange the objects according to an
internal ordering mechanism (such as a hash table) and thus you may get
different results from one iteration to the next. The safe approach is to
require the user to establish the type during construction of the iterator.</p>

<p class=MsoNormal><span style='display:none'>#[BT_200]#</span>Lastly, how do
we build the iterator? We cannot rewrite the existing Java library classes that
already produce <b>Enumeration</b>s and <b>Iterator</b>s. However, we can use
the <i>Decorator</i> design pattern, and create a class that simply wraps the <b>Enumeration</b>
or <b>Iterator</b> that is produced, generating a new object that has the
iteration behavior that we want (which is, in this case, to throw a <b>RuntimeException</b>
if an incorrect type is encountered) but with the same interface as the
original <b>Enumeration</b> or <b>Iterator</b>, so that it can be used in the
same places (you may argue that this is actually a <i>Proxy</i> pattern, but
it’s more likely <i>Decorator</i> because of its intent). Here is the code:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//:
com:bruceeckel:util:TypedIterator.java</p>

<p class=Code style='margin-left:0in'>package com.bruceeckel.util;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class TypedIterator implements
Iterator {</p>

<p class=Code style='margin-left:0in'>  private Iterator imp;</p>

<p class=Code style='margin-left:0in'>  private Class type;</p>

<p class=Code style='margin-left:0in'>  public TypedIterator(Iterator it, Class
type) {</p>

<p class=Code style='margin-left:0in'>    imp = it;</p>

<p class=Code style='margin-left:0in'>    this.type = type;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public boolean hasNext() { </p>

<p class=Code style='margin-left:0in'>    return imp.hasNext(); </p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void remove() { imp.remove(); }</p>

<p class=Code style='margin-left:0in'>  public Object next() {</p>

<p class=Code style='margin-left:0in'>    Object obj = imp.next();</p>

<p class=Code style='margin-left:0in'>    if(!type.isInstance(obj))</p>

<p class=Code style='margin-left:0in'>      throw new ClassCastException(</p>

<p class=Code style='margin-left:0in'>        &quot;TypedIterator for type
&quot; + type +</p>

<p class=Code style='margin-left:0in'>        &quot; encountered type: &quot; +
obj.getClass());</p>

<p class=Code style='margin-left:0in'>    return obj;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169706">Exercises</a></h2>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>1. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Create an example of the “virtual proxy.”</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>2. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Create an example of the “Smart reference” proxy where you keep
count of the number of method calls to a particular object.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>3. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Create a program similar to certain DBMS systems that only allow
a certain number of connections at any time. To implement this, use a
singleton-like system that controls the number of “connection” objects that it
creates. When a user is finished with a connection, the system must be informed
so that it can check that connection back in to be reused. To guarantee this,
provide a proxy object instead of a reference to the actual connection, and
design the proxy so that it will cause the connection to be released back to
the system.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>4. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Using the <i>State</i> pattern,<i> </i>make a class called <b>UnpredictablePerson</b>
which changes the kind of response to its <b>hello(&nbsp;)</b> method depending
on what kind of <b>Mood</b> it’s in. Add an additional kind of <b>Mood</b>
called <b>Prozac</b>.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>5. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Create a simple copy-on write implementation.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>6. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>The <b>java.util.Map</b> has no way to automatically load a
two-dimensional array of objects into a <b>Map</b> as key-value pairs. Create
an adapter class that does this.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>7. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Create an <i>Adapter Factory</i> that dynamically finds and
produces the adapter that you need to connect a given object to a desired
interface.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>8. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Solve the above exercise using the <i>dynamic proxy</i> that’s
part of the Java standard library.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>9. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Modify the Object Pool solution so that the objects are returned
to the pool automatically after a certain amount of time.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>10. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Modify the above solution to use “leasing” so that the client can
renew the lease on the object to prevent it from being automatically released
by the timer.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>11. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Modify the Object Pool system to take threading issues into
account.</p>

<p class=MsoNormal>&nbsp;</p>

<h1 style='margin-left:.75in'><a name="_Toc375545413"></a><a
name="_Toc455024531"></a><a name="_Toc476705898"></a><a name="_Toc476705897"></a><a
name="_Toc41169707">Factoring commonality</a></h1>

<p class=Intro>Applying the “once and only once” principle produces the most
basic pattern of putting code that changes into a method.</p>

<p class=MsoNormal>This can be expressed two ways: </p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169708"></a><a
name="_Toc476705907"></a><a name="_Toc462393594">Strategy</a>: choosing the
algorithm at run-time</h2>

<p class=MsoNormal><i><span style='display:none'>#[BT_231]#</span>Strategy</i>
also adds a “Context” which can be a surrogate class that controls the
selection and use of the particular strategy object—just like <i>State</i>!
Here’s what it looks like:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: strategy:StrategyPattern.java</p>

<p class=Code style='margin-left:0in'>package strategy;</p>

<p class=Code style='margin-left:0in'>import com.bruceeckel.util.*; // Arrays2.toString()</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// The strategy interface:</p>

<p class=Code style='margin-left:0in'>interface FindMinima {</p>

<p class=Code style='margin-left:0in'>  // Line is a sequence of points:</p>

<p class=Code style='margin-left:0in'>  double[] algorithm(double[] line);</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// The various strategies:</p>

<p class=Code style='margin-left:0in'>class LeastSquares implements FindMinima
{</p>

<p class=Code style='margin-left:0in'>  public double[] algorithm(double[]
line) {</p>

<p class=Code style='margin-left:0in'>    return new double[] { 1.1, 2.2 }; //
Dummy</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class NewtonsMethod implements FindMinima
{</p>

<p class=Code style='margin-left:0in'>  public double[] algorithm(double[]
line) {</p>

<p class=Code style='margin-left:0in'>    return new double[] { 3.3, 4.4 }; //
Dummy</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Bisection implements FindMinima {</p>

<p class=Code style='margin-left:0in'>  public double[] algorithm(double[]
line) {</p>

<p class=Code style='margin-left:0in'>    return new double[] { 5.5, 6.6 }; //
Dummy</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class ConjugateGradient implements
FindMinima {</p>

<p class=Code style='margin-left:0in'>  public double[] algorithm(double[]
line) {</p>

<p class=Code style='margin-left:0in'>    return new double[] { 3.3, 4.4 }; //
Dummy</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// The &quot;Context&quot; controls the
strategy:</p>

<p class=Code style='margin-left:0in'>class MinimaSolver {</p>

<p class=Code style='margin-left:0in'>  private FindMinima strategy;</p>

<p class=Code style='margin-left:0in'>  public MinimaSolver(FindMinima strat) {</p>

<p class=Code style='margin-left:0in'>    strategy = strat;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  double[] minima(double[] line) {</p>

<p class=Code style='margin-left:0in'>    return strategy.algorithm(line);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  void changeAlgorithm(FindMinima
newAlgorithm) {</p>

<p class=Code style='margin-left:0in'>    strategy = newAlgorithm;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class StrategyPattern extends
TestCase  {</p>

<p class=Code style='margin-left:0in'>  MinimaSolver solver = </p>

<p class=Code style='margin-left:0in'>    new MinimaSolver(new LeastSquares());</p>

<p class=Code style='margin-left:0in'>  double[] line = { </p>

<p class=Code style='margin-left:0in'>    1.0, 2.0, 1.0, 2.0, -1.0, </p>

<p class=Code style='margin-left:0in'>    3.0, 4.0, 5.0, 4.0 };</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      Arrays2.toString(solver.minima(line)));</p>

<p class=Code style='margin-left:0in'>    solver.changeAlgorithm(new
Bisection());</p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      Arrays2.toString(solver.minima(line)));</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(StrategyPattern.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>Note similarity with template method – TM claims distinction
that it has more than one method to call, does things piecewise. However, it’s
not unlikely that strategy object would have more than one method call;
consider Shalloway’s order fulfullment system with country information in each
strategy.</p>

<p class=MsoNormal>Strategy example from JDK: comparator objects.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169709">Policy: generalized
strategy</a></h2>

<p class=MsoNormal>Although GoF says that Policy is just another name for
strategy, their use of Strategy implicitly assumes a single method in the
strategy object – that you’ve broken out your changing algorithm as a single
piece of code.</p>

<p class=MsoNormal>Others<a href="#_ftn6" name="_ftnref6" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><span style='font-size:11.0pt;font-family:Georgia;
vertical-align:baseline'>[6]</span></span></span></span></a> use Policy to mean
an object that has multiple methods that may vary independently from class to
class. This gives more flexibility than being restricted to a single method.</p>

<p class=MsoNormal>For example, a shipping policy for a product can be used to
describe shipping issues for sending a package to various different countries.
This may include the available methods of shipping, how to calculate postage or
shipping cost, customs requirements and fees, and special handling costs. All
these things may vary independently of each other, and more importantly you may
need the information from each at different points in the shipping process.</p>

<p class=MsoNormal>It also seems generally useful to distinguish Strategies
with single methods from Policies with multiple methods.</p>

<p class=MsoNormal><span style='display:none'>#[BT_232]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_233]#</span></p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169710">Template method</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_86]#</span>An application
framework allows you to inherit from a class or set of classes and create a new
application, reusing most of the code in the existing classes and overriding
one or more methods in order to customize the application to your needs. A
fundamental concept in the application framework is the <i>Template Method</i>
which is typically hidden beneath the covers and drives the application by
calling the various methods in the base class (some of which you have
overridden in order to create the application).</p>

<p class=MsoNormal><span style='display:none'>#[BT_87]#</span>For example, whenever
you create an applet you’re using an application framework: you inherit from <b>JApplet</b>
and then override <b>init(&nbsp;)</b>. The applet mechanism (which is a <i>Template
Method</i>)<i> </i>does the rest by drawing the screen, handling the event
loop, resizing, etc.</p>

<p class=MsoNormal><span style='display:none'>#[BT_88]#</span>An important
characteristic of the <i>Template Method</i> is that it is defined in the base
class and cannot be changed. It’s sometimes a <b>private</b> method but it’s
virtually always <b>final</b>. It calls other base-class methods (the ones you
override) in order to do its job, but it is usually called only as part of an
initialization process (and thus the client programmer isn’t necessarily able
to call it directly).</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: templatemethod:TemplateMethod.java</p>

<p class=Code style='margin-left:0in'>// Simple demonstration of Template
Method.</p>

<p class=Code style='margin-left:0in'>package templatemethod;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>abstract class ApplicationFramework {</p>

<p class=Code style='margin-left:0in'>  public ApplicationFramework() {</p>

<p class=Code style='margin-left:0in'>    templateMethod(); // Dangerous!</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  abstract void customize1();</p>

<p class=Code style='margin-left:0in'>  abstract void customize2();</p>

<p class=Code style='margin-left:0in'>  final void templateMethod() {</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; 5; i++) {</p>

<p class=Code style='margin-left:0in'>      customize1();</p>

<p class=Code style='margin-left:0in'>      customize2();</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// Create a new &quot;application&quot;:</p>

<p class=Code style='margin-left:0in'>class MyApp extends ApplicationFramework
{</p>

<p class=Code style='margin-left:0in'>  void customize1() { </p>

<p class=Code style='margin-left:0in'>    System.out.print(&quot;Hello &quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  void customize2() { </p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;World!&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class TemplateMethod extends
TestCase  {</p>

<p class=Code style='margin-left:0in'>  MyApp app = new MyApp();</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    // The MyApp constructor does all the
work.</p>

<p class=Code style='margin-left:0in'>    // This just makes sure it will
complete </p>

<p class=Code style='margin-left:0in'>    // without throwing an exception.</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(TemplateMethod.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_89]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_90]#</span>The base-class
constructor is responsible for performing the necessary initialization and then
starting the “engine” (the template method) that runs the application (in a GUI
application, this “engine” would be the main event loop). The client programmer
simply provides definitions for <b>customize1(&nbsp;)</b> and <b>customize2(&nbsp;)</b>
and the “application” is ready to run.</p>

<h3><a name="_Toc41169711">Exercises</a></h3>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>1. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Create a framework that takes a list of file names on the command
line. It opens each file except the last for reading, and the last for writing.
The framework will process each input file using an undetermined policy and
write the output to the last file. Inherit to customize this framework to
create two separate applications:<br>
1) Converts all the letters in each file to uppercase.<br>
2) Searches the files for words given in the first file.</p>

<p class=MsoNormal><span style='display:none'>#[BT_91]#</span></p>

</div>

<span style='font-size:11.0pt;font-family:Georgia;display:none'><br clear=all
style='page-break-before:right'>
</span>

<div class=Section9>

<h1 style='margin-left:.75in'><a name="_Toc41169712">Encapsulating creation</a></h1>

<p class=MsoNormal><span style='display:none'>#[BT_203]#</span>When you
discover that you need to add new types to a system, the most sensible first
step is to use polymorphism to create a common interface to those new types.
This separates the rest of the code in your system from the knowledge of the
specific types that you are adding. New types may be added without disturbing
existing code … or so it seems. At first it would appear that the only place
you need to change the code in such a design is the place where you inherit a
new type, but this is not quite true. You must still create an object of your
new type, and at the point of creation you must specify the exact constructor
to use. Thus, if the code that creates objects is distributed throughout your
application, you have the same problem when adding new types—you must still
chase down all the points of your code where type matters. It happens to be the
<i>creation</i> of the type that matters in this case rather than the <i>use</i>
of the type (which is taken care of by polymorphism), but the effect is the
same: adding a new type can cause problems.</p>

<p class=MsoNormal><span style='display:none'>#[BT_204]#</span>The solution is
to force the creation of objects to occur through a common <i>factory</i>
rather than to allow the creational code to be spread throughout your system.
If all the code in your program must go through this factory whenever it needs
to create one of your objects, then all you must do when you add a new object
is to modify the factory. </p>

<p class=MsoNormal><span style='display:none'>#[BT_205]#</span>Since every
object-oriented program creates objects, and since it’s very likely you will
extend your program by adding new types, I suspect that factories may be the
most universally useful kinds of design patterns.</p>

<p class=MsoNormal>Although only the <i>Simple Factory Method</i> is a true
singleton, you’ll find that each specify factory class in the more general
types of factories will only have a single instance.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169713">Simple Factory method</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_206]#</span>As an example,
let’s revisit the <b>Shape</b> system.  <span style='display:none'>#[BT_207]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_208]#</span>One approach is
to make the factory a <b>static</b> method of the base class:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: factory:shapefact1:ShapeFactory1.java</p>

<p class=Code style='margin-left:0in'>// A simple static factory method.</p>

<p class=Code style='margin-left:0in'>package factory.shapefact1;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>abstract class Shape {</p>

<p class=Code style='margin-left:0in'>  public abstract void draw();</p>

<p class=Code style='margin-left:0in'>  public abstract void erase();</p>

<p class=Code style='margin-left:0in'>  public static Shape factory(String
type) {</p>

<p class=Code style='margin-left:0in'>    if(type.equals(&quot;Circle&quot;))
return new Circle();</p>

<p class=Code style='margin-left:0in'>    if(type.equals(&quot;Square&quot;))
return new Square();</p>

<p class=Code style='margin-left:0in'>    throw new RuntimeException(</p>

<p class=Code style='margin-left:0in'>      &quot;Bad shape creation: &quot; +
type);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Circle extends Shape {</p>

<p class=Code style='margin-left:0in'>  Circle() {} // Package-access
constructor</p>

<p class=Code style='margin-left:0in'>  public void draw() { </p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Circle.draw&quot;); </p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void erase() { </p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Circle.erase&quot;);
</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Square extends Shape {</p>

<p class=Code style='margin-left:0in'>  Square() {} // Package-access
constructor</p>

<p class=Code style='margin-left:0in'>  public void draw() { </p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Square.draw&quot;); </p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void erase() { </p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Square.erase&quot;); </p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class ShapeFactory1 extends
TestCase  {</p>

<p class=Code style='margin-left:0in'>  String shlist[] = { &quot;Circle&quot;,
&quot;Square&quot;, </p>

<p class=Code style='margin-left:0in'>    &quot;Square&quot;,
&quot;Circle&quot;, &quot;Circle&quot;, &quot;Square&quot; };</p>

<p class=Code style='margin-left:0in'>  List shapes = new ArrayList();</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    Iterator it =
Arrays.asList(shlist).iterator();</p>

<p class=Code style='margin-left:0in'>    while(it.hasNext())</p>

<p class=Code style='margin-left:0in'>     
shapes.add(Shape.factory((String)it.next()));</p>

<p class=Code style='margin-left:0in'>    it = shapes.iterator();</p>

<p class=Code style='margin-left:0in'>    while(it.hasNext()) {</p>

<p class=Code style='margin-left:0in'>      Shape s = (Shape)it.next();</p>

<p class=Code style='margin-left:0in'>      s.draw();</p>

<p class=Code style='margin-left:0in'>      s.erase();</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(ShapeFactory1.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span style='display:none'>#[BT_209]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_210]#</span>The <b>factory(&nbsp;)</b>
takes an argument that allows it to determine what type of  <b>Shape</b> to
create; it happens to be a <b>String</b> in this case but it could be any set
of data. The <b>factory(&nbsp;)</b> is now the only other code in the system
that needs to be changed when a new type of <b>Shape </b>is added (the
initialization data for the objects will presumably come from somewhere outside
the system, and not be a hard-coded array as in the above example).</p>

<p class=MsoNormal><span style='display:none'>#[BT_211]#</span>To encourage
creation to only happen in the <b>factory(&nbsp;)</b>, the constructors for the
specific types of <b>Shape</b> are give package access, so <b>factory(&nbsp;)</b>
has access to the constructors but they are not available outside the package.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169714"></a><a
name="_Toc476705903"></a><a name="_Toc455024532">Polymorphic factories</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_212]#</span>The <b>static
factory(&nbsp;)</b> method in the previous example forces all the creation
operations to be focused in one spot, so that’s the only place you need to
change the code. This is certainly a reasonable solution, as it throws a box
around the process of creating objects. However, the <i>Design Patterns</i>
book emphasizes that the reason for the <i>Factory Method</i> pattern is so
that different types of factories can be subclassed from the basic factory (the
above design is mentioned as a special case). However, the book does not
provide an example, but instead just repeats the example used for the <i>Abstract
Factory</i> (you’ll see an example of this in the next section). Here is <b>ShapeFactory1.java</b>
modified so the factory methods are in a separate class as virtual functions.
Notice also that the specific <b>Shape </b>classes are dynamically loaded on
demand:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: factory:shapefact2:ShapeFactory2.java</p>

<p class=Code style='margin-left:0in'>// Polymorphic factory methods.</p>

<p class=Code style='margin-left:0in'>package factory.shapefact2;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>interface Shape {</p>

<p class=Code style='margin-left:0in'>  void draw();</p>

<p class=Code style='margin-left:0in'>  void erase();</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>abstract class ShapeFactory {</p>

<p class=Code style='margin-left:0in'>  protected abstract Shape create();</p>

<p class=Code style='margin-left:0in'>  private static Map factories = new
HashMap();</p>

<p class=Code style='margin-left:0in'>  public static void </p>

<p class=Code style='margin-left:0in'>  addFactory(String id, ShapeFactory f) {</p>

<p class=Code style='margin-left:0in'>    factories.put(id, f);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  // A Template Method:</p>

<p class=Code style='margin-left:0in'>  public static final </p>

<p class=Code style='margin-left:0in'>  Shape createShape(String id) {</p>

<p class=Code style='margin-left:0in'>    if(!factories.containsKey(id)) {</p>

<p class=Code style='margin-left:0in'>      try {</p>

<p class=Code style='margin-left:0in'>        // Load dynamically</p>

<p class=Code style='margin-left:0in'>       
Class.forName(&quot;factory.shapefact2.&quot; + id);</p>

<p class=Code style='margin-left:0in'>      } catch(ClassNotFoundException e) {</p>

<p class=Code style='margin-left:0in'>        throw new RuntimeException(</p>

<p class=Code style='margin-left:0in'>          &quot;Bad shape creation:
&quot; + id);</p>

<p class=Code style='margin-left:0in'>      }</p>

<p class=Code style='margin-left:0in'>      // See if it was put in:</p>

<p class=Code style='margin-left:0in'>      if(!factories.containsKey(id))</p>

<p class=Code style='margin-left:0in'>        throw new RuntimeException(</p>

<p class=Code style='margin-left:0in'>          &quot;Bad shape creation:
&quot; + id);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    return </p>

<p class=Code style='margin-left:0in'>     
((ShapeFactory)factories.get(id)).create();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Circle implements Shape {</p>

<p class=Code style='margin-left:0in'>  private Circle() {}</p>

<p class=Code style='margin-left:0in'>  public void draw() { </p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Circle.draw&quot;); </p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void erase() { </p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Circle.erase&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  private static class Factory </p>

<p class=Code style='margin-left:0in'>  extends ShapeFactory {</p>

<p class=Code style='margin-left:0in'>    protected Shape create() { </p>

<p class=Code style='margin-left:0in'>      return new Circle(); </p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  static {</p>

<p class=Code style='margin-left:0in'>    ShapeFactory.addFactory(</p>

<p class=Code style='margin-left:0in'>      &quot;Circle&quot;, new Factory());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Square implements Shape {</p>

<p class=Code style='margin-left:0in'>  private Square() {} </p>

<p class=Code style='margin-left:0in'>  public void draw() { </p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Square.draw&quot;);
</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void erase() { </p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Square.erase&quot;); </p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  private static class Factory </p>

<p class=Code style='margin-left:0in'>  extends ShapeFactory {</p>

<p class=Code style='margin-left:0in'>    protected Shape create() { </p>

<p class=Code style='margin-left:0in'>      return new Square(); </p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  static {</p>

<p class=Code style='margin-left:0in'>    ShapeFactory.addFactory(</p>

<p class=Code style='margin-left:0in'>      &quot;Square&quot;, new Factory());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class ShapeFactory2 extends
TestCase  {</p>

<p class=Code style='margin-left:0in'>  String shlist[] = { &quot;Circle&quot;,
&quot;Square&quot;, </p>

<p class=Code style='margin-left:0in'>    &quot;Square&quot;,
&quot;Circle&quot;, &quot;Circle&quot;, &quot;Square&quot; };</p>

<p class=Code style='margin-left:0in'>  List shapes = new ArrayList();</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    // This just makes sure it will
complete </p>

<p class=Code style='margin-left:0in'>    // without throwing an exception.</p>

<p class=Code style='margin-left:0in'>    Iterator it =
Arrays.asList(shlist).iterator();</p>

<p class=Code style='margin-left:0in'>    while(it.hasNext())</p>

<p class=Code style='margin-left:0in'>      shapes.add(</p>

<p class=Code style='margin-left:0in'>       
ShapeFactory.createShape((String)it.next()));</p>

<p class=Code style='margin-left:0in'>    it = shapes.iterator();</p>

<p class=Code style='margin-left:0in'>    while(it.hasNext()) {</p>

<p class=Code style='margin-left:0in'>      Shape s = (Shape)it.next();</p>

<p class=Code style='margin-left:0in'>      s.draw();</p>

<p class=Code style='margin-left:0in'>      s.erase();</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>   
junit.textui.TestRunner.run(ShapeFactory2.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span style='display:none'>#[BT_213]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_214]#</span>Now the factory
method appears in its own class, <b>ShapeFactory</b>, as the <b>create(&nbsp;)</b>
method. This is a <b>protected</b> method which means it cannot be called
directly, but it can be overridden. The subclasses of <b>Shape</b> must each
create their own subclasses of <b>ShapeFactory</b> and override the <b>create(&nbsp;)</b>
method to create an object of their own type. The actual creation of shapes is
performed by calling <b>ShapeFactory.createShape(&nbsp;)</b>, which is a static
method that uses the <b>Map</b> in <b>ShapeFactory</b> to find the appropriate
factory object based on an identifier that you pass it. The factory is
immediately used to create the shape object, but you could imagine a more
complex problem where the appropriate factory object is returned and then used
by the caller to create an object in a more sophisticated way. However, it
seems that much of the time you don’t need the intricacies of the polymorphic
factory method, and a single static method in the base class (as shown in <b>ShapeFactory1.java</b>)
will work fine.</p>

<p class=MsoNormal><span style='display:none'>#[BT_215]#</span>Notice that the <b>ShapeFactory</b>
must be initialized by loading its <b>Map</b> with factory objects, which takes
place in the static initialization clause of each of the <b>Shape</b>
implementations. So to add a new type to this design you must inherit the type,
create a factory, and add the static initialization clause to load the <b>Map</b>.
This extra complexity again suggests the use of a <b>static</b> factory method
if you don’t need to create individual factory objects.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169715"></a><a
name="_Toc476705904"></a><a name="_Toc455024533">Abstract factories</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_216]#</span>The <i>Abstract
Factory</i> pattern looks like the factory objects we’ve seen previously, with
not one but several factory methods. Each of the factory methods creates a
different kind of object. The idea is that at the point of creation of the
factory object, you decide how all the objects created by that factory will be
used. The example given in <i>Design Patterns</i> implements portability across
various graphical user interfaces (GUIs): you create a factory object
appropriate to the GUI that you’re working with, and from then on when you ask
it for a menu, button, slider, etc. it will automatically create the appropriate
version of that item for the GUI. Thus you’re able to isolate, in one place,
the effect of changing from one GUI to another.</p>

<p class=MsoNormal><span style='display:none'>#[BT_217]#</span>As another
example suppose you are creating a general-purpose gaming environment and you
want to be able to support different types of games. Here’s how it might look
using an abstract factory:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: factory:Games.java</p>

<p class=Code style='margin-left:0in'>// An example of the Abstract Factory
pattern.</p>

<p class=Code style='margin-left:0in'>package factory;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>interface Obstacle {</p>

<p class=Code style='margin-left:0in'>  void action();</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>interface Player {</p>

<p class=Code style='margin-left:0in'>  void interactWith(Obstacle o);</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Kitty implements Player {</p>

<p class=Code style='margin-left:0in'>  public void interactWith(Obstacle ob) {</p>

<p class=Code style='margin-left:0in'>    System.out.print(&quot;Kitty has
encountered a &quot;);</p>

<p class=Code style='margin-left:0in'>    ob.action();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class KungFuGuy implements Player {</p>

<p class=Code style='margin-left:0in'>  public void interactWith(Obstacle ob) {</p>

<p class=Code style='margin-left:0in'>    System.out.print(&quot;KungFuGuy now
battles a &quot;);</p>

<p class=Code style='margin-left:0in'>    ob.action();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Puzzle implements Obstacle {</p>

<p class=Code style='margin-left:0in'>  public void action() { </p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Puzzle&quot;); </p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class NastyWeapon implements Obstacle {</p>

<p class=Code style='margin-left:0in'>  public void action() { </p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;NastyWeapon&quot;);
</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// The Abstract Factory:</p>

<p class=Code style='margin-left:0in'>interface GameElementFactory {</p>

<p class=Code style='margin-left:0in'>  Player makePlayer();</p>

<p class=Code style='margin-left:0in'>  Obstacle makeObstacle();</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// Concrete factories:</p>

<p class=Code style='margin-left:0in'>class KittiesAndPuzzles </p>

<p class=Code style='margin-left:0in'>implements GameElementFactory {</p>

<p class=Code style='margin-left:0in'>  public Player makePlayer() { </p>

<p class=Code style='margin-left:0in'>    return new Kitty();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public Obstacle makeObstacle() {</p>

<p class=Code style='margin-left:0in'>    return new Puzzle();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class KillAndDismember </p>

<p class=Code style='margin-left:0in'>implements GameElementFactory {</p>

<p class=Code style='margin-left:0in'>  public Player makePlayer() { </p>

<p class=Code style='margin-left:0in'>    return new KungFuGuy();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public Obstacle makeObstacle() {</p>

<p class=Code style='margin-left:0in'>    return new NastyWeapon();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class GameEnvironment {</p>

<p class=Code style='margin-left:0in'>  private GameElementFactory gef;</p>

<p class=Code style='margin-left:0in'>  private Player p;</p>

<p class=Code style='margin-left:0in'>  private Obstacle ob;</p>

<p class=Code style='margin-left:0in'>  public GameEnvironment(</p>

<p class=Code style='margin-left:0in'>    GameElementFactory factory) {</p>

<p class=Code style='margin-left:0in'>    gef = factory;</p>

<p class=Code style='margin-left:0in'>    p = factory.makePlayer(); </p>

<p class=Code style='margin-left:0in'>    ob = factory.makeObstacle();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void play() {
p.interactWith(ob); }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class Games extends TestCase  {</p>

<p class=Code style='margin-left:0in'>  GameElementFactory</p>

<p class=Code style='margin-left:0in'>    kp = new KittiesAndPuzzles(),</p>

<p class=Code style='margin-left:0in'>    kd = new KillAndDismember();</p>

<p class=Code style='margin-left:0in'>  GameEnvironment </p>

<p class=Code style='margin-left:0in'>    g1 = new GameEnvironment(kp),</p>

<p class=Code style='margin-left:0in'>    g2 = new GameEnvironment(kd);</p>

<p class=Code style='margin-left:0in'>  // These just ensure no exceptions are
thrown:</p>

<p class=Code style='margin-left:0in'>  public void test1() { g1.play(); }</p>

<p class=Code style='margin-left:0in'>  public void test2() { g2.play(); }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(Games.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_218]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_219]#</span>In this
environment, <b>Player</b> objects interact with <b>Obstacle</b> objects, but
there are different types of players and obstacles depending on what kind of
game you’re playing. You determine the kind of game by choosing a particular <b>GameElementFactory</b>,
and then the <b>GameEnvironment</b> controls the setup and play of the game. In
this example, the setup and play is very simple, but those activities (the <i>initial
conditions</i> and the <i>state change</i>) can determine much of the game’s
outcome. Here, <b>GameEnvironment</b> is not designed to be inherited, although
it could very possibly make sense to do that.</p>

<p class=MsoNormal><span style='display:none'>#[BT_220]#</span>This also
contains examples of <i>Double Dispatching</i> and the <i>Factory Method</i>,
both of which will be explained later.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169716">Exercises</a></h2>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>1. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Add a class Triangle to ShapeFactory1.java</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>2. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Add a class <b>Triangle</b> to <b>ShapeFactory2.java</b></p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>3. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Add a new type of <b>GameEnvironment</b> called <b>GnomesAndFairies</b>
to <b>Games.java</b></p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>4. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Modify <b>ShapeFactory2.java</b> so that it uses an <i>Abstract
Factory</i> to create different sets of shapes (for example, one particular
type of factory object creates “thick shapes,” another creates “thin shapes,”
but each factory object can create all the shapes: circles, squares, triangles
etc.).</p>

<p class=MsoNormal><span style='display:none'>#[BT_221]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_222]#</span></p>

</div>

<span style='font-size:11.0pt;font-family:Georgia;display:none'><br clear=all
style='page-break-before:right'>
</span>

<div class=Section10>

<h1 style='margin-left:.75in'><a name="_Toc41169717">Specialized creation</a></h1>

<h2 style='margin-left:40.5pt'><a name="_Toc41169718">Prototype</a></h2>

<p class=MsoNormal>Objects are created by cloning a prototypical instance. An
example of this appears in the “Pattern Refactoring” chapter.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169719">Builder</a></h2>

<p class=MsoNormal>The goal of builder is to separate the construction from the
“representation,” to allow multiple different representations. The construction
process stays the same, but the resulting object has different possible
representations. GoF points out that the main difference with Abstract Factory
is that a Builder creates the object step-by-step, so the fact that the
creation process is spread out in time seems to be important. In addition, it
seems that the “director” gets a stream of pieces that it passes to the
Builder, and each piece is used to perform one of the steps in the build
process.</p>

<p class=MsoNormal>One example given in GoF is that of a text format converter.
The incoming format is RTF, and once it is parsed the directives are passed to
the text converter, which may be implemented in different ways depending on
whether the resulting format is ASCII, TeX, or a “GUI Text Widget.” Although
the resulting “object” (the entire converted text file) is created over time,
if you consider the conversion of each RTF directive to be an object, this
feels to me a little more like Bridge, because the specific types of converters
extend the interface of the base class. Also, the general solution to the problem
would allow multiple readers on the “front end” and multiple converters on the
“back end,” which is a primary characteristic of Bridge.</p>

<p class=MsoNormal>To me, the fact that Builder has multiple steps in creating
an object, and those steps are accessed externally to the Builder object, is
the essence of what distinguishes it (structurally, anyway) from a regular
factory.  However, GoF emphasizes that you’re able to create different
representations using the same process. They never define exactly what they
mean by representation. (Does the “representation” involve an object that is
too large? Would the need for Builder vanish if the representation was broken
into smaller objects?)</p>

<p class=MsoNormal>The other example <a name=AAA></a>in GoF creates a maze
object and adds rooms within the maze and doors within the rooms. Thus it is a
multistep process, but alas, the different “representations” are the “Standard”
and “Complex” mazes – not really different kinds of mazes, but instead
different complexity. I think I would have tried to create one maze builder
that could handle arbitrarily complex mazes. The final variation of the maze
builder is something that doesn’t create mazes at all, but instead counts the
rooms in an existing maze. </p>

<p class=MsoNormal>Neither the RTF converter nor the Mazebuilder example makes
an overwhelmingly compelling case for Builder. Readers have suggested that the
output of the Sax XML parser, and standard compiler parsers, might naturally be
fed into a Builder.</p>

<p class=MsoNormal>Here’s an example that may be a little more compelling, or
at least give more of an idea of what Builder is trying to do. Media may be
constructed into different representations, in this case books, magazines and
web sites. The example argues that the steps involved are the same, and so can
be abstracted into the director class.</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: builder:BuildMedia.java</p>

<p class=Code style='margin-left:0in'>// Example of the Builder pattern</p>

<p class=Code style='margin-left:0in'>package builder;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// Different &quot;representations&quot;
of media:</p>

<p class=Code style='margin-left:0in'>class Media extends ArrayList {}</p>

<p class=Code style='margin-left:0in'>class Book extends Media {}</p>

<p class=Code style='margin-left:0in'>class Magazine extends Media {}</p>

<p class=Code style='margin-left:0in'>class WebSite extends Media {}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// ... contain different kinds of media
items:</p>

<p class=Code style='margin-left:0in'>class MediaItem {</p>

<p class=Code style='margin-left:0in'>  private String s;</p>

<p class=Code style='margin-left:0in'>  public MediaItem(String s) { this.s =
s; }</p>

<p class=Code style='margin-left:0in'>  public String toString() { return s; }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>class Chapter extends MediaItem {</p>

<p class=Code style='margin-left:0in'>  public Chapter(String s) { super(s); }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>class Article extends MediaItem {</p>

<p class=Code style='margin-left:0in'>  public Article(String s) { super(s); }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>class WebItem extends MediaItem {</p>

<p class=Code style='margin-left:0in'>  public WebItem(String s) { super(s); }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// ... but use the same basic
construction steps:</p>

<p class=Code style='margin-left:0in'>class MediaBuilder {</p>

<p class=Code style='margin-left:0in'>  public void buildBase() {}</p>

<p class=Code style='margin-left:0in'>  public void addMediaItem(MediaItem
item) {}</p>

<p class=Code style='margin-left:0in'>  public Media getFinishedMedia() {
return null; }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class BookBuilder extends MediaBuilder {</p>

<p class=Code style='margin-left:0in'>  private Book b;</p>

<p class=Code style='margin-left:0in'>  public void buildBase() {</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Building
book framework&quot;);</p>

<p class=Code style='margin-left:0in'>    b = new Book();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void addMediaItem(MediaItem
chapter) {</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Adding
chapter &quot; + chapter);</p>

<p class=Code style='margin-left:0in'>    b.add(chapter);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public Media getFinishedMedia() {
return b; }</p>

<p class=Code style='margin-left:0in'>}  </p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class MagazineBuilder extends
MediaBuilder {</p>

<p class=Code style='margin-left:0in'>  private Magazine m;</p>

<p class=Code style='margin-left:0in'>  public void buildBase() {</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Building
magazine framework&quot;);</p>

<p class=Code style='margin-left:0in'>    m = new Magazine();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void addMediaItem(MediaItem
article) {</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Adding
article &quot; + article);</p>

<p class=Code style='margin-left:0in'>    m.add(article);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public Media getFinishedMedia() {
return m; }</p>

<p class=Code style='margin-left:0in'>}  </p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class WebSiteBuilder extends MediaBuilder
{</p>

<p class=Code style='margin-left:0in'>  private WebSite w;</p>

<p class=Code style='margin-left:0in'>  public void buildBase() {</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Building web
site framework&quot;);</p>

<p class=Code style='margin-left:0in'>    w = new WebSite();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void addMediaItem(MediaItem
webItem) {</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Adding web
item &quot; + webItem);</p>

<p class=Code style='margin-left:0in'>    w.add(webItem);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public Media getFinishedMedia() {
return w; }</p>

<p class=Code style='margin-left:0in'>}  </p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class MediaDirector { // a.k.a.
&quot;Context&quot;</p>

<p class=Code style='margin-left:0in'>  private MediaBuilder mb;</p>

<p class=Code style='margin-left:0in'>  public MediaDirector(MediaBuilder mb) {</p>

<p class=Code style='margin-left:0in'>    this.mb = mb; // Strategy-ish</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public Media produceMedia(List input) {</p>

<p class=Code style='margin-left:0in'>    mb.buildBase();</p>

<p class=Code style='margin-left:0in'>    for(Iterator it = input.iterator();
it.hasNext();)</p>

<p class=Code style='margin-left:0in'>     
mb.addMediaItem((MediaItem)it.next());</p>

<p class=Code style='margin-left:0in'>    return mb.getFinishedMedia();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>};</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class BuildMedia extends TestCase
{</p>

<p class=Code style='margin-left:0in'>  private List input = Arrays.asList(new
MediaItem[] {</p>

<p class=Code style='margin-left:0in'>    new MediaItem(&quot;item1&quot;), new
MediaItem(&quot;item2&quot;),</p>

<p class=Code style='margin-left:0in'>    new MediaItem(&quot;item3&quot;), new
MediaItem(&quot;item4&quot;),</p>

<p class=Code style='margin-left:0in'>  });</p>

<p class=Code style='margin-left:0in'>  public void testBook() {</p>

<p class=Code style='margin-left:0in'>    MediaDirector buildBook = </p>

<p class=Code style='margin-left:0in'>      new MediaDirector(new
BookBuilder());</p>

<p class=Code style='margin-left:0in'>    Media book =
buildBook.produceMedia(input);</p>

<p class=Code style='margin-left:0in'>    String result = &quot;book: &quot; +
book;</p>

<p class=Code style='margin-left:0in'>    System.out.println(result);</p>

<p class=Code style='margin-left:0in'>    assertEquals(result, </p>

<p class=Code style='margin-left:0in'>      &quot;book: [item1, item2, item3,
item4]&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void testMagazine() {</p>

<p class=Code style='margin-left:0in'>    MediaDirector buildMagazine = </p>

<p class=Code style='margin-left:0in'>      new MediaDirector(new
MagazineBuilder());</p>

<p class=Code style='margin-left:0in'>    Media magazine =
buildMagazine.produceMedia(input);</p>

<p class=Code style='margin-left:0in'>    String result = &quot;magazine:
&quot; + magazine;</p>

<p class=Code style='margin-left:0in'>    System.out.println(result);</p>

<p class=Code style='margin-left:0in'>    assertEquals(result, </p>

<p class=Code style='margin-left:0in'>      &quot;magazine: [item1, item2,
item3, item4]&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void testWebSite() {</p>

<p class=Code style='margin-left:0in'>    MediaDirector buildWebSite = </p>

<p class=Code style='margin-left:0in'>      new MediaDirector(new
WebSiteBuilder());</p>

<p class=Code style='margin-left:0in'>    Media webSite =
buildWebSite.produceMedia(input);</p>

<p class=Code style='margin-left:0in'>    String result = &quot;web site:
&quot; + webSite;</p>

<p class=Code style='margin-left:0in'>    System.out.println(result);</p>

<p class=Code style='margin-left:0in'>    assertEquals(result, </p>

<p class=Code style='margin-left:0in'>      &quot;web site: [item1, item2,
item3, item4]&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String[] args)
{</p>

<p class=Code style='margin-left:0in'>   
junit.textui.TestRunner.run(BuildMedia.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>Note that in some ways this could be seen as a more
complicated State pattern, since the behavior of the director depends on what
type of builder you use. Instead of simply forwarding the requests through to
the underlying State object, however, the director has a sequence of operations
to perform, and it uses the State object as a Policy to fulfill its job. Thus,
Builder could be described as using a Policy to create objects.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc476705902"></a><a
name="_Toc41169720">Exercises</a></h2>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>1. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Break a text file up into an input stream of words (consider
using regular expressions for this). Create one Builder that puts the words
into a <b>java.util.TreeSet</b>, and another that produces a <b>java.util.HashMap</b>
containing words and occurrences of those words (that is, it does a word
count).</p>

<h1 style='margin-left:.75in'><a name="_Toc41169721">Too many</a></h1>

<h2 style='margin-left:40.5pt'><a name="_Toc41169722">Flyweight: too many
objects</a></h2>

<p class=MsoNormal>The odd thing about flyweight, in the company of the other
design patterns, is that it’s a performance hack. It’s generally ideal to
simply make an object for every item in your system, but some problems generate
a prohibitive number of objects, which may result in excessive slowness or
running out of memory.</p>

<p class=MsoNormal>Flyweight solves this problem by reducing the number of
objects. To do this, you externalize some of the data in an object, so that you
can pretend that you have more objects than you really do. However, this adds
complexity to the interface for using such objects, because you must pass in
additional information to method calls in order to tell the method how to find
the externalized information.</p>

<p class=MsoNormal>As a very simple example, consider a <b>DataPoint</b> object
that holds an <b>int</b>, a <b>float</b>, and an <b>id</b> that carries the
object number. Suppose you need to create a million of these objects, and then
manipulate them, like so:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: flyweight:ManyObjects.java</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class DataPoint {</p>

<p class=Code style='margin-left:0in'>  private static int count = 0;</p>

<p class=Code style='margin-left:0in'>  private int id = count++;</p>

<p class=Code style='margin-left:0in'>  private int i;</p>

<p class=Code style='margin-left:0in'>  private float f;</p>

<p class=Code style='margin-left:0in'>  public int getI() { return i; }</p>

<p class=Code style='margin-left:0in'>  public void setI(int i) { this.i = i; }</p>

<p class=Code style='margin-left:0in'>  public float getF() { return f; }</p>

<p class=Code style='margin-left:0in'>  public void setF(float f) { this.f = f;
}</p>

<p class=Code style='margin-left:0in'>  public String toString() {</p>

<p class=Code style='margin-left:0in'>    return &quot;id: &quot; + id +
&quot;, i = &quot; + i + &quot;, f = &quot; + f;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class ManyObjects {</p>

<p class=Code style='margin-left:0in'>  static final int size = 1000000;</p>

<p class=Code style='margin-left:0in'>  public static void main(String[] args)
{</p>

<p class=Code style='margin-left:0in'>    DataPoint[] array = new
DataPoint[size];</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; array.length;
i++)</p>

<p class=Code style='margin-left:0in'>      array[i] = new DataPoint();</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; array.length;
i++) {</p>

<p class=Code style='margin-left:0in'>      DataPoint dp = array[i];</p>

<p class=Code style='margin-left:0in'>      dp.setI(dp.getI() + 1);</p>

<p class=Code style='margin-left:0in'>      dp.setF(47.0f);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    System.out.println(array[size -1]);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=CodeInline style='margin-left:0in'>} ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<p class=MsoNormal>Depending on your computer, this program may take several
seconds to run. More complex objects and more involved operations may cause the
overhead to become untenable. To solve the problem the <b>DataPoint</b> can be
reduced from a million objects to one object by externalizing the data held in
the <b>DataPoint</b>:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: flyweight:FlyWeightObjects.java</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class ExternalizedData {</p>

<p class=Code style='margin-left:0in'>  static final int size = 5000000;</p>

<p class=Code style='margin-left:0in'>  static int[] id = new int[size];</p>

<p class=Code style='margin-left:0in'>  static int[] i = new int[size];</p>

<p class=Code style='margin-left:0in'>  static float[] f = new float[size];</p>

<p class=Code style='margin-left:0in'>  static {</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; size; i++)</p>

<p class=Code style='margin-left:0in'>      id[i] = i;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class FlyPoint {</p>

<p class=Code style='margin-left:0in'>  private FlyPoint() {}</p>

<p class=Code style='margin-left:0in'>  public static int getI(int obnum) {</p>

<p class=Code style='margin-left:0in'>    return ExternalizedData.i[obnum];</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void setI(int obnum, int
i) {</p>

<p class=Code style='margin-left:0in'>    ExternalizedData.i[obnum] = i;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static float getF(int obnum) {</p>

<p class=Code style='margin-left:0in'>    return ExternalizedData.f[obnum];</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void setF(int obnum,
float f) {</p>

<p class=Code style='margin-left:0in'>    ExternalizedData.f[obnum] = f;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static String str(int obnum) {</p>

<p class=Code style='margin-left:0in'>    return &quot;id: &quot; +</p>

<p class=Code style='margin-left:0in'>      ExternalizedData.id[obnum] +</p>

<p class=Code style='margin-left:0in'>      <span lang=SV>&quot;, i = &quot; +</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>     
ExternalizedData.i[obnum] +</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>      &quot;, f = &quot; +</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>      </span>ExternalizedData.f[obnum];</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class FlyWeightObjects {</p>

<p class=Code style='margin-left:0in'>  public static void main(String[] args)
{</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt;
ExternalizedData.size; i++) {</p>

<p class=Code style='margin-left:0in'>      FlyPoint.setI(i, FlyPoint.getI(i) +
1);</p>

<p class=Code style='margin-left:0in'>      FlyPoint.setF(i, 47.0f);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      FlyPoint.str(ExternalizedData.size
-1));</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=CodeInline style='margin-left:0in'>} ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<p class=MsoNormal>Since all the data is now in <b>ExternalizedData</b>, each
call to a <b>FlyPoint</b> method must include the index into <b>ExternalizedData</b>.
For consistency, and to remind the reader of the similarity with the implicit <b>this</b>
pointer in method calls, the “this index” is passed in as the first argument.</p>

<p class=MsoNormal>Naturally, it’s worth repeating admonishments against
premature optimization. “First make it work, then make it fast – if you have
to.” Also, a profiler is the tool to use for discovering performance
bottlenecks, not guesswork.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169723">Decorator: too many
classes</a></h2>

<p class=Intro>The use of layered objects to dynamically and transparently add
responsibilities to individual objects is referred to as the <i>decorator</i>
pattern.</p>

<p class=MsoNormal><span style='display:none'>#[BT_155]#</span>Used when
subclassing creates too many (&amp; inflexible) classes</p>

<p class=MsoNormal><span style='display:none'>#[BT_156]#</span>All decorators
that wrap around the original object must have the same basic interface</p>

<p class=MsoNormal><span style='display:none'>#[BT_157]#</span>Dynamic
proxy/surrogate?</p>

<p class=MsoNormal><span style='display:none'>#[BT_158]#</span>This accounts
for the odd inheritance structure</p>

<p class=MsoNormal><span style='display:none'>#[BT_159]#</span>Tradeoff: coding
is more complicated when using decorators</p>

<h3><a name="_Toc41169724">Basic decorator structure</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_160]#</span><img border=0
width=485 height=252 src="TIPatterns_files/image002.gif"></p>

<h3><a name="_Toc41169725">A coffee example</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_161]#</span>Consider going
down to the local coffee shop, <i>BeanMeUp</i>, for a coffee.  There are
typically many different drinks on offer -- espressos, lattes, teas, iced
coffees, hot chocolate to name a few, as well as a number of extras (which cost
extra too) such as whipped cream or an extra shot of espresso. You can also
make certain changes to your drink at no extra cost, such as asking for decaf coffee
instead of regular coffee. </p>

<p class=MsoNormal><span style='display:none'>#[BT_162]#</span>Quite clearly if
we are going to model all these drinks and combinations, there will be sizeable
class diagrams. So for clarity we will only consider a subset of the coffees:
Espresso, Espresso Con Panna, Café Late, Cappuccino and Café Mocha. We'll
include 2 extras - whipped cream (&quot;whipped&quot;) and an extra shot of
espresso; and three changes - decaf, steamed milk (&quot;wet&quot;) and foamed
milk (&quot;dry&quot;).</p>

<h3><a name="_Toc41169726">Class for each combination</a> </h3>

<p class=MsoNormal><span style='display:none'>#[BT_163]#</span>One solution is
to create an individual class for every combination. Each class describes the
drink and is responsible for the cost etc. The resulting menu is huge, and a
part of the class diagram would look something like this:</p>

<p class=MsoNormal><span style='display:none'>#[BT_164]#</span> <img border=0
width=504 height=257 src="TIPatterns_files/image003.gif"></p>

<p class=MsoNormal><span style='display:none'>#[BT_165]#</span>Here is one of
the combinations, a simple implementation of a Cappuccino:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>class Cappuccino {</p>

<p class=Code style='margin-left:0in'>  private float cost = 1;</p>

<p class=Code style='margin-left:0in'>  private String description =
&quot;Cappucino&quot;;</p>

<p class=Code style='margin-left:0in'>  public float getCost() {</p>

<p class=Code style='margin-left:0in'>    return cost;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return description;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_166]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_167]#</span>The key to using
this method is to find the particular combination you want.  So, once you've
found the drink you would like, here is how you would use it, as shown in the
CoffeeShop class in the following code:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: decorator:nodecorators:CoffeeShop.java</p>

<p class=Code style='margin-left:0in'>// Coffee example with no decorators</p>

<p class=Code style='margin-left:0in'>package decorator.nodecorators;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Espresso {}</p>

<p class=Code style='margin-left:0in'>class DoubleEspresso {}</p>

<p class=Code style='margin-left:0in'>class EspressoConPanna {}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Cappuccino {</p>

<p class=Code style='margin-left:0in'>  private float cost = 1;</p>

<p class=Code style='margin-left:0in'>  private String description =
&quot;Cappucino&quot;;</p>

<p class=Code style='margin-left:0in'>  public float getCost() {</p>

<p class=Code style='margin-left:0in'>    return cost;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return description;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>class CappuccinoDecaf {}</p>

<p class=Code style='margin-left:0in'>class CappuccinoDecafWhipped {}</p>

<p class=Code style='margin-left:0in'>class CappuccinoDry {}</p>

<p class=Code style='margin-left:0in'>class CappuccinoDryWhipped {}</p>

<p class=Code style='margin-left:0in'>class CappuccinoExtraEspresso {}</p>

<p class=Code style='margin-left:0in'>class CappuccinoExtraEspressoWhipped {}</p>

<p class=Code style='margin-left:0in'>class CappuccinoWhipped {}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class CafeMocha {}</p>

<p class=Code style='margin-left:0in'>class CafeMochaDecaf {}</p>

<p class=Code style='margin-left:0in'>class CafeMochaDecafWhipped {</p>

<p class=Code style='margin-left:0in'>  private float cost = 1.25f;</p>

<p class=Code style='margin-left:0in'>  private String description =</p>

<p class=Code style='margin-left:0in'>    &quot;Cafe Mocha decaf whipped
cream&quot;;</p>

<p class=Code style='margin-left:0in'>  public float getCost() {</p>

<p class=Code style='margin-left:0in'>    return cost;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return description;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>class CafeMochaExtraEspresso {}</p>

<p class=Code style='margin-left:0in'>class CafeMochaExtraEspressoWhipped {}</p>

<p class=Code style='margin-left:0in'>class CafeMochaWet {}</p>

<p class=Code style='margin-left:0in'>class CafeMochaWetWhipped {}</p>

<p class=Code style='margin-left:0in'>class CafeMochaWhipped {}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class CafeLatte {}</p>

<p class=Code style='margin-left:0in'>class CafeLatteDecaf {}</p>

<p class=Code style='margin-left:0in'>class CafeLatteDecafWhipped {}</p>

<p class=Code style='margin-left:0in'>class CafeLatteExtraEspresso {}</p>

<p class=Code style='margin-left:0in'>class CafeLatteExtraEspressoWhipped {}</p>

<p class=Code style='margin-left:0in'>class CafeLatteWet {}</p>

<p class=Code style='margin-left:0in'>class CafeLatteWetWhipped {}</p>

<p class=Code style='margin-left:0in'>class CafeLatteWhipped {}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class CoffeeShop extends TestCase  {</p>

<p class=Code style='margin-left:0in'>  public void testCappuccino() {</p>

<p class=Code style='margin-left:0in'>    // This just makes sure it will
complete </p>

<p class=Code style='margin-left:0in'>    // without throwing an exception.</p>

<p class=Code style='margin-left:0in'>    // Create a plain cappuccino</p>

<p class=Code style='margin-left:0in'>    Cappuccino cappuccino = new
Cappuccino();</p>

<p class=Code style='margin-left:0in'>    System.out.println(cappuccino.getDescription()</p>

<p class=Code style='margin-left:0in'>      + &quot;: $&quot; +
cappuccino.getCost());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void testCafeMocha() {</p>

<p class=Code style='margin-left:0in'>    // This just makes sure it will
complete </p>

<p class=Code style='margin-left:0in'>    // without throwing an exception.</p>

<p class=Code style='margin-left:0in'>    // Create a decaf cafe mocha with
whipped</p>

<p class=Code style='margin-left:0in'>    // cream</p>

<p class=Code style='margin-left:0in'>    CafeMochaDecafWhipped cafeMocha =</p>

<p class=Code style='margin-left:0in'>      new CafeMochaDecafWhipped();</p>

<p class=Code style='margin-left:0in'>   
System.out.println(cafeMocha.getDescription()</p>

<p class=Code style='margin-left:0in'>      + &quot;: $&quot; +
cafeMocha.getCost());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String[] args)
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(CoffeeShop.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_168]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_169]#</span>And here is the
corresponding output:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>Cappucino: $1.0</p>

</div>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>Cafe Mocha decaf whipped cream: $1.25</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_170]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_171]#</span>You can see that
creating the particular combination you want is easy, since you are just
creating an instance of a class. However, there are a number of problems with
this approach. Firstly, the combinations are fixed statically so that any
combination a customer may wish to order needs to be created up front.
Secondly, the resulting menu is so huge that finding your particular
combination is difficult and time consuming.</p>

<h3><a name="_Toc41169727">The decorator approach</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_172]#</span>Another approach
would be to break the drinks down into the various components such as espresso
and foamed milk, and then let the customer combine the components to describe a
particular coffee. </p>

<p class=MsoNormal><span style='display:none'>#[BT_173]#</span>In order to do
this programmatically, we use the Decorator pattern.  A Decorator adds
responsibility to a component by wrapping it, but the Decorator conforms to the
interface of the component it encloses, so the wrapping is transparent.
Decorators can also be nested without the loss of this transparency. </p>

<p class=MsoNormal><span style='display:none'>#[BT_174]#</span><img border=0
width=504 height=180 src="TIPatterns_files/image004.gif"></p>

<p class=MsoNormal><span style='display:none'>#[BT_175]#</span>Methods invoked
on the Decorator can in turn invoke methods in the component, and can of course
perform processing before or after the invocation.</p>

<p class=MsoNormal><span style='display:none'>#[BT_176]#</span>So if we added <b>getTotalCost()</b>
and <b>getDescription()</b> methods to the <b>DrinkComponent</b> interface, an
Espresso looks like this:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>class Espresso extends Decorator {</p>

<p class=Code style='margin-left:0in'>  private float cost = 0.75f;</p>

<p class=Code style='margin-left:0in'>  private String description = &quot;
espresso&quot;;</p>

<p class=Code style='margin-left:0in'>  public Espresso(DrinkComponent
component) {</p>

<p class=Code style='margin-left:0in'>    super(component);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public float getTotalCost() {</p>

<p class=Code style='margin-left:0in'>    return component.getTotalCost() +
cost;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return component.getDescription() +</p>

<p class=Code style='margin-left:0in'>      description;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_177]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_178]#</span>You combine the
components to create a drink as follows, as shown in the code below:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: decorator:alldecorators:CoffeeShop2.java</p>

<p class=Code style='margin-left:0in'>// Coffee example using decorators</p>

<p class=Code style='margin-left:0in'>package decorator.alldecorators;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>interface DrinkComponent {</p>

<p class=Code style='margin-left:0in'>  String getDescription();</p>

<p class=Code style='margin-left:0in'>  float getTotalCost();</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Mug implements DrinkComponent {</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return &quot;mug&quot;;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public float getTotalCost() {</p>

<p class=Code style='margin-left:0in'>    return 0;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>abstract class Decorator implements
DrinkComponent</p>

<p class=Code style='margin-left:0in'>{</p>

<p class=Code style='margin-left:0in'>  protected DrinkComponent component;</p>

<p class=Code style='margin-left:0in'>  Decorator(DrinkComponent component) {</p>

<p class=Code style='margin-left:0in'>    this.component = component;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public float getTotalCost() {</p>

<p class=Code style='margin-left:0in'>    return component.getTotalCost();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public abstract String
getDescription();</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Espresso extends Decorator {</p>

<p class=Code style='margin-left:0in'>  private float cost = 0.75f;</p>

<p class=Code style='margin-left:0in'>  private String description = &quot;
espresso&quot;;</p>

<p class=Code style='margin-left:0in'>  public Espresso(DrinkComponent
component) {</p>

<p class=Code style='margin-left:0in'>    super(component);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public float getTotalCost() {</p>

<p class=Code style='margin-left:0in'>    return component.getTotalCost() +
cost;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return component.getDescription() +</p>

<p class=Code style='margin-left:0in'>      description;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Decaf extends Decorator {</p>

<p class=Code style='margin-left:0in'>  private String description = &quot;
decaf&quot;;</p>

<p class=Code style='margin-left:0in'>  public Decaf(DrinkComponent component)
{</p>

<p class=Code style='margin-left:0in'>    super(component);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return component.getDescription() +</p>

<p class=Code style='margin-left:0in'>      description;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class FoamedMilk extends Decorator {</p>

<p class=Code style='margin-left:0in'>  private float cost = 0.25f;</p>

<p class=Code style='margin-left:0in'>  private String description = &quot;
foamed milk&quot;;</p>

<p class=Code style='margin-left:0in'>  public FoamedMilk(DrinkComponent
component) {</p>

<p class=Code style='margin-left:0in'>    super(component);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public float getTotalCost() {</p>

<p class=Code style='margin-left:0in'>    return component.getTotalCost() +
cost;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return component.getDescription() +</p>

<p class=Code style='margin-left:0in'>      description;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class SteamedMilk extends Decorator {</p>

<p class=Code style='margin-left:0in'>  private float cost = 0.25f;</p>

<p class=Code style='margin-left:0in'>  private String description = &quot;
steamed milk&quot;;</p>

<p class=Code style='margin-left:0in'>  public SteamedMilk(DrinkComponent
component) {</p>

<p class=Code style='margin-left:0in'>    super(component);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public float getTotalCost() {</p>

<p class=Code style='margin-left:0in'>    return component.getTotalCost() +
cost;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return component.getDescription() +</p>

<p class=Code style='margin-left:0in'>      description;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Whipped extends Decorator {</p>

<p class=Code style='margin-left:0in'>  private float cost = 0.25f;</p>

<p class=Code style='margin-left:0in'>  private String description = &quot;
whipped cream&quot;;</p>

<p class=Code style='margin-left:0in'>  public Whipped(DrinkComponent
component) {</p>

<p class=Code style='margin-left:0in'>    super(component);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public float getTotalCost() {</p>

<p class=Code style='margin-left:0in'>    return component.getTotalCost() +
cost;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return component.getDescription() +</p>

<p class=Code style='margin-left:0in'>      description;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Chocolate extends Decorator {</p>

<p class=Code style='margin-left:0in'>  private float cost = 0.25f;</p>

<p class=Code style='margin-left:0in'>  private String description = &quot;
chocolate&quot;;</p>

<p class=Code style='margin-left:0in'>  public Chocolate(DrinkComponent
component) {</p>

<p class=Code style='margin-left:0in'>    super(component);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public float getTotalCost() {</p>

<p class=Code style='margin-left:0in'>    return component.getTotalCost() +
cost;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return component.getDescription() +</p>

<p class=Code style='margin-left:0in'>      description;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class CoffeeShop2 extends TestCase
 {</p>

<p class=Code style='margin-left:0in'>  public void testCappuccino() {</p>

<p class=Code style='margin-left:0in'>    // This just makes sure it will
complete </p>

<p class=Code style='margin-left:0in'>    // without throwing an exception.</p>

<p class=Code style='margin-left:0in'>    // Create a plain cappucino</p>

<p class=Code style='margin-left:0in'>    DrinkComponent cappuccino = new
Espresso(</p>

<p class=Code style='margin-left:0in'>      new FoamedMilk(new Mug()));</p>

<p class=Code style='margin-left:0in'>    System.out.println(cappuccino.</p>

<p class=Code style='margin-left:0in'>      getDescription().trim() + &quot;:
$&quot; +</p>

<p class=Code style='margin-left:0in'>      cappuccino.getTotalCost());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void testCafeMocha() {</p>

<p class=Code style='margin-left:0in'>    // This just makes sure it will
complete </p>

<p class=Code style='margin-left:0in'>    // without throwing an exception.</p>

<p class=Code style='margin-left:0in'>    // Create a decaf cafe mocha with
whipped</p>

<p class=Code style='margin-left:0in'>    // cream</p>

<p class=Code style='margin-left:0in'>    DrinkComponent cafeMocha = new
Espresso(</p>

<p class=Code style='margin-left:0in'>      new SteamedMilk(new Chocolate(new
Whipped(</p>

<p class=Code style='margin-left:0in'>      new Decaf(new Mug())))));</p>

<p class=Code style='margin-left:0in'>   
System.out.println(cafeMocha.getDescription().</p>

<p class=Code style='margin-left:0in'>      trim() + &quot;: $&quot; +
cafeMocha.getTotalCost());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String[] args)
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(CoffeeShop2.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_179]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_180]#</span>This approach
would certainly provide the most flexibility and the smallest menu. You have a
small number of components to choose from, but assembling the description of
the coffee then becomes rather arduous. </p>

<p class=MsoNormal><span style='display:none'>#[BT_181]#</span>If you want to
describe a plain cappuccino, you create it with</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>new Espresso(new FoamedMilk(new Mug()))</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_182]#</span>Creating a decaf
Café Mocha with whipped cream requires an even longer description. </p>

<h3><a name="_Toc41169728">Compromise</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_183]#</span>The previous
approach takes too long to describe a coffee. There will also be certain
combinations that you will describe regularly, and it would be convenient to
have a quick way of describing them.</p>

<p class=MsoNormal><span style='display:none'>#[BT_184]#</span>The 3rd approach
is a mixture of the first 2 approaches, and combines flexibility with ease of
use. This compromise is achieved by creating a reasonably sized menu of basic
selections, which would often work exactly as they are, but if you wanted to
decorate them (whipped cream, decaf etc.) then you would use decorators to make
the modifications. This is the type of menu you are presented with in most
coffee shops.</p>

<p class=MsoNormal><span style='display:none'>#[BT_185]#</span><img border=0
width=449 height=200 src="TIPatterns_files/image005.gif"></p>

<p class=MsoNormal><span style='display:none'>#[BT_186]#</span>Here is how to
create a basic selection, as well as a decorated selection:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: decorator:compromise:CoffeeShop3.java</p>

<p class=Code style='margin-left:0in'>// Coffee example with a compromise of
basic</p>

<p class=Code style='margin-left:0in'>// combinations and decorators</p>

<p class=Code style='margin-left:0in'>package decorator.compromise;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>interface DrinkComponent {</p>

<p class=Code style='margin-left:0in'>  float getTotalCost();</p>

<p class=Code style='margin-left:0in'>  String getDescription();</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Espresso implements DrinkComponent
{</p>

<p class=Code style='margin-left:0in'>  private String description =
&quot;Espresso&quot;;</p>

<p class=Code style='margin-left:0in'>  private float cost = 0.75f;</p>

<p class=Code style='margin-left:0in'>  public float getTotalCost() {</p>

<p class=Code style='margin-left:0in'>    return cost;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return description;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class EspressoConPanna implements
DrinkComponent {</p>

<p class=Code style='margin-left:0in'>  private String description =
&quot;EspressoConPare&quot;;</p>

<p class=Code style='margin-left:0in'>  private float cost = 1;</p>

<p class=Code style='margin-left:0in'>  public float getTotalCost() {</p>

<p class=Code style='margin-left:0in'>    return cost;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return description;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Cappuccino implements
DrinkComponent {</p>

<p class=Code style='margin-left:0in'>  private float cost = 1;</p>

<p class=Code style='margin-left:0in'>  private String description =
&quot;Cappuccino&quot;;</p>

<p class=Code style='margin-left:0in'>  public float getTotalCost() {</p>

<p class=Code style='margin-left:0in'>    return cost;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return description;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class CafeLatte implements DrinkComponent
{</p>

<p class=Code style='margin-left:0in'>  private float cost = 1;</p>

<p class=Code style='margin-left:0in'>  private String description = &quot;Cafe
Late&quot;;</p>

<p class=Code style='margin-left:0in'>  public float getTotalCost() {</p>

<p class=Code style='margin-left:0in'>    return cost;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return description;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class CafeMocha implements DrinkComponent
{</p>

<p class=Code style='margin-left:0in'>  private float cost = 1.25f;</p>

<p class=Code style='margin-left:0in'>  private String description = &quot;Cafe
Mocha&quot;;</p>

<p class=Code style='margin-left:0in'>  public float getTotalCost() {</p>

<p class=Code style='margin-left:0in'>    return cost;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return description;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>abstract class Decorator implements
DrinkComponent {</p>

<p class=Code style='margin-left:0in'>  protected DrinkComponent component;</p>

<p class=Code style='margin-left:0in'>  public Decorator(DrinkComponent
component) {</p>

<p class=Code style='margin-left:0in'>    this.component = component;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public float getTotalCost() {</p>

<p class=Code style='margin-left:0in'>    return component.getTotalCost();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return component.getDescription();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class ExtraEspresso extends Decorator {</p>

<p class=Code style='margin-left:0in'>  private float cost = 0.75f;</p>

<p class=Code style='margin-left:0in'>  public ExtraEspresso(DrinkComponent
component) {</p>

<p class=Code style='margin-left:0in'>    super(component);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return component.getDescription() +</p>

<p class=Code style='margin-left:0in'>      &quot; extra espresso&quot;;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public float getTotalCost() {</p>

<p class=Code style='margin-left:0in'>    return cost +
component.getTotalCost();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Whipped extends Decorator {</p>

<p class=Code style='margin-left:0in'>  private float cost = 0.50f;</p>

<p class=Code style='margin-left:0in'>  public Whipped(DrinkComponent
component) {</p>

<p class=Code style='margin-left:0in'>    super(component);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public float getTotalCost() {</p>

<p class=Code style='margin-left:0in'>    return cost +
component.getTotalCost();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return component.getDescription() +</p>

<p class=Code style='margin-left:0in'>      &quot; whipped cream&quot;;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Decaf extends Decorator{</p>

<p class=Code style='margin-left:0in'>  public Decaf(DrinkComponent component)
{</p>

<p class=Code style='margin-left:0in'>    super(component);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return component.getDescription() +
&quot; decaf&quot;;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Dry extends Decorator {</p>

<p class=Code style='margin-left:0in'>  public Dry(DrinkComponent component) {</p>

<p class=Code style='margin-left:0in'>    super(component);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return component.getDescription() +</p>

<p class=Code style='margin-left:0in'>      &quot; extra foamed milk&quot;;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Wet extends Decorator {</p>

<p class=Code style='margin-left:0in'>  public Wet(DrinkComponent component) {</p>

<p class=Code style='margin-left:0in'>    super(component);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getDescription() {</p>

<p class=Code style='margin-left:0in'>    return component.getDescription() +</p>

<p class=Code style='margin-left:0in'>      &quot; extra steamed milk&quot;;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class CoffeeShop3 extends TestCase
 {</p>

<p class=Code style='margin-left:0in'>  public void testCappuccino() {</p>

<p class=Code style='margin-left:0in'>    // This just makes sure it will
complete </p>

<p class=Code style='margin-left:0in'>    // without throwing an exception.</p>

<p class=Code style='margin-left:0in'>    // Create a plain cappucino</p>

<p class=Code style='margin-left:0in'>    DrinkComponent cappuccino = new Cappuccino();</p>

<p class=Code style='margin-left:0in'>   
System.out.println(cappuccino.getDescription()</p>

<p class=Code style='margin-left:0in'>      + &quot;: $&quot; +
cappuccino.getTotalCost());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void testCafeMocha() {</p>

<p class=Code style='margin-left:0in'>    // This just makes sure it will
complete </p>

<p class=Code style='margin-left:0in'>    // without throwing an exception.</p>

<p class=Code style='margin-left:0in'>    // Create a decaf cafe mocha with
whipped</p>

<p class=Code style='margin-left:0in'>    // cream</p>

<p class=Code style='margin-left:0in'>    DrinkComponent cafeMocha = new
Whipped(</p>

<p class=Code style='margin-left:0in'>      new Decaf(new CafeMocha()));</p>

<p class=Code style='margin-left:0in'>   
System.out.println(cafeMocha.getDescription()</p>

<p class=Code style='margin-left:0in'>      + &quot;: $&quot; +
cafeMocha.getTotalCost());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String[] args)
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(CoffeeShop3.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_187]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_188]#</span>You can see that
creating a basic selection is quick and easy, which makes sense since they will
be described regularly.  Describing a decorated drink is more work than when
using a class per combination, but clearly less work than when only using
decorators.</p>

<p class=MsoNormal><span style='display:none'>#[BT_189]#</span>The final result
is not too many classes, but not too many decorators either. Most of the time
it's possible to get away without using any decorators at all, so we have the
benefits of both approaches.</p>

<h3><a name="_Toc41169729">Other considerations</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_190]#</span>What happens if
we decide to change the menu at a later stage, such as by adding a new type of
drink? If we had used the class per combination approach, the effect of adding
an extra such as syrup would be an exponential growth in the number of classes.
However, the implications to the all decorator or compromise approaches are the
same - one extra class is created. </p>

<p class=MsoNormal><span style='display:none'>#[BT_191]#</span>How about the
effect of changing the cost of steamed milk and foamed milk, when the price of
milk goes up? Having a class for each combination means that you need to change
a method in each class, and thus maintain many classes. By using decorators,
maintenance is reduced by defining the logic in one place. </p>

<h3><a name="_Toc41169730">Exercises</a></h3>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>1. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Add a Syrup class to the decorator approach described above. Then
create a Café Latte (you'll need to use steamed milk with an espresso) with
syrup.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>2. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Repeat Exercise 1 for the compromise approach.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>3. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Create a simple decorator system that models the fact that some
birds fly and some don’t, some swim and some don’t, and some do both.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>4. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Implement the decorator pattern to create a Pizza restaurant,
which has a set menu of choices as well as the option to design your own
pizza.  Follow the compromise approach to create a menu consisting of a
Margherita, Hawaiian, Regina, and Vegetarian pizzas, with toppings (decorators)
of Garlic, Olives, Spinach, Avocado, Feta and Pepperdews. Create a Hawaiian
pizza, as well as a Margherita decorated with Spinach, Feta, Pepperdews and
Olives.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>5. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>About <i>Decorator, </i>the <i>Design Patterns</i> book states:
“With decorators, responsibilities can be added and removed at run-time simply
by attaching and detaching them.” Implement the coffee decoration system to
allow this “simple” detaching of a responsibility from the middle of the list
of decorators of a complex coffee beverage.</p>

<p class=MsoNormal><span style='display:none'>#[BT_192]#</span></p>

</div>

<span style='font-size:11.0pt;font-family:Georgia;display:none'><br clear=all
style='page-break-before:right'>
</span>

<div class=Section11>

<h1 style='margin-left:.75in'><a name="_Toc462393592"></a><a
name="_Toc476705909"></a><a name="_Toc41169731">Connecting different types</a></h1>

<h2 style='margin-left:40.5pt'><a name="_Toc41169732"></a><a
name="_Toc476705910">Adapter</a></h2>

<p class=MsoNormal><i>Adapter</i> takes one type and produces an interface to
some other type. <span style='display:none'>#[BT_240]#</span>When you’ve got <i>this</i>,
and you need <i>that</i>, <i>Adapter</i> solves the problem. The only
requirement is to produce a <i>that</i>, and there are a number of ways you can
accomplish this adaptation.</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: adapter:SimpleAdapter.java</p>

<p class=Code style='margin-left:0in'>// &quot;Object Adapter&quot; from GoF
diagram</p>

<p class=Code style='margin-left:0in'>package adapter;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Target {</p>

<p class=Code style='margin-left:0in'>  public void request() {}</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Adaptee {</p>

<p class=Code style='margin-left:0in'>  public void specificRequest() {</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Adaptee:
SpecificRequest&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Adapter extends Target {</p>

<p class=Code style='margin-left:0in'>  private Adaptee adaptee;</p>

<p class=Code style='margin-left:0in'>  public Adapter(Adaptee a) {</p>

<p class=Code style='margin-left:0in'>    adaptee = a;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void request() {</p>

<p class=Code style='margin-left:0in'>    adaptee.specificRequest();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class SimpleAdapter extends
TestCase  {</p>

<p class=Code style='margin-left:0in'>  Adaptee a = new Adaptee();</p>

<p class=Code style='margin-left:0in'>  Target t = new Adapter(a);</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    t.request();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(SimpleAdapter.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: adapter:AdapterVariations.java</p>

<p class=Code style='margin-left:0in'>// Variations on the Adapter pattern.</p>

<p class=Code style='margin-left:0in'>package adapter;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class WhatIHave {</p>

<p class=Code style='margin-left:0in'>  public void g() {}</p>

<p class=Code style='margin-left:0in'>  public void h() {}</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>interface WhatIWant {</p>

<p class=Code style='margin-left:0in'>  void f();</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class SurrogateAdapter implements
WhatIWant {</p>

<p class=Code style='margin-left:0in'>  WhatIHave whatIHave;</p>

<p class=Code style='margin-left:0in'>  public SurrogateAdapter(WhatIHave wih)
{</p>

<p class=Code style='margin-left:0in'>    whatIHave = wih;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void f() {</p>

<p class=Code style='margin-left:0in'>    // Implement behavior using </p>

<p class=Code style='margin-left:0in'>    // methods in WhatIHave:</p>

<p class=Code style='margin-left:0in'>    whatIHave.g();</p>

<p class=Code style='margin-left:0in'>    whatIHave.h();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>  </p>

<p class=Code style='margin-left:0in'>class WhatIUse {</p>

<p class=Code style='margin-left:0in'>  public void op(WhatIWant wiw) {</p>

<p class=Code style='margin-left:0in'>    wiw.f();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// Approach 2: build adapter use into
op():</p>

<p class=Code style='margin-left:0in'>class WhatIUse2 extends WhatIUse {</p>

<p class=Code style='margin-left:0in'>  public void op(WhatIHave wih) {</p>

<p class=Code style='margin-left:0in'>    new SurrogateAdapter(wih).f();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// Approach 3: build adapter into
WhatIHave:</p>

<p class=Code style='margin-left:0in'>class WhatIHave2 extends WhatIHave </p>

<p class=Code style='margin-left:0in'>implements WhatIWant {</p>

<p class=Code style='margin-left:0in'>  public void f() {</p>

<p class=Code style='margin-left:0in'>    g();</p>

<p class=Code style='margin-left:0in'>    h();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// Approach 4: use an inner class:</p>

<p class=Code style='margin-left:0in'>class WhatIHave3 extends WhatIHave {</p>

<p class=Code style='margin-left:0in'>  private class InnerAdapter implements
WhatIWant{</p>

<p class=Code style='margin-left:0in'>    public void f() {</p>

<p class=Code style='margin-left:0in'>      g();</p>

<p class=Code style='margin-left:0in'>      h();</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public WhatIWant whatIWant() { </p>

<p class=Code style='margin-left:0in'>    return new InnerAdapter(); </p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class AdapterVariations extends
TestCase  {</p>

<p class=Code style='margin-left:0in'>  WhatIUse whatIUse = new WhatIUse();</p>

<p class=Code style='margin-left:0in'>  WhatIHave whatIHave = new WhatIHave();</p>

<p class=Code style='margin-left:0in'>  WhatIWant adapt= new SurrogateAdapter(whatIHave);</p>

<p class=Code style='margin-left:0in'>  WhatIUse2 whatIUse2 = new WhatIUse2();</p>

<p class=Code style='margin-left:0in'>  WhatIHave2 whatIHave2 = new
WhatIHave2();</p>

<p class=Code style='margin-left:0in'>  WhatIHave3 whatIHave3 = new
WhatIHave3();</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    whatIUse.op(adapt);</p>

<p class=Code style='margin-left:0in'>    // Approach 2:</p>

<p class=Code style='margin-left:0in'>    whatIUse2.op(whatIHave);</p>

<p class=Code style='margin-left:0in'>    // Approach 3:</p>

<p class=Code style='margin-left:0in'>    whatIUse.op(whatIHave2);</p>

<p class=Code style='margin-left:0in'>    // Approach 4:</p>

<p class=Code style='margin-left:0in'>    whatIUse.op(whatIHave3.whatIWant());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(AdapterVariations.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_241]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_242]#</span>I’m taking
liberties with the term “proxy” here, because in <i>Design Patterns</i> they
assert that a proxy must have an identical interface with the object that it is
a surrogate for. However, if you have the two words together: “proxy adapter,”
it is perhaps more reasonable.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169733">Bridge</a></h2>

<p class=MsoNormal>While researching <i>Bridge</i>, I discovered that it
appears to be the most poorly-described pattern in the GoF. I began to come to
this conclusion when reading Alan Shalloway’s chapter on <i>Bridge</i> in his
book <i>Design Patterns Explained</i> – he begins by pointing out that the
description in GoF left him quite unenlightened.</p>

<p class=MsoNormal>At a conference, I talked to two people who had written
about and were giving talks on design patterns, including <i>Bridge</i>. In two
separate discussions I got completely different perspectives on the structure
of <i>Bridge</i>.</p>

<p class=MsoNormal>Armed with misinformation, I delved back into the GoF and
realized that neither of the above perspectives agreed with the book. I also
found that the book did a miserable job of describing <i>Bridge</i>, except in
one place – not the general structure chart describing the pattern, which
wasn’t helpful, but in the structure chart describing their specific example.
Only if you stare at that for a bit does <i>Bridge</i> begin to make sense.</p>

<p class=MsoNormal>An important feature to understand when looking at <i>Bridge</i>
is that it is often a construct that is used to help you <i>write</i> code. You
may choose the objects you use for a particular situation at compile-time or
runtime, but the goal of <i>Bridge</i> is to allow you to structure your code
so that you can easily add new kinds of front-end objects which are implemented
with functionality in new kinds of back-end objects. Thus, both front-end and
back-end can vary independently of each other.</p>

<p class=MsoNormal>The front-end classes can have completely different
interfaces from each other, and typically do. What they have in common is that
they can implement their functionality using facilities from any number of
different back-end objects. The back-end objects also don’t have the same
interface. The only thing the back-end objects must have in common is that they
implement the same kind of functionality – for example, a group of different
ways to implement a graphics library or a set of different data-storage
solutions.</p>

<p class=MsoNormal><i>Bridge</i> is really a code-organization tool that allows
you to add in any number of new front-end services that implement their
operations by delegating to any number of back-end options. Using <i>Bridge</i>,
you can accomplish this without the normal combinatorial explosion of
possibilities that would otherwise occur. But keep in mind that the vector of
change with <i>Bridge</i> is typically happening at coding time: it keeps your
code organized when you are dealing with an increasing number of options for
implementing functionality.</p>

<p class=MsoNormal><img border=0 width=504 height=276
src="TIPatterns_files/image006.gif"></p>

<p class=MsoNormal>Here’s an example whose sole purpose is to demonstrate the
structure of <i>Bridge</i> (it implements the above diagram):</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: bridge:BridgeStructure.java</p>

<p class=Code style='margin-left:0in'>// A demonstration of the structure and
operation</p>

<p class=Code style='margin-left:0in'>// of the Bridge Pattern.</p>

<p class=Code style='margin-left:0in'>package bridge;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Abstraction {</p>

<p class=Code style='margin-left:0in'>  private Implementation implementation;</p>

<p class=Code style='margin-left:0in'>  public Abstraction(Implementation imp)
{</p>

<p class=Code style='margin-left:0in'>    implementation = imp;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  // Abstraction used by the various
front-end </p>

<p class=Code style='margin-left:0in'>  // objects in order to implement their </p>

<p class=Code style='margin-left:0in'>  // different interfaces.</p>

<p class=Code style='margin-left:0in'>  public void service1() {</p>

<p class=Code style='margin-left:0in'>    // Implement this feature using some </p>

<p class=Code style='margin-left:0in'>    // combination of back-end
implementation:</p>

<p class=Code style='margin-left:0in'>    implementation.facility1();</p>

<p class=Code style='margin-left:0in'>    implementation.facility2();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void service2() {</p>

<p class=Code style='margin-left:0in'>    // Implement this feature using some
other</p>

<p class=Code style='margin-left:0in'>    // combination of back-end
implementation:</p>

<p class=Code style='margin-left:0in'>    implementation.facility2();</p>

<p class=Code style='margin-left:0in'>    implementation.facility3();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void service3() {</p>

<p class=Code style='margin-left:0in'>    // Implement this feature using some
other</p>

<p class=Code style='margin-left:0in'>    // combination of back-end
implementation:</p>

<p class=Code style='margin-left:0in'>    implementation.facility1();</p>

<p class=Code style='margin-left:0in'>    implementation.facility2();</p>

<p class=Code style='margin-left:0in'>    implementation.facility4();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  // For use by subclasses:</p>

<p class=Code style='margin-left:0in'>  protected Implementation
getImplementation() { </p>

<p class=Code style='margin-left:0in'>    return implementation; </p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class ClientService1 extends Abstraction
{</p>

<p class=Code style='margin-left:0in'>  public ClientService1(Implementation
imp) { super(imp); }</p>

<p class=Code style='margin-left:0in'>  public void serviceA() {</p>

<p class=Code style='margin-left:0in'>    service1();</p>

<p class=Code style='margin-left:0in'>    service2();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void serviceB() {</p>

<p class=Code style='margin-left:0in'>    service3();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class ClientService2 extends Abstraction
{</p>

<p class=Code style='margin-left:0in'>  public ClientService2(Implementation
imp) { super(imp); }</p>

<p class=Code style='margin-left:0in'>  public void serviceC() {</p>

<p class=Code style='margin-left:0in'>    service2();</p>

<p class=Code style='margin-left:0in'>    service3();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void serviceD() {</p>

<p class=Code style='margin-left:0in'>    service1();</p>

<p class=Code style='margin-left:0in'>    service3();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void serviceE() {</p>

<p class=Code style='margin-left:0in'>    getImplementation().facility3();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>interface Implementation {</p>

<p class=Code style='margin-left:0in'>  // The common implementation provided
by the </p>

<p class=Code style='margin-left:0in'>  // back-end objects, each in their own
way.</p>

<p class=Code style='margin-left:0in'>  void facility1();</p>

<p class=Code style='margin-left:0in'>  void facility2();</p>

<p class=Code style='margin-left:0in'>  void facility3();</p>

<p class=Code style='margin-left:0in'>  void facility4();</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Library1 {</p>

<p class=Code style='margin-left:0in'>  public void method1() {</p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Library1.method1()&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void method2() {</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Library1.method2()&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Library2 {</p>

<p class=Code style='margin-left:0in'>  public void operation1() {</p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Library2.operation1()&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void operation2() {</p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Library2.operation2()&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void operation3() {</p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Library2.operation3()&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Implementation1 implements
Implementation {</p>

<p class=Code style='margin-left:0in'>  // Each facility delegates to a
different library</p>

<p class=Code style='margin-left:0in'>  // in order to fulfill the obligations.</p>

<p class=Code style='margin-left:0in'>  private Library1 delegate = new
Library1();</p>

<p class=Code style='margin-left:0in'>  public void facility1() {</p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Implementation1.facility1&quot;);</p>

<p class=Code style='margin-left:0in'>    delegate.method1();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void facility2() {</p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Implementation1.facility2&quot;);</p>

<p class=Code style='margin-left:0in'>    delegate.method2();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void facility3() {</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Implementation1.facility3&quot;);</p>

<p class=Code style='margin-left:0in'>    delegate.method2();</p>

<p class=Code style='margin-left:0in'>    delegate.method1();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void facility4() {</p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Implementation1.facility4&quot;);</p>

<p class=Code style='margin-left:0in'>    delegate.method1();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>  </p>

<p class=Code style='margin-left:0in'>class Implementation2 implements
Implementation {</p>

<p class=Code style='margin-left:0in'>  private Library2 delegate = new
Library2();</p>

<p class=Code style='margin-left:0in'>  public void facility1() {</p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Implementation2.facility1&quot;);</p>

<p class=Code style='margin-left:0in'>    delegate.operation1();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void facility2() {</p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Implementation2.facility2&quot;);</p>

<p class=Code style='margin-left:0in'>    delegate.operation2();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void facility3() {</p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Implementation2.facility3&quot;);</p>

<p class=Code style='margin-left:0in'>    delegate.operation3();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void facility4() {</p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;Implementation2.facility4&quot;);</p>

<p class=Code style='margin-left:0in'>    delegate.operation1();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class BridgeStructure extends
TestCase  {</p>

<p class=Code style='margin-left:0in'>  public void test1() {</p>

<p class=Code style='margin-left:0in'>    // Here, the implementation is
determined by </p>

<p class=Code style='margin-left:0in'>    // the client at creation time:</p>

<p class=Code style='margin-left:0in'>    ClientService1 cs1 = </p>

<p class=Code style='margin-left:0in'>      new ClientService1(new
Implementation1());</p>

<p class=Code style='margin-left:0in'>    cs1.serviceA();</p>

<p class=Code style='margin-left:0in'>    cs1.serviceB();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void test2() {</p>

<p class=Code style='margin-left:0in'>    ClientService1 cs1 = </p>

<p class=Code style='margin-left:0in'>      new ClientService1(new
Implementation2());</p>

<p class=Code style='margin-left:0in'>    cs1.serviceA();</p>

<p class=Code style='margin-left:0in'>    cs1.serviceB();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void test3() {</p>

<p class=Code style='margin-left:0in'>    ClientService2 cs2 = </p>

<p class=Code style='margin-left:0in'>      new ClientService2(new
Implementation1());</p>

<p class=Code style='margin-left:0in'>    cs2.serviceC();</p>

<p class=Code style='margin-left:0in'>    cs2.serviceD();</p>

<p class=Code style='margin-left:0in'>    cs2.serviceE();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void test4() {</p>

<p class=Code style='margin-left:0in'>    ClientService2 cs2 = </p>

<p class=Code style='margin-left:0in'>      new ClientService2(new
Implementation2());</p>

<p class=Code style='margin-left:0in'>    cs2.serviceC();</p>

<p class=Code style='margin-left:0in'>    cs2.serviceD();</p>

<p class=Code style='margin-left:0in'>    cs2.serviceE();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String[] args)
{</p>

<p class=Code style='margin-left:0in'>   
junit.textui.TestRunner.run(BridgeStructure.class);</p>

<p class=Code style='margin-left:0in'>  }  </p>

<p class=CodeInline style='margin-left:0in'>} ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<p class=MsoNormal>The front-end base class provides the operations used to
fulfill the front-end derived classes, <i>in terms of the methods of the
back-end base class</i>. Thus, any back-end derived class can be used to
perform the operations needed by the front-end class. Notice that the bridging
happens in this sequence of steps, each of which is providing a layer of
abstraction. Here, <b>Implementation</b> is defined as an interface to
emphasize that all the functionality is implemented in the back-end derived
classes, and none in the back-end base.</p>

<p class=MsoNormal>The back-end derived classes perform the operations defined
in the base class by delegating to objects (of class <b>Library1 </b>and <b>Library2</b>,
in this case)<b> </b>that typically have radically different interfaces, but
somehow provide the same functionality (this is one of the important objectives
of <i>Bridge</i>). Effectively, each of the back-end implementations is an
adapter to a different library or tool used to implement the desired functionality
in a different way.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169734">Exercises</a></h2>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>1. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Modify <b>BridgeStructure.java</b> so that the implementations
are chosen using a factory.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>2. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Modify <b>BridgeStructure.java</b> to use delegation instead of
inheritance on the front end. What benefits and drawbacks do you see by using
delegation rather than inheritance?</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>3. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Create an example of Bridge with an abstraction that is an <i>associative
array</i>. This allows you to fetch elements by passing in a key Object. The
constructor provides an initial set of key-value pairs which are placed in an
array. As long as you only fetch elements, the array is used, but as soon as
you set a new key-value pair, the implementation is switched to a map.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>4. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Use a bridge along with the collections in <b>java.util.collections</b>
to create stack and queue classes using an <b>ArrayList</b>. After you get the
system working, add a double-ended queue class. Now add a <b>LinkedList</b> as
an implementation. These steps will demonstrate how <i>Bridge</i> allows you to
add new front-end classes and new back-end classes in your code, with minimal
impact.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>5. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Create a <i>Bridge</i> that provides a connection between various
kinds of bookkeeping programs (along with their interfaces and data formats)
and different banks (which provide different kinds of services and interfaces).</p>

<p class=Exercises style='text-indent:-.75in;display:none'><span
style='font-size:12.0pt;font-family:Verdana;display:none'>6. </span><span
style='display:none'>&nbsp;</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_250]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_251]#</span></p>

</div>

<span style='font-size:11.0pt;font-family:Georgia;display:none'><br clear=all
style='page-break-before:right'>
</span>

<div class=Section12>

<h1 style='margin-left:.75in'><a name="_Toc41169735">Flexible structure</a></h1>

<h2 style='text-indent:-.25in'><a name="_Toc41169736">Composite</a></h2>

<p class=MsoNormal>The important thing here is that all elements in the
part-whole have operations, and that performing an operation on a
node/composite also performs that operation on any children of that
node/composite. GoF includes implementation details of containment and
visitation of children in the interface of the base class, but this doesn’t
seem necessary. In the following example, the <b>Composite</b> class simply
inherits <b>ArrayList</b> in order to gain its containment abilities.</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: composite:CompositeStructure.java</p>

<p class=Code style='margin-left:0in'>package composite;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>interface Component {</p>

<p class=Code style='margin-left:0in'>  void operation();</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Leaf implements Component {</p>

<p class=Code style='margin-left:0in'>  private String name;</p>

<p class=Code style='margin-left:0in'>  public Leaf(String name) { this.name =
name; }</p>

<p class=Code style='margin-left:0in'>  public String toString() { return name;
}</p>

<p class=Code style='margin-left:0in'>  public void operation() {</p>

<p class=Code style='margin-left:0in'>    System.out.println(this);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Node extends ArrayList implements
Component {</p>

<p class=Code style='margin-left:0in'>  private String name;</p>

<p class=Code style='margin-left:0in'>  public Node(String name) { this.name =
name; }</p>

<p class=Code style='margin-left:0in'>  public String toString() { return name;
}</p>

<p class=Code style='margin-left:0in'>  public void operation() {</p>

<p class=Code style='margin-left:0in'>    System.out.println(this);</p>

<p class=Code style='margin-left:0in'>    for(Iterator it = iterator();
it.hasNext(); )</p>

<p class=Code style='margin-left:0in'>      ((Component)it.next()).operation();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class CompositeStructure extends
TestCase {</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    Node root = new Node(&quot;root&quot;);</p>

<p class=Code style='margin-left:0in'>    root.add(new
Leaf(&quot;Leaf1&quot;));</p>

<p class=Code style='margin-left:0in'>    Node c2 = new
Node(&quot;Node1&quot;);</p>

<p class=Code style='margin-left:0in'>    c2.add(new Leaf(&quot;Leaf2&quot;));</p>

<p class=Code style='margin-left:0in'>    c2.add(new Leaf(&quot;Leaf3&quot;));</p>

<p class=Code style='margin-left:0in'>    root.add(c2);</p>

<p class=Code style='margin-left:0in'>    c2 = new Node(&quot;Node2&quot;);</p>

<p class=Code style='margin-left:0in'>    c2.add(new Leaf(&quot;Leaf4&quot;));</p>

<p class=Code style='margin-left:0in'>    c2.add(new Leaf(&quot;Leaf5&quot;));</p>

<p class=Code style='margin-left:0in'>    root.add(c2);</p>

<p class=Code style='margin-left:0in'>    root.operation();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>   
junit.textui.TestRunner.run(CompositeStructure.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=CodeInline style='margin-left:0in'>} ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<p class=MsoNormal>While this approach seems to be “the simplest thing that
could possibly work,” it’s possible that in a larger system problems could
arise. However, it’s probably best to start with the simplest approach and
change it only if the situation demands.</p>

<h1 style='margin-left:.75in'><a name="_Toc41169737">System decoupling</a></h1>

<h2 style='margin-left:40.5pt'><a name="_Toc41169738"></a><a
name="_Toc476705914"></a><a name="_Toc462393595">Observer</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_383]#</span>Like the other
forms of callback, this contains a hook point where you can change code. The
difference is in the observer’s completely dynamic nature. It is often used for
the specific case of changes based on other object’s change of state, but is
also the basis of event management. Anytime you want to decouple the source of
the call from the called code in a completely dynamic way.</p>

<p class=MsoNormal><span style='display:none'>#[BT_384]#</span>The observer pattern solves a fairly common problem: What if a group of objects needs to
update themselves when some object changes state? This can be seen in the
“model-view” aspect of Smalltalk’s MVC (model-view-controller), or the
almost-equivalent “Document-View Architecture.” Suppose that you have some data
(the “document”) and more than one view, say a plot and a textual view. When
you change the data, the two views must know to update themselves, and that’s
what the observer facilitates. It’s a common enough problem that its solution
has been made a part of the standard <b>java.util</b> library.</p>

<p class=MsoNormal><span style='display:none'>#[BT_385]#</span>There are two
types of objects used to implement the observer pattern in Java. The <b>Observable</b> class keeps track of everybody who wants to be informed when a
change happens, whether the “state” has changed or not. When someone says “OK,
everybody should check and potentially update themselves,” the <b>Observable</b>
class performs this task by calling the <b>notifyObservers(&nbsp;)</b> method for each one on the list. The <b>notifyObservers(&nbsp;)</b> method is part of the
base class <b>Observable</b>.</p>

<p class=MsoNormal><span style='display:none'>#[BT_386]#</span>There are actually
two “things that change” in the observer pattern: the quantity of observing
objects and the way an update occurs. That is, the observer pattern allows you
to modify both of these without affecting the surrounding code.</p>

<p class=MsoNormal><span style='display:none'>#[BT_387]#</span>------------- </p>

<p class=MsoNormal><b><span style='display:none'>#[BT_388]#</span>Observer</b>
is an “interface” class that only has one member function, <b>update(&nbsp;)</b>.
This function is called by the object that’s being observed, when that object
decides its time to update all its observers. The arguments are optional; you
could have an <b>update(&nbsp;)</b> with no arguments and that would still fit
the observer pattern; however this is more general—it allows the observed
object to pass the object that caused the update (since an <b>Observer </b>may
be registered with more than one observed object) and any extra information if
that’s helpful, rather than forcing the <b>Observer</b> object to hunt around
to see who is updating and to fetch any other information it needs.</p>

<p class=MsoNormal><span style='display:none'>#[BT_389]#</span>The “observed
object” that decides when and how to do the updating will be called the <b>Observable</b>.</p>

<p class=MsoNormal><b><span style='display:none'>#[BT_390]#</span>Observable</b>
has a flag to indicate whether it’s been changed. In a simpler design, there
would be no flag; if something happened, everyone would be notified. The flag
allows you to wait, and only notify the <b>Observer</b>s when you decide the time
is right. Notice, however, that the control of the flag’s state is <b>protected</b>,
so that only an inheritor can decide what constitutes a change, and not the end
user of the resulting derived <b>Observer</b> class.</p>

<p class=MsoNormal><span style='display:none'>#[BT_391]#</span>Most of the work
is done in <b>notifyObservers(&nbsp;)</b>. If the <b>changed</b> flag has not
been set, this does nothing. Otherwise, it first clears the <b>changed</b> flag
so repeated calls to <b>notifyObservers(&nbsp;)</b> won’t waste time. This is
done before notifying the observers in case the calls to <b>update(&nbsp;)</b>
do anything that causes a change back to this <b>Observable</b> object. Then it
moves through the <b>set</b> and calls back to the <b>update(&nbsp;)</b> member
function of each <b>Observer</b>. </p>

<p class=MsoNormal><span style='display:none'>#[BT_392]#</span>At first it may
appear that you can use an ordinary <b>Observable</b> object to manage the
updates. But this doesn’t work; to get an effect, you <i>must</i> inherit from <b>Observable</b>
and somewhere in your derived-class code call <b>setChanged(&nbsp;)</b>. This is the member function that sets the “changed” flag,
which means that when you call <b>notifyObservers(&nbsp;)</b> all of the
observers will, in fact, get notified. <i>Where</i> you call <b>setChanged(&nbsp;)</b>
depends on the logic of your program.</p>

<h3><a name="_Toc41169739">Observing flowers</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_393]#</span>Here is an
example of the observer pattern:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: observer:ObservedFlower.java</p>

<p class=Code style='margin-left:0in'>// Demonstration of &quot;observer&quot;
pattern.</p>

<p class=Code style='margin-left:0in'>package observer;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Flower {</p>

<p class=Code style='margin-left:0in'>  private boolean isOpen;</p>

<p class=Code style='margin-left:0in'>  private OpenNotifier oNotify = </p>

<p class=Code style='margin-left:0in'>    new OpenNotifier();</p>

<p class=Code style='margin-left:0in'>  private CloseNotifier cNotify = </p>

<p class=Code style='margin-left:0in'>    new CloseNotifier();</p>

<p class=Code style='margin-left:0in'>  public Flower() { isOpen = false; }</p>

<p class=Code style='margin-left:0in'>  public void open() { // Opens its
petals</p>

<p class=Code style='margin-left:0in'>    isOpen = true;</p>

<p class=Code style='margin-left:0in'>    oNotify.notifyObservers();</p>

<p class=Code style='margin-left:0in'>    cNotify.open();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void close() { // Closes its
petals</p>

<p class=Code style='margin-left:0in'>    isOpen = false;</p>

<p class=Code style='margin-left:0in'>    cNotify.notifyObservers();</p>

<p class=Code style='margin-left:0in'>    oNotify.close();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public Observable opening() { return
oNotify; }</p>

<p class=Code style='margin-left:0in'>  public Observable closing() { return
cNotify; }</p>

<p class=Code style='margin-left:0in'>  private class OpenNotifier extends
Observable {</p>

<p class=Code style='margin-left:0in'>    private boolean alreadyOpen = false;</p>

<p class=Code style='margin-left:0in'>    public void notifyObservers() {</p>

<p class=Code style='margin-left:0in'>      if(isOpen &amp;&amp; !alreadyOpen)
{</p>

<p class=Code style='margin-left:0in'>        setChanged();</p>

<p class=Code style='margin-left:0in'>        super.notifyObservers();</p>

<p class=Code style='margin-left:0in'>        alreadyOpen = true;</p>

<p class=Code style='margin-left:0in'>      }</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    public void close() { alreadyOpen =
false; }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  private class CloseNotifier extends
Observable{</p>

<p class=Code style='margin-left:0in'>    private boolean alreadyClosed =
false;</p>

<p class=Code style='margin-left:0in'>    public void notifyObservers() {</p>

<p class=Code style='margin-left:0in'>      if(!isOpen &amp;&amp;
!alreadyClosed) {</p>

<p class=Code style='margin-left:0in'>        setChanged();</p>

<p class=Code style='margin-left:0in'>        super.notifyObservers();</p>

<p class=Code style='margin-left:0in'>        alreadyClosed = true;</p>

<p class=Code style='margin-left:0in'>      }</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    public void open() { alreadyClosed =
false; }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Bee {</p>

<p class=Code style='margin-left:0in'>  private String name;</p>

<p class=Code style='margin-left:0in'>  private OpenObserver openObsrv = </p>

<p class=Code style='margin-left:0in'>    new OpenObserver();</p>

<p class=Code style='margin-left:0in'>  private CloseObserver closeObsrv = </p>

<p class=Code style='margin-left:0in'>    new CloseObserver();</p>

<p class=Code style='margin-left:0in'>  public Bee(String nm)  { name = nm; }</p>

<p class=Code style='margin-left:0in'>  // An inner class for observing
openings:</p>

<p class=Code style='margin-left:0in'>  private class OpenObserver implements
Observer{</p>

<p class=Code style='margin-left:0in'>    public void update(Observable ob,
Object a) {</p>

<p class=Code style='margin-left:0in'>      System.out.println(&quot;Bee &quot;
+ name </p>

<p class=Code style='margin-left:0in'>        + &quot;'s breakfast
time!&quot;);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  // Another inner class for closings:</p>

<p class=Code style='margin-left:0in'>  private class CloseObserver implements
Observer{</p>

<p class=Code style='margin-left:0in'>    public void update(Observable ob,
Object a) {</p>

<p class=Code style='margin-left:0in'>      System.out.println(&quot;Bee &quot;
+ name </p>

<p class=Code style='margin-left:0in'>        + &quot;'s bed time!&quot;);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public Observer openObserver() { </p>

<p class=Code style='margin-left:0in'>    return openObsrv; </p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public Observer closeObserver() { </p>

<p class=Code style='margin-left:0in'>    return closeObsrv;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Hummingbird {</p>

<p class=Code style='margin-left:0in'>  private String name;</p>

<p class=Code style='margin-left:0in'>  private OpenObserver openObsrv = </p>

<p class=Code style='margin-left:0in'>    new OpenObserver();</p>

<p class=Code style='margin-left:0in'>  private CloseObserver closeObsrv = </p>

<p class=Code style='margin-left:0in'>    new CloseObserver();</p>

<p class=Code style='margin-left:0in'>  public Hummingbird(String nm) { name =
nm; }</p>

<p class=Code style='margin-left:0in'>  private class OpenObserver implements
Observer{</p>

<p class=Code style='margin-left:0in'>    public void update(Observable ob,
Object a) {</p>

<p class=Code style='margin-left:0in'>     
System.out.println(&quot;Hummingbird &quot; + name </p>

<p class=Code style='margin-left:0in'>        + &quot;'s breakfast
time!&quot;);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  private class CloseObserver implements
Observer{</p>

<p class=Code style='margin-left:0in'>    public void update(Observable ob,
Object a) {</p>

<p class=Code style='margin-left:0in'>      System.out.println(&quot;Hummingbird
&quot; + name </p>

<p class=Code style='margin-left:0in'>        + &quot;'s bed time!&quot;);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public Observer openObserver() { </p>

<p class=Code style='margin-left:0in'>    return openObsrv; </p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public Observer closeObserver() { </p>

<p class=Code style='margin-left:0in'>    return closeObsrv;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class ObservedFlower extends
TestCase {</p>

<p class=Code style='margin-left:0in'>  Flower f = new Flower();</p>

<p class=Code style='margin-left:0in'>  Bee </p>

<p class=Code style='margin-left:0in'>    ba = new Bee(&quot;A&quot;), </p>

<p class=Code style='margin-left:0in'>    bb = new Bee(&quot;B&quot;);</p>

<p class=Code style='margin-left:0in'>  Hummingbird </p>

<p class=Code style='margin-left:0in'>    ha = new Hummingbird(&quot;A&quot;), </p>

<p class=Code style='margin-left:0in'>    hb = new Hummingbird(&quot;B&quot;);</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>   
f.opening().addObserver(ha.openObserver());</p>

<p class=Code style='margin-left:0in'>    f.opening().addObserver(hb.openObserver());</p>

<p class=Code style='margin-left:0in'>   
f.opening().addObserver(ba.openObserver());</p>

<p class=Code style='margin-left:0in'>   
f.opening().addObserver(bb.openObserver());</p>

<p class=Code style='margin-left:0in'>   
f.closing().addObserver(ha.closeObserver());</p>

<p class=Code style='margin-left:0in'>   
f.closing().addObserver(hb.closeObserver());</p>

<p class=Code style='margin-left:0in'>   
f.closing().addObserver(ba.closeObserver());</p>

<p class=Code style='margin-left:0in'>   
f.closing().addObserver(bb.closeObserver());</p>

<p class=Code style='margin-left:0in'>    // Hummingbird B decides to sleep in:</p>

<p class=Code style='margin-left:0in'>    f.opening().deleteObserver(</p>

<p class=Code style='margin-left:0in'>      hb.openObserver());</p>

<p class=Code style='margin-left:0in'>    // A change that interests observers:</p>

<p class=Code style='margin-left:0in'>    f.open();</p>

<p class=Code style='margin-left:0in'>    f.open(); // It's already open, no
change.</p>

<p class=Code style='margin-left:0in'>    // Bee A doesn't want to go to bed:</p>

<p class=Code style='margin-left:0in'>    f.closing().deleteObserver(</p>

<p class=Code style='margin-left:0in'>      ba.closeObserver());</p>

<p class=Code style='margin-left:0in'>    f.close();</p>

<p class=Code style='margin-left:0in'>    f.close(); // It's already closed; no
change</p>

<p class=Code style='margin-left:0in'>    f.opening().deleteObservers();</p>

<p class=Code style='margin-left:0in'>    f.open();</p>

<p class=Code style='margin-left:0in'>    f.close();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>   
junit.textui.TestRunner.run(ObservedFlower.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span style='display:none'>#[BT_394]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_395]#</span>The events of
interest are that a <b>Flower</b> can open or close. Because of the use of the
inner class idiom, both these events can be separately observable phenomena. <b>OpenNotifier</b>
and <b>CloseNotifier</b> both inherit <b>Observable</b>, so they have access to
<b>setChanged(&nbsp;)</b> and can be handed to anything that needs an <b>Observable</b>.</p>

<p class=MsoNormal><span style='display:none'>#[BT_396]#</span>The inner class
idiom also comes in handy to define more than one kind of <b>Observer</b>, in <b>Bee</b>
and <b>Hummingbird</b>, since both those classes may want to independently
observe <b>Flower</b> openings and closings. Notice how the inner class idiom
provides something that has most of the benefits of inheritance (the ability to
access the <b>private</b> data in the outer class, for example) without the
same restrictions.</p>

<p class=MsoNormal><span style='display:none'>#[BT_397]#</span>In <b>main(&nbsp;)</b>,
you can see one of the prime benefits of the observer pattern: the ability to
change behavior at run time by dynamically registering and un-registering <b>Observer</b>s
with <b>Observable</b>s. </p>

<p class=MsoNormal><span style='display:none'>#[BT_398]#</span>If you study the
code above you’ll see that <b>OpenNotifier </b>and <b>CloseNotifier</b> use the
basic <b>Observable</b> interface. This means that you could inherit other
completely different <b>Observer</b> classes; the only connection the <b>Observer</b>s
have with <b>Flower</b>s is the <b>Observer</b> interface.</p>

<h3><a name="_Toc462393596"></a><a name="_Toc41169740"></a><a
name="_Toc476705915">A visual example of observers</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_399]#</span>The following
example is similar to the <b>ColorBoxes</b> example from Chapter 14 in <i>Thinking
in Java, 2<sup>nd</sup> Edition</i>. Boxes are placed in a grid on the screen
and each one is initialized to a random color. In addition, each box <b>implements</b>
the <b>Observer</b> interface and is registered with an <b>Observable</b>
object. When you click on a box, all of the other boxes are notified that a
change has been made because the <b>Observable</b> object automatically calls
each <b>Observer </b>object’s <b>update(&nbsp;)</b> method. Inside this method,
the box checks to see if it’s adjacent to the one that was clicked, and if so
it changes its color to match the clicked box.</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: observer:BoxObserver.java</p>

<p class=Code style='margin-left:0in'>// Demonstration of Observer pattern
using</p>

<p class=Code style='margin-left:0in'>// Java's built-in observer classes.</p>

<p class=Code style='margin-left:0in'>package observer;</p>

<p class=Code style='margin-left:0in'>import javax.swing.*;</p>

<p class=Code style='margin-left:0in'>import java.awt.*;</p>

<p class=Code style='margin-left:0in'>import java.awt.event.*;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// You must inherit a new type of
Observable:</p>

<p class=Code style='margin-left:0in'>class BoxObservable extends Observable {</p>

<p class=Code style='margin-left:0in'>  public void notifyObservers(Object b) {</p>

<p class=Code style='margin-left:0in'>    // Otherwise it won't propagate
changes:</p>

<p class=Code style='margin-left:0in'>    setChanged();</p>

<p class=Code style='margin-left:0in'>    super.notifyObservers(b);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class BoxObserver extends JFrame {</p>

<p class=Code style='margin-left:0in'>  Observable notifier = new
BoxObservable();</p>

<p class=Code style='margin-left:0in'>  public BoxObserver(int grid) {</p>

<p class=Code style='margin-left:0in'>    setTitle(&quot;Demonstrates Observer
pattern&quot;);</p>

<p class=Code style='margin-left:0in'>    Container cp = getContentPane();</p>

<p class=Code style='margin-left:0in'>    cp.setLayout(new GridLayout(grid,
grid));</p>

<p class=Code style='margin-left:0in'>    for(int x = 0; x &lt; grid; x++)</p>

<p class=Code style='margin-left:0in'>      for(int y = 0; y &lt; grid; y++)</p>

<p class=Code style='margin-left:0in'>        cp.add(new OCBox(x, y,
notifier));</p>

<p class=Code style='margin-left:0in'>  }   </p>

<p class=Code style='margin-left:0in'>  public static void main(String[] args)
{</p>

<p class=Code style='margin-left:0in'>    int grid = 8;</p>

<p class=Code style='margin-left:0in'>    if(args.length &gt; 0)</p>

<p class=Code style='margin-left:0in'>      grid = Integer.parseInt(args[0]);</p>

<p class=Code style='margin-left:0in'>    JFrame f = new BoxObserver(grid);</p>

<p class=Code style='margin-left:0in'>    f.setSize(500, 400);</p>

<p class=Code style='margin-left:0in'>    f.setVisible(true);</p>

<p class=Code style='margin-left:0in'>   
f.setDefaultCloseOperation(EXIT_ON_CLOSE);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class OCBox extends JPanel implements
Observer {</p>

<p class=Code style='margin-left:0in'>  Observable notifier;</p>

<p class=Code style='margin-left:0in'>  int x, y; // Locations in grid</p>

<p class=Code style='margin-left:0in'>  Color cColor = newColor();</p>

<p class=Code style='margin-left:0in'>  static final Color[] colors = { </p>

<p class=Code style='margin-left:0in'>    Color.BLACK, Color.BLUE, Color.CYAN, </p>

<p class=Code style='margin-left:0in'>    Color.DARK_GRAY, Color.GRAY,
Color.GREEN,</p>

<p class=Code style='margin-left:0in'>    Color.LIGHT_GRAY, Color.MAGENTA, </p>

<p class=Code style='margin-left:0in'>    Color.ORANGE, Color.PINK, Color.RED, </p>

<p class=Code style='margin-left:0in'>    Color.WHITE, Color.YELLOW </p>

<p class=Code style='margin-left:0in'>  };</p>

<p class=Code style='margin-left:0in'>  static Random rand = new Random();</p>

<p class=Code style='margin-left:0in'>  static final Color newColor() {</p>

<p class=Code style='margin-left:0in'>    return
colors[rand.nextInt(colors.length)];</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  OCBox(int x, int y, Observable
notifier) {</p>

<p class=Code style='margin-left:0in'>    this.x = x;</p>

<p class=Code style='margin-left:0in'>    this.y = y;</p>

<p class=Code style='margin-left:0in'>    notifier.addObserver(this);</p>

<p class=Code style='margin-left:0in'>    this.notifier = notifier;</p>

<p class=Code style='margin-left:0in'>    addMouseListener(new ML());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void paintComponent(Graphics g)
{</p>

<p class=Code style='margin-left:0in'>    super.paintComponent(g);</p>

<p class=Code style='margin-left:0in'>    g.setColor(cColor);</p>

<p class=Code style='margin-left:0in'>    Dimension s = getSize();</p>

<p class=Code style='margin-left:0in'>    g.fillRect(0, 0, s.width, s.height);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  class ML extends MouseAdapter {</p>

<p class=Code style='margin-left:0in'>    public void mousePressed(MouseEvent
e) {</p>

<p class=Code style='margin-left:0in'>     
notifier.notifyObservers(OCBox.this);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void update(Observable o, Object
arg) {</p>

<p class=Code style='margin-left:0in'>    OCBox clicked = (OCBox)arg;</p>

<p class=Code style='margin-left:0in'>    if(nextTo(clicked)) {</p>

<p class=Code style='margin-left:0in'>      cColor = clicked.cColor;</p>

<p class=Code style='margin-left:0in'>      repaint();</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  private final boolean nextTo(OCBox b) {</p>

<p class=Code style='margin-left:0in'>    return Math.abs(x - b.x) &lt;= 1
&amp;&amp; </p>

<p class=Code style='margin-left:0in'>           Math.abs(y - b.y) &lt;= 1;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=CodeInline style='margin-left:0in'>} ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<p class=MsoNormal><span style='display:none'>#[BT_400]#</span>When you first
look at the online documentation for <b>Observable</b>, it’s a bit confusing
because it appears that you can use an ordinary <b>Observable</b> object to
manage the updates. But this doesn’t work; try it—inside <b>BoxObserver</b>,
create an <b>Observable</b> object instead of a <b>BoxObservable</b> object and
see what happens: nothing. To get an effect, you <i>must</i> inherit from <b>Observable</b>
and somewhere in your derived-class code call <b>setChanged(&nbsp;)</b>. This is the method that sets the “changed” flag, which
means that when you call <b>notifyObservers(&nbsp;)</b> all of the observers
will, in fact, get notified. In the example above <b>setChanged(&nbsp;)</b> is
simply called within <b>notifyObservers(&nbsp;)</b>, but you could use any
criterion you want to decide when to call <b>setChanged(&nbsp;)</b>. </p>

<p class=MsoNormal><b><span style='display:none'>#[BT_401]#</span>BoxObserver</b>
contains a single <b>Observable </b>object called <b>notifier</b>, and every
time an <b>OCBox</b> object is created, it is tied to <b>notifier</b>. In <b>OCBox</b>,
whenever you click the mouse the <b>notifyObservers(&nbsp;)</b> method is
called, passing the clicked object in as an argument so that all the boxes
receiving the message (in their <b>update(&nbsp;) </b>method) know who was
clicked and can decide whether to change themselves or not. Using a combination
of code in <b>notifyObservers(&nbsp;)</b> and <b>update(&nbsp;)</b> you can
work out some fairly complex schemes.</p>

<p class=MsoNormal><span style='display:none'>#[BT_402]#</span>It might appear
that the way the observers are notified must be frozen at compile time in the <b>notifyObservers(&nbsp;)</b>
method. However, if you look more closely at the code above you’ll see that the
only place in <b>BoxObserver</b> or <b>OCBox</b> where you're aware that you’re
working with a <b>BoxObservable</b> is at the point of creation of the <b>Observable
</b>object—from then on everything uses the basic <b>Observable</b> interface.
This means that you could inherit other <b>Observable</b> classes and swap them
at run time if you want to change notification behavior then.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169741">Mediator</a></h2>

<p class=MsoNormal>Sweep coupling under the rug, how is this different from
MVC?</p>

<p class=MsoNormal>MVC has distinct model and view; mediator could be anything.
MVC a flavor of mediator</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169742">Exercises</a></h2>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>1. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Create a minimal Observer-Observable design in two classes. Just
create the bare minimum in the two classes, then demonstrate your design by
creating one <b>Observable</b> and many <b>Observer</b>s, and cause the <b>Observable</b>
to update the <b>Observer</b>s.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>2. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Create a minimal <b>Observer</b> system using <b>java.util.Timer</b>
inside your <b>Observable</b>, to generate events that are reported to the <b>Observer</b>s.
Create several different <b>Observer</b>s using anonymous inner classes,
register these with the <b>Observable</b>, and show that they are called when
the <b>Timer</b> events occur.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>3. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Modify <b>BoxObserver.java</b> to turn it into a simple game. If
any of the squares surrounding the one you clicked is part of a contiguous
patch of the same color, then all the squares in that patch are changed to the
color you clicked on. You can configure the game for competition between
players or to keep track of the number of clicks that a single player uses to
turn the field into a single color. You may also want to restrict a player's
color to the first one that was chosen.</p>

<p class=MsoNormal><span style='display:none'>#[BT_403]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_404]#</span></p>

</div>

<span style='font-size:11.0pt;font-family:Georgia;display:none'><br clear=all
style='page-break-before:right'>
</span>

<div class=Section13>

<h1 style='margin-left:.75in'><a name="_Toc41169743">Reducing interface complexity</a></h1>

<p class=MsoNormal><span style='display:none'>#[BT_239]#</span>Sometimes the
problem that you’re solving is as simple as “I don’t have the interface that I
want.” <i>Façade</i> creates an interface to a set of classes, simply to
provide a more comfortable way to deal with a library or bundle of resources.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169744"></a><a
name="_Toc476705911">Façade</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_243]#</span>A general
principle that I apply when I’m casting about trying to mold requirements into
a first-cut object is “If something is ugly, hide it inside an object.” This is
basically what <i>Façade</i> accomplishes. If you have a rather confusing collection
of classes and interactions that the client programmer doesn’t really need to
see, then you can create an interface that is useful for the client programmer
and that only presents what’s necessary.</p>

<p class=MsoNormal><span style='display:none'>#[BT_244]#</span>Façade is often
implemented as singleton abstract factory. Of course, you can easily get this
effect by creating a class containing <b>static</b> factory methods:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: facade:Facade.java</p>

<p class=Code style='margin-left:0in'>package facade;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class A { public A(int x) {} }</p>

<p class=Code style='margin-left:0in'>class B { public B(long x) {} }</p>

<p class=Code style='margin-left:0in'>class C { public C(double x) {} }</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// Other classes that aren't exposed</p>

<p class=Code style='margin-left:0in'>// by the facade go here ...</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class Facade extends TestCase  {</p>

<p class=Code style='margin-left:0in'>  static A makeA(int x) { return new
A(x); }</p>

<p class=Code style='margin-left:0in'>  static B makeB(long x) { return new
B(x); }</p>

<p class=Code style='margin-left:0in'>  static C makeC(double x) { return new
C(x); }</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    // The client programmer gets the
objects</p>

<p class=Code style='margin-left:0in'>    // by calling the static methods:</p>

<p class=Code style='margin-left:0in'>    A a = Facade.makeA(1);</p>

<p class=Code style='margin-left:0in'>    B b = Facade.makeB(1);</p>

<p class=Code style='margin-left:0in'>    C c = Facade.makeC(1.0);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(Facade.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_245]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_246]#</span>The example
given in <i>Design Patterns</i> is just a class that uses the other classes.</p>

<p class=MsoNormal>A tax adviser is a Façade between you and the tax code, and
a mediator between you and the tax system.<span style='display:none'>A A</span></p>

<h3><a name="_Toc41169745">Package as a variation of <i>Façade</i></a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_247]#</span>To me, the <i>Façade</i>
has a rather “procedural” (non-object-oriented) feel to it: you are just
calling some functions to give you objects. And how different is it, really,
from <i>Abstract Factory</i>? The point of <i>Façade</i> is to hide part of a
library of classes (and their interactions) from the client programmer, to make
the interface to that group of classes more digestible and easier to
understand.</p>

<p class=MsoNormal><span style='display:none'>#[BT_248]#</span>However, this is
precisely what the packaging features in Java accomplish: outside of the
library, you can only create and use <b>public</b> classes; all the non-<b>public</b>
classes are only accessible within the package. It’s as if <i>Façade</i> is a
built-in feature of Java.</p>

<p class=MsoNormal><span style='display:none'>#[BT_249]#</span>To be fair, <i>Design
Patterns</i> is written primarily for a C++ audience. Although C++ has
namespaces to prevent clashes of globals and class names, this does not provide
the class hiding mechanism that you get with non-<b>public</b> classes in Java.
The majority of the time I think that Java packages will solve the <i>Façade </i>problem.</p>

<h1 style='margin-left:.75in'><a name="_Toc476705912"></a><a name="_Toc41169746">Algorithmic
partitioning</a></h1>

<p class=MsoNormal><a name="_Toc462393593">&nbsp;</a></p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169747"></a><a
name="_Toc476705906">Command</a>: choosing the operation at run-time</h2>

<p class=MsoNormal><span style='display:none'>#[BT_223]#</span>In <i>Advanced
C++:Programming Styles And Idioms (Addison-Wesley, 1992)</i>, Jim Coplien coins
the term <i>functor</i> which is an object whose sole purpose is to encapsulate
a function (since “functor” has a meaning in mathematics, in this book I shall
use the more explicit term <i>function object</i>). The point is to decouple
the choice of function to be called from the site where that function is
called. </p>

<p class=MsoNormal><span style='display:none'>#[BT_224]#</span>This term is
mentioned but not used in <i>Design Patterns</i>. However, the theme of the
function object is repeated in a number of patterns in that book.</p>

<p class=MsoNormal>A Command is a function object in its purest sense: a method
that’s an object<a href="#_ftn7" name="_ftnref7" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><span style='font-size:11.0pt;font-family:Georgia;
vertical-align:baseline'>[7]</span></span></span></span></a>. By wrapping a
method in an object, you can pass it to other methods or objects as a
parameter, to tell them to perform this particular operation in the process of
fulfilling your request. You could say that a <i>Command</i> is a messenger
(because its intent and use is very straightforward) that carries behavior,
rather than data.</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: command:CommandPattern.java</p>

<p class=Code style='margin-left:0in'>package command;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>interface Command {</p>

<p class=Code style='margin-left:0in'>  void execute();</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Hello implements Command {</p>

<p class=Code style='margin-left:0in'>  public void execute() {</p>

<p class=Code style='margin-left:0in'>    System.out.print(&quot;Hello &quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class World implements Command {</p>

<p class=Code style='margin-left:0in'>  public void execute() {</p>

<p class=Code style='margin-left:0in'>    System.out.print(&quot;World!
&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class IAm implements Command {</p>

<p class=Code style='margin-left:0in'>  public void execute() {</p>

<p class=Code style='margin-left:0in'>    System.out.print(&quot;I'm the
command pattern!&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// An object that holds commands:</p>

<p class=Code style='margin-left:0in'>class Macro {</p>

<p class=Code style='margin-left:0in'>  private List commands = new
ArrayList();</p>

<p class=Code style='margin-left:0in'>  public void add(Command c) {
commands.add(c); }</p>

<p class=Code style='margin-left:0in'>  public void run() {</p>

<p class=Code style='margin-left:0in'>    Iterator it = commands.iterator();</p>

<p class=Code style='margin-left:0in'>    while(it.hasNext())</p>

<p class=Code style='margin-left:0in'>      ((Command)it.next()).execute();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class CommandPattern extends
TestCase  {</p>

<p class=Code style='margin-left:0in'>  Macro macro = new Macro();</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    macro.add(new Hello());</p>

<p class=Code style='margin-left:0in'>    macro.add(new World());</p>

<p class=Code style='margin-left:0in'>    macro.add(new IAm());</p>

<p class=Code style='margin-left:0in'>    macro.run();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(CommandPattern.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_226]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_227]#</span>The primary
point of <i>Command</i> is to allow you to hand a desired action to a method or
object. In the above example, this provides a way to queue a set of actions to
be performed collectively. In this case, it allows you to dynamically create
new behavior, something you can normally only do by writing new code but in the
above example could be done by interpreting a script (see the <i>Interpreter</i>
pattern if what you need to do gets very complex).</p>

<p class=MsoNormal><span style='display:none'>#[BT_228]#</span>Another example
of <i>Command</i> is <b>refactor:DirList.java [????]</b>. The <b>DirFilter</b>
class is the command object which contains its action in the method <b>accept(&nbsp;)</b>
that is passed to the <b>list(&nbsp;)</b> method. The <b>list(&nbsp;)</b>
method determines what to include in its result by calling <b>accept(&nbsp;)</b>.</p>

<p class=MsoNormal><i><span style='display:none'>#[BT_229]#</span>Design
Patterns</i> says that “Commands are an object-oriented replacement for
callbacks<a href="#_ftn8" name="_ftnref8" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><span style='font-size:11.0pt;font-family:Georgia;
vertical-align:baseline'>[8]</span></span></span></span></a>.” However, I think
that the word “back” is an essential part of the concept of callbacks. That is,
I think a callback actually reaches back to the creator of the callback. On the
other hand, with a <i>Command</i> object you typically just create it and hand
it to some method or object, and are not otherwise connected over time to the <i>Command</i>
object. That’s my take on it, anyway. Later in this book, I combine a group of
design patterns under the heading of “callbacks.”</p>

<p class=MsoNormal><i><span style='display:none'>#[BT_230]#</span>Strategy</i>
appears to be a family of <i>Command</i> classes, all inherited from the same
base. But if you look at <i>Command</i>, you’ll see that it has the same
structure: a hierarchy of function objects. The difference is in the way this
hierarchy is used. As seen in <b>refactor:DirList.java</b>, you use <i>Command</i>
to solve a particular problem—in that case, selecting files from a list. The
“thing that stays the same” is the body of the method that’s being called, and
the part that varies is isolated in the function object. I would hazard to say
that <i>Command</i> provides flexibility while you’re writing the program,
whereas <i>Strategy</i>’s flexibility is at run time. Nonetheless, it seems a
rather fragile distinction.</p>

<h3><a name="_Toc476705908"></a><a name="_Toc41169748">Exercises</a></h3>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>4. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Use <i>Command</i> in Chapter 3, Exercise 1.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169749">Chain of responsibility</a></h2>

<p class=MsoNormal>Example: translation service
(local-&gt;global-&gt;Babelfish).</p>

<p class=MsoNormal><i><span style='display:none'>#[BT_234]#</span>Chain of
Responsibility</i> might be thought of as a dynamic generalization of recursion
using <i>Strategy </i>objects. You make a call, and each <i>Strategy</i> in a
linked sequence tries to satisfy the call. The process ends when one of the
strategies is successful or the chain ends. In recursion, one method calls
itself over and over until a termination condition is reached; with <i>Chain of
Responsibility</i>, a method calls itself, which (by moving down the chain of <i>Strategies</i>)<i>
</i>calls a different implementation of the method, etc., until a termination
condition is reached. The termination condition is either the bottom of the
chain is reached (in which case a default object is returned; you may or may
not be able to provide a default result so you must be able to determine the
success or failure of the chain) or one of the <i>Strategies</i> is successful.</p>

<p class=MsoNormal><span style='display:none'>#[BT_235]#</span>Instead of
calling a single method to satisfy a request, multiple methods in the chain
have a chance to satisfy the request, so it has the flavor of an expert system.
Since the chain is effectively a linked list, it can be dynamically created, so
you could also think of it as a more general, dynamically-built <b>switch</b>
statement.</p>

<p class=MsoNormal>In the GoF, there’s a fair amount of <span style='display:
none'>Thi</span>discussion of how to create the chain of responsibility as a
linked list. However, when you look at the pattern it really shouldn’t matter
how the chain is maintained; that’s an implementation detail. Since GoF was
written before the Standard Template Library (STL) was incorporated into most
C++ compilers, the reason for this is most likely (1) there was no list and
thus they had to create one and (2) data structures are often taught as a
fundamental skill in academia, and the idea that data structures should be
standard tools available with the programming language may not have occurred to
the GoF authors. I maintain that the implementation of <i>Chain of
Responsibility</i> as a chain (specifically, a linked list) adds nothing to the
solution and can just as easily be implemented using a standard Java <b>List</b>,
as shown below. Furthermore, you’ll see that I’ve gone to some effort to
separate the chain-management parts of the implementation from the various <i>Strategies</i>,
so that the code can be more easily reused.</p>

<p class=MsoNormal><span style='display:none'>#[BT_236]#</span>In <b>StrategyPattern.java</b>,
above, what you probably want is to automatically find a solution. <i>Chain of
Responsibility</i> provides a way to do this by chaining the <i>Strategy</i> objects
together and providing a mechanism for them to automatically recurse through
each one in the chain:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: chainofresponsibility:FindMinima.java</p>

<p class=Code style='margin-left:0in'>package chainofresponsibility;</p>

<p class=Code style='margin-left:0in'>import com.bruceeckel.util.*; //
Arrays2.toString()</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// Carries the result data and </p>

<p class=Code style='margin-left:0in'>// whether the strategy was successful:</p>

<p class=Code style='margin-left:0in'>class LineData {</p>

<p class=Code style='margin-left:0in'>  public double[] data;</p>

<p class=Code style='margin-left:0in'>  public LineData(double[] data) {
this.data = data; }</p>

<p class=Code style='margin-left:0in'>  private boolean succeeded;</p>

<p class=Code style='margin-left:0in'>  public boolean isSuccessful() { return
succeeded; }</p>

<p class=Code style='margin-left:0in'>  public void setSuccessful(boolean b) {
succeeded = b; }</p>

<p class=Code style='margin-left:0in'><span lang=IT>}</span></p>

<p class=Code style='margin-left:0in'><span lang=IT>&nbsp;</span></p>

<p class=Code style='margin-left:0in'><span lang=IT>interface Strategy {</span></p>

<p class=Code style='margin-left:0in'><span lang=IT>  LineData
strategy(LineData m);</span></p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class LeastSquares implements Strategy {</p>

<p class=Code style='margin-left:0in'>  public LineData strategy(LineData m) {</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Trying
LeastSquares algorithm&quot;);</p>

<p class=Code style='margin-left:0in'>    LineData ld = (LineData)m;</p>

<p class=Code style='margin-left:0in'>    // [ Actual test/calculation here ]</p>

<p class=Code style='margin-left:0in'>    LineData r = new LineData(</p>

<p class=Code style='margin-left:0in'>      new double[] { 1.1, 2.2 }); //
Dummy data</p>

<p class=Code style='margin-left:0in'>    r.setSuccessful(false);</p>

<p class=Code style='margin-left:0in'>    return r;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class NewtonsMethod implements Strategy {</p>

<p class=Code style='margin-left:0in'>  public LineData strategy(LineData m) {</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Trying
NewtonsMethod algorithm&quot;);</p>

<p class=Code style='margin-left:0in'>    LineData ld = (LineData)m;</p>

<p class=Code style='margin-left:0in'>    // [ Actual test/calculation here ]</p>

<p class=Code style='margin-left:0in'>    LineData r = new LineData(</p>

<p class=Code style='margin-left:0in'>      new double[] { 3.3, 4.4 }); //
Dummy data</p>

<p class=Code style='margin-left:0in'>    r.setSuccessful(false);</p>

<p class=Code style='margin-left:0in'>    return r;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Bisection implements Strategy {</p>

<p class=Code style='margin-left:0in'>  public LineData strategy(LineData m) {</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Trying
Bisection algorithm&quot;);</p>

<p class=Code style='margin-left:0in'>    LineData ld = (LineData)m;</p>

<p class=Code style='margin-left:0in'>    // [ Actual test/calculation here ]</p>

<p class=Code style='margin-left:0in'>    LineData r = new LineData(</p>

<p class=Code style='margin-left:0in'>      new double[] { 5.5, 6.6 }); //
Dummy data</p>

<p class=Code style='margin-left:0in'>    r.setSuccessful(true);</p>

<p class=Code style='margin-left:0in'>    return r;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class ConjugateGradient implements
Strategy {</p>

<p class=Code style='margin-left:0in'>  public LineData strategy(LineData m) {</p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      &quot;Trying ConjugateGradient
algorithm&quot;);</p>

<p class=Code style='margin-left:0in'>    LineData ld = (LineData)m;</p>

<p class=Code style='margin-left:0in'>    // [ Actual test/calculation here ]</p>

<p class=Code style='margin-left:0in'>    LineData r = new LineData(</p>

<p class=Code style='margin-left:0in'>      new double[] { 5.5, 6.6 }); //
Dummy data</p>

<p class=Code style='margin-left:0in'>    r.setSuccessful(true);</p>

<p class=Code style='margin-left:0in'>    return r;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class MinimaFinder {</p>

<p class=Code style='margin-left:0in'>  private static Strategy[] solutions = {</p>

<p class=Code style='margin-left:0in'>    new LeastSquares(),</p>

<p class=Code style='margin-left:0in'>    new NewtonsMethod(),</p>

<p class=Code style='margin-left:0in'>    new Bisection(),</p>

<p class=Code style='margin-left:0in'>    new ConjugateGradient(),</p>

<p class=Code style='margin-left:0in'>  };</p>

<p class=Code style='margin-left:0in'>  public static LineData solve(LineData
line) {</p>

<p class=Code style='margin-left:0in'>    LineData r = line;</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt;
solutions.length; i++) {</p>

<p class=Code style='margin-left:0in'>      r = solutions[i].strategy(r);</p>

<p class=Code style='margin-left:0in'>      if(r.isSuccessful())</p>

<p class=Code style='margin-left:0in'>        return r;</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    throw new
RuntimeException(&quot;unsolved: &quot; + line);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>  </p>

<p class=Code style='margin-left:0in'>public class FindMinima extends TestCase 
{</p>

<p class=Code style='margin-left:0in'>  LineData line = new LineData(new
double[]{ </p>

<p class=Code style='margin-left:0in'>    1.0, 2.0, 1.0, 2.0, -1.0, 3.0, 4.0,
5.0, 4.0</p>

<p class=Code style='margin-left:0in'>  });</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    System.out.println(Arrays2.toString(</p>

<p class=Code style='margin-left:0in'>     
((LineData)MinimaFinder.solve(line)).data));</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>   
junit.textui.TestRunner.run(FindMinima.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<h3><a name="_Toc41169750">Exercises</a></h3>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>1. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Implement <i>Chain of Responsibility</i> to create an
&quot;expert system&quot; that solves problems by successively trying one
solution after another until one matches. You should be able to dynamically add
solutions to the expert system. The test for solution should just be a string
match, but when a solution fits, the expert system should return the
appropriate type of <b>ProblemSolver</b> object. What other pattern/patterns
show up here?</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>2. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Implement <i>Chain of Responsibility</i> to create a language
translator which begins by searching for a local specialized translation system
(which may know specifics about your problem domain), then a more global
generalized system, and finally falls back on BabelFish if it can’t translate
everything. Note that each link in the chain may partially translate what it’s
able to.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>3. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Implement <i>Chain of Responsibility</i> to create an tool to
help reformat Java source code by trying multiple approaches to breaking lines.
Note that normal code and comments will probably need to be treated
differently, leading to the possibility of implementing a <i>Tree of
Responsibility</i>. Also note the similarity between this approach and the <i>Composite</i>
design pattern; perhaps the more general description of this technique is a <i>Composite
of Strategies</i>.</p>

<p class=MsoNormal><span style='display:none'>#[BT_238]#</span></p>

</div>

<span style='font-size:11.0pt;font-family:Georgia;display:none'><br clear=all
style='page-break-before:right'>
</span>

<div class=Section14>

<h1 style='margin-left:.75in'><a name="_Toc41169751">Externalizing object state</a></h1>

<h2 style='margin-left:40.5pt'><a name="_Toc41169752">Memento</a></h2>

<p class=MsoNormal>Use serialization to create an undo mechanism.</p>

<h1 style='margin-left:.75in'><a name="_Toc41169753">Complex interactions</a></h1>

<h2 style='margin-left:40.5pt'><a name="_Toc41169754">Multiple dispatching</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_405]#</span>When dealing
with multiple types which are interacting, a program can get particularly
messy. For example, consider a system that parses and executes mathematical
expressions. You want to be able to say <b>Number + Number</b>, <b>Number *
Number</b>, etc., where <b>Number</b> is the base class for a family of
numerical objects. But when you say <b>a + b</b>, and you don’t know the exact
type of either <b>a</b> or <b>b</b>, so how can you get them to interact
properly?</p>

<p class=MsoNormal><span style='display:none'>#[BT_406]#</span>The answer
starts with something you probably don’t think about: Java performs only single
dispatching. That is, if you are performing an operation on more than one
object whose type is unknown, Java can invoke the dynamic binding mechanism on
only one of those types. This doesn’t solve the problem, so you end up
detecting some types manually and effectively producing your own dynamic
binding behavior.</p>

<p class=MsoNormal><span style='display:none'>#[BT_407]#</span>The solution is
called <i>multiple dispatching</i>. Remember that polymorphism can occur only
via member function calls, so if you want double dispatching to occur, there
must be two member function calls: the first to determine the first unknown
type, and the second to determine the second unknown type. With multiple
dispatching, you must have a polymorphic method call to determine each of the
types. Generally, you’ll set up a configuration such that a single member
function call produces more than one dynamic member function call and thus
determines more than one type in the process. To get this effect, you need to
work with more than one polymorphic method call: you’ll need one call for each
dispatch. The methods in the following example are called <b>compete(&nbsp;) </b>and
<b>eval(&nbsp;)</b>, and are both members of the same type. (In this case there
will be only two dispatches, which is referred to as <i>double dispatching</i>). If you are working with two different type hierarchies that are
interacting, then you’ll have to have a polymorphic method call in each
hierarchy.</p>

<p class=MsoNormal><span style='display:none'>#[BT_408]#</span>Here’s an
example of multiple dispatching:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//:
multipledispatch:PaperScissorsRock.java</p>

<p class=Code style='margin-left:0in'>// Demonstration of multiple dispatching.</p>

<p class=Code style='margin-left:0in'>package multipledispatch;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// An enumeration type:</p>

<p class=Code style='margin-left:0in'>class Outcome {</p>

<p class=Code style='margin-left:0in'>  private String name;</p>

<p class=Code style='margin-left:0in'>  private Outcome(String name) {
this.name = name; }</p>

<p class=Code style='margin-left:0in'>  public final static Outcome</p>

<p class=Code style='margin-left:0in'>    WIN = new Outcome(&quot;wins&quot;), </p>

<p class=Code style='margin-left:0in'>    LOSE = new
Outcome(&quot;loses&quot;), </p>

<p class=Code style='margin-left:0in'>    DRAW = new
Outcome(&quot;draws&quot;);</p>

<p class=Code style='margin-left:0in'>  public String toString() { return name;
}</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>interface Item {</p>

<p class=Code style='margin-left:0in'>  Outcome compete(Item it);</p>

<p class=Code style='margin-left:0in'>  Outcome eval(Paper p);</p>

<p class=Code style='margin-left:0in'>  Outcome eval(Scissors s);</p>

<p class=Code style='margin-left:0in'>  Outcome eval(Rock r);</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Paper implements Item {</p>

<p class=Code style='margin-left:0in'>  public Outcome compete(Item it) {
return it.eval(this); }</p>

<p class=Code style='margin-left:0in'>  public Outcome eval(Paper p) { return
Outcome.DRAW; }</p>

<p class=Code style='margin-left:0in'>  public Outcome eval(Scissors s) {
return Outcome.WIN; }</p>

<p class=Code style='margin-left:0in'>  public Outcome eval(Rock r) { return
Outcome.LOSE; }</p>

<p class=Code style='margin-left:0in'>  public String toString() { return
&quot;Paper&quot;; }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Scissors implements Item {</p>

<p class=Code style='margin-left:0in'>  public Outcome compete(Item it) {
return it.eval(this); }</p>

<p class=Code style='margin-left:0in'>  public Outcome eval(Paper p) { return
Outcome.LOSE; }</p>

<p class=Code style='margin-left:0in'>  public Outcome eval(Scissors s) {
return Outcome.DRAW; }</p>

<p class=Code style='margin-left:0in'>  public Outcome eval(Rock r) { return
Outcome.WIN; }</p>

<p class=Code style='margin-left:0in'>  public String toString() { return
&quot;Scissors&quot;; }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Rock implements Item {</p>

<p class=Code style='margin-left:0in'>  public Outcome compete(Item it) {
return it.eval(this); }</p>

<p class=Code style='margin-left:0in'>  public Outcome eval(Paper p) { return
Outcome.WIN; }</p>

<p class=Code style='margin-left:0in'>  public Outcome eval(Scissors s) {
return Outcome.LOSE; }</p>

<p class=Code style='margin-left:0in'>  public Outcome eval(Rock r) { return
Outcome.DRAW; }</p>

<p class=Code style='margin-left:0in'>  public String toString() { return
&quot;Rock&quot;; }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class ItemGenerator {</p>

<p class=Code style='margin-left:0in'>  private static Random rand = new
Random();</p>

<p class=Code style='margin-left:0in'>  public static Item newItem() {</p>

<p class=Code style='margin-left:0in'>    switch(rand.nextInt(3)) {</p>

<p class=Code style='margin-left:0in'>      default:</p>

<p class=Code style='margin-left:0in'>      case 0: return new Scissors();</p>

<p class=Code style='margin-left:0in'>      case 1: return new Paper();</p>

<p class=Code style='margin-left:0in'>      case 2: return new Rock();</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Compete {</p>

<p class=Code style='margin-left:0in'>  public static void match(Item a, Item
b) {</p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      a + &quot; &quot; + a.compete(b) +
&quot; vs. &quot; + b);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class PaperScissorsRock extends
TestCase  {</p>

<p class=Code style='margin-left:0in'>  static int SIZE = 20;</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; SIZE; i++)</p>

<p class=Code style='margin-left:0in'>     
Compete.match(ItemGenerator.newItem(),</p>

<p class=Code style='margin-left:0in'>        ItemGenerator.newItem());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>   
junit.textui.TestRunner.run(PaperScissorsRock.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=CodeInline style='margin-left:0in'>} ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span style='display:none'>#[BT_409]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_410]#</span></p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169755"></a><a
name="_Toc476705917"></a><a name="_Toc462393597">Visitor, a type of multiple
dispatching</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_411]#</span>The assumption
is that you have a primary class hierarchy that is fixed; perhaps it’s from
another vendor and you can’t make changes to that hierarchy. However, you’d
like to add new polymorphic methods to that hierarchy, which means that
normally you’d have to add something to the base class interface. So the
dilemma is that you need to add methods to the base class, but you can’t touch
the base class. How do you get around this?</p>

<p class=MsoNormal><span style='display:none'>#[BT_412]#</span>The design
pattern that solves this kind of problem is called a “visitor” (the final one
in the <i>Design Patterns</i> book), and it builds on the double<i> </i>dispatching
scheme shown in the last section.</p>

<p class=MsoNormal><span style='display:none'>#[BT_413]#</span>The visitor pattern allows you to extend the interface of the primary type by creating a
separate class hierarchy of type <b>Visitor </b>to virtualize the operations
performed upon the primary type. The objects of the primary type simply
“accept” the visitor, then call the visitor’s dynamically<b>-</b>bound member
function.</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: visitor:BeeAndFlowers.java</p>

<p class=Code style='margin-left:0in'>// Demonstration of &quot;visitor&quot;
pattern.</p>

<p class=Code style='margin-left:0in'>package visitor;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>interface Visitor {  </p>

<p class=Code style='margin-left:0in'>  void visit(Gladiolus g);</p>

<p class=Code style='margin-left:0in'>  void visit(Runuculus r);</p>

<p class=Code style='margin-left:0in'>  void visit(Chrysanthemum c);</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// The Flower hierarchy cannot be
changed:</p>

<p class=Code style='margin-left:0in'>interface Flower {  </p>

<p class=Code style='margin-left:0in'>  void accept(Visitor v);</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Gladiolus implements Flower {  </p>

<p class=Code style='margin-left:0in'>  public void accept(Visitor v) {
v.visit(this);}</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Runuculus implements Flower {  </p>

<p class=Code style='margin-left:0in'>  public void accept(Visitor v) {
v.visit(this);}</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Chrysanthemum implements Flower {  </p>

<p class=Code style='margin-left:0in'>  public void accept(Visitor v) {
v.visit(this);}</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// Add the ability to produce a string:</p>

<p class=Code style='margin-left:0in'>class StringVal implements Visitor {</p>

<p class=Code style='margin-left:0in'>  String s;  </p>

<p class=Code style='margin-left:0in'>  public String toString() { return s; }</p>

<p class=Code style='margin-left:0in'>  public void visit(Gladiolus g) { </p>

<p class=Code style='margin-left:0in'>    s = &quot;Gladiolus&quot;; </p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void visit(Runuculus r) { </p>

<p class=Code style='margin-left:0in'>    s = &quot;Runuculus&quot;; </p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void visit(Chrysanthemum c) { </p>

<p class=Code style='margin-left:0in'>    s = &quot;Chrysanthemum&quot;; </p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// Add the ability to do &quot;Bee&quot;
activities:</p>

<p class=Code style='margin-left:0in'>class Bee implements Visitor {  </p>

<p class=Code style='margin-left:0in'>  public void visit(Gladiolus g) {</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Bee and
Gladiolus&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void visit(Runuculus r) {</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Bee and
Runuculus&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void visit(Chrysanthemum c) {</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Bee and
Chrysanthemum&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class FlowerGenerator {</p>

<p class=Code style='margin-left:0in'>  private static Random rand = new
Random();</p>

<p class=Code style='margin-left:0in'>  public static Flower newFlower() {</p>

<p class=Code style='margin-left:0in'>    switch(rand.nextInt(3)) {</p>

<p class=Code style='margin-left:0in'>      default:</p>

<p class=Code style='margin-left:0in'>      case 0: return new Gladiolus();</p>

<p class=Code style='margin-left:0in'>      case 1: return new Runuculus();</p>

<p class=Code style='margin-left:0in'>      case 2: return new Chrysanthemum();</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class BeeAndFlowers extends
TestCase  {</p>

<p class=Code style='margin-left:0in'>  List flowers = new ArrayList();</p>

<p class=Code style='margin-left:0in'>  public BeeAndFlowers() {</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; 10; i++)</p>

<p class=Code style='margin-left:0in'>     
flowers.add(FlowerGenerator.newFlower());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    // It's almost as if I had a function
to</p>

<p class=Code style='margin-left:0in'>    // produce a Flower string
representation:</p>

<p class=Code style='margin-left:0in'>    StringVal sval = new StringVal();</p>

<p class=Code style='margin-left:0in'>    Iterator it = flowers.iterator();</p>

<p class=Code style='margin-left:0in'>    while(it.hasNext()) {</p>

<p class=Code style='margin-left:0in'>      ((Flower)it.next()).accept(sval);</p>

<p class=Code style='margin-left:0in'>      System.out.println(sval);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    // Perform &quot;Bee&quot; operation
on all Flowers:</p>

<p class=Code style='margin-left:0in'>    Bee bee = new Bee();</p>

<p class=Code style='margin-left:0in'>    it = flowers.iterator();</p>

<p class=Code style='margin-left:0in'>    while(it.hasNext())</p>

<p class=Code style='margin-left:0in'>      ((Flower)it.next()).accept(bee);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(BeeAndFlowers.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_414]#</span></p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169756">Exercises</a></h2>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>1. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Create a business-modeling environment with three types of <b>Inhabitant</b>:
<b>Dwarf</b> (for engineers), <b>Elf</b> (for marketers) and <b>Troll</b> (for
managers). Now create a class called <b>Project</b> that creates the different
inhabitants and causes them to <b>interact(&nbsp;)</b> with each other using
multiple dispatching.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>2. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Modify the above example to make the interactions more detailed.
Each <b>Inhabitant</b> can randomly produce a <b>Weapon</b> using <b>getWeapon(&nbsp;)</b>:
a <b>Dwarf</b> uses <b>Jargon</b> or <b>Play</b>, an <b>Elf</b> uses <b>InventFeature</b>
or <b>SellImaginaryProduct</b>, and a <b>Troll</b> uses <b>Edict</b> and <b>Schedule</b>.
You must decide which weapons “win” and “lose” in each interaction (as in <b>PaperScissorsRock.java</b>).
Add a <b>battle(&nbsp;)</b> member function to <b>Project</b> that takes two <b>Inhabitant</b>s
and matches them against each other. Now create a <b>meeting(&nbsp;)</b> member
function for <b>Project</b> that creates groups of <b>Dwarf</b>, <b>Elf</b> and
<b>Manager</b> and battles the groups against each other until only members of
one group are left standing. These are the “winners.”</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>3. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Modify <b>PaperScissorsRock.java</b> to replace the double
dispatching with a table lookup. The easiest way to do this is to create a <b>Map
</b>of <b>Map</b>s, with the key of each <b>Map </b>the class of each object.
Then you can do the lookup by saying:<br>
(<b>(Map)map.get(o1.getClass())).get(o2.getClass())</b><br>
Notice how much easier it is to reconfigure the system. When is it more
appropriate to use this approach vs. hard-coding the dynamic dispatches? Can
you create a system that has the syntactic simplicity of use of the dynamic
dispatch but uses a table lookup?</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>4. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Modify Exercise 2 to use the table lookup technique described in
Exercise 3.</p>

<p class=MsoNormal><span style='display:none'>#[BT_415]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_416]#</span></p>

</div>

<span style='font-size:11.0pt;font-family:Georgia;display:none'><br clear=all
style='page-break-before:right'>
</span>

<div class=Section15>

<h1 style='margin-left:.75in'><a name="_Toc41169757">Multiple languages</a></h1>

<p class=MsoNormal><span style='display:none'>#[BT_256]#</span>This chapter
looks at the value of crossing language boundaries. It is often very
advantageous to solve a problem using more than one programming language,
rather than being arbitrarily stuck using a single language. As you’ll see in
this chapter, a problem that is very difficult or tedious to solve in one
language can often be solved quickly and easily in another. If you can combine
the use of languages, you can create your product much more quickly and
cheaply.</p>

<p class=MsoNormal><span style='display:none'>#[BT_257]#</span>The most
straightforward use of this idea is the <i>Interpreter</i> design pattern,
which adds an interpreted language to your program to allow the end user to
easily customize a solution. In Java, the easiest and most powerful way to do
this is with <i>Jython</i><a href="#_ftn9" name="_ftnref9" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><span style='font-size:11.0pt;font-family:Georgia;
vertical-align:baseline'>[9]</span></span></span></span></a>, an implementation
of the Python language in pure Java byte codes.</p>

<p class=MsoNormal><i><span style='display:none'>#[BT_258]#</span>Interpreter</i>
solves a particular problem – that of creating a scripting language for the
user. But sometimes it’s just easier and faster to temporarily step into
another language to solve a particular aspect of your problem. You’re not
creating an interpreter, you’re just writing some code in another language.
Again, Jython is a good example of this, but CORBA also allows you to cross
language boundaries.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169758">Interpreter motivation</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_259]#</span>If the
application user needs greater run time flexibility, for example to create
scripts describing the desired behavior of the system, you can use the <i>Interpreter</i>
design pattern. Here, you create and embed a language interpreter into your
program.</p>

<p class=MsoNormal><span style='display:none'>#[BT_260]#</span>Remember that
each design pattern allows one or more factors to change, so it’s important to
first be aware of which factor is changing. Sometimes the end users of your
application (rather than the programmers of that application) need complete
flexibility in the way that they configure some aspect of the program. That is,
they need to do some kind of simple programming. The interpreter pattern
provides this flexibility by adding a language interpreter.</p>

<p class=MsoNormal><span style='display:none'>#[BT_261]#</span>The problem is
that developing your own language and building an interpreter is a
time-consuming distraction from the process of developing your application. You
must ask whether you want to finish writing your application or create a new
language.  The best solution is to reuse code: embed an interpreter that’s
already been built and debugged for you. The Python language can be freely
embedded into your for-profit application without signing any license
agreement, paying royalties, or dealing with strings of any kind. There are
basically no restrictions at all when you're using Python.</p>

<p class=MsoNormal><span style='display:none'>#[BT_262]#</span>Python is a
language that is very easy to learn, very logical to read and write, supports
functions and objects, has a large set of available libraries, and runs on
virtually every platform. You can download Python and learn more about it by
going to <i>www.Python.org</i>.</p>

<p class=MsoNormal><span style='display:none'>#[BT_263]#</span>For solving Java
problems, we will look at a special version of Python called Jython. This is
generated entirely in Java byte codes, so incorporating it into your
application is quite simple,  and it’s as portable as Java is. It has an
extremely clean interface with Java: Java can call Python classes, and Python
can call Java classes. </p>

<p class=MsoNormal><span style='display:none'>#[BT_264]#</span>Python is
designed with classes from the ground up and is a truly pure object oriented language
(both C++ and Java violate purity in various ways). Python scales up so that
you can create very big programs without losing control of the code.</p>

<p class=MsoNormal><span style='display:none'>#[BT_265]#</span>To install
Python, go to <a href="http://www.python.org/"><i>www.Python.org</i></a> and
follow the links and instructions. To install Jython, go to<i> </i><a
href="http://jython.sourceforge.net/"><i>http://jython.sourceforge.net</i></a>. 
The download is a <b>.class</b> file, which will run an installer when you
execute it with Java.  You also need to add <b>jython.jar</b> to your
CLASSPATH. You can find further installation instructions at <a
href="http://www.bruceeckel.com/TIPatterns/Building-Code.html">http://www.bruceeckel.com/TIPatterns/Building-Code.html</a>.
</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169759">Python overview</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_266]#</span>To get you
started, here is a brief introduction for the experienced programmer (which is
what you should be if you’re reading this book). You can refer to the full
documentation at <i>www.Python.org</i> (especially the incredibly useful HTML
page <i>A Python Quick Reference</i>),<i> </i>and also numerous books such as <i>Learning
Python</i> by Mark Lutz and David Ascher (O’Reilly, 1999).</p>

<p class=MsoNormal><span style='display:none'>#[BT_267]#</span>Python is often
referred to as a scripting language, but scripting languages tend to be
limiting, especially in the scope of the problems that they solve. Python, on
the other hand, is a programming language that also supports scripting. It <i>is</i>
marvelous for scripting, and you may find yourself replacing all your batch
files, shell scripts, and simple programs with Python scripts. But it is far
more than a scripting language.</p>

<p class=MsoNormal><span style='display:none'>#[BT_268]#</span>Python is
designed to be very clean to write and especially to read. You will find that
it’s quite easy to read your own code long after you’ve written it, and also to
read other people’s code. This is accomplished partially through clean, to-the-point
syntax, but a major factor in code readability is indentation – scoping in
Python is determined by indentation. For example:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>##interpreter:if.py</p>

<p class=Code style='margin-left:0in'>response = &quot;yes&quot;</p>

<p class=Code style='margin-left:0in'>if response == &quot;yes&quot;:</p>

<p class=Code style='margin-left:0in'>  print &quot;affirmative&quot;</p>

<p class=Code style='margin-left:0in'>  val = 1</p>

<p class=Code style='margin-left:0in'>print &quot;continuing...&quot;</p>

<p class=Code style='margin-left:0in'>##~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_269]#</span>The ‘<b>#</b>’
denotes a comment that goes until the end of the line, just like C++ and Java ‘<b>//</b>’
comments.</p>

<p class=MsoNormal><span style='display:none'>#[BT_270]#</span>First notice
that the basic syntax of Python is C-ish; notice the <b>if</b> statement. But
in a C <b>if</b>, you would be required to use parentheses around the
conditional, whereas they are not necessary in Python (but it won’t complain if
you use them anyway).</p>

<p class=MsoNormal><span style='display:none'>#[BT_271]#</span>The conditional
clause ends with a colon, and this indicates that what follows will be a group
of indented statements, which are the “then” part of the <b>if</b> statement.
In this case, there is a “print” statement which sends the result to standard
output, followed by an assignment to a variable named <b>val</b>. The
subsequent statement is not indented so it is no longer part of the <b>if</b>.
Indenting can nest to any level, just like curly braces in C++ or Java, but
unlike those languages there is no option (and no argument) about where the
braces are placed – the compiler forces everyone’s code to be formatted the
same way, which is one of the main reasons for Python’s consistent readability.</p>

<p class=MsoNormal><span style='display:none'>#[BT_272]#</span>Python normally
has only one statement per line (you can put more by separating them with
semicolons), thus no terminating semicolon is necessary.  Even from the brief
example above you can see that the language is designed to be as simple as
possible, and yet still very readable.</p>

<h3><a name="_Toc41169760">Built-in containers</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_273]#</span>With languages
like C++ and Java, containers are add-on libraries and not integral to the
language. In Python, the essential nature of containers for programming is
acknowledged by building them into the core of the language: both lists and
associative arrays (a.k.a. maps, dictionaries, hash tables) are fundamental
data types. This adds much to the elegance of the language.</p>

<p class=MsoNormal><span style='display:none'>#[BT_274]#</span>In addition, the
<b>for</b> statement automatically iterates through lists rather than just
counting through a sequence of numbers. This makes a lot of sense when you
think about it, since you’re almost always using a <b>for</b> loop to step
through an array or a container. Python formalizes this by automatically making
<b>for</b> use an iterator that works through a sequence. Here’s an example:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>## interpreter:list.py</p>

<p class=Code style='margin-left:0in'>list = [ 1, 3, 5, 7, 9, 11 ]</p>

<p class=Code style='margin-left:0in'>print list</p>

<p class=Code style='margin-left:0in'>list.append(13)</p>

<p class=Code style='margin-left:0in'>for x in list:</p>

<p class=Code style='margin-left:0in;text-align:justify'>  print x</p>

<p class=Code style='margin-left:0in'>##~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_275]#</span>The first line
creates a list. You can print the list and it will look exactly as you put it
in (in contrast, remember that I had to create a special <b>Arrays2</b> class
in <i>Thinking in Java, 2<sup>nd</sup> Edition </i>in order to print arrays in
Java). Lists are like Java containers – you can add new elements to them (here,
<b>append(&nbsp;) </b>is used) and they will automatically resize themselves.
The <b>for</b> statement creates an iterator <b>x</b> which takes on each value
in the list.</p>

<p class=MsoNormal><span style='display:none'>#[BT_276]#</span>You can create a
list of numbers with the <b>range(&nbsp;)</b> function, so if you really need
to imitate C’s <b>for</b>, you can.</p>

<p class=MsoNormal><span style='display:none'>#[BT_277]#</span>Notice that
there aren’t any type declarations – the object names simply appear, and Python
infers their type by the way that you use them. It’s as if Python is designed
so that you only need to press the keys that absolutely must. You’ll find after
you’ve worked with Python for a short while that you’ve been using up a lot of
brain cycles parsing semicolons, curly braces, and all sorts of other extra
verbiage that was demanded by your non-Python programming language but didn’t
actually describe what your program was supposed to do.</p>

<h3><a name="_Toc41169761">Functions</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_278]#</span>To create a
function in Python, you use the <b>def</b> keyword, followed by the function
name and argument list, and a colon to begin the function body. Here is the
first example turned into a function:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>## interpreter:myFunction.py</p>

<p class=Code style='margin-left:0in'>def myFunction(response):</p>

<p class=Code style='margin-left:0in'>  val = 0</p>

<p class=Code style='margin-left:0in'>  if response == &quot;yes&quot;:</p>

<p class=Code style='margin-left:0in'>    print &quot;affirmative&quot;</p>

<p class=Code style='margin-left:0in'>    val = 1</p>

<p class=Code style='margin-left:0in'>  print &quot;continuing...&quot;</p>

<p class=Code style='margin-left:0in'>  return val</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>print myFunction(&quot;no&quot;)</p>

<p class=Code style='margin-left:0in'>print myFunction(&quot;yes&quot;)</p>

<p class=Code style='margin-left:0in'>##~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_279]#</span>Notice there is
no type information in the function signature – all it specifies is the name of
the function and the argument identifiers, but no argument types or return
types. Python is a <i>weakly-typed</i> language, which means it puts the
minimum possible requirements on typing. For example, you could pass and return
different types from the same function:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>## interpreter:differentReturns.py</p>

<p class=Code style='margin-left:0in'>def differentReturns(arg):</p>

<p class=Code style='margin-left:0in'>  if arg == 1:</p>

<p class=Code style='margin-left:0in'>    return &quot;one&quot;</p>

<p class=Code style='margin-left:0in'>  if arg == &quot;one&quot;:</p>

<p class=Code style='margin-left:0in'>    return 1</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>print differentReturns(1)</p>

<p class=Code style='margin-left:0in'>print differentReturns(&quot;one&quot;)</p>

<p class=Code style='margin-left:0in'>##~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_280]#</span>The only
constraints on an object that is passed into the function are that the function
can apply its operations to that object, but other than that, it doesn’t care.
Here, the same function applies the ‘<b>+</b>’ operator to integers and
strings:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>## interpreter:sum.py</p>

<p class=Code style='margin-left:0in'>def sum(arg1, arg2):</p>

<p class=Code style='margin-left:0in'>  return arg1 + arg2</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>print sum(42, 47)</p>

<p class=Code style='margin-left:0in'>print sum('spam ', &quot;eggs&quot;)</p>

<p class=Code style='margin-left:0in'>##~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_281]#</span>When the
operator ‘<b>+</b>’ is used with strings, it means concatenation (yes, Python
supports operator overloading, and it does a nice job of it).</p>

<h3><a name="_Toc41169762">Strings</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_282]#</span>The above
example also shows a little bit about Python string handling,  which is the
best of any language I’ve seen. You can use single or double quotes to
represent strings, which is very nice because if you surround a string with
double quotes, you can embed single quotes and vice versa:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>## interpreter:strings.py</p>

<p class=Code style='margin-left:0in'>print &quot;That isn't a horse&quot;</p>

<p class=Code style='margin-left:0in'>print 'You are not a &quot;Viking&quot;'</p>

<p class=Code style='margin-left:0in'>print &quot;&quot;&quot;You're just
pounding two</p>

<p class=Code style='margin-left:0in'>coconut halves
together.&quot;&quot;&quot;</p>

<p class=Code style='margin-left:0in'>print '''&quot;Oh no!&quot; He exclaimed.</p>

<p class=Code style='margin-left:0in'>&quot;It's the blemange!&quot;'''</p>

<p class=Code style='margin-left:0in'>print r'c:\python\lib\utils'</p>

<p class=Code style='margin-left:0in'>##~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_283]#</span>Note that Python
was not named after the snake, but rather the Monty Python comedy troupe, and
so examples are virtually required to include Python-esque references.</p>

<p class=MsoNormal><span style='display:none'>#[BT_284]#</span>The triple-quote
syntax quotes everything, including newlines. This makes it particularly useful
for doing things like generating web pages (Python is an especially good CGI
language), since you can just triple-quote the entire page that you want
without any other editing.</p>

<p class=MsoNormal><span style='display:none'>#[BT_285]#</span>The ‘<b>r</b>’
right before a string means “raw,” which takes the backslashes literally so you
don’t have to put in an extra backslash.</p>

<p class=MsoNormal><span style='display:none'>#[BT_286]#</span>Substitution in
strings is exceptionally easy, since Python uses C’s <b>printf(&nbsp;)</b>
substitution syntax, but for any string at all. You simply follow the string
with a ‘<b>%</b>’ and the values to substitute:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>## interpreter:stringFormatting.py</p>

<p class=Code style='margin-left:0in'>val = 47</p>

<p class=Code style='margin-left:0in'>print &quot;The number is %d&quot; % val</p>

<p class=Code style='margin-left:0in'>val2 = 63.4</p>

<p class=Code style='margin-left:0in'>s = &quot;val: %d, val2: %f&quot; % (val,
val2)</p>

<p class=Code style='margin-left:0in'>print s</p>

<p class=Code style='margin-left:0in'>##~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_287]#</span>As you can see
in the second case, if you have more than one argument you surround them in
parentheses (this forms a <i>tuple</i>, which is a list that cannot be
modified).</p>

<p class=MsoNormal><span style='display:none'>#[BT_288]#</span>All the
formatting from <b>printf(&nbsp;)</b> is available, including control over the
number of decimal places and alignment. Python also has very sophisticated
regular expressions.</p>

<h3><a name="_Toc41169763">Classes</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_289]#</span>Like everything
else in Python, the definition of a class uses a minimum of additional syntax.
You use the <b>class</b> keyword, and inside the body you use <b>def</b> to create
methods. Here’s a simple class:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>## interpreter:SimpleClass.py</p>

<p class=Code style='margin-left:0in'>class Simple:</p>

<p class=Code style='margin-left:0in'>  def __init__(self, str):</p>

<p class=Code style='margin-left:0in'>    print &quot;Inside the Simple
constructor&quot;</p>

<p class=Code style='margin-left:0in'>    self.s = str</p>

<p class=Code style='margin-left:0in'>  # Two methods:</p>

<p class=Code style='margin-left:0in'>  def show(self):</p>

<p class=Code style='margin-left:0in'>    print self.s</p>

<p class=Code style='margin-left:0in'>  def showMsg(self, msg):</p>

<p class=Code style='margin-left:0in'>    print msg + ':',</p>

<p class=Code style='margin-left:0in'>    self.show() # Calling another method</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>if __name__ == &quot;__main__&quot;:</p>

<p class=Code style='margin-left:0in'>  # Create an object:</p>

<p class=Code style='margin-left:0in'>  x = Simple(&quot;constructor
argument&quot;)</p>

<p class=Code style='margin-left:0in'>  x.show()</p>

<p class=Code style='margin-left:0in'>  x.showMsg(&quot;A message&quot;)</p>

<p class=Code style='margin-left:0in'>##~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_290]#</span>Both methods
have “<b>self</b>”<b> </b>as their first argument. C++ and Java both have a
hidden first argument in their class methods, which points to the object that
the method was called for and can be accessed using the keyword <b>this</b>.
Python methods also use a reference to the current object, but when you are <i>defining</i>
a method you must explicitly specify the reference as the first argument.
Traditionally, the reference is called <b>self</b> but you could use any
identifier you want (if you do not use <b>self</b> you will probably confuse a
lot of people, however). If you need to refer to fields in the object or other
methods in the object, you must use <b>self</b> in the expression. However,
when you call a method for an object as in <b>x.show(&nbsp;)</b>, you do not
hand it the reference to the object – <i>that</i> is done for you.</p>

<p class=MsoNormal><span style='display:none'>#[BT_291]#</span>Here, the first
method is special, as is any identifier that begins and ends with double
underscores. In this case, it defines the constructor, which is automatically
called when the object is created, just like in C++ and Java. However, at the
bottom of the example you can see that the creation of an object looks just
like a function call using the class name. Python’s spare syntax makes you
realize that the <b>new</b> keyword isn’t really necessary in C++ or Java,
either.</p>

<p class=MsoNormal><span style='display:none'>#[BT_292]#</span>All the code at
the bottom is set off by an <b>if</b> clause, which checks to see if something
called <b>__name­__</b> is equivalent to <b>__main__</b>. Again, the double
underscores indicate special names. The reason for the <b>if</b> is that any
file can also be used as a library module within another program (modules are
described shortly). In that case, you just want the classes defined, but you
don’t want the code at the bottom of the file to be executed. This particular <b>if</b>
statement is only true when you are running this file directly; that is, if you
say on the command line:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>Python SimpleClass.py</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_293]#</span>However, if this
file is imported as a module into another program, the <b>__main__</b> code is
not executed.</p>

<p class=MsoNormal><span style='display:none'>#[BT_294]#</span>Something that’s
a little surprising at first is that you define fields inside methods, and not
outside of the methods like C++ or Java (if you create fields using the
C++/Java style, they implicitly become static fields). To create an object
field, you just name it – using <b>self</b> – inside of one of the methods
(usually in the constructor, but not always), and space is created when that
method is run. This seems a little strange coming from C++ or Java where you
must decide ahead of time how much space your object is going to occupy, but it
turns out to be a very flexible way to program.</p>

<h4>Inheritance</h4>

<p class=MsoNormal><span style='display:none'>#[BT_295]#</span>Because Python
is weakly typed, it doesn’t really care about interfaces – all it cares about
is applying operations to objects (in fact, Java’s <b>interface</b> keyword
would be wasted in Python). This means that inheritance in Python is different
from inheritance in C++ or Java, where you often inherit simply to establish a
common interface. In Python, the only reason you inherit is to inherit an
implementation – to re-use the code in the base class. </p>

<p class=MsoNormal><span style='display:none'>#[BT_296]#</span>If you’re going
to inherit from a class, you must tell Python to bring that class into your new
file. Python controls its name spaces as aggressively as Java does, and in a
similar fashion (albeit with Python’s penchant for simplicity). Every time you
create a file, you implicitly create a module (which is like a package in Java)
with the same name as that file. Thus, no <b>package</b> keyword is needed in
Python. When you want to use a module, you just say <b>import</b> and give the
name of the module. Python searches the PYTHONPATH in the same way that Java
searches the CLASSPATH (but for some reason, Python doesn’t have the same kinds
of pitfalls as Java does) and reads in the file. To refer to any of the
functions or classes within a module, you give the module name, a period, and
the function or class name. If you don’t want the trouble of qualifying the
name, you can say </p>

<p class=MsoNormal><b><span style='display:none'>#[BT_297]#</span>from </b><i>module</i>
<b>import</b> <i>name(s)</i></p>

<p class=MsoNormal><span style='display:none'>#[BT_298]#</span>Where “name(s)”
can be a list of names separated by commas.</p>

<p class=MsoNormal><span style='display:none'>#[BT_299]#</span>You inherit a
class (or classes – Python supports multiple inheritance) by listing the
name(s) of the class inside parentheses after the name of the inheriting class.
Note that the <b>Simple</b> class, which resides in the file (and thus, module)
named <b>SimpleClass</b> is brought into this new name space using an <b>import</b>
statement:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>## interpreter:Simple2.py</p>

<p class=Code style='margin-left:0in'>from SimpleClass import Simple</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Simple2(Simple):</p>

<p class=Code style='margin-left:0in'>  def __init__(self, str):</p>

<p class=Code style='margin-left:0in'>    print &quot;Inside Simple2
constructor&quot;</p>

<p class=Code style='margin-left:0in'>    # You must explicitly call </p>

<p class=Code style='margin-left:0in'>    # the base-class constructor:</p>

<p class=Code style='margin-left:0in'>    Simple.__init__(self, str)</p>

<p class=Code style='margin-left:0in'>  def display(self):</p>

<p class=Code style='margin-left:0in'>    self.showMsg(&quot;Called from display()&quot;)</p>

<p class=Code style='margin-left:0in'>  # Overriding a base-class method</p>

<p class=Code style='margin-left:0in'>  def show(self):</p>

<p class=Code style='margin-left:0in'>    print &quot;Overridden show()
method&quot;</p>

<p class=Code style='margin-left:0in'>    # Calling a base-class method from
inside</p>

<p class=Code style='margin-left:0in'>    # the overridden method:</p>

<p class=Code style='margin-left:0in'>    Simple.show(self)</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Different:</p>

<p class=Code style='margin-left:0in'>  def show(self):</p>

<p class=Code style='margin-left:0in'>    print &quot;Not derived from
Simple&quot;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>if __name__ == &quot;__main__&quot;:</p>

<p class=Code style='margin-left:0in'>  x = Simple2(&quot;Simple2 constructor
argument&quot;)</p>

<p class=Code style='margin-left:0in'>  x.display()</p>

<p class=Code style='margin-left:0in'>  x.show()</p>

<p class=Code style='margin-left:0in'>  x.showMsg(&quot;Inside main&quot;)</p>

<p class=Code style='margin-left:0in'>  def f(obj): obj.show() # One-line
definition</p>

<p class=Code style='margin-left:0in'>  f(x)</p>

<p class=Code style='margin-left:0in'>  f(Different())</p>

<p class=Code style='margin-left:0in'>##~</p>

</div>

<p class=MsoNormal><b><span style='display:none'>#[BT_300]#</span>Simple2</b>
is inherited from <b>Simple</b>, and in the constructor, the base-class
constructor is called. In <b>display(&nbsp;)</b>, <b>showMsg(&nbsp;)</b> can be
called as a method of <b>self</b>, but when calling the base-class version of
the method you are overriding, you must fully qualify the name and pass <b>self</b>
in as the first argument, as shown in the base-class constructor call. This can
also be seen in the overridden version of <b>show(&nbsp;)</b>.</p>

<p class=MsoNormal><span style='display:none'>#[BT_301]#</span>In <b>__main__</b>,
you will see (when you run the program) that the base-class constructor is
called. You can also see that the <b>showMsg(&nbsp;)</b> method is available in
the derived class, just as you would expect with inheritance.</p>

<p class=MsoNormal><span style='display:none'>#[BT_302]#</span>The class <b>Different</b>
also has a method named <b>show(&nbsp;)</b>, but this class is not derived from
<b>Simple</b>. The <b>f(&nbsp;)</b> method defined in <b>__main__</b>
demonstrates weak typing: all it cares about is that <b>show(&nbsp;)</b> can be
applied to <b>obj</b>, and it doesn’t have any other type requirements. You can
see that <b>f(&nbsp;)</b> can be applied equally to an object of a class
derived from <b>Simple</b> and one that isn’t, without discrimination. If
you’re a C++ programmer, you should see that the objective of the C++ <b>template</b>
feature is exactly this: to provide weak typing in a strongly-typed language.
Thus, in Python you automatically get the equivalent of templates – without
having to learn that particularly difficult syntax and semantics.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169764">Creating a language</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_303]#</span>It turns out to
be remarkably simple to use Jython to create an interpreted language inside
your application. Consider the greenhouse controller example from Chapter 8 of <i>Thinking
in Java, 2<sup>nd</sup> edition</i>. This is a situation where you want the end
user – the person managing the greenhouse – to have configuration control over
the system, and so a simple scripting language is the ideal solution.</p>

<p class=MsoNormal><span style='display:none'>#[BT_304]#</span>To create the
language, we’ll simply write a set of Python classes, and the constructor of
each will add itself to a (static) master list. The common data and behavior
will be factored into the base class <b>Event</b>. Each <b>Event</b> object
will contain an <b>action</b> string (for simplicity – in reality, you’d have
some sort of functionality) and a time when the event is supposed to run. The
constructor initializes these fields, and then adds the new <b>Event</b> object
to a static list called <b>events</b> (defining it in the class, but outside of
any methods, is what makes it static):</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>#:interpreter:GreenHouseLanguage.py</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Event:</p>

<p class=Code style='margin-left:0in'>  events = [] # static</p>

<p class=Code style='margin-left:0in'>  def __init__(self, action, time):</p>

<p class=Code style='margin-left:0in'>    self.action = action</p>

<p class=Code style='margin-left:0in'>    self.time = time</p>

<p class=Code style='margin-left:0in'>    Event.events.append(self)</p>

<p class=Code style='margin-left:0in'>  # Used by sort(). This will cause</p>

<p class=Code style='margin-left:0in'>  # comparisons to be based only on time:</p>

<p class=Code style='margin-left:0in'>  def __cmp__ (self, other):</p>

<p class=Code style='margin-left:0in'>    if self.time &lt; other.time: return
-1</p>

<p class=Code style='margin-left:0in'>    if self.time &gt; other.time: return
1</p>

<p class=Code style='margin-left:0in'>    return 0</p>

<p class=Code style='margin-left:0in'>  def run(self):</p>

<p class=Code style='margin-left:0in'>    print &quot;%.2f: %s&quot; %
(self.time, self.action)</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class LightOn(Event):</p>

<p class=Code style='margin-left:0in'>  def __init__(self, time):</p>

<p class=Code style='margin-left:0in'>    Event.__init__(self, &quot;Light
on&quot;, time)</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class LightOff(Event):</p>

<p class=Code style='margin-left:0in'>  def __init__(self, time):</p>

<p class=Code style='margin-left:0in'>    Event.__init__(self, &quot;Light
off&quot;, time)</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class WaterOn(Event):</p>

<p class=Code style='margin-left:0in'>  def __init__(self, time):</p>

<p class=Code style='margin-left:0in'>    Event.__init__(self, &quot;Water
on&quot;, time)</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class WaterOff(Event):</p>

<p class=Code style='margin-left:0in'>  def __init__(self, time):</p>

<p class=Code style='margin-left:0in'>    Event.__init__(self, &quot;Water
off&quot;, time)</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class ThermostatNight(Event):</p>

<p class=Code style='margin-left:0in'>  def __init__(self, time):</p>

<p class=Code style='margin-left:0in'>    Event.__init__(self,&quot;Thermostat
night&quot;, time)</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class ThermostatDay(Event):</p>

<p class=Code style='margin-left:0in'>  def __init__(self, time):</p>

<p class=Code style='margin-left:0in'>    Event.__init__(self, &quot;Thermostat
day&quot;, time)</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Bell(Event):</p>

<p class=Code style='margin-left:0in'>  def __init__(self, time):</p>

<p class=Code style='margin-left:0in'>    Event.__init__(self, &quot;Ring
bell&quot;, time)</p>

<p class=Code style='margin-left:0in'>  </p>

<p class=Code style='margin-left:0in'>def run():</p>

<p class=Code style='margin-left:0in'>  Event.events.sort();</p>

<p class=Code style='margin-left:0in'>  for e in Event.events:</p>

<p class=Code style='margin-left:0in'>    e.run()</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'># To test, this will be run when you say:</p>

<p class=Code style='margin-left:0in'># python GreenHouseLanguage.py</p>

<p class=Code style='margin-left:0in'>if __name__ == &quot;__main__&quot;:</p>

<p class=Code style='margin-left:0in'>  ThermostatNight(5.00)</p>

<p class=Code style='margin-left:0in'>  LightOff(2.00)</p>

<p class=Code style='margin-left:0in'>  WaterOn(3.30)</p>

<p class=Code style='margin-left:0in'>  WaterOff(4.45)</p>

<p class=Code style='margin-left:0in'>  LightOn(1.00)</p>

<p class=Code style='margin-left:0in'>  ThermostatDay(6.00)</p>

<p class=Code style='margin-left:0in'>  Bell(7.00)</p>

<p class=Code style='margin-left:0in'>  run()</p>

<p class=Code style='margin-left:0in'>##~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_305]#</span>The constructor
of each derived class calls the base-class constructor, which adds the new
object to the list. The <b>run(&nbsp;)</b> function sorts the list, which
automatically uses the <b>__cmp__(&nbsp;)</b> method that was defined in <b>Event</b>
to base comparisons on time only. In this example, it only prints out the list,
but in the real system it would wait for the time of each event to come up and
then run the event.</p>

<p class=MsoNormal><span style='display:none'>#[BT_306]#</span>The <b>__main__</b>
section performs a simple test on the classes.</p>

<p class=MsoNormal><span style='display:none'>#[BT_307]#</span>The above file
is now a module that can be included in another Python program to define all
the classes it contains. But instead of an ordinary Python program, let’s use
Jython, inside of Java. This turns out to be remarkably simple: you import some
Jython classes, create a <b>PythonInterpreter</b> object, and cause the Python
files to be loaded:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'><span lang=IT>//- interpreter:GreenHouseController.java</span></p>

<p class=Code style='margin-left:0in'><span lang=IT>package interpreter;</span></p>

<p class=Code style='margin-left:0in'>import org.python.util.PythonInterpreter;
</p>

<p class=Code style='margin-left:0in'>import org.python.core.*; </p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class </p>

<p class=Code style='margin-left:0in'>GreenHouseController extends TestCase  { </p>

<p class=Code style='margin-left:0in'>  PythonInterpreter interp = </p>

<p class=Code style='margin-left:0in'>    new PythonInterpreter();</p>

<p class=Code style='margin-left:0in'>  public void test() throws PyException 
{</p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      &quot;Loading GreenHouse
Language&quot;);</p>

<p class=Code style='margin-left:0in'>   
interp.execfile(&quot;GreenHouseLanguage.py&quot;);</p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      &quot;Loading GreenHouse
Script&quot;);</p>

<p class=Code style='margin-left:0in'>   
interp.execfile(&quot;Schedule.ghs&quot;);</p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      &quot;Executing GreenHouse
Script&quot;);</p>

<p class=Code style='margin-left:0in'>    interp.exec(&quot;run()&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void </p>

<p class=Code style='margin-left:0in'>  main(String[] args) throws PyException 
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(GreenHouseController.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_308]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_309]#</span>The <b>PythonInterpreter</b>
object is a complete Python interpreter that accepts commands from the Java
program. One of these commands is <b>execfile(&nbsp;)</b>, which tells it to
execute all the statements it finds in a particular file. By executing <b>GreenHouseLanguage.py</b>,
all the classes from that file are loaded into our <b>PythonInterpreter</b>
object, and so it now “holds” the greenhouse controller language. The <b>Schedule.ghs</b>
file is the one created by the end user to control the greenhouse. Here’s an
example:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//:! interpreter:Schedule.ghs</p>

<p class=Code style='margin-left:0in'>Bell(7.00)</p>

<p class=Code style='margin-left:0in'>ThermostatDay(6.00)</p>

<p class=Code style='margin-left:0in'>WaterOn(3.30)</p>

<p class=Code style='margin-left:0in'>LightOn(1.00)</p>

<p class=Code style='margin-left:0in'>ThermostatNight(5.00)</p>

<p class=Code style='margin-left:0in'>LightOff(2.00)</p>

<p class=Code style='margin-left:0in'>WaterOff(4.45)</p>

<p class=Code style='margin-left:0in'>///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_310]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_311]#</span>This is the goal
of the interpreter design pattern: to make the configuration of your program as
simple as possible for the end user. With Jython you can achieve this with
almost no effort at all.</p>

<p class=MsoNormal><span style='display:none'>#[BT_312]#</span>One of the other
methods available to the <b>PythonInterpreter</b> is <b>exec(&nbsp;)</b>, which
allows you to send a command to the interpreter. Here, the <b>run(&nbsp;)</b>
function is called using <b>exec(&nbsp;)</b>. </p>

<p class=MsoNormal><span style='display:none'>#[BT_313]#</span>Remember, to run
this program you must go to <a href="http://sourceforge.net/projects/jython"><i>http://jython.sourceforge.net</i></a><i>
</i>and download and install Jython (actually, you only need <b>jython.jar</b>
in your CLASSPATH). Once that’s in place, it’s just like running any other Java
program.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169765">Controlling the
interpreter</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_314]#</span>The prior
example only creates and runs the interpreter using external scripts. In the
rest of this chapter, we shall look at more sophisticated ways to interact with
Jython. The simplest way to exercise more control over the <b>PythonInterpreter</b>
object from within Java is to send data to the interpreter, and pull data back
out.</p>

<h3><a name="_Toc41169766">Putting data in</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_315]#</span>To inject data
into your Python program, the <b>PythonInterpreter</b> class has a deceptively
simple method: <b>set(&nbsp;)</b>. However, <b>set(&nbsp;)</b> takes many
different data types and performs conversions upon them.  The following example
is a reasonably thorough exercise of the various <b>set(&nbsp;)</b>
possibilities, along with comments that should give a fairly complete
explanation:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//- interpreter:PythonInterpreterSetting.java</p>

<p class=Code style='margin-left:0in'>// Passing data from Java to python when
using</p>

<p class=Code style='margin-left:0in'>// the PythonInterpreter object.</p>

<p class=Code style='margin-left:0in'>package interpreter;</p>

<p class=Code style='margin-left:0in'>import org.python.util.PythonInterpreter;
</p>

<p class=Code style='margin-left:0in'>import org.python.core.*; </p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import com.bruceeckel.python.*;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class </p>

<p class=Code style='margin-left:0in'>PythonInterpreterSetting extends TestCase
 {</p>

<p class=Code style='margin-left:0in'>  PythonInterpreter interp = </p>

<p class=Code style='margin-left:0in'>    new PythonInterpreter();</p>

<p class=Code style='margin-left:0in'>  public void test() throws PyException 
{</p>

<p class=Code style='margin-left:0in'>    // It automatically converts Strings </p>

<p class=Code style='margin-left:0in'>    // into native Python strings:</p>

<p class=Code style='margin-left:0in'>    interp.set(&quot;a&quot;, &quot;This
is a test&quot;);</p>

<p class=Code style='margin-left:0in'>    interp.exec(&quot;print a&quot;);</p>

<p class=Code style='margin-left:0in'>    interp.exec(&quot;print a[5:]&quot;);
// A slice</p>

<p class=Code style='margin-left:0in'>    // It also knows what to do with
arrays:</p>

<p class=Code style='margin-left:0in'>    String[] s = { &quot;How&quot;,
&quot;Do&quot;, &quot;You&quot;, &quot;Do?&quot; };</p>

<p class=Code style='margin-left:0in'>    interp.set(&quot;b&quot;, s);</p>

<p class=Code style='margin-left:0in'>    interp.exec(&quot;for x in b: print
x[0], x&quot;);</p>

<p class=Code style='margin-left:0in'>    // set() only takes Objects, so it
can't </p>

<p class=Code style='margin-left:0in'>    // figure out primitives. Instead,</p>

<p class=Code style='margin-left:0in'>    // you have to use wrappers:</p>

<p class=Code style='margin-left:0in'>    interp.set(&quot;c&quot;, new
PyInteger(1));</p>

<p class=Code style='margin-left:0in'>    interp.set(&quot;d&quot;, new
PyFloat(2.2));</p>

<p class=Code style='margin-left:0in'>    interp.exec(&quot;print c + d&quot;);</p>

<p class=Code style='margin-left:0in'>    // You can also use Java's object
wrappers:</p>

<p class=Code style='margin-left:0in'>    interp.set(&quot;c&quot;, new
Integer(9));</p>

<p class=Code style='margin-left:0in'>    interp.set(&quot;d&quot;, new
Float(3.14));</p>

<p class=Code style='margin-left:0in'>    interp.exec(&quot;print c + d&quot;);</p>

<p class=Code style='margin-left:0in'>    // Define a Python function to print
arrays:</p>

<p class=Code style='margin-left:0in'>    interp.exec(</p>

<p class=Code style='margin-left:0in'>      &quot;def prt(x): \n&quot; +</p>

<p class=Code style='margin-left:0in'>      &quot;  print x \n&quot; +</p>

<p class=Code style='margin-left:0in'>      &quot;  for i in x: \n&quot; +</p>

<p class=Code style='margin-left:0in'>      &quot;    print i, \n&quot; +</p>

<p class=Code style='margin-left:0in'>      &quot;  print x.__class__\n&quot;);</p>

<p class=Code style='margin-left:0in'>    // Arrays are Objects, so it has no
trouble </p>

<p class=Code style='margin-left:0in'>    // figuring out the types contained
in arrays:</p>

<p class=Code style='margin-left:0in'>    Object[] types = {</p>

<p class=Code style='margin-left:0in'>      new boolean[]{ true, false, false,
true },</p>

<p class=Code style='margin-left:0in'>      new char[]{ 'a', 'b', 'c', 'd' },</p>

<p class=Code style='margin-left:0in'>      new byte[]{ 1, 2, 3, 4 },</p>

<p class=Code style='margin-left:0in'>      new int[]{ 10, 20, 30, 40 },</p>

<p class=Code style='margin-left:0in'>      new long[]{ 100, 200, 300, 400 },</p>

<p class=Code style='margin-left:0in'>      new float[]{ 1.1f, 2.2f, 3.3f, 4.4f
},</p>

<p class=Code style='margin-left:0in'>      new double[]{ 1.1, 2.2, 3.3, 4.4 },</p>

<p class=Code style='margin-left:0in'>    };</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; types.length;
i++) {</p>

<p class=Code style='margin-left:0in'>      <span lang=SV>interp.set(&quot;e&quot;,
types[i]);</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>      </span>interp.exec(&quot;prt(e)&quot;);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    // It uses toString() to print Java
objects:</p>

<p class=Code style='margin-left:0in'>    interp.set(&quot;f&quot;, new
Date());</p>

<p class=Code style='margin-left:0in'>    interp.exec(&quot;print f&quot;);</p>

<p class=Code style='margin-left:0in'>    // You can pass it a List </p>

<p class=Code style='margin-left:0in'>    // and index into it...</p>

<p class=Code style='margin-left:0in'>    List x = new ArrayList();</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; 10; i++)</p>

<p class=Code style='margin-left:0in'>        x.add(new Integer(i * 10));</p>

<p class=Code style='margin-left:0in'>    interp.set(&quot;g&quot;, x);</p>

<p class=Code style='margin-left:0in'>    interp.exec(&quot;print g&quot;);</p>

<p class=Code style='margin-left:0in'>    interp.exec(&quot;print g[1]&quot;);</p>

<p class=Code style='margin-left:0in'>    // ... But it's not quite smart
enough</p>

<p class=Code style='margin-left:0in'>    // to treat it as a Python array:</p>

<p class=Code style='margin-left:0in'>    interp.exec(&quot;print
g.__class__&quot;);</p>

<p class=Code style='margin-left:0in'>    // interp.exec(&quot;print g[5:]); //
Fails</p>

<p class=Code style='margin-left:0in'>    // If you want it to be a python
array, you</p>

<p class=Code style='margin-left:0in'>    // must extract the Java array:</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;ArrayList to
array:&quot;);</p>

<p class=Code style='margin-left:0in'>    interp.set(&quot;h&quot;,
x.toArray());</p>

<p class=Code style='margin-left:0in'>    interp.exec(&quot;print
h.__class__&quot;);</p>

<p class=Code style='margin-left:0in'>    interp.exec(&quot;print h[5:]&quot;);</p>

<p class=Code style='margin-left:0in'>    // Passing in a Map:</p>

<p class=Code style='margin-left:0in'>    Map m = new HashMap();</p>

<p class=Code style='margin-left:0in'>    m.put(new Integer(1), new
Character('a'));</p>

<p class=Code style='margin-left:0in'>    m.put(new Integer(3), new
Character('b'));</p>

<p class=Code style='margin-left:0in'>    m.put(new Integer(5), new
Character('c'));</p>

<p class=Code style='margin-left:0in'>    m.put(new Integer(7), new
Character('d'));</p>

<p class=Code style='margin-left:0in'>    m.put(new Integer(11), new
Character('e'));</p>

<p class=Code style='margin-left:0in'>    <span lang=SV>System.out.println(&quot;m:
&quot; + m);</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>    </span>interp.set(&quot;m&quot;,
m);</p>

<p class=Code style='margin-left:0in'>    interp.exec(&quot;print m,
m.__class__, &quot; + </p>

<p class=Code style='margin-left:0in'>      &quot;m[1], m[1].__class__&quot;);</p>

<p class=Code style='margin-left:0in'>    // Not a Python dictionary, so this
fails:</p>

<p class=Code style='margin-left:0in'>    //! interp.exec(&quot;for x in
m.keys():&quot; +</p>

<p class=Code style='margin-left:0in'>    //!   &quot;print x, m[x]&quot;);</p>

<p class=Code style='margin-left:0in'>    // To convert a Map to a Python dictionary,</p>

<p class=Code style='margin-left:0in'>    // use com.bruceeckel.python.PyUtil:</p>

<p class=Code style='margin-left:0in'>    interp.set(&quot;m&quot;,
PyUtil.toPyDictionary(m));</p>

<p class=Code style='margin-left:0in'>    interp.exec(&quot;print m,
m.__class__, &quot; + </p>

<p class=Code style='margin-left:0in'>      &quot;m[1], m[1].__class__&quot;);</p>

<p class=Code style='margin-left:0in'>    interp.exec(&quot;for x in
m.keys():print x,m[x]&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void </p>

<p class=Code style='margin-left:0in'>  main(String[] args) throws PyException 
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(</p>

<p class=Code style='margin-left:0in'>      PythonInterpreterSetting.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_316]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_317]#</span>As usual with
Java, the distinction between real objects and primitive types causes trouble.
In general, if you pass a regular object to <b>set(&nbsp;)</b>, it knows what
to do with it, but if you want to pass in a primitive you must perform a
conversion. One way to do this is to create a “Py” type, such as <b>PyInteger</b>
or <b>PyFloat</b>. but it turns out you can also use Java’s own object wrappers
like <b>Integer</b> and <b>Float</b>, which is probably going to be a lot
easier to remember.</p>

<p class=MsoNormal><span style='display:none'>#[BT_318]#</span>Early in the
program you’ll see an <b>exec(&nbsp;)</b> containing the Python statement:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>print a[5:]</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_319]#</span>The colon inside
the indexing statement indicates a Python <i>slice</i>, which produces a range
of elements from the original array. In this case, it produces an array
containing the elements from number 5 until the end of the array. You could
also say ‘<b>a[3:5]</b>’ to produce elements 3 through 5, or ‘<b>a[:5]</b>’ to
produce the elements zero through 5. The reason a slice is used in this
statement is to make sure that the Java <b>String</b> has really been converted
to a Python string, which can also be treated as an array of characters.</p>

<p class=MsoNormal><span style='display:none'>#[BT_320]#</span>You can see that
it’s possible, using <b>exec(&nbsp;)</b>, to create a Python function (although
it’s a bit awkward). The <b>prt(&nbsp;)</b> function prints the whole array,
and then (to make sure it’s a real Python array), iterates through each element
of the array and prints it. Finally, it prints the class of the array, so we
can see what conversion has taken place (Python not only has run-time type
information, it also has the equivalent of Java reflection). The <b>prt(&nbsp;)</b>
function is used to print arrays that come from each of the Java primitive
types.</p>

<p class=MsoNormal><span style='display:none'>#[BT_321]#</span>Although a Java <b>ArrayList</b>
does pass into the interpreter using <b>set(&nbsp;)</b>, and you can index into
it as if it were an array, trying to create a slice fails. To completely
convert it into an array, one approach is to simply extract a Java array using <b>toArray(&nbsp;)</b>,
and pass that in. The <b>set(&nbsp;)</b> method converts it to a <b>PyArray</b>
– one of the classes provided with Jython – which can be treated as a Python
array (you can also explicitly create a <b>PyArray</b>, but this seems
unnecessary).</p>

<p class=MsoNormal><span style='display:none'>#[BT_322]#</span>Finally, a <b>Map</b>
is created and passed directly into the interpreter. While it is possible to do
simple things like index into the resulting object, it’s not a real Python
dictionary so you can’t (for example) call the <b>keys(&nbsp;)</b> method.
There is no straightforward way to convert a Java <b>Map</b> into a Python
dictionary, and so I wrote a utility called <b>toPyDictionary(&nbsp;)</b> and
made it a <b>static</b> method of <b>com.bruceeckel.python.PyUtil</b>. This
also includes utilities to extract a Python array into a Java <b>List</b>, and
a Python dictionary into a Java <b>Map</b>:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//- com:bruceeckel:python:PyUtil.java</p>

<p class=Code style='margin-left:0in'>// PythonInterpreter utilities</p>

<p class=Code style='margin-left:0in'>package com.bruceeckel.python;</p>

<p class=Code style='margin-left:0in'>import org.python.util.PythonInterpreter;
</p>

<p class=Code style='margin-left:0in'>import org.python.core.*; </p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class PyUtil { </p>

<p class=Code style='margin-left:0in'>  /** Extract a Python tuple or array
into a Java</p>

<p class=Code style='margin-left:0in'>  List (which can be converted into other
kinds </p>

<p class=Code style='margin-left:0in'>  of lists and sets inside Java). </p>

<p class=Code style='margin-left:0in'>  @param interp The Python interpreter
object</p>

<p class=Code style='margin-left:0in'>  @param pyName The id of the python list
object</p>

<p class=Code style='margin-left:0in'>  */</p>

<p class=Code style='margin-left:0in'>  public static List </p>

<p class=Code style='margin-left:0in'>  toList(PythonInterpreter interp, String
pyName){</p>

<p class=Code style='margin-left:0in'>    return new ArrayList(Arrays.asList(</p>

<p class=Code style='margin-left:0in'>      (Object[])interp.get(</p>

<p class=Code style='margin-left:0in'>        pyName, Object[].class)));</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  /** Extract a Python dictionary into a
Java Map</p>

<p class=Code style='margin-left:0in'>  @param interp The Python interpreter
object</p>

<p class=Code style='margin-left:0in'>  @param pyName The id of the python
dictionary</p>

<p class=Code style='margin-left:0in'>  */</p>

<p class=Code style='margin-left:0in'>  public static Map </p>

<p class=Code style='margin-left:0in'>  toMap(PythonInterpreter interp, String
pyName){</p>

<p class=Code style='margin-left:0in'>    PyList pa =
((PyDictionary)interp.get(</p>

<p class=Code style='margin-left:0in'>      pyName)).items();</p>

<p class=Code style='margin-left:0in'>    Map map = new HashMap();</p>

<p class=Code style='margin-left:0in'>    while(pa.__len__() != 0) {</p>

<p class=Code style='margin-left:0in'>      PyTuple po = (PyTuple)pa.pop();</p>

<p class=Code style='margin-left:0in'>      Object first = po.__finditem__(0)</p>

<p class=Code style='margin-left:0in'>        .__tojava__(Object.class);</p>

<p class=Code style='margin-left:0in'>      Object second = po.__finditem__(1)</p>

<p class=Code style='margin-left:0in'>        .__tojava__(Object.class);</p>

<p class=Code style='margin-left:0in'>      map.put(first, second);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    return map;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  /** Turn a Java Map into a
PyDictionary, </p>

<p class=Code style='margin-left:0in'>  suitable for placing into a
PythonInterpreter</p>

<p class=Code style='margin-left:0in'>  @param map The Java Map object</p>

<p class=Code style='margin-left:0in'>  */</p>

<p class=Code style='margin-left:0in'>  public static PyDictionary </p>

<p class=Code style='margin-left:0in'>  toPyDictionary(Map map) {</p>

<p class=Code style='margin-left:0in'>    Map m = new HashMap();</p>

<p class=Code style='margin-left:0in'>    Iterator it =
map.entrySet().iterator();</p>

<p class=Code style='margin-left:0in'>    while(it.hasNext()) {</p>

<p class=Code style='margin-left:0in'>      Map.Entry e = (Map.Entry)it.next();</p>

<p class=Code style='margin-left:0in'>      m.put(Py.java2py(e.getKey()), </p>

<p class=Code style='margin-left:0in'>        Py.java2py(e.getValue()));</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    // PyDictionary constructor wants a
Hashtable:</p>

<p class=Code style='margin-left:0in'>    return new PyDictionary(new
Hashtable(m));</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_323]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_324]#</span>Here is the
(black-box) unit testing code:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//- com:bruceeckel:python:Test.java</p>

<p class=Code style='margin-left:0in'>package com.bruceeckel.python;</p>

<p class=Code style='margin-left:0in'>import org.python.util.PythonInterpreter;
</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class Test extends TestCase  {</p>

<p class=Code style='margin-left:0in'>  PythonInterpreter pi =</p>

<p class=Code style='margin-left:0in'>    new PythonInterpreter();</p>

<p class=Code style='margin-left:0in'>  public void test1() {</p>

<p class=Code style='margin-left:0in'>   
pi.exec(&quot;tup=('fee','fi','fo','fum','fi')&quot;);</p>

<p class=Code style='margin-left:0in'>    List lst = PyUtil.toList(pi,
&quot;tup&quot;);</p>

<p class=Code style='margin-left:0in'>    System.out.println(lst);</p>

<p class=Code style='margin-left:0in'>    System.out.println(new HashSet(lst));</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void test2() {</p>

<p class=Code style='margin-left:0in'>   
pi.exec(&quot;ints=[1,3,5,7,9,11,13,17,19]&quot;);</p>

<p class=Code style='margin-left:0in'>    <span lang=SV>List lst =
PyUtil.toList(pi, &quot;ints&quot;);</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>   
System.out.println(lst);</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>  </span>}</p>

<p class=Code style='margin-left:0in'>  public void test3() {</p>

<p class=Code style='margin-left:0in'>    pi.exec(&quot;dict = { 1 : 'a', 3 :
'b', &quot; + </p>

<p class=Code style='margin-left:0in'>      &quot;5 : 'c', 9 : 'd', 11 :
'e'}&quot;);</p>

<p class=Code style='margin-left:0in'>    Map mp = PyUtil.toMap(pi,
&quot;dict&quot;);</p>

<p class=Code style='margin-left:0in'>    System.out.println(mp);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void test4() {</p>

<p class=Code style='margin-left:0in'>    Map m = new HashMap();</p>

<p class=Code style='margin-left:0in'>    m.put(&quot;twas&quot;, new
Integer(11));</p>

<p class=Code style='margin-left:0in'>    m.put(&quot;brillig&quot;, new
Integer(27));</p>

<p class=Code style='margin-left:0in'>    m.put(&quot;and&quot;, new
Integer(47));</p>

<p class=Code style='margin-left:0in'>    m.put(&quot;the&quot;, new
Integer(42));</p>

<p class=Code style='margin-left:0in'>    m.put(&quot;slithy&quot;, new
Integer(33));</p>

<p class=Code style='margin-left:0in'>    m.put(&quot;toves&quot;, new Integer(55));</p>

<p class=Code style='margin-left:0in'>    System.out.println(m);</p>

<p class=Code style='margin-left:0in'>    pi.set(&quot;m&quot;,
PyUtil.toPyDictionary(m));</p>

<p class=Code style='margin-left:0in'>    pi.exec(&quot;print m&quot;);</p>

<p class=Code style='margin-left:0in'>    pi.exec(&quot;print
m['slithy']&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(Test.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_325]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_326]#</span>We’ll see the
use of the extraction tools in the next section.</p>

<h3><a name="_Toc41169767">Getting data out</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_327]#</span>There are a
number of different ways to extract data from the <b>PythonInterpreter</b>. If
you simply call the <b>get(&nbsp;)</b> method, passing it the object identifier
as a string, it returns a <b>PyObject</b> (part of the <b>org.python.core</b>
support classes). It’s possible to “cast” it using the <b>__tojava__(&nbsp;)</b>
method, but there are better alternatives:</p>

<p class=Numbered><span style='font-family:Verdana'>1.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>The convenience methods in the <b>Py</b> class, such as <b>py2int(&nbsp;)</b>,
take a <b>PyObject</b> and convert it to a number of different types.</p>

<p class=Numbered><span style='font-family:Verdana'>2.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>An overloaded version of <b>get(&nbsp;)</b> takes the desired
Java <b>Class</b> object as a second argument, and produces an object that has
that run-time type (so you still need to perform a cast on the result in your
Java code).</p>

<p class=MsoNormal><span style='display:none'>#[BT_328]#</span>Using the second
approach, getting an array from the <b>PythonInterpreter</b> is quite easy.
This is especially useful because Python is exceptionally good at manipulating
strings and files, and so you will commonly want to extract the results as an
array of strings. For example, you can do a wildcard expansion of file names
using Python’s <b>glob(&nbsp;)</b>, as shown further down in the following
code:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//- interpreter:PythonInterpreterGetting.java</p>

<p class=Code style='margin-left:0in'>// Getting data from the
PythonInterpreter object.</p>

<p class=Code style='margin-left:0in'>package interpreter;</p>

<p class=Code style='margin-left:0in'>import org.python.util.PythonInterpreter;
</p>

<p class=Code style='margin-left:0in'>import org.python.core.*; </p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import com.bruceeckel.python.*;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class </p>

<p class=Code style='margin-left:0in'>PythonInterpreterGetting extends TestCase
{ </p>

<p class=Code style='margin-left:0in'>  PythonInterpreter interp = </p>

<p class=Code style='margin-left:0in'>    new PythonInterpreter();</p>

<p class=Code style='margin-left:0in'>  public void test() throws PyException 
{ </p>

<p class=Code style='margin-left:0in'>    interp.exec(&quot;a = 100&quot;);</p>

<p class=Code style='margin-left:0in'>    // If you just use the ordinary
get(), </p>

<p class=Code style='margin-left:0in'>    // it returns a PyObject:</p>

<p class=Code style='margin-left:0in'>    PyObject a =
interp.get(&quot;a&quot;);</p>

<p class=Code style='margin-left:0in'>    // There's not much you can do with a
generic</p>

<p class=Code style='margin-left:0in'>    // PyObject, but you can print it
out:</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;a = &quot; +
a);</p>

<p class=Code style='margin-left:0in'>    // If you know the type it's supposed
to be,</p>

<p class=Code style='margin-left:0in'>    // you can &quot;cast&quot; it using
__tojava__() to</p>

<p class=Code style='margin-left:0in'>    // that Java type and manipulate it
in Java.</p>

<p class=Code style='margin-left:0in'>    // To use 'a' as an int, you must use</p>

<p class=Code style='margin-left:0in'>    // the Integer wrapper class:</p>

<p class=Code style='margin-left:0in'>    int ai=
((Integer)a.__tojava__(Integer.class))</p>

<p class=Code style='margin-left:0in'>      .intValue();</p>

<p class=Code style='margin-left:0in'>    // There are also convenience
functions:</p>

<p class=Code style='margin-left:0in'>    <span lang=IT>ai = Py.py2int(a);</span></p>

<p class=Code style='margin-left:0in'><span lang=IT>   
System.out.println(&quot;ai + 47 = &quot; + (ai + 47));</span></p>

<p class=Code style='margin-left:0in'><span lang=IT>    </span>// You can
convert it to different types:</p>

<p class=Code style='margin-left:0in'>    float af = Py.py2float(a);</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;af + 47 =
&quot; + (af + 47));</p>

<p class=Code style='margin-left:0in'>    // If you try to cast it to an
inappropriate</p>

<p class=Code style='margin-left:0in'>    // type you'll get a runtime
exception:</p>

<p class=Code style='margin-left:0in'>    //! String as = (String)a.__tojava__(</p>

<p class=Code style='margin-left:0in'>    //!   String.class);</p>

<p class=Code style='margin-left:0in'>    </p>

<p class=Code style='margin-left:0in'>    // If you know the type, a more
useful method</p>

<p class=Code style='margin-left:0in'>    // is the overloaded get() that takes
the </p>

<p class=Code style='margin-left:0in'>    // desired class as the 2nd argument:</p>

<p class=Code style='margin-left:0in'>    <span lang=SV>interp.exec(&quot;x = 1
+ 2&quot;);</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>    int x =
((Integer)interp</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>      </span>.get(&quot;x&quot;,
Integer.class)).intValue();</p>

<p class=Code style='margin-left:0in'>    <span lang=SV>System.out.println(&quot;x
= &quot; + x);</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>    </span></p>

<p class=Code style='margin-left:0in'><span lang=SV>    </span>// Since Python
is so good at manipulating</p>

<p class=Code style='margin-left:0in'>    // strings and files, you will often
need to</p>

<p class=Code style='margin-left:0in'>    // extract an array of Strings. Here,
a file </p>

<p class=Code style='margin-left:0in'>    // is read as a Python array:</p>

<p class=Code style='margin-left:0in'>    interp.exec(&quot;lines = &quot; + </p>

<p class=Code style='margin-left:0in'>      &quot;open('PythonInterpreterGetting.java')&quot;
+</p>

<p class=Code style='margin-left:0in'>      &quot;.readlines()&quot;);</p>

<p class=Code style='margin-left:0in'>    // Pull it in as a Java array of
String:</p>

<p class=Code style='margin-left:0in'>    String[] lines = (String[])</p>

<p class=Code style='margin-left:0in'>      interp.get(&quot;lines&quot;,
String[].class);</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; 10; i++)</p>

<p class=Code style='margin-left:0in'>      System.out.print(lines[i]);</p>

<p class=Code style='margin-left:0in'>    </p>

<p class=Code style='margin-left:0in'>    // As an example of useful string
tools,</p>

<p class=Code style='margin-left:0in'>    // global expansion of ambiguous file
names</p>

<p class=Code style='margin-left:0in'>    // using glob is very useful, but
it's not</p>

<p class=Code style='margin-left:0in'>    // part of the standard Jython
package, so</p>

<p class=Code style='margin-left:0in'>    // you'll have to make sure that your</p>

<p class=Code style='margin-left:0in'>    // Python path is set to include
these, or</p>

<p class=Code style='margin-left:0in'>    // that you deliver the necessary
Python</p>

<p class=Code style='margin-left:0in'>    // files with your application.</p>

<p class=Code style='margin-left:0in'>    interp.exec(&quot;from glob import
glob&quot;);</p>

<p class=Code style='margin-left:0in'>    interp.exec(&quot;files =
glob('*.java')&quot;);</p>

<p class=Code style='margin-left:0in'>    String[] files = (String[])</p>

<p class=Code style='margin-left:0in'>      interp.get(&quot;files&quot;,
String[].class);</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; files.length;
i++)</p>

<p class=Code style='margin-left:0in'>      System.out.println(files[i]);</p>

<p class=Code style='margin-left:0in'>    </p>

<p class=Code style='margin-left:0in'>    // You can extract tuples and arrays
into </p>

<p class=Code style='margin-left:0in'>    // Java Lists with
com.bruceeckel.PyUtil:</p>

<p class=Code style='margin-left:0in'>    interp.exec(</p>

<p class=Code style='margin-left:0in'>      &quot;tup = ('fee', 'fi', 'fo',
'fum', 'fi')&quot;);</p>

<p class=Code style='margin-left:0in'>    List tup = PyUtil.toList(interp,
&quot;tup&quot;);</p>

<p class=Code style='margin-left:0in'>    System.out.println(tup);</p>

<p class=Code style='margin-left:0in'>    // It really is a list of String
objects:</p>

<p class=Code style='margin-left:0in'>   
System.out.println(tup.get(0).getClass());</p>

<p class=Code style='margin-left:0in'>    // You can easily convert it to a
Set:</p>

<p class=Code style='margin-left:0in'>    Set tups = new HashSet(tup);</p>

<p class=Code style='margin-left:0in'>    System.out.println(tups);</p>

<p class=Code style='margin-left:0in'>    interp.exec(&quot;ints=[1,3,5,7,9,11,13,17,19]&quot;);</p>

<p class=Code style='margin-left:0in'>    List ints = PyUtil.toList(interp,
&quot;ints&quot;);</p>

<p class=Code style='margin-left:0in'>    System.out.println(ints);</p>

<p class=Code style='margin-left:0in'>    // It really is a List of Integer
objects:</p>

<p class=Code style='margin-left:0in'>   
System.out.println((ints.get(1)).getClass());</p>

<p class=Code style='margin-left:0in'>    </p>

<p class=Code style='margin-left:0in'>    // If you have a Python dictionary,
it can</p>

<p class=Code style='margin-left:0in'>    // be extracted into a Java Map,
again with</p>

<p class=Code style='margin-left:0in'>    // com.bruceeckel.PyUtil:</p>

<p class=Code style='margin-left:0in'>    interp.exec(&quot;dict = { 1 : 'a', 3
: 'b',&quot; +</p>

<p class=Code style='margin-left:0in'>      &quot;5 : 'c', 9 : 'd', 11 : 'e'
}&quot;);</p>

<p class=Code style='margin-left:0in'>    Map map = PyUtil.toMap(interp,
&quot;dict&quot;);</p>

<p class=Code style='margin-left:0in'>    <span lang=SV>System.out.println(&quot;map:
&quot; + map);</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>    </span>// It really is
Java objects, not PyObjects:</p>

<p class=Code style='margin-left:0in'>    Iterator it =
map.entrySet().iterator();</p>

<p class=Code style='margin-left:0in'>    Map.Entry e = (Map.Entry)it.next();</p>

<p class=Code style='margin-left:0in'>   
System.out.println(e.getKey().getClass());</p>

<p class=Code style='margin-left:0in'>   
System.out.println(e.getValue().getClass());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void </p>

<p class=Code style='margin-left:0in'>  main(String[] args) throws PyException 
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(</p>

<p class=Code style='margin-left:0in'>      PythonInterpreterGetting.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_329]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_330]#</span>The last two
examples show the extraction of Python tuples and lists into Java <b>List</b>s,
and Python dictionaries into Java <b>Map</b>s. Both of these cases require more
processing than is provided in the standard Jython library, so I have again
created utilities in <b>com.bruceeckel.pyton.PyUtil</b>: <b>toList(&nbsp;)</b>
to produce a <b>List</b> from a Python sequence, and <b>toMap(&nbsp;)</b> to
produce a <b>Map</b> from a Python dictionary. The <b>PyUtil</b> methods make
it easier to take important data structures back and forth between Java and
Python.</p>

<h3><a name="_Toc41169768">Multiple interpreters</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_331]#</span>It’s also worth
noting that you can have multiple <b>PythonInterpreter</b> objects in a
program, and each one has its own name space:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//- interpreter:MultipleJythons.java</p>

<p class=Code style='margin-left:0in'>// You can run multiple interpreters,
each</p>

<p class=Code style='margin-left:0in'>// with its own name space.</p>

<p class=Code style='margin-left:0in'>package interpreter;</p>

<p class=Code style='margin-left:0in'>import org.python.util.PythonInterpreter;
</p>

<p class=Code style='margin-left:0in'>import org.python.core.*; </p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class MultipleJythons extends
TestCase  { </p>

<p class=Code style='margin-left:0in'>  PythonInterpreter </p>

<p class=Code style='margin-left:0in'>    interp1 =  new PythonInterpreter(),</p>

<p class=Code style='margin-left:0in'>    interp2 =  new PythonInterpreter();</p>

<p class=Code style='margin-left:0in'>  public void test() throws PyException {
</p>

<p class=Code style='margin-left:0in'>    interp1.set(&quot;a&quot;, new
PyInteger(42));</p>

<p class=Code style='margin-left:0in'>    interp2.set(&quot;a&quot;, new
PyInteger(47));</p>

<p class=Code style='margin-left:0in'>    interp1.exec(&quot;print a&quot;);</p>

<p class=Code style='margin-left:0in'>    interp2.exec(&quot;print a&quot;);</p>

<p class=Code style='margin-left:0in'>    PyObject x1 =
interp1.get(&quot;a&quot;);</p>

<p class=Code style='margin-left:0in'>    PyObject x2 =
interp2.get(&quot;a&quot;);</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;a from
interp1: &quot; + x1);</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;a from
interp2: &quot; + x2);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void </p>

<p class=Code style='margin-left:0in'>  main(String[] args) throws PyException 
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(MultipleJythons.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_332]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_333]#</span>When you run the
program you’ll see that the value of <b>a</b> is distinct within each <b>PythonInterpreter</b>.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169769">Controlling Java from
Jython</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_334]#</span>Since you have
the Java language at your disposal, and you can set and retrieve values in the
interpreter, there’s a tremendous amount that you can accomplish with the above
approach (controlling Python from Java).  But one of the amazing things about
Jython is that it makes Java classes almost transparently available from within
Jython. Basically, a Java class looks like a Python class. This is true for
standard Java library classes as well as classes that you create yourself, as
you can see here:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>## interpreter:JavaClassInPython.py</p>

<p class=Code style='margin-left:0in'>#=M jython.bat JavaClassInPython.py</p>

<p class=Code style='margin-left:0in'># Using Java classes within Jython</p>

<p class=Code style='margin-left:0in'>from java.util import Date, HashSet,
HashMap</p>

<p class=Code style='margin-left:0in'>from interpreter.javaclass import
JavaClass</p>

<p class=Code style='margin-left:0in'>from math import sin</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>d = Date() # Creating a Java Date object</p>

<p class=Code style='margin-left:0in'>print d # Calls toString()</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'># A &quot;generator&quot; to easily
create data:</p>

<p class=Code style='margin-left:0in'>class ValGen:</p>

<p class=Code style='margin-left:0in'>  def __init__(self, maxVal):</p>

<p class=Code style='margin-left:0in'>    self.val = range(maxVal)</p>

<p class=Code style='margin-left:0in'>  # Called during 'for' iteration:</p>

<p class=Code style='margin-left:0in'>  def __getitem__(self, i):</p>

<p class=Code style='margin-left:0in'>    # Returns a tuple of two elements:</p>

<p class=Code style='margin-left:0in'>    return self.val[i], sin(self.val[i])</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'># Java standard containers:</p>

<p class=Code style='margin-left:0in'>map = HashMap()</p>

<p class=Code style='margin-left:0in'>set = HashSet()</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>for x, y in ValGen(10):</p>

<p class=Code style='margin-left:0in'>  map.put(x, y)</p>

<p class=Code style='margin-left:0in'>  set.add(y)</p>

<p class=Code style='margin-left:0in'>  set.add(y)</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>print map</p>

<p class=Code style='margin-left:0in'>print set</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'># Iterating through a set:</p>

<p class=Code style='margin-left:0in'>for z in set:</p>

<p class=Code style='margin-left:0in'>  print z, z.__class__</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>print map[3] # Uses Python dictionary
indexing</p>

<p class=Code style='margin-left:0in'>for x in map.keySet(): # keySet() is a
Map method</p>

<p class=Code style='margin-left:0in'>  print x, map[x]</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'># Using a Java class that you create
yourself is</p>

<p class=Code style='margin-left:0in'># just as easy:</p>

<p class=Code style='margin-left:0in'>jc = JavaClass()</p>

<p class=Code style='margin-left:0in'>jc2 = JavaClass(&quot;Created within
Jython&quot;)</p>

<p class=Code style='margin-left:0in'>print jc2.getVal()</p>

<p class=Code style='margin-left:0in'>jc.setVal(&quot;Using a Java class is
trivial&quot;)</p>

<p class=Code style='margin-left:0in'>print jc.getVal()</p>

<p class=Code style='margin-left:0in'>print jc.getChars()</p>

<p class=Code style='margin-left:0in'>jc.val = &quot;Using bean
properties&quot;</p>

<p class=Code style='margin-left:0in'>print jc.val</p>

<p class=Code style='margin-left:0in'>##~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_335]#</span>The “<b>=M</b>”
comment is recognized by the makefile generator tool (that I created for this
book) as a replacement makefile command. This will be used instead of the
commands that the extraction tool would normally place in the makefile.</p>

<p class=MsoNormal><span style='display:none'>#[BT_336]#</span>Note that the <b>import</b>
statements map to the Java package structure exactly as you would expect. In
the first example, a <b>Date(&nbsp;)</b> object is created as if it were a
native Python class, and printing this object just calls <b>toString(&nbsp;)</b>.</p>

<p class=MsoNormal><b><span style='display:none'>#[BT_337]#</span>ValGen</b>
implements the concept of a “generator” which is used a great deal in the C++
STL (<i>Standard Template Library</i>, part of the Standard C++ Library). A
generator is an object that produces a new object every time its “generation
method” is called, and it is quite convenient for filling containers. Here, I
wanted to use it in a <b>for</b> iteration, and so I needed the generation
method to be the one that is called by the iteration process. This is a special
method called <b>__getitem__(&nbsp;)</b>, which is actually the overloaded
operator for indexing, ‘<b>[ ]</b>’. A <b>for</b> loop calls this method every
time it wants to move the iteration forward, and when the elements run out, <b>__getitem__(&nbsp;)</b>
throws an out-of-bounds exception and that signals the end of the <b>for</b>
loop (in other languages, you would never use an exception for ordinary control
flow, but in Python it seems to work quite well). This exception happens
automatically when <b>self.val[i]</b> runs out of elements, so the <b>__getitem__(&nbsp;)</b>
code turns out to be simple. The only complexity is that <b>__getitem__(&nbsp;)</b>
appears to return <i>two</i> objects instead of just one. What Python does is
automatically package multiple return values into a tuple, so you still only
end up returning a single object (in C++ or Java you would have to create your
own data structure to accomplish this). In addition, in the <b>for</b> loop
where <b>ValGen</b> is used, Python automatically “unpacks” the tuple so that
you can have multiple iterators in the <b>for</b>. These are the kinds of
syntax simplifications that make Python so endearing.</p>

<p class=MsoNormal><span style='display:none'>#[BT_338]#</span>The <b>map</b>
and <b>set</b> objects are instances of Java’s <b>HashMap</b> and <b>HashSet</b>,
again created as if those classes were just native Python components. In the <b>for</b>
loop, the <b>put(&nbsp;)</b> and <b>add(&nbsp;)</b> methods work just like they
do in Java. Also, indexing into a Java <b>Map</b> uses the same notation as for
dictionaries, but note that to iterate through the keys in a <b>Map</b> you
must use the <b>Map</b> method <b>keySet(&nbsp;)</b> rather than the Python
dictionary method <b>keys(&nbsp;)</b>.</p>

<p class=MsoNormal><span style='display:none'>#[BT_339]#</span>The final part
of the example shows the use of a Java class that I created from scratch, to
demonstrate how trivial it is. Notice also that Jython intuitively understands
JavaBeans properties, since you can either use the <b>getVal(&nbsp;)</b> and <b>setVal(&nbsp;)</b>
methods, or assign to and read from the equivalent <b>val</b> property. Also, <b>getChars(&nbsp;)</b>
returns a <b>Character[]</b> in Java, and this becomes an array in Python.</p>

<p class=MsoNormal><span style='display:none'>#[BT_340]#</span>The easiest way
to use Java classes that you create for use inside a Python program is to put
them inside a package. Although Jython can also import unpackaged java classes
(<b>import JavaClass</b>), all such unpackaged java classes will be treated as
if they were defined in different packages so they can only see each other’s
public methods. </p>

<p class=MsoNormal><span style='display:none'>#[BT_341]#</span>Java packages
translate into Python modules, and Python must import a module in order to be
able to use the Java class. Here is the Java code for <b>JavaClass</b>:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//- interpreter:javaclass:JavaClass.java</p>

<p class=Code style='margin-left:0in'>package interpreter.javaclass;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>import com.bruceeckel.util.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class JavaClass {</p>

<p class=Code style='margin-left:0in'>  private String s = &quot;&quot;;</p>

<p class=Code style='margin-left:0in'>  public JavaClass() {</p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;JavaClass()&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public JavaClass(String a) {</p>

<p class=Code style='margin-left:0in'>    s = a;</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;JavaClass(String)&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String getVal() {</p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;getVal()&quot;);</p>

<p class=Code style='margin-left:0in'>    return s;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void setVal(String a) {</p>

<p class=Code style='margin-left:0in'>   
System.out.println(&quot;setVal()&quot;);</p>

<p class=Code style='margin-left:0in'>    s = a;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public Character[] getChars() {</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;getChars()&quot;);</p>

<p class=Code style='margin-left:0in'>    Character[] r = new
Character[s.length()];</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; s.length();
i++)</p>

<p class=Code style='margin-left:0in'>      r[i] = new Character(s.charAt(i));</p>

<p class=Code style='margin-left:0in'>    return r;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static class Test extends
TestCase  {</p>

<p class=Code style='margin-left:0in'>    JavaClass </p>

<p class=Code style='margin-left:0in'>      x1 = new JavaClass(),</p>

<p class=Code style='margin-left:0in'>      x2 = new
JavaClass(&quot;UnitTest&quot;);</p>

<p class=Code style='margin-left:0in'>    public void test1() {</p>

<p class=Code style='margin-left:0in'>      System.out.println(x2.getVal());</p>

<p class=Code style='margin-left:0in'>     
x1.setVal(&quot;SpamEggsSausageAndSpam&quot;);</p>

<p class=Code style='margin-left:0in'>      System.out.println(</p>

<p class=Code style='margin-left:0in'>        Arrays2.toString(x1.getChars()));</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String[] args)
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(Test.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_342]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_343]#</span>You can see that
this is just an ordinary Java class, without any awareness that it will be used
in a Jython program. For this reason, one of the important uses of Jython is in
testing Java code<a href="#_ftn10" name="_ftnref10" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><span style='font-size:11.0pt;font-family:Georgia;
vertical-align:baseline'>[10]</span></span></span></span></a>. Because Python
is such a powerful, flexible, dynamic language it is an ideal tool for
automated test frameworks, without making any changes to the Java code that’s
being tested.</p>

<h3><a name="_Toc41169770">Inner Classes</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_344]#</span>Inner classes
becomes attributes on the class object. Instances of <b>static</b> inner
classes can be create by the usual call:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>com.foo.JavaClass.StaticInnerClass()</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_345]#</span>Non-<b>static</b>
inner classes must have an outer class instance supplied explicitly as the
first argument:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>com.foo.JavaClass.InnerClass(com.foo.JavaClass())</p>

</div>

<h2 style='margin-left:40.5pt'><a name="_Toc41169771">Using Java libraries</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_346]#</span>Jython wraps the
Java libraries so that any of them can be used directly or via inheritance. In
addition, Python shorthand simplifies coding.</p>

<p class=MsoNormal><span style='display:none'>#[BT_347]#</span>As an example,
consider the <b>HTMLButton.java</b> example from Chapter 9 of <i>Thinking in
Java, 2<sup>nd</sup> edition</i> (you presumably have already downloaded and
installed the source code for that book from <i>www.BruceEckel.com</i>, since a
number of examples in this book use libraries from that book). Here is its
conversion to Jython:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>## interpreter:PythonSwing.py</p>

<p class=Code style='margin-left:0in'># The HTMLButton.java example from </p>

<p class=Code style='margin-left:0in'># &quot;Thinking in Java, 2nd
edition,&quot; Chapter 13,</p>

<p class=Code style='margin-left:0in'># converted into Jython.</p>

<p class=Code style='margin-left:0in'># Don’t run this as part of the automatic
make:</p>

<p class=Code style='margin-left:0in'>#=M @echo skipping PythonSwing.py</p>

<p class=Code style='margin-left:0in'>from javax.swing import JFrame, JButton,
JLabel</p>

<p class=Code style='margin-left:0in'>from java.awt import FlowLayout</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>frame = JFrame(&quot;HTMLButton&quot;,
visible=1,</p>

<p class=Code style='margin-left:0in'> 
defaultCloseOperation=JFrame.EXIT_ON_CLOSE)</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>def kapow(e):</p>

<p class=Code style='margin-left:0in'> 
frame.contentPane.add(JLabel(&quot;&lt;html&gt;&quot;+</p>

<p class=Code style='margin-left:0in'>    &quot;&lt;i&gt;&lt;font
size=+4&gt;Kapow!&quot;))</p>

<p class=Code style='margin-left:0in'>  # Force a re-layout to</p>

<p class=Code style='margin-left:0in'>  # include the new label:</p>

<p class=Code style='margin-left:0in'>  frame.validate()</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>button =
JButton(&quot;&lt;html&gt;&lt;b&gt;&lt;font size=+2&gt;&quot; +</p>

<p class=Code style='margin-left:0in'> 
&quot;&lt;center&gt;Hello!&lt;br&gt;&lt;i&gt;Press me now!&quot;,</p>

<p class=Code style='margin-left:0in'>  actionPerformed=kapow)</p>

<p class=Code style='margin-left:0in'>frame.contentPane.layout = FlowLayout()</p>

<p class=Code style='margin-left:0in'>frame.contentPane.add(button)</p>

<p class=Code style='margin-left:0in'>frame.pack()</p>

<p class=Code style='margin-left:0in'>frame.size=200, 500</p>

<p class=Code style='margin-left:0in'>##~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_348]#</span>If you compare
the Java version of the program to the above Jython implementation, you’ll see
that Jython is shorter and generally easier to understand. For example, in the
Java version to set up the frame you had to make several calls: the constructor
for <b>JFrame(&nbsp;)</b>, the <b>setVisible(&nbsp;)</b> method and the <b>setDefaultCloseOperation(&nbsp;)</b>
method, whereas in the above code all three of these operations are performed
with a single constructor call.</p>

<p class=MsoNormal><span style='display:none'>#[BT_349]#</span>Also notice that
the <b>JButton</b> is configured with an <b>actionListener(&nbsp;)</b> method
inside the constructor, with the assignment to <b>kapow</b>. In addition,
Jython’s JavaBean awareness means that a call to any method with a name that
begins with “<b>set</b>” can be replaced with an assignment, as you can see
above.</p>

<p class=MsoNormal><span style='display:none'>#[BT_350]#</span>The only method
that did not come over from Java is the <b>pack(&nbsp;)</b> method, which seems
to be essential in order to force the layout to happen properly. It’s also
important that the call to <b>pack(&nbsp;)</b> appear <i>before</i> the <b>size</b>
setting.</p>

<h3><a name="_Toc41169772">Inheriting from Java library classes</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_351]#</span>You can easily
inherit from standard Java library classes in Jython. Here’s the <b>Dialogs.java</b>
example from Chapter 13 of <i>Thinking in Java, 2<sup>nd</sup> edition</i>,
converted into Jython:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>## interpreter:PythonDialogs.py</p>

<p class=Code style='margin-left:0in'># Dialogs.java from &quot;Thinking in
Java, 2nd </p>

<p class=Code style='margin-left:0in'># edition,&quot; Chapter 13, converted
into Jython.</p>

<p class=Code style='margin-left:0in'># Don’t run this as part of the automatic
make:</p>

<p class=Code style='margin-left:0in'>#=M @echo skipping PythonDialogs.py</p>

<p class=Code style='margin-left:0in'>from java.awt import FlowLayout</p>

<p class=Code style='margin-left:0in'>from javax.swing import JFrame, JDialog,
JLabel</p>

<p class=Code style='margin-left:0in'>from javax.swing import JButton</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class MyDialog(JDialog):</p>

<p class=Code style='margin-left:0in'>  def __init__(self, parent=None):</p>

<p class=Code style='margin-left:0in'>    JDialog.__init__(self, </p>

<p class=Code style='margin-left:0in'>      title=&quot;My dialog&quot;,
modal=1)</p>

<p class=Code style='margin-left:0in'>    self.contentPane.layout =
FlowLayout()</p>

<p class=Code style='margin-left:0in'>    self.contentPane.add(JLabel(&quot;A
dialog!&quot;))</p>

<p class=Code style='margin-left:0in'>    self.contentPane.add(JButton(&quot;OK&quot;,
</p>

<p class=Code style='margin-left:0in'>      actionPerformed = </p>

<p class=Code style='margin-left:0in'>        lambda e, t=self: t.dispose()))</p>

<p class=Code style='margin-left:0in'>    self.pack()</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>frame = JFrame(&quot;Dialogs&quot;,
visible=1,</p>

<p class=Code style='margin-left:0in'> 
defaultCloseOperation=JFrame.EXIT_ON_CLOSE)</p>

<p class=Code style='margin-left:0in'><span lang=SV>dlg = MyDialog()</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>frame.contentPane.add(</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>  </span>JButton(&quot;Press
here to get a Dialog Box&quot;, </p>

<p class=Code style='margin-left:0in'>    actionPerformed = lambda e:
dlg.show()))</p>

<p class=Code style='margin-left:0in'>frame.pack()</p>

<p class=Code style='margin-left:0in'>##~</p>

</div>

<p class=MsoNormal><b><span style='display:none'>#[BT_352]#</span>MyDialog</b>
is inherited from <b>JDialog</b>, and you can see named arguments being used in
the call to the base-class constructor.</p>

<p class=MsoNormal><span style='display:none'>#[BT_353]#</span>In the creation
of the “OK” <b>JButton</b>, note that the <b>actionPerformed</b> method is set
right inside the constructor, and that the function is created using the Python
<b>lambda</b> keyword. This creates a nameless function with the arguments
appearing before the colon and the expression that generates the returned value
after the colon. As you should know, the Java prototype for the <b>actionPerformed(&nbsp;)</b>
method only contains a single argument, but the lambda expression indicates
two. However, the second argument is provided with a default value, so the
function <i>can</i> be called with only one argument. The reason for the second
argument is seen in the default value, because this is a way to pass <b>self</b>
into the lambda expression, so that it can be used to dispose of the dialog.</p>

<p class=MsoNormal><span style='display:none'>#[BT_354]#</span>Compare this
code with the version that’s published in <i>Thinking in Java, 2<sup>nd</sup>
edition</i>. You’ll find that Python language features allow a much more
succinct and direct implementation.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169773">Creating Java classes
with Jython</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_355]#</span>Although it does
not directly relate to the original problem of this chapter (creating an
interpreter), Jython has the additional ability to create Java classes directly
from your Jython code. This can produce very useful results, as you are then
able to treat the results as if they are native Java classes, albeit with
Python power under the hood.</p>

<p class=MsoNormal><span style='display:none'>#[BT_356]#</span>To produce Java
classes from Python code, Jython comes with a compiler called <b>jythonc</b>.</p>

<p class=MsoNormal><span style='display:none'>#[BT_357]#</span>The process of
creating Python classes that will produce Java classes is a bit more complex
than when calling Java classes from Python, because the methods in Java classes
are strongly typed, while Python functions and methods are weakly typed. Thus,
you must somehow tell <b>jythonc</b> that a Python method is intended to have a
particular set of argument types and that its return value is a particular
type. You accomplish this with the “@sig” string, which is placed right after
the beginning of the Python method definition (this is the standard location
for the Python documentation string). For example:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>  def returnArray(self):</p>

<p class=Code style='margin-left:0in'>    &quot;@sig public java.lang.String[]
returnArray()&quot;</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_358]#</span>The Python
definition doesn’t specify any return type, but the @sig string gives the full
type information about what is being passed and returned. The <b>jythonc</b>
compiler uses this information to generate the correct Java code.</p>

<p class=MsoNormal><span style='display:none'>#[BT_359]#</span>There’s one
other set of rules you must follow in order to get a successful compilation:
you must inherit from a Java class or interface in your Python class (you do
not need to specify the <b>@sig</b> signature for methods defined in the
superclass/interface). If you do not do this, you won’t get your desired
methods – unfortunately, <b>jythonc</b> gives you no warnings or errors in this
case, but you won’t get what you want. If you don’t see what’s missing, it can
be very frustrating.</p>

<p class=MsoNormal><span style='display:none'>#[BT_360]#</span>In addition, you
must import the appropriate java class and give the correct package
specification.  In the example below, <b>java</b> is imported so you must
inherit from <b>java.lang.Object</b>,<b> </b>but you could also say <b>from
java.lang import Object</b> and then you’d just inherit from <b>Object</b>
without the package specification. Unfortunately, you don’t get any warnings or
errors if you get this wrong, so you must be patient and keep trying.</p>

<p class=MsoNormal><span style='display:none'>#[BT_361]#</span>Here is an
example of a Python class created to produce a Java class. This also introduces
the ‘<b>=T</b>’ directive for the makefile builder tool, which specifies a
different target than the one that is normally used by the tool. In this case,
the Python file is used to build a Java <b>.class</b> file, so the class file
is the desired makefile target. To accomplish this, the default makefile
command is replaced using the ‘<b>=M</b>’ directive (notice how you can break
across lines using ‘<b>\</b>’):</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>## interpreter:PythonToJavaClass.py</p>

<p class=Code style='margin-left:0in'>#=T
python\java\test\PythonToJavaClass.class</p>

<p class=Code style='margin-left:0in'>#=M jythonc.bat --package
python.java.test \</p>

<p class=Code style='margin-left:0in'>#=M PythonToJavaClass.py</p>

<p class=Code style='margin-left:0in'># A Python class created to produce a
Java class</p>

<p class=Code style='margin-left:0in'>from jarray import array</p>

<p class=Code style='margin-left:0in'>import java</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class
PythonToJavaClass(java.lang.Object):</p>

<p class=Code style='margin-left:0in'>  # The '@sig' signature string is used
to create</p>

<p class=Code style='margin-left:0in'>  # the proper signature in the resulting</p>

<p class=Code style='margin-left:0in'>  # Java code:</p>

<p class=Code style='margin-left:0in'>  def __init__(self):</p>

<p class=Code style='margin-left:0in'>    &quot;@sig public
PythonToJavaClass()&quot;</p>

<p class=Code style='margin-left:0in'>    print &quot;Constructor for
PythonToJavaClass&quot;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>  def simple(self):</p>

<p class=Code style='margin-left:0in'>    &quot;@sig public void simple()&quot;</p>

<p class=Code style='margin-left:0in'>    print &quot;simple()&quot;</p>

<p class=Code style='margin-left:0in'>  </p>

<p class=Code style='margin-left:0in'>  # Returning values to Java:</p>

<p class=Code style='margin-left:0in'>  def returnString(self):</p>

<p class=Code style='margin-left:0in'>    &quot;@sig public java.lang.String
returnString()&quot;</p>

<p class=Code style='margin-left:0in'>    return &quot;howdy&quot;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>  # You must construct arrays to return
along </p>

<p class=Code style='margin-left:0in'>  # with the type of the array:</p>

<p class=Code style='margin-left:0in'>  def returnArray(self):</p>

<p class=Code style='margin-left:0in'>    &quot;@sig public java.lang.String[]
returnArray()&quot;</p>

<p class=Code style='margin-left:0in'>    test = [ &quot;fee&quot;,
&quot;fi&quot;, &quot;fo&quot;, &quot;fum&quot; ]</p>

<p class=Code style='margin-left:0in'>    return array(test, java.lang.String)</p>

<p class=Code style='margin-left:0in'>    </p>

<p class=Code style='margin-left:0in'>  def ints(self):</p>

<p class=Code style='margin-left:0in'>    &quot;@sig public java.lang.Integer[]
ints()&quot;</p>

<p class=Code style='margin-left:0in'>    test = [ 1, 3, 5, 7, 11, 13, 17, 19,
23 ]</p>

<p class=Code style='margin-left:0in'>    return array(test, java.lang.Integer)</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>  def doubles(self):</p>

<p class=Code style='margin-left:0in'>    &quot;@sig public java.lang.Double[]
doubles()&quot;</p>

<p class=Code style='margin-left:0in'>    test = [ 1, 3, 5, 7, 11, 13, 17, 19,
23 ]</p>

<p class=Code style='margin-left:0in'>    return array(test, java.lang.Double)</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>  # Passing arguments in from Java:</p>

<p class=Code style='margin-left:0in'>  def argIn1(self, a):</p>

<p class=Code style='margin-left:0in'>    &quot;@sig public void
argIn1(java.lang.String a)&quot;</p>

<p class=Code style='margin-left:0in'>    print &quot;a: %s&quot; % a</p>

<p class=Code style='margin-left:0in'>    print &quot;a.__class__&quot;,
a.__class__</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>  def argIn2(self, a):</p>

<p class=Code style='margin-left:0in'>    &quot;@sig public void
argIn1(java.lang.Integer a)&quot;</p>

<p class=Code style='margin-left:0in'>    print &quot;a + 100: %d&quot; % (a +
100)</p>

<p class=Code style='margin-left:0in'>    print &quot;a.__class__&quot;,
a.__class__</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>  def argIn3(self, a):</p>

<p class=Code style='margin-left:0in'>    &quot;@sig public void
argIn3(java.util.List a)&quot;</p>

<p class=Code style='margin-left:0in'>    print &quot;received List:&quot;, a,
a.__class__</p>

<p class=Code style='margin-left:0in'>    print &quot;element type:&quot;,
a[0].__class__</p>

<p class=Code style='margin-left:0in'>    print &quot;a[3] + a[5]:&quot;, a[5]
+ a[7]</p>

<p class=Code style='margin-left:0in'>    #! print &quot;a[2:5]:&quot;, a[2:5]
# Doesn't work</p>

<p class=Code style='margin-left:0in'>    </p>

<p class=Code style='margin-left:0in'>  def argIn4(self, a):</p>

<p class=Code style='margin-left:0in'>    &quot;@sig public void \</p>

<p class=Code style='margin-left:0in'>       argIn4(org.python.core.PyArray
a)&quot;</p>

<p class=Code style='margin-left:0in'>    print &quot;received type:&quot;,
a.__class__</p>

<p class=Code style='margin-left:0in'>    print &quot;a: &quot;, a</p>

<p class=Code style='margin-left:0in'>    print &quot;element type:&quot;,
a[0].__class__</p>

<p class=Code style='margin-left:0in'>    print &quot;a[3] + a[5]:&quot;, a[5]
+ a[7]</p>

<p class=Code style='margin-left:0in'>    print &quot;a[2:5]:&quot;, a[2:5] # A
real Python array</p>

<p class=Code style='margin-left:0in'>    </p>

<p class=Code style='margin-left:0in'>  # A map must be passed in as a
PyDictionary:</p>

<p class=Code style='margin-left:0in'>  def argIn5(self, m):</p>

<p class=Code style='margin-left:0in'>    &quot;@sig public void \</p>

<p class=Code style='margin-left:0in'>      
argIn5(org.python.core.PyDictionary m)&quot;</p>

<p class=Code style='margin-left:0in'>    print &quot;received Map: &quot;, m,
m.__class__</p>

<p class=Code style='margin-left:0in'>    print &quot;m['3']:&quot;, m['3']</p>

<p class=Code style='margin-left:0in'>    for x in m.keys():</p>

<p class=Code style='margin-left:0in'>      print x, m[x]</p>

<p class=Code style='margin-left:0in'>##~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_362]#</span>First note that <b>PythonToJavaClass</b>
is inherited from <b>java.lang.Object</b>; if you don’t do this you will
quietly get a Java class without the right signatures. You are not required to
inherit from <b>Object</b>; any other Java class will do.</p>

<p class=MsoNormal><span style='display:none'>#[BT_363]#</span>This class is
designed to demonstrate different  arguments and return values, to provide you
with enough examples that you’ll be able to easily create your own signature
strings. The first three of these are fairly self-explanatory, but note the
full qualification of the Java name in the signature string.</p>

<p class=MsoNormal><span style='display:none'>#[BT_364]#</span>In <b>returnArray(&nbsp;)</b>,
a Python array must be returned as a Java array. To do this, the Jython <b>array(&nbsp;)</b>
function (from the <b>jarray</b> module) must be used, along with the type of
the class for the resulting array. Any time you need to return an array to Java,
you must use <b>array(&nbsp;)</b>, as seen in the methods <b>ints(&nbsp;)</b>
and <b>doubles(&nbsp;)</b>.</p>

<p class=MsoNormal><span style='display:none'>#[BT_365]#</span>The last methods
show how to pass arguments in from Java. Basic types happen automatically as
long as you specify them in the <b>@sig</b> string, but you must use objects
and you cannot pass in primitives (that is, primitives must be ensconced in
wrapper objects, such as <b>Integer</b>).</p>

<p class=MsoNormal><span style='display:none'>#[BT_366]#</span>In <b>argIn3(&nbsp;)</b>,
you can see that a Java <b>List</b> is transparently converted to something
that behaves just like a Python array, but is not a true array because you
cannot take a slice from it. If you want a true Python array, then you must
create and pass a <b>PyArray</b> as in <b>argIn4(&nbsp;)</b>, where the slice
is successful. Similarly, a Java <b>Map</b> must come in as a <b>PyDictionary</b>
in order to be treated as a Python dictionary.</p>

<p class=MsoNormal><span style='display:none'>#[BT_367]#</span>Here is the Java
program to exercise the Java classes produced by the above Python code. This
also introduces the ‘<b>=D</b>’ directive for the makefile builder tool, which
specifies a dependency in addition to those detected by the tool. Here, you
can’t compile <b>TestPythonToJavaClass.java</b> until <b>PythonToJavaClass.class</b>
is available:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//- interpreter:TestPythonToJavaClass.java</p>

<p class=Code style='margin-left:0in'>//+D
python\java\test\PythonToJavaClass.class</p>

<p class=Code style='margin-left:0in'>package interpreter;</p>

<p class=Code style='margin-left:0in'>import java.lang.reflect.*;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import org.python.core.*; </p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>import com.bruceeckel.util.*;</p>

<p class=Code style='margin-left:0in'>import com.bruceeckel.python.*;</p>

<p class=Code style='margin-left:0in'>// The package with the Python-generated
classes:</p>

<p class=Code style='margin-left:0in'>import python.java.test.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class </p>

<p class=Code style='margin-left:0in'>TestPythonToJavaClass extends TestCase  {</p>

<p class=Code style='margin-left:0in'>  PythonToJavaClass p2j = new
PythonToJavaClass();</p>

<p class=Code style='margin-left:0in'>  public void testDumpClassInfo() {</p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      Arrays2.toString(</p>

<p class=Code style='margin-left:0in'>        p2j.getClass().getConstructors()));</p>

<p class=Code style='margin-left:0in'>    Method[] methods =</p>

<p class=Code style='margin-left:0in'>      p2j.getClass().getMethods();</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; methods.length;
i++) {</p>

<p class=Code style='margin-left:0in'>      String nm = methods[i].toString();</p>

<p class=Code style='margin-left:0in'>     
if(nm.indexOf(&quot;PythonToJavaClass&quot;) != -1)</p>

<p class=Code style='margin-left:0in'>        System.out.println(nm);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void test1() {</p>

<p class=Code style='margin-left:0in'>    p2j.simple();</p>

<p class=Code style='margin-left:0in'>   
System.out.println(p2j.returnString());</p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      Arrays2.toString(p2j.returnArray()));</p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      Arrays2.toString(p2j.ints());</p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      Arrays2.toString(p2j.doubles()));</p>

<p class=Code style='margin-left:0in'>    p2j.argIn1(&quot;Testing
argIn1()&quot;);</p>

<p class=Code style='margin-left:0in'>    p2j.argIn2(new Integer(47));</p>

<p class=Code style='margin-left:0in'>    ArrayList a = new ArrayList();</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; 10; i++)</p>

<p class=Code style='margin-left:0in'>      a.add(new Integer(i));</p>

<p class=Code style='margin-left:0in'>    p2j.argIn3(a);</p>

<p class=Code style='margin-left:0in'>    p2j.argIn4(</p>

<p class=Code style='margin-left:0in'>      new PyArray(Integer.class,
a.toArray()));</p>

<p class=Code style='margin-left:0in'>    Map m = new HashMap();</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; 10; i++)</p>

<p class=Code style='margin-left:0in'>      m.put(&quot;&quot; + i, new
Float(i));</p>

<p class=Code style='margin-left:0in'>    p2j.argIn5(PyUtil.toPyDictionary(m));</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String[] args)
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(</p>

<p class=Code style='margin-left:0in'>      TestPythonToJavaClass.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_368]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_369]#</span>For Python
support, you’ll usually only need to import the classes in <b>org.python.core</b>.
Everything else in the above example is fairly straightforward, as <b>PythonToJavaClass</b>
appears, from the Java side, to be just another Java class. <b>dumpClassInfo(&nbsp;)</b>
uses reflection to verify that the method signatures specified in <b>PythonToJavaClass.py</b>
have come through properly.</p>

<h3><a name="_Toc41169774">Building the Java classes from the Python code</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_370]#</span>Part of the
trick of creating Java classes from Python code is the @sig information in the
method documentation strings. But there’s a second problem which stems from the
fact that Python has no “package” keyword – the Python equivalent of packages
(modules) are implicitly created based on the file name. However, to bring the
resulting class files into the Java program, <b>jythonc</b> must be given
information about how to create the Java package for the Python code. This is
done on the <b>jythonc</b> command line using the <b>--package</b> flag,
followed by the package name you wish to produce (including the separation
dots, just as you would give the package name using the <b>package</b> keyword
in a Java program). This will put the resulting <b>.class</b> files in the
appropriate subdirectory off of the current directory. Then you only need to
import the package in your Java program, as shown above (you’ll need ‘<b>.</b>’
in your CLASSPATH in order to run it from the code directory).</p>

<p class=MsoNormal><span style='display:none'>#[BT_371]#</span>Here are the <b>make
</b>dependency rules that I used to build the above example (the backslashes at
the ends of the lines are understood by <b>make </b>to be line continuations).
These rules are encoded into the above Java and Python files using the comment
syntax that’s understood by my makefile builder tool:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>TestPythonToJavaClass.class: \</p>

<p class=Code style='margin-left:0in'>        TestPythonToJavaClass.java \</p>

<p class=Code style='margin-left:0in'>       
python\java\test\PythonToJavaClass.class</p>

<p class=Code style='margin-left:0in'>    javac TestPythonToJavaClass.java</p>

<p class=Code style='margin-left:0in'>  </p>

<p class=Code style='margin-left:0in'>python\java\test\PythonToJavaClass.class:
\</p>

<p class=Code style='margin-left:0in'>        PythonToJavaClass.py</p>

<p class=Code style='margin-left:0in'>    jythonc.bat --package
python.java.test \</p>

<p class=Code style='margin-left:0in'>    PythonToJavaClass.py</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_372]#</span>The first
target, <b>TestPythonToJavaClass.class</b>, depends on both <b>TestPythonToJavaClass.java</b>
and the <b>PythonToJavaClass.class</b>, which is the Python code that’s
converted to a class file. This latter, in turn, depends on the Python source
code. Note that it’s important that the directory where the target lives be
specified, so that the makefile will create the Java program with the minimum
necessary amount of rebuilding.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169775">The Java-Python Extension
(JPE)</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_373]#</span>An alternative
to Jython is the <i>Java-Python Extension</i> (JPE), which directly connects
with your native C-Python implementation.</p>

<p class=MsoNormal><span style='display:none'>#[BT_374]#</span>Jython runs
entirely within the JavaVM, which produces two fundamental limitations: Jython
cannot be called from CPython, and native Python extensions are not accessible
from JPython. JPE is linked with the Python C libraries, so JPE can be called
from C-Python, and native Python extensions can be called from Java through
JPE.</p>

<p class=MsoNormal><span style='display:none'>#[BT_375]#</span>If you need to
access the features on your native platform, JPE might be the easiest solution.
You can find JPE at http://www.arakne.com/jpe.htm.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169776">Summary</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_376]#</span>This chapter has
arguably gone much deeper into Jython than required to use the interpreter
design pattern. Indeed, once you decide that you need to use interpreter and
that you’re not going to get lost inventing your own language, the solution of
installing Jython is quite simple, and you can at least get started by
following the <b>GreenHouseController</b> example.</p>

<p class=MsoNormal><span style='display:none'>#[BT_377]#</span>Of course, that
example is often too simple and you may need something more sophisticated,
often requiring more interesting data to be passed back and forth. When I
encountered the limited documentation, I felt it necessary to come up with a
more thorough examination of Jython.</p>

<p class=MsoNormal><span style='display:none'>#[BT_378]#</span>In the process,
note that there could be another equally powerful design pattern lurking in
here, which could perhaps be called <i>multiple languages</i>. This is based on
the experience of having each language solve a certain class of problems better
than the other; by combining languages you can solve problems much faster than
with either language by itself. CORBA is another way to bridge across languages,
and at the same time bridging between computers and operating systems. </p>

<p class=MsoNormal><span style='display:none'>#[BT_379]#</span>To me, Python
and Java present a very potent combination for program development because of
Java’s architecture and tool set, and Python’s extremely rapid development
(generally considered to be 5-10 times faster than C++ or Java). Python is
usually slower, however, but even if you end up re-coding parts of your program
for speed, the initial fast development will allow you to more quickly flesh
out the system and uncover and solve the critical sections. And often, the
execution speed of Python is not a problem – in those cases it’s an even bigger
win. A number of commercial products already use Java and Jython, and because
of the terrific productivity leverage I expect to see this happen more in the
future.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169777">Exercises</a></h2>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>1. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Modify <b>GreenHouseLanguage.py</b> so that it checks the times
for the events and runs those events at the appropriate times.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>2. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Modify <b>GreenHouseLanguage.py</b> so that it calls a function
for <b>action</b> instead of just printing a string.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>3. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Create a Swing application with a <b>JTextField</b> (where the
user will enter commands) and a <b>JTextArea</b> (where the command results
will be displayed). Connect to a <b>PythonInterpreter</b> object so that the
output will be sent to the <b>JTextArea</b> (which should scroll). You’ll need
to locate the <b>PythonInterpreter</b> command that redirects the output to a
Java stream.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>4. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Modify <b>GreenHouseLanguage.py</b> to add a master controller
class (instead of the static array inside <b>Event</b>) and provide a <b>run(&nbsp;)</b>
method for each of the subclasses. Each <b>run(&nbsp;)</b> should create and
use an object from the standard Java library during its execution. Modify <b>GreenHouseController.java</b>
to use this new class.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>5. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Modify the resulting <b>GreenHouseLanguage.py</b> from exercise
two to produce Java classes (add the @sig documentation strings to produce the
correct Java signatures, and create a makefile to build the Java <b>.class</b>
files). Write a Java program that uses these classes.</p>

<p class=MsoNormal><span style='display:none'>#[BT_380]#</span></p>

</div>

<span style='font-size:11.0pt;font-family:Georgia;display:none'><br clear=all
style='page-break-before:right'>
</span>

<div class=Section16>

<h1 style='margin-left:.75in'><a name="_Toc476705913"></a><a name="_Toc41169778">Complex
system states</a></h1>

<h2 style='margin-left:40.5pt'><a name="_Toc41169779"></a><a
name="_Toc476705901">StateMachine</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_106]#</span>While <i>State</i>
has a way to allow the client programmer to change the implementation, <i>StateMachine</i>
imposes a structure to automatically change the implementation from one object
to the next. The current implementation represents the state that a system is
in, and the system behaves differently from one state to the next (because it
uses <i>State</i>). Basically, this is a “state machine” using objects.</p>

<p class=MsoNormal><span style='display:none'>#[BT_107]#</span>The code that
moves the system from one state to the next is often a <i>Template Method</i>,
as seen in the following framework for a basic state machine. We start by
defining a tagging interface for input objects:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: statemachine:Input.java</p>

<p class=Code style='margin-left:0in'>// Inputs to a state machine</p>

<p class=Code style='margin-left:0in'>package statemachine;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public interface Input {} ///:~</p>

</div>

<p class=MsoNormal>Each state can be <b>run(&nbsp;)</b> to perform its
behavior, and (in this design) you can also pass it an <b>Input</b> object so
it can tell you what new state to move to based on that <b>Input</b>. The key
distinction between this design and the next is that here, each <b>State</b>
object decides what other states it can move to, based on the <b>Input</b>,
whereas in the subsequent design all of the state transitions are held in a
single table. Another way to put it is that here, each <b>State</b> object has
its own little <b>State</b> table, and in the subsequent design there is a
single master state transition table for the whole system.</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: statemachine:State.java</p>

<p class=Code style='margin-left:0in'>// A State has an operation, and can be
moved</p>

<p class=Code style='margin-left:0in'>// into the next State given an Input:</p>

<p class=Code style='margin-left:0in'>package statemachine;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public interface State {</p>

<p class=Code style='margin-left:0in'>  void run();</p>

<p class=Code style='margin-left:0in'>  State next(Input i);</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>The <b>StateMachine</b> keeps track of the current state,
which is initialized by the constructor. The <b>runAll(&nbsp;)</b> method takes
an <b>Iterator</b> to a list of <b>Input</b> objects (an <b>Iterator</b> is
used here for convenience and simplicity; the important issue is that the input
information comes from somewhere). This method not only moves to the next
state, but it also calls <b>run(&nbsp;)</b> for each state object – thus you
can see it’s an expansion of the idea of the <b>State</b> pattern, since <b>run(&nbsp;)</b>
does something different depending on the state that the system is in.</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: statemachine:StateMachine.java</p>

<p class=Code style='margin-left:0in'>// Takes an Iterator of Inputs to move
from State</p>

<p class=Code style='margin-left:0in'>// to State using a template method.</p>

<p class=Code style='margin-left:0in'>package statemachine;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class StateMachine {</p>

<p class=Code style='margin-left:0in'>  private State currentState;</p>

<p class=Code style='margin-left:0in'>  public StateMachine(State initialState)
{</p>

<p class=Code style='margin-left:0in'>    currentState = initialState;</p>

<p class=Code style='margin-left:0in'>    currentState.run();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  // Template method:</p>

<p class=Code style='margin-left:0in'>  public final void runAll(Iterator
inputs) {</p>

<p class=Code style='margin-left:0in'>    while(inputs.hasNext()) {</p>

<p class=Code style='margin-left:0in'>      Input i = (Input)inputs.next();</p>

<p class=Code style='margin-left:0in'>      System.out.println(i);</p>

<p class=Code style='margin-left:0in'>      currentState = currentState.next(i);</p>

<p class=Code style='margin-left:0in'>      currentState.run();</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}  ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>I’ve also treated <b>runAll(&nbsp;)</b> as a template
method. This is typical, but certainly not required – you could concievably
want to override it, but typically the behavior change will occur in <b>State</b>’s
<b>run(&nbsp;)</b> instead.</p>

<p class=MsoNormal>At this point the basic framework for this style of <i>StateMachine</i>
(where each state decides the next states) is complete. As an example, I’ll use
a fancy mousetrap that can move through several states in the process of
trapping a mouse<a href="#_ftn11" name="_ftnref11" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><span style='font-size:11.0pt;font-family:Georgia;
vertical-align:baseline'>[11]</span></span></span></span></a>. The mouse
classes and information are stored in the <b>mouse</b> package, including a
class representing all the possible moves that a mouse can make, which will be
the inputs to the state machine:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: statemachine:mouse:MouseAction.java</p>

<p class=Code style='margin-left:0in'>package statemachine.mouse;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import statemachine.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class MouseAction implements Input
{</p>

<p class=Code style='margin-left:0in'>  private String action;</p>

<p class=Code style='margin-left:0in'>  private static List instances = new
ArrayList();</p>

<p class=Code style='margin-left:0in'>  private MouseAction(String a) { </p>

<p class=Code style='margin-left:0in'>    action = a; </p>

<p class=Code style='margin-left:0in'>    instances.add(this);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String toString() { return
action; }</p>

<p class=Code style='margin-left:0in'>  public int hashCode() { </p>

<p class=Code style='margin-left:0in'>    return action.hashCode();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public boolean equals(Object o) {</p>

<p class=Code style='margin-left:0in'>    return (o instanceof MouseAction)</p>

<p class=Code style='margin-left:0in'>      &amp;&amp;
action.equals(((MouseAction)o).action);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static MouseAction forString(String
description) {</p>

<p class=Code style='margin-left:0in'>    Iterator it = instances.iterator();</p>

<p class=Code style='margin-left:0in'>    while(it.hasNext()) {</p>

<p class=Code style='margin-left:0in'>      MouseAction ma =
(MouseAction)it.next();</p>

<p class=Code style='margin-left:0in'>      if(ma.action.equals(description))</p>

<p class=Code style='margin-left:0in'>        return ma;</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    throw new RuntimeException(&quot;not
found: &quot; + description);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static MouseAction</p>

<p class=Code style='margin-left:0in'>    appears = new MouseAction(&quot;mouse
appears&quot;),</p>

<p class=Code style='margin-left:0in'>    runsAway = new
MouseAction(&quot;mouse runs away&quot;),</p>

<p class=Code style='margin-left:0in'>    enters = new MouseAction(&quot;mouse
enters trap&quot;),</p>

<p class=Code style='margin-left:0in'>    escapes = new MouseAction(&quot;mouse
escapes&quot;),</p>

<p class=Code style='margin-left:0in'>    trapped = new MouseAction(&quot;mouse
trapped&quot;),</p>

<p class=Code style='margin-left:0in'>    removed = new MouseAction(&quot;mouse
removed&quot;);</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>You’ll note that <b>hashCode(&nbsp;)</b> and <b>equals(&nbsp;)</b>
have been overriden so that <b>MouseAction</b> objects can be used as keys in a
<b>HashMap</b>, but in the first version of the mousetrap we won’t do this.
Also, each possible move by a mouse is enumerated as a <b>static MouseAction</b>
object.</p>

<p class=MsoNormal>For creating test code, a sequence of mouse inputs is
provided from a text file:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//:! statemachine:mouse:MouseMoves.txt</p>

<p class=Code style='margin-left:0in'>mouse appears</p>

<p class=Code style='margin-left:0in'>mouse runs away</p>

<p class=Code style='margin-left:0in'>mouse appears</p>

<p class=Code style='margin-left:0in'>mouse enters trap</p>

<p class=Code style='margin-left:0in'>mouse escapes</p>

<p class=Code style='margin-left:0in'>mouse appears</p>

<p class=Code style='margin-left:0in'>mouse enters trap</p>

<p class=Code style='margin-left:0in'>mouse trapped</p>

<p class=Code style='margin-left:0in'>mouse removed</p>

<p class=Code style='margin-left:0in'>mouse appears</p>

<p class=Code style='margin-left:0in'>mouse runs away</p>

<p class=Code style='margin-left:0in'>mouse appears</p>

<p class=Code style='margin-left:0in'>mouse enters trap</p>

<p class=Code style='margin-left:0in'>mouse trapped</p>

<p class=Code style='margin-left:0in'>mouse removed</p>

<p class=Code style='margin-left:0in'>///:~</p>

</div>

<p class=MsoNormal>To read this file in a generic fashion, here is a
general-purpose tool called <b>StringList</b>:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: com:bruceeckel:util:StringList.java</p>

<p class=Code style='margin-left:0in'>// General-purpose tool that reads a file
of text</p>

<p class=Code style='margin-left:0in'>// lines into a List, one line per list.</p>

<p class=Code style='margin-left:0in'>package com.bruceeckel.util;</p>

<p class=Code style='margin-left:0in'>import java.io.*;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class StringList extends ArrayList
{</p>

<p class=Code style='margin-left:0in'>  public StringList(String textFilePath)
{</p>

<p class=Code style='margin-left:0in'>    try {</p>

<p class=Code style='margin-left:0in'>      BufferedReader inputs = new
BufferedReader (</p>

<p class=Code style='margin-left:0in'>        new FileReader(textFilePath));</p>

<p class=Code style='margin-left:0in'>      String line;</p>

<p class=Code style='margin-left:0in'>      while((line = inputs.readLine()) !=
null)</p>

<p class=Code style='margin-left:0in'>        add(line.trim());</p>

<p class=Code style='margin-left:0in'>    } catch(IOException e) {</p>

<p class=Code style='margin-left:0in'>      throw new RuntimeException(e);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>This <b>StringList</b> only holds <b>Object</b>s, just as an
<b>ArrayList</b> does, so we need an adapter to turn the <b>String</b>s into <b>MouseAction</b>s:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: statemachine:mouse:MouseMoveList.java</p>

<p class=Code style='margin-left:0in'>// A &quot;transformer&quot; to produce a</p>

<p class=Code style='margin-left:0in'>// List of MouseAction objects.</p>

<p class=Code style='margin-left:0in'>package statemachine.mouse;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import com.bruceeckel.util.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class MouseMoveList extends
ArrayList {</p>

<p class=Code style='margin-left:0in'>  public MouseMoveList(Iterator it) {</p>

<p class=Code style='margin-left:0in'>    while(it.hasNext())</p>

<p class=Code style='margin-left:0in'>      add(MouseAction.forString((String)it.next()));</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>The <b>MouseMoveList</b> looks a bit like a decorator, and
acts a bit like an adapter. However, an adapter changes one interface to
another, and a decorator adds functionality or data. <b>MouseMoveList</b>
changes the contents of the container, so it might be thought of as a <i>Transformer</i>.</p>

<p class=MsoNormal>With these tools in place, it’s now possible to create the
first version of the mousetrap program. Each <b>State</b> subclass defines it’s
<b>run(&nbsp;)</b> behavior, and also establishes its next state with an <b>if-else</b>
clause:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: statemachine:mousetrap1:MouseTrapTest.java</p>

<p class=Code style='margin-left:0in'>// State Machine pattern using 'if'
statements</p>

<p class=Code style='margin-left:0in'>// to determine the next state.</p>

<p class=Code style='margin-left:0in'>package statemachine.mousetrap1;</p>

<p class=Code style='margin-left:0in'>import statemachine.mouse.*;</p>

<p class=Code style='margin-left:0in'>import statemachine.*;</p>

<p class=Code style='margin-left:0in'>import com.bruceeckel.util.*;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import java.io.*;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// A different subclass for each state:</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Waiting implements State {</p>

<p class=Code style='margin-left:0in'>  public void run() { </p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      &quot;Waiting: Broadcasting cheese
smell&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public State next(Input i) {</p>

<p class=Code style='margin-left:0in'>    MouseAction ma = (MouseAction)i;</p>

<p class=Code style='margin-left:0in'>    if(ma.equals(MouseAction.appears))</p>

<p class=Code style='margin-left:0in'>      return MouseTrap.luring;</p>

<p class=Code style='margin-left:0in'>    return MouseTrap.waiting;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Luring implements State {</p>

<p class=Code style='margin-left:0in'>  public void run() {</p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      &quot;Luring: Presenting Cheese,
door open&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public State next(Input i) {</p>

<p class=Code style='margin-left:0in'>    MouseAction ma = (MouseAction)i;</p>

<p class=Code style='margin-left:0in'>    if(ma.equals(MouseAction.runsAway))</p>

<p class=Code style='margin-left:0in'>      return MouseTrap.waiting;</p>

<p class=Code style='margin-left:0in'>    if(ma.equals(MouseAction.enters))</p>

<p class=Code style='margin-left:0in'>      return MouseTrap.trapping;</p>

<p class=Code style='margin-left:0in'>    return MouseTrap.luring;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Trapping implements State {</p>

<p class=Code style='margin-left:0in'>  public void run() {</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Trapping:
Closing door&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public State next(Input i) {</p>

<p class=Code style='margin-left:0in'>    MouseAction ma = (MouseAction)i;</p>

<p class=Code style='margin-left:0in'>    if(ma.equals(MouseAction.escapes))</p>

<p class=Code style='margin-left:0in'>      return MouseTrap.waiting;</p>

<p class=Code style='margin-left:0in'>    if(ma.equals(MouseAction.trapped))</p>

<p class=Code style='margin-left:0in'>      return MouseTrap.holding;</p>

<p class=Code style='margin-left:0in'>    return MouseTrap.trapping;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Holding implements State {</p>

<p class=Code style='margin-left:0in'>  public void run() {</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Holding:
Mouse caught&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public State next(Input i) {</p>

<p class=Code style='margin-left:0in'>    MouseAction ma = (MouseAction)i;</p>

<p class=Code style='margin-left:0in'>    if(ma.equals(MouseAction.removed))</p>

<p class=Code style='margin-left:0in'>      return MouseTrap.waiting;</p>

<p class=Code style='margin-left:0in'>    return MouseTrap.holding;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class MouseTrap extends StateMachine {</p>

<p class=Code style='margin-left:0in'>  public static State </p>

<p class=Code style='margin-left:0in'>    waiting = new Waiting(),</p>

<p class=Code style='margin-left:0in'>    luring = new Luring(),</p>

<p class=Code style='margin-left:0in'>    trapping = new Trapping(),</p>

<p class=Code style='margin-left:0in'>    holding = new Holding();</p>

<p class=Code style='margin-left:0in'>  public MouseTrap() {</p>

<p class=Code style='margin-left:0in'>    super(waiting); // Initial state</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class MouseTrapTest extends
TestCase  {</p>

<p class=Code style='margin-left:0in'>  MouseTrap trap = new MouseTrap();</p>

<p class=Code style='margin-left:0in'>  MouseMoveList moves = </p>

<p class=Code style='margin-left:0in'>    new MouseMoveList(</p>

<p class=Code style='margin-left:0in'>      new
StringList(&quot;../mouse/MouseMoves.txt&quot;)</p>

<p class=Code style='margin-left:0in'>        .iterator());</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    trap.runAll(moves.iterator());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(MouseTrapTest.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>The <b>StateMachine</b> class simply defines all the
possible states as static objects, and also sets up the initial state. The <b>UnitTest</b>
creates a <b>MouseTrap</b> and then tests it with all the inputs from a <b>MouseMoveList</b>.</p>

<p class=MsoNormal>While the<span style='display:none'>WhiW</span> use of <b>if-else</b>
statements inside the <b>next(&nbsp;)</b> methods is perfectly reasonable,
managing a large number of these could become difficult. Another approach is to
create tables inside each <b>State</b> object defining the various next states
based on the input.</p>

<p class=MsoNormal>Initially, this seems like it ought to be quite simple. You
should be able to define a <b>static</b> table in each <b>State</b> subclass
that defines the transitions in terms of the other <b>State</b> objects.
However, it turns out that this approach generates cyclic initialization
dependencies. To solve the problem, I’ve had to delay the initialization of the
tables until the first time that the <b>next(&nbsp;)</b> method is called for a
particular <b>State</b> object. Initially, the <b>next(&nbsp;)</b> methods can
appear a little strange because of this.</p>

<p class=MsoNormal>The <b>StateT</b> class is an implementation of <b>State</b>
(so that the same <b>StateMachine</b> class can be used from the previous
example) that adds a <b>Map</b> and a method to initialize the map from a
two-dimensional array. The <b>next(&nbsp;)</b> method has a base-class
implementation which must be called from the overridden derived class <b>next(&nbsp;)</b>
methods after they test for a <b>null Map</b> (and initialize it if it’s <b>null</b>):</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: statemachine:mousetrap2:MouseTrap2Test.java</p>

<p class=Code style='margin-left:0in'>// A better mousetrap using tables</p>

<p class=Code style='margin-left:0in'>package statemachine.mousetrap2;</p>

<p class=Code style='margin-left:0in'>import statemachine.mouse.*;</p>

<p class=Code style='margin-left:0in'>import statemachine.*;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import java.io.*;</p>

<p class=Code style='margin-left:0in'>import com.bruceeckel.util.*;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>abstract class StateT implements State {</p>

<p class=Code style='margin-left:0in'>  protected Map transitions = null;</p>

<p class=Code style='margin-left:0in'>  protected void init(Object[][] states)
{</p>

<p class=Code style='margin-left:0in'>    transitions = new HashMap();</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; states.length;
i++)</p>

<p class=Code style='margin-left:0in'>      transitions.put(states[i][0],
states[i][1]);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public abstract void run();</p>

<p class=Code style='margin-left:0in'>  public State next(Input i) {</p>

<p class=Code style='margin-left:0in'>    if(transitions.containsKey(i))</p>

<p class=Code style='margin-left:0in'>      return (State)transitions.get(i);</p>

<p class=Code style='margin-left:0in'>    else</p>

<p class=Code style='margin-left:0in'>      throw new RuntimeException(</p>

<p class=Code style='margin-left:0in'>        &quot;Input not supported for
current state&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class MouseTrap extends StateMachine {</p>

<p class=Code style='margin-left:0in'>  public static State</p>

<p class=Code style='margin-left:0in'>    waiting = new Waiting(),</p>

<p class=Code style='margin-left:0in'>    luring = new Luring(),</p>

<p class=Code style='margin-left:0in'>    trapping = new Trapping(),</p>

<p class=Code style='margin-left:0in'>    holding = new Holding();</p>

<p class=Code style='margin-left:0in'>  public MouseTrap() {</p>

<p class=Code style='margin-left:0in'>    super(waiting); // Initial state</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Waiting extends StateT {</p>

<p class=Code style='margin-left:0in'>  public void run() { </p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      &quot;Waiting: Broadcasting cheese
smell&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public State next(Input i) {</p>

<p class=Code style='margin-left:0in'>    // Delayed initialization:</p>

<p class=Code style='margin-left:0in'>    if(transitions == null)</p>

<p class=Code style='margin-left:0in'>      init(new Object[][] { </p>

<p class=Code style='margin-left:0in'>        { MouseAction.appears,
MouseTrap.luring },</p>

<p class=Code style='margin-left:0in'>      });</p>

<p class=Code style='margin-left:0in'>    return super.next(i);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Luring extends StateT {</p>

<p class=Code style='margin-left:0in'>  public void run() {</p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      &quot;Luring: Presenting Cheese,
door open&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public State next(Input i) {</p>

<p class=Code style='margin-left:0in'>    if(transitions == null)</p>

<p class=Code style='margin-left:0in'>      init(new Object[][] { </p>

<p class=Code style='margin-left:0in'>        { MouseAction.enters,
MouseTrap.trapping },</p>

<p class=Code style='margin-left:0in'>        { MouseAction.runsAway,
MouseTrap.waiting },</p>

<p class=Code style='margin-left:0in'>      });</p>

<p class=Code style='margin-left:0in'>    return super.next(i);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Trapping extends StateT {</p>

<p class=Code style='margin-left:0in'>  public void run() {</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Trapping:
Closing door&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public State next(Input i) {</p>

<p class=Code style='margin-left:0in'>    if(transitions == null)</p>

<p class=Code style='margin-left:0in'>      init(new Object[][] { </p>

<p class=Code style='margin-left:0in'>        { MouseAction.escapes,
MouseTrap.waiting },</p>

<p class=Code style='margin-left:0in'>        { MouseAction.trapped,
MouseTrap.holding },</p>

<p class=Code style='margin-left:0in'>      });</p>

<p class=Code style='margin-left:0in'>    return super.next(i);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Holding extends StateT {</p>

<p class=Code style='margin-left:0in'>  public void run() {</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Holding:
Mouse caught&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public State next(Input i) {</p>

<p class=Code style='margin-left:0in'>    if(transitions == null)</p>

<p class=Code style='margin-left:0in'>      init(new Object[][] { </p>

<p class=Code style='margin-left:0in'>        { MouseAction.removed,
MouseTrap.waiting },</p>

<p class=Code style='margin-left:0in'>      });</p>

<p class=Code style='margin-left:0in'>    return super.next(i);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class MouseTrap2Test extends
TestCase  {</p>

<p class=Code style='margin-left:0in'>  MouseTrap trap = new MouseTrap();</p>

<p class=Code style='margin-left:0in'>  MouseMoveList moves = </p>

<p class=Code style='margin-left:0in'>    new MouseMoveList(</p>

<p class=Code style='margin-left:0in'>      new
StringList(&quot;../mouse/MouseMoves.txt&quot;)</p>

<p class=Code style='margin-left:0in'>        .iterator());</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    trap.runAll(moves.iterator());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(MouseTrap2Test.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>The rest of the code is identical – the difference is in the
<b>next(&nbsp;)</b> methods and the <b>StateT</b> class.</p>

<p class=MsoNormal>If you have to create and maintain a lot of <b>State</b>
classes, this approach is an improvement, since it’s easier to quickly read and
understand the state transitions from looking at the table.</p>

<h3><a name="_Toc41169780">Exercises</a></h3>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>1. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Modify <b>MouseTrap2Test.java</b> so that the state table
information is loaded from an external text file, which only contains the state
table information.</p>

<p class=MsoNormal><span style='display:none'>#[BT_110]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_112]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_116]#</span></p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169781"></a>Table-Driven State
Machine</h2>

<p class=MsoNormal><span style='display:none'>#[BT_114]#</span>The advantage of
the previous design is that all the information about a state, including the
state transition information, is located within the state class itself. This is
generally a good design principle.</p>

<p class=MsoNormal><span style='display:none'>#[BT_115]#</span>However, in a
pure state machine, the machine can be completely represented by a single
state-transition table. This has the advantage of locating all the information
about the state machine in a single place, which means that you can more easily
create and maintain the table based on a classic state-transition diagram.</p>

<p class=MsoNormal>The classic state-transition diagram uses a circle to
represent each state, and lines from the state pointing to all states that
state can transition into. Each transition line is annotated with conditions
for transition and an action during transition. Here’s what it looks like:</p>

<p class=MsoNormal><span style='display:none'>#[BT_122]#</span>(Simple State
Machine Diagram)</p>

<p class=MsoNormal><span style='display:none'>#[BT_123]#</span>Goals:</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='display:none'>#[BT_124]#</span>Direct translation of
state diagram</p>

<p class=Exercises style='line-height:12.0pt'><span style='font-family:Symbol'>·<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Vector of change: the state diagram representation</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='display:none'>#[BT_125]#</span>Reasonable
implementation</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='display:none'>#[BT_126]#</span>No excess of states
(you could represent every single change with a new state)</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='display:none'>#[BT_127]#</span>Simplicity and
flexibility</p>

<p class=MsoNormal><span style='display:none'>#[BT_128]#</span>Observations:</p>

<p class=Exercises style='line-height:12.0pt'><span style='font-family:Symbol'>·<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>States are trivial – no information or functions/data, just an
identity</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='display:none'>#[BT_129]#</span>Not like the State
pattern!</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='display:none'>#[BT_130]#</span>The machine governs
the move from state to state</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='display:none'>#[BT_131]#</span>Similar to flyweight</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='display:none'>#[BT_132]#</span>Each state may move
to many others</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='display:none'>#[BT_133]#</span>Condition &amp;
action functions must also be external to states</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='display:none'>#[BT_134]#</span>Centralize
description in a single table containing all variations, for ease of
configuration</p>

<p class=MsoNormal><span style='display:none'>#[BT_135]#</span>Example:</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='display:none'>#[BT_136]#</span>State Machine &amp;
Table-Driven Code</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='display:none'>#[BT_137]#</span>Implements a vending
machine</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='display:none'>#[BT_138]#</span>Uses several other
patterns</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='display:none'>#[BT_139]#</span>Separates common
state-machine code from specific application (like template method)</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='display:none'>#[BT_140]#</span>Each input causes a
seek for appropriate solution (like chain of responsibility)</p>

<p class=MsoNormal style='margin-left:.75in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='display:none'>#[BT_141]#</span>Tests and transitions
are encapsulated in function objects (objects that hold functions)</p>

<p class=Exercises style='line-height:12.0pt'><span style='font-family:Symbol'>·<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Java constraint: methods are not first-class objects</p>

<p class=MsoNormal><span style='display:none'>#[BT_142]#</span><img border=0
width=552 height=404 src="TIPatterns_files/image007.gif"></p>

<h3><a name="_Toc41169782">The State class</a></h3>

<p class=MsoNormal>The <b>State</b> class is distinctly different from before,
since it is really just a placeholder with a name. Thus it is not inherited
from previous <b>State</b> classes:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: statemachine2:State.java</p>

<p class=Code style='margin-left:0in'>package statemachine2;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class State {</p>

<p class=Code style='margin-left:0in'>  private String name;</p>

<p class=Code style='margin-left:0in'>  public State(String nm) { name = nm; }</p>

<p class=Code style='margin-left:0in'>  public String toString() { return name;
}</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_145]#</span></p>

<h3><a name="_Toc41169783">Conditions for transition</a></h3>

<p class=MsoNormal>In the state transition diagram, an input is tested to see
if it meets the condition necessary to transfer to the state under question. As
before, the <b>Input</b> is just a tagging interface:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: statemachine2:Input.java</p>

<p class=Code style='margin-left:0in'>// Inputs to a state machine</p>

<p class=Code style='margin-left:0in'>package statemachine2;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public interface Input {} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>The <b>Condition</b> evaluates the <b>Input</b> to decide
whether this row in the table is the correct transition:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: statemachine2:Condition.java</p>

<p class=Code style='margin-left:0in'>// Condition function object for state
machine</p>

<p class=Code style='margin-left:0in'>package statemachine2;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public interface Condition {</p>

<p class=Code style='margin-left:0in'>  boolean condition(Input i);</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span style='display:none'>#[BT_146]#</span></p>

<h3><a name="_Toc41169784">Transition actions</a></h3>

<p class=MsoNormal>If the <b>Condition</b> returns <b>true</b>, then the
transition to a new state is made, and as that transition is made some kind of
action occurs (in the previous state machine design, this was the <b>run(&nbsp;)</b>
method):</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: statemachine2:Transition.java</p>

<p class=Code style='margin-left:0in'>// Transition function object for state
machine</p>

<p class=Code style='margin-left:0in'>package statemachine2;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public interface Transition {</p>

<p class=Code style='margin-left:0in'>  void transition(Input i);</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<h3><a name="_Toc41169785">The table</a></h3>

<p class=MsoNormal>With these classes in place, we can set up a 3-dimensional
table where <span style='display:none'>#[BT_143]#</span>each row completely
describes a state. The first element in the row is the current state, and the
rest of the elements are each a row indicating what the <i>type </i>of the
input can be, the condition that must be satisfied in order for this state
change to be the correct one, the action that happens during transition, and
the new state to move into. Note that the <b>Input</b> object is not just used
for its type, it is also a <i>Messenger</i> object that carries information to
the <b>Condition</b> and <b>Transition</b> objects:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>{ {CurrentState},</p>

<p class=Code style='margin-left:0in'>  {Input, Condition(Input),
Transition(Input), Next},</p>

<p class=Code style='margin-left:0in'>  {Input, Condition(Input),
Transition(Input), Next},</p>

<p class=Code style='margin-left:0in'>  {Input, Condition(Input),
Transition(Input), Next},</p>

<p class=Code style='margin-left:0in'>   ...</p>

<p class=Code style='margin-left:0in'>}</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_144]#</span></p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>&nbsp;</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_147]#</span></p>

<h3><a name="_Toc41169786">The basic machine</a></h3>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: statemachine2:StateMachine.java</p>

<p class=Code style='margin-left:0in'>// A table-driven state machine</p>

<p class=Code style='margin-left:0in'>package statemachine2;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class StateMachine {</p>

<p class=Code style='margin-left:0in'>  private State state;</p>

<p class=Code style='margin-left:0in'>  private Map map = new HashMap();</p>

<p class=Code style='margin-left:0in'>  public StateMachine(State initial) {</p>

<p class=Code style='margin-left:0in'>    state = initial;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void buildTable(Object[][][]
table) {</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; table.length;
i++) {</p>

<p class=Code style='margin-left:0in'>      Object[][] row = table[i];</p>

<p class=Code style='margin-left:0in'>      Object currentState = row[0][0];</p>

<p class=Code style='margin-left:0in'>      List transitions = new ArrayList();</p>

<p class=Code style='margin-left:0in'>      for(int j = 1; j &lt; row.length;
j++)</p>

<p class=Code style='margin-left:0in'>        transitions.add(row[j]);</p>

<p class=Code style='margin-left:0in'>      map.put(currentState, transitions);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void nextState(Input input) {</p>

<p class=Code style='margin-left:0in'>    Iterator
it=((List)map.get(state)).iterator();</p>

<p class=Code style='margin-left:0in'>    while(it.hasNext()) {</p>

<p class=Code style='margin-left:0in'>      Object[] tran =
(Object[])it.next();</p>

<p class=Code style='margin-left:0in'>      if(input == tran[0] || </p>

<p class=Code style='margin-left:0in'>         input.getClass() == tran[0]) {</p>

<p class=Code style='margin-left:0in'>        if(tran[1] != null) {</p>

<p class=Code style='margin-left:0in'>          Condition c =
(Condition)tran[1];</p>

<p class=Code style='margin-left:0in'>          if(!c.condition(input))</p>

<p class=Code style='margin-left:0in'>            continue; // Failed test</p>

<p class=Code style='margin-left:0in'>        }</p>

<p class=Code style='margin-left:0in'>        if(tran[2] != null)</p>

<p class=Code style='margin-left:0in'>         
((Transition)tran[2]).transition(input);</p>

<p class=Code style='margin-left:0in'>        state = (State)tran[3];</p>

<p class=Code style='margin-left:0in'>        return;</p>

<p class=Code style='margin-left:0in'>      }</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    throw new RuntimeException(</p>

<p class=Code style='margin-left:0in'>      &quot;Input not supported for
current state&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_148]#</span></p>

<h3><a name="_Toc41169787">Simple vending machine</a></h3>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: statemachine:vendingmachine:VendingMachine.java</p>

<p class=Code style='margin-left:0in'>// Demonstrates use of StateMachine.java</p>

<p class=Code style='margin-left:0in'>package statemachine.vendingmachine;</p>

<p class=Code style='margin-left:0in'>import statemachine2.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>final class VM extends State {</p>

<p class=Code style='margin-left:0in'>  private VM(String nm) { super(nm); }</p>

<p class=Code style='margin-left:0in'>  public final static VM</p>

<p class=Code style='margin-left:0in'>    quiescent = new
VM(&quot;Quiesecent&quot;),</p>

<p class=Code style='margin-left:0in'>    collecting = new
VM(&quot;Collecting&quot;),</p>

<p class=Code style='margin-left:0in'>    selecting = new
VM(&quot;Selecting&quot;),</p>

<p class=Code style='margin-left:0in'>    unavailable = new
VM(&quot;Unavailable&quot;),</p>

<p class=Code style='margin-left:0in'>    wantMore = new VM(&quot;Want
More?&quot;),</p>

<p class=Code style='margin-left:0in'>    noChange = new VM(&quot;Use Exact
Change Only&quot;),</p>

<p class=Code style='margin-left:0in'>    makesChange = new VM(&quot;Machine
makes change&quot;);</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>final class HasChange implements Input {</p>

<p class=Code style='margin-left:0in'>  private String name;</p>

<p class=Code style='margin-left:0in'>  private HasChange(String nm) { name =
nm; }</p>

<p class=Code style='margin-left:0in'>  public String toString() { return name;
}</p>

<p class=Code style='margin-left:0in'>  public final static HasChange</p>

<p class=Code style='margin-left:0in'>    yes = new HasChange(&quot;Has
change&quot;),</p>

<p class=Code style='margin-left:0in'>    no = new HasChange(&quot;Cannot make
change&quot;);</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>class ChangeAvailable extends
StateMachine {</p>

<p class=Code style='margin-left:0in'>  public ChangeAvailable() {</p>

<p class=Code style='margin-left:0in'>    super(VM.makesChange);</p>

<p class=Code style='margin-left:0in'>    buildTable(new Object[][][]{</p>

<p class=Code style='margin-left:0in'>      { {VM.makesChange}, // Current
state</p>

<p class=Code style='margin-left:0in'>        // Input, test, transition, next
state:</p>

<p class=Code style='margin-left:0in'>        {HasChange.no, null, null,
VM.noChange}},</p>

<p class=Code style='margin-left:0in'>      { {VM.noChange}, // Current state</p>

<p class=Code style='margin-left:0in'>        // Input, test, transition, next
state:</p>

<p class=Code style='margin-left:0in'>        <span lang=SV>{HasChange.yes,
null, </span></p>

<p class=Code style='margin-left:0in'><span lang=SV>         null,
VM.makesChange}},</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>    </span>});</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>final class Money implements Input {</p>

<p class=Code style='margin-left:0in'>  private String name;</p>

<p class=Code style='margin-left:0in'>  private int value;</p>

<p class=Code style='margin-left:0in'>  private Money(String nm, int val) {</p>

<p class=Code style='margin-left:0in'>    name = nm;</p>

<p class=Code style='margin-left:0in'>    value = val;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String toString() { return name;
}</p>

<p class=Code style='margin-left:0in'>  public int getValue() { return value; }</p>

<p class=Code style='margin-left:0in'>  public final static Money</p>

<p class=Code style='margin-left:0in'>    quarter = new
Money(&quot;Quarter&quot;, 25),</p>

<p class=Code style='margin-left:0in'>    dollar = new
Money(&quot;Dollar&quot;, 100);</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>final class Quit implements Input {</p>

<p class=Code style='margin-left:0in'>  private Quit() {}</p>

<p class=Code style='margin-left:0in'>  public String toString() { return
&quot;Quit&quot;; }</p>

<p class=Code style='margin-left:0in'>  public final static Quit quit = new
Quit();</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>final class FirstDigit implements Input {</p>

<p class=Code style='margin-left:0in'>  private String name;</p>

<p class=Code style='margin-left:0in'>  private int value;</p>

<p class=Code style='margin-left:0in'>  private FirstDigit(String nm, int val)
{</p>

<p class=Code style='margin-left:0in'>    name = nm;</p>

<p class=Code style='margin-left:0in'>    value = val;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String toString() { return name;
}</p>

<p class=Code style='margin-left:0in'>  public int getValue() { return value; }</p>

<p class=Code style='margin-left:0in'>  public final static FirstDigit</p>

<p class=Code style='margin-left:0in'>    A = new FirstDigit(&quot;A&quot;, 0),</p>

<p class=Code style='margin-left:0in'>    B = new FirstDigit(&quot;B&quot;, 1),</p>

<p class=Code style='margin-left:0in'>    C = new FirstDigit(&quot;C&quot;, 2),</p>

<p class=Code style='margin-left:0in'>    D = new FirstDigit(&quot;D&quot;, 3);</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>final class SecondDigit implements Input
{</p>

<p class=Code style='margin-left:0in'>  private String name;</p>

<p class=Code style='margin-left:0in'>  private int value;</p>

<p class=Code style='margin-left:0in'>  private SecondDigit(String nm, int val)
{</p>

<p class=Code style='margin-left:0in'>    name = nm;</p>

<p class=Code style='margin-left:0in'>    value = val;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String toString() { return name;
}</p>

<p class=Code style='margin-left:0in'>  public int getValue() { return value; }</p>

<p class=Code style='margin-left:0in'>  public final static SecondDigit</p>

<p class=Code style='margin-left:0in'>    one = new
SecondDigit(&quot;one&quot;, 0),</p>

<p class=Code style='margin-left:0in'>    two = new
SecondDigit(&quot;two&quot;, 1),</p>

<p class=Code style='margin-left:0in'>    three = new
SecondDigit(&quot;three&quot;, 2),</p>

<p class=Code style='margin-left:0in'>    four = new
SecondDigit(&quot;four&quot;, 3);</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>class ItemSlot {</p>

<p class=Code style='margin-left:0in'>  int price;</p>

<p class=Code style='margin-left:0in'>  int quantity;</p>

<p class=Code style='margin-left:0in'>  static int counter = 0;</p>

<p class=Code style='margin-left:0in'>  String id =
Integer.toString(counter++);</p>

<p class=Code style='margin-left:0in'>  public ItemSlot(int prc, int quant) {</p>

<p class=Code style='margin-left:0in'>    price = prc;</p>

<p class=Code style='margin-left:0in'>    quantity = quant;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public String toString() { return id; }</p>

<p class=Code style='margin-left:0in'>  public int getPrice() { return price; }</p>

<p class=Code style='margin-left:0in'>  public int getQuantity() { return
quantity; }</p>

<p class=Code style='margin-left:0in'>  public void decrQuantity() {
quantity--; }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>public class VendingMachine extends
StateMachine{</p>

<p class=Code style='margin-left:0in'>  StateMachine changeAvailable = </p>

<p class=Code style='margin-left:0in'>    new ChangeAvailable();</p>

<p class=Code style='margin-left:0in'>  int amount = 0;</p>

<p class=Code style='margin-left:0in'>  FirstDigit first = null;</p>

<p class=Code style='margin-left:0in'>  ItemSlot[][] items = new
ItemSlot[4][4];</p>

<p class=Code style='margin-left:0in'>  Condition notEnough = new Condition() {</p>

<p class=Code style='margin-left:0in'>    public boolean condition(Input input)
{</p>

<p class=Code style='margin-left:0in'>      int i1 = first.getValue();</p>

<p class=Code style='margin-left:0in'>      int i2 =
((SecondDigit)input).getValue();</p>

<p class=Code style='margin-left:0in'>      return items[i1][i2].getPrice()
&gt; amount;</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  };</p>

<p class=Code style='margin-left:0in'>  Condition itemAvailable = new Condition()
{</p>

<p class=Code style='margin-left:0in'>    public boolean condition(Input input)
{</p>

<p class=Code style='margin-left:0in'>      int i1 = first.getValue();</p>

<p class=Code style='margin-left:0in'>      int i2 =
((SecondDigit)input).getValue();</p>

<p class=Code style='margin-left:0in'>      return items[i1][i2].getQuantity()
&gt; 0;</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  };</p>

<p class=Code style='margin-left:0in'>  Condition itemNotAvailable = new
Condition() {</p>

<p class=Code style='margin-left:0in'>    public boolean condition(Input input)
{</p>

<p class=Code style='margin-left:0in'>      return
!itemAvailable.condition(input);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  };</p>

<p class=Code style='margin-left:0in'>  Transition clearSelection = new
Transition() {</p>

<p class=Code style='margin-left:0in'>    public void transition(Input input) {</p>

<p class=Code style='margin-left:0in'>      int i1 = first.getValue();</p>

<p class=Code style='margin-left:0in'>      int i2 =
((SecondDigit)input).getValue();</p>

<p class=Code style='margin-left:0in'>      ItemSlot is = items[i1][i2];</p>

<p class=Code style='margin-left:0in'>      System.out.println(</p>

<p class=Code style='margin-left:0in'>        &quot;Clearing selection: item
&quot; + is +</p>

<p class=Code style='margin-left:0in'>        &quot; costs &quot; +
is.getPrice() +</p>

<p class=Code style='margin-left:0in'>        &quot; and has quantity &quot; +
is.getQuantity());</p>

<p class=Code style='margin-left:0in'>      first = null;</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  };</p>

<p class=Code style='margin-left:0in'>  Transition dispense = new Transition()
{</p>

<p class=Code style='margin-left:0in'>    public void transition(Input input) {</p>

<p class=Code style='margin-left:0in'>      int i1 = first.getValue();</p>

<p class=Code style='margin-left:0in'>      int i2 =
((SecondDigit)input).getValue();</p>

<p class=Code style='margin-left:0in'>      ItemSlot is = items[i1][i2];</p>

<p class=Code style='margin-left:0in'>      System.out.println(&quot;Dispensing
item &quot; + </p>

<p class=Code style='margin-left:0in'>        is + &quot; costs &quot; +
is.getPrice() +</p>

<p class=Code style='margin-left:0in'>        &quot; and has quantity &quot; +
is.getQuantity());</p>

<p class=Code style='margin-left:0in'>      items[i1][i2].decrQuantity();</p>

<p class=Code style='margin-left:0in'>      System.out.println(&quot;New
Quantity &quot; + </p>

<p class=Code style='margin-left:0in'>        is.getQuantity());</p>

<p class=Code style='margin-left:0in'>      amount -= is.getPrice();</p>

<p class=Code style='margin-left:0in'>      System.out.println(&quot;Amount
remaining &quot; + </p>

<p class=Code style='margin-left:0in'>        amount);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  };</p>

<p class=Code style='margin-left:0in'>  Transition showTotal = new Transition()
{</p>

<p class=Code style='margin-left:0in'>    public void transition(Input input) {</p>

<p class=Code style='margin-left:0in'>      amount +=
((Money)input).getValue();</p>

<p class=Code style='margin-left:0in'>      System.out.println(&quot;Total
amount = &quot; + </p>

<p class=Code style='margin-left:0in'>        amount);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  };</p>

<p class=Code style='margin-left:0in'>  Transition returnChange = new
Transition() {</p>

<p class=Code style='margin-left:0in'>    public void transition(Input input) {</p>

<p class=Code style='margin-left:0in'>      System.out.println(&quot;Returning
&quot; + amount);</p>

<p class=Code style='margin-left:0in'>      amount = 0;</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  };</p>

<p class=Code style='margin-left:0in'>  Transition showDigit = new Transition()
{</p>

<p class=Code style='margin-left:0in'>    public void transition(Input input) {</p>

<p class=Code style='margin-left:0in'>      first = (FirstDigit)input;</p>

<p class=Code style='margin-left:0in'>      System.out.println(&quot;First
Digit= &quot;+ first);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  };</p>

<p class=Code style='margin-left:0in'>  public VendingMachine() {</p>

<p class=Code style='margin-left:0in'>    super(VM.quiescent); // Initial state</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; items.length;
i++)</p>

<p class=Code style='margin-left:0in'>      for(int j = 0; j &lt;
items[i].length; j++)</p>

<p class=Code style='margin-left:0in'>        items[i][j] = new
ItemSlot((j+1)*25, 5);</p>

<p class=Code style='margin-left:0in'>    items[3][0] = new ItemSlot(25, 0);</p>

<p class=Code style='margin-left:0in'>    buildTable(new Object[][][]{</p>

<p class=Code style='margin-left:0in'>      { {VM.quiescent}, // Current state</p>

<p class=Code style='margin-left:0in'>        // Input, test, transition, next
state:</p>

<p class=Code style='margin-left:0in'>        {Money.class, null, </p>

<p class=Code style='margin-left:0in'>         showTotal, VM.collecting}},</p>

<p class=Code style='margin-left:0in'>      { {VM.collecting}, // Current state</p>

<p class=Code style='margin-left:0in'>        // Input, test, transition, next
state:</p>

<p class=Code style='margin-left:0in'>        {Quit.quit, null, </p>

<p class=Code style='margin-left:0in'>         returnChange, VM.quiescent},</p>

<p class=Code style='margin-left:0in'>        {Money.class, null, </p>

<p class=Code style='margin-left:0in'>         showTotal, VM.collecting},</p>

<p class=Code style='margin-left:0in'>        {FirstDigit.class, null, </p>

<p class=Code style='margin-left:0in'>         showDigit, VM.selecting}},</p>

<p class=Code style='margin-left:0in'>      { {VM.selecting}, // Current state</p>

<p class=Code style='margin-left:0in'>        // Input, test, transition, next
state:</p>

<p class=Code style='margin-left:0in'>        {Quit.quit, null, </p>

<p class=Code style='margin-left:0in'>         returnChange, VM.quiescent},</p>

<p class=Code style='margin-left:0in'>        {SecondDigit.class, notEnough, </p>

<p class=Code style='margin-left:0in'>         clearSelection, VM.collecting},</p>

<p class=Code style='margin-left:0in'>        {SecondDigit.class,
itemNotAvailable, </p>

<p class=Code style='margin-left:0in'>         clearSelection, VM.unavailable},</p>

<p class=Code style='margin-left:0in'>        {SecondDigit.class,
itemAvailable, </p>

<p class=Code style='margin-left:0in'>         dispense, VM.wantMore}},</p>

<p class=Code style='margin-left:0in'>      { {VM.unavailable}, // Current
state</p>

<p class=Code style='margin-left:0in'>        // Input, test, transition, next
state:</p>

<p class=Code style='margin-left:0in'>        {Quit.quit, null, </p>

<p class=Code style='margin-left:0in'>         returnChange, VM.quiescent},</p>

<p class=Code style='margin-left:0in'>        {FirstDigit.class, null, </p>

<p class=Code style='margin-left:0in'>         showDigit, VM.selecting}},</p>

<p class=Code style='margin-left:0in'>      { {VM.wantMore}, // Current state</p>

<p class=Code style='margin-left:0in'>        // Input, test, transition, next
state:</p>

<p class=Code style='margin-left:0in'>        {Quit.quit, null, </p>

<p class=Code style='margin-left:0in'>         returnChange, VM.quiescent},</p>

<p class=Code style='margin-left:0in'>        {FirstDigit.class, null, </p>

<p class=Code style='margin-left:0in'>         showDigit, VM.selecting}},</p>

<p class=Code style='margin-left:0in'>    });</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_149]#</span></p>

<h3><a name="_Toc41169788">Testing the machine</a></h3>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: statemachine:vendingmachine:VendingMachineTest.java</p>

<p class=Code style='margin-left:0in'>// Demonstrates use of StateMachine.java</p>

<p class=Code style='margin-left:0in'>package statemachine.vendingmachine;</p>

<p class=Code style='margin-left:0in'>import statemachine2.*;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class VendingMachineTest extends
TestCase {</p>

<p class=Code style='margin-left:0in'>  VendingMachine vm = new
VendingMachine();</p>

<p class=Code style='margin-left:0in'>  Input[] inputs = {</p>

<p class=Code style='margin-left:0in'>    Money.quarter,</p>

<p class=Code style='margin-left:0in'>    Money.quarter,</p>

<p class=Code style='margin-left:0in'>    Money.dollar,</p>

<p class=Code style='margin-left:0in'>    FirstDigit.A,</p>

<p class=Code style='margin-left:0in'>    SecondDigit.two,</p>

<p class=Code style='margin-left:0in'>    FirstDigit.A,</p>

<p class=Code style='margin-left:0in'>    SecondDigit.two,</p>

<p class=Code style='margin-left:0in'>    FirstDigit.C,</p>

<p class=Code style='margin-left:0in'>    SecondDigit.three,</p>

<p class=Code style='margin-left:0in'>    FirstDigit.D,</p>

<p class=Code style='margin-left:0in'>    SecondDigit.one,</p>

<p class=Code style='margin-left:0in'>    Quit.quit,</p>

<p class=Code style='margin-left:0in'>  };</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; inputs.length;
i++)</p>

<p class=Code style='margin-left:0in'>      vm.nextState(inputs[i]);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String[] args)
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(VendingMachineTest.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_150]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_151]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_152]#</span></p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169789">Tools</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_153]#</span>Another
approach, as your state machine gets bigger, is to use an automation tool whereby
you configure a table and let the tool generate the state machine code for you.
This can be created yourself using a language like Python, but there are also
free, open-source tools such as <i>Libero</i>, at <a
href="http://www.imatix.com/">http://www.imatix.com</a>. </p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169790">Table-driven code:
configuration flexibility</a></h2>

<h3><a name="_Toc41169791">Table-driven code using anonymous inner classes</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_252]#</span>See <b>ListPerformance.java</b>
example in TIJ from Chapter 9</p>

<p class=MsoNormal><span style='display:none'>#[BT_253]#</span>Also <b>GreenHouse.java</b></p>

<p class=MsoNormal><span style='display:none'>#[BT_254]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_255]#</span></p>

</div>

<span style='font-size:11.0pt;font-family:Georgia;display:none'><br clear=all
style='page-break-before:right'>
</span>

<div class=Section17>

<h2 style='margin-left:40.5pt'><a name="_Toc41169792">Exercises</a></h2>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>1. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Apply <b>TransitionTable.java</b> to the “Washer” problem.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>2. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Create a <i>StateMachine</i> system whereby the current state
along with input information determines the next state that the system will be
in. To do this, each state must store a reference back to the proxy object (the
state controller) so that it can request the state change. Use a <b>HashMap</b>
to create a table of states, where the key is a <b>String</b> naming the new
state and the value is the new state object. Inside each state subclass
override a method <b>nextState(&nbsp;)</b> that has its own state-transition
table. The input to <b>nextState(&nbsp;)</b> should be a single word that comes
from a text file containing one word per line.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>3. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Modify the previous exercise so that the state machine can be
configured by creating/modifying a single multi-dimensional array.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>4. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Modify the “mood” exercise from the previous session so that it
becomes a state machine using StateMachine.java</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>5. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Create an elevator state machine system using StateMachine.java</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>6. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Create a heating/air-conditioning system using StateMachine.java</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>7. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>A <i>generator</i> is an object that produces other objects, just
like a factory, except that the generator function doesn’t require any
arguments. Create a <b>MouseMoveGenerator</b> which produces correct <b>MouseMove</b>
actions as outputs each time the generator function is called (that is, the
mouse must move in the proper sequence, thus the possible moves are based on
the previous move – it’s another state machine). Add a method <b>iterator( ) </b>to
produce an iterator, but this method should take an <b>int</b> argument that
specifies the number of moves to produce before <b>hasNext( )</b> returns <b>false</b>.</p>

<p class=MsoNormal><span style='display:none'>#[BT_154]#</span></p>

</div>

<span style='font-size:11.0pt;font-family:Georgia;display:none'><br clear=all
style='page-break-before:right'>
</span>

<div class=Section18>

<h1 style='margin-left:.75in'><a name="_Toc41169793"></a><a name="_Toc476705918">Pattern
refactoring</a></h1>

<p class=MsoNormal><span style='display:none'>#[BT_417]#</span>This chapter
will look at the process of solving a problem by applying design patterns in an
evolutionary fashion. That is, a first cut design will be used for the initial
solution, and then this solution will be examined and various design patterns
will be applied to the problem (some of which will work, and some of which
won’t). The key question that will always be asked in seeking improved
solutions is “what will change?”</p>

<p class=MsoNormal><span style='display:none'>#[BT_418]#</span>This process is
similar to what Martin Fowler talks about in his book <i>Refactoring: Improving
the Design of Existing Code<a href="#_ftn12" name="_ftnref12" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><b><span style='font-size:11.0pt;font-family:Georgia;
vertical-align:baseline'>[12]</span></b></span></span></span></a></i> (although
he tends to talk about pieces of code more than pattern-level designs). You
start with a solution, and then when you discover that it doesn’t continue to
meet your needs, you fix it. Of course, this is a natural tendency but in
computer programming it’s been extremely difficult to accomplish with
procedural programs, and the acceptance of the idea that we <i>can</i> refactor
code and designs adds to the body of proof that object-oriented programming is
“a good thing.”</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169794"></a><a
name="_Toc476705919">Simulating the trash recycler</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_419]#</span>The nature of
this problem is that the trash is thrown unclassified into a single bin, so the
specific type information is lost. But later, the specific type information
must be recovered to properly sort the trash. In the initial solution, RTTI
(described in Chapter 12 of <i>Thinking in Java, 2<sup>nd</sup> edition</i>) is
used.</p>

<p class=MsoNormal><span style='display:none'>#[BT_420]#</span>This is not a
trivial design because it has an added constraint. That’s what makes it
interesting—it’s more like the messy problems you’re likely to encounter in
your work. The extra constraint is that the trash arrives at the trash
recycling plant all mixed together. The program must model the sorting of that
trash. This is where RTTI comes in: you have a bunch of anonymous pieces of
trash, and the program figures out exactly what type they are.</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: refactor:recyclea:RecycleA.java </p>

<p class=Code style='margin-left:0in'>// Recycling with RTTI.</p>

<p class=Code style='margin-left:0in'>package refactor.recyclea;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import java.io.*;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>abstract class Trash {</p>

<p class=Code style='margin-left:0in'>  private double weight;</p>

<p class=Code style='margin-left:0in'>  Trash(double wt) { weight = wt; }</p>

<p class=Code style='margin-left:0in'>  abstract double getValue();</p>

<p class=Code style='margin-left:0in'>  double getWeight() { return weight; }</p>

<p class=Code style='margin-left:0in'>  // Sums the value of Trash in a bin:</p>

<p class=Code style='margin-left:0in'>  static void sumValue(Iterator it) {</p>

<p class=Code style='margin-left:0in'>    double val = 0.0f;</p>

<p class=Code style='margin-left:0in'>    while(it.hasNext()) {</p>

<p class=Code style='margin-left:0in'>      // One kind of RTTI:</p>

<p class=Code style='margin-left:0in'>      // A dynamically-checked cast</p>

<p class=Code style='margin-left:0in'>      Trash t = (Trash)it.next();</p>

<p class=Code style='margin-left:0in'>      // Polymorphism in action:</p>

<p class=Code style='margin-left:0in'>      val += t.getWeight() *
t.getValue();</p>

<p class=Code style='margin-left:0in'>      System.out.println(</p>

<p class=Code style='margin-left:0in'>        &quot;weight of &quot; +</p>

<p class=Code style='margin-left:0in'>        // Using RTTI to get type</p>

<p class=Code style='margin-left:0in'>        // information about the class:</p>

<p class=Code style='margin-left:0in'>        t.getClass().getName() +</p>

<p class=Code style='margin-left:0in'>        &quot; = &quot; + t.getWeight());</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Total value
= &quot; + val);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Aluminum extends Trash {</p>

<p class=Code style='margin-left:0in'>  static double val  = 1.67f;</p>

<p class=Code style='margin-left:0in'>  Aluminum(double wt) { super(wt); }</p>

<p class=Code style='margin-left:0in'>  double getValue() { return val; }</p>

<p class=Code style='margin-left:0in'>  static void setValue(double newval) {</p>

<p class=Code style='margin-left:0in'>    val = newval;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Paper extends Trash {</p>

<p class=Code style='margin-left:0in'>  static double val = 0.10f;</p>

<p class=Code style='margin-left:0in'>  Paper(double wt) { super(wt); }</p>

<p class=Code style='margin-left:0in'>  double getValue() { return val; }</p>

<p class=Code style='margin-left:0in'>  static void setValue(double newval) {</p>

<p class=Code style='margin-left:0in'>    val = newval;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class Glass extends Trash {</p>

<p class=Code style='margin-left:0in'>  static double val = 0.23f;</p>

<p class=Code style='margin-left:0in'>  Glass(double wt) { super(wt); }</p>

<p class=Code style='margin-left:0in'>  double getValue() { return val; }</p>

<p class=Code style='margin-left:0in'>  static void setValue(double newval) {</p>

<p class=Code style='margin-left:0in'>    val = newval;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class RecycleA extends TestCase  {</p>

<p class=Code style='margin-left:0in'>  Collection </p>

<p class=Code style='margin-left:0in'>    bin = new ArrayList(),</p>

<p class=Code style='margin-left:0in'>    glassBin = new ArrayList(),</p>

<p class=Code style='margin-left:0in'>    paperBin = new ArrayList(),</p>

<p class=Code style='margin-left:0in'>    alBin = new ArrayList();</p>

<p class=Code style='margin-left:0in'>  private static Random rand = new
Random();</p>

<p class=Code style='margin-left:0in'>  public RecycleA() {</p>

<p class=Code style='margin-left:0in'>    // Fill up the Trash bin:</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; 30; i++)</p>

<p class=Code style='margin-left:0in'>      switch(rand.nextInt(3)) {</p>

<p class=Code style='margin-left:0in'>        case 0 :</p>

<p class=Code style='margin-left:0in'>          bin.add(new</p>

<p class=Code style='margin-left:0in'>            Aluminum(rand.nextDouble() * 100));</p>

<p class=Code style='margin-left:0in'>          break;</p>

<p class=Code style='margin-left:0in'>        case 1 :</p>

<p class=Code style='margin-left:0in'>          bin.add(new</p>

<p class=Code style='margin-left:0in'>            Paper(rand.nextDouble() * 100));</p>

<p class=Code style='margin-left:0in'>          break;</p>

<p class=Code style='margin-left:0in'>        case 2 :</p>

<p class=Code style='margin-left:0in'>          bin.add(new</p>

<p class=Code style='margin-left:0in'>            Glass(rand.nextDouble() * 100));</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    Iterator sorter = bin.iterator();</p>

<p class=Code style='margin-left:0in'>    // Sort the Trash:</p>

<p class=Code style='margin-left:0in'>    while(sorter.hasNext()) {</p>

<p class=Code style='margin-left:0in'>      Object t = sorter.next();</p>

<p class=Code style='margin-left:0in'>      // RTTI to show class membership:</p>

<p class=Code style='margin-left:0in'>      if(t instanceof Aluminum)</p>

<p class=Code style='margin-left:0in'>        alBin.add(t);</p>

<p class=Code style='margin-left:0in'>      if(t instanceof Paper)</p>

<p class=Code style='margin-left:0in'>        paperBin.add(t);</p>

<p class=Code style='margin-left:0in'>      if(t instanceof Glass)</p>

<p class=Code style='margin-left:0in'>        glassBin.add(t);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    Trash.sumValue(alBin.iterator());</p>

<p class=Code style='margin-left:0in'>    Trash.sumValue(paperBin.iterator());</p>

<p class=Code style='margin-left:0in'>    Trash.sumValue(glassBin.iterator());</p>

<p class=Code style='margin-left:0in'>    Trash.sumValue(bin.iterator());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(RecycleA.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_421]#</span></p>

<p class=MsoNormal><a name="_Toc305628786"></a><a name="_Toc305593314"><span
style='display:none'>#[BT_422]#</span>In the source code listings available for
this book, this file will be placed in the subdirectory <b>recyclea</b> that
branches off from the subdirectory <b>refactor</b>. The unpacking tool takes
care of placing it into the correct subdirectory. The reason for doing this is
that this chapter rewrites this particular example a number of times and by putting
each version in its own directory (using the default package in each directory
so that invoking the program is easy), the class names will not clash.</a></p>

<p class=MsoNormal><span style='display:none'>#[BT_423]#</span>Several <b>ArrayList</b> objects are created to hold <b>Trash</b> references. Of course, <b>ArrayList</b>s<b>
</b>actually hold <b>Object</b>s so they’ll hold anything at all. The reason
they hold <b>Trash </b>(or something derived from <b>Trash</b>) is only because
you’ve been careful to not put in anything except <b>Trash</b>. If you do put
something “wrong” into the <b>ArrayList</b>, you won’t get any compile-time
warnings or errors—you’ll find out only via an exception at run time.</p>

<p class=MsoNormal><span style='display:none'>#[BT_424]#</span>When the <b>Trash</b>
references are added, they lose their specific identities and become simply <b>Object
reference</b>s (they are <i>upcast</i>). However, because of polymorphism the proper behavior still occurs when the dynamically-bound methods are called through the <b>Iterator</b> <b>sorter</b>, once the resulting <b>Object</b> has been
cast back to <b>Trash</b>. <b>sumValue(&nbsp;)</b> also takes an <b>Iterator </b>to
perform operations on every object in the <b>ArrayList</b>. </p>

<p class=MsoNormal><span style='display:none'>#[BT_425]#</span>It looks silly
to upcast the types of <b>Trash</b> into a container holding base type
references, and then turn around and downcast. Why not just put the trash into
the appropriate receptacle in the first place? (Indeed, this is the whole
enigma of recycling). In this program it would be easy to repair, but sometimes
a system’s structure and flexibility can benefit greatly from downcasting.</p>

<p class=MsoNormal><span style='display:none'>#[BT_426]#</span>The program
satisfies the design requirements: it works. This might be fine as long as it’s
a one-shot solution. However, a useful program tends to evolve over time, so
you must ask, “What if the situation changes?” For example, cardboard is now a
valuable recyclable commodity, so how will that be integrated into the system
(especially if the program is large and complicated). Since the above type-check coding in the <b>switch</b> statement could be scattered throughout the
program, you must go find all that code every time a new type is added, and if
you miss one the compiler won’t give you any help by pointing out an error.</p>

<p class=MsoNormal><span style='display:none'>#[BT_427]#</span>The key to the misuse of RTTI here is that <i>every type is tested</i>. If you’re looking for only
a subset of types because that subset needs special treatment, that’s probably
fine. But if you’re hunting for every type inside a switch statement, then
you’re probably missing an important point, and definitely making your code
less maintainable. In the next section we’ll look at how this program evolved
over several stages to become much more flexible. This should prove a valuable
example in program design.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169795"></a><a
name="_Toc476705920"></a><a name="_Toc375545414">Improving the design</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_428]#</span>The solutions in
<i>Design Patterns</i> are organized around the question “What will change as
this program evolves?” This is usually the most important question that you can
ask about any design. If you can build your system around the answer, the
results will be two-pronged: not only will your system allow easy (and
inexpensive) maintenance, but you might also produce components that are
reusable, so that other systems can be built more cheaply. This is the promise
of object-oriented programming, but it doesn’t happen automatically; it
requires thought and insight on your part. In this section we’ll see how this
process can happen during the refinement of a system.</p>

<p class=MsoNormal><span style='display:none'>#[BT_429]#</span>The answer to
the question “What will change?” for the recycling system is a common one: more
types will be added to the system. The goal of the design, then, is to make
this addition of types as painless as possible. In the recycling program, we’d
like to encapsulate all places where specific type information is mentioned, so
(if for no other reason) any changes can be localized to those encapsulations.
It turns out that this process also cleans up the rest of the code
considerably.</p>

<h3><a name="_Toc41169796"></a><a name="_Toc476705921"></a><a
name="_Toc375545415">“Make more objects”</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_430]#</span>This brings up a
general object-oriented design principle that I first heard spoken by Grady Booch: “If the design is too complicated, make more objects.” This is
simultaneously counterintuitive and ludicrously simple, and yet it’s the most
useful guideline I’ve found. (You might observe that “making more objects” is
often equivalent to “add another level of indirection.”) In general, if you
find a place with messy code, consider what sort of class would clean that up.
Often the side effect of cleaning up the code will be a system that has better
structure and is more flexible.</p>

<p class=MsoNormal><span style='display:none'>#[BT_431]#</span>Consider first
the place where <b>Trash</b> objects are created, which is a <b>switch</b>
statement inside <b>main(&nbsp;)</b>:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; 30; i++)</p>

<p class=Code style='margin-left:0in'>      switch((int)(rand.nextInt(3)) {</p>

<p class=Code style='margin-left:0in'>        case 0 :</p>

<p class=Code style='margin-left:0in'>          bin.add(new</p>

<p class=Code style='margin-left:0in'>            Aluminum(rand.nextDouble() *
100));</p>

<p class=Code style='margin-left:0in'>          break;</p>

<p class=Code style='margin-left:0in'>        case 1 :</p>

<p class=Code style='margin-left:0in'>          bin.add(new</p>

<p class=Code style='margin-left:0in'>            Paper(rand.nextDouble() * 100));</p>

<p class=Code style='margin-left:0in'>          break;</p>

<p class=Code style='margin-left:0in'>        case 2 :</p>

<p class=Code style='margin-left:0in'>          bin.add(new</p>

<p class=Code style='margin-left:0in'>            Glass(rand.nextDouble() * 100));</p>

<p class=Code style='margin-left:0in'>      }</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_432]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_433]#</span>This is
definitely messy, and also a place where you must change code whenever a new
type is added. If new types are commonly added, a better solution is a single
method that takes all of the necessary information and produces a reference to
an object of the correct type, already upcast to a trash object. In <i>Design
Patterns</i> this is broadly referred to as a <i>creational pattern</i> (of which there are several). The specific pattern that will be applied here is a
variant of the <i>Factory Method</i>. Here, the factory method is a <b>static</b>
member of <b>Trash</b>, but more commonly it is a method that is overridden in
the derived class.</p>

<p class=MsoNormal><span style='display:none'>#[BT_434]#</span>The idea of the
factory method is that you pass it the essential information it needs to know
to create your object, then stand back and wait for the reference (already
upcast to the base type) to pop out as the return value. From then on, you
treat the object polymorphically. Thus, you never even need to know the exact
type of object that’s created. In fact, the factory method hides it from you to
prevent accidental misuse. If you want to use the object without polymorphism,
you must explicitly use RTTI and casting.</p>

<p class=MsoNormal><span style='display:none'>#[BT_435]#</span>But there’s a
little problem, especially when you use the more complicated approach (not
shown here) of making the factory method in the base class and overriding it in
the derived classes. What if the information required in the derived class
requires more or different arguments? “Creating more objects” solves this
problem. To implement the factory method, the <b>Trash</b> class gets a new
method called <b>factory</b>. To hide the creational data, there’s a new class
called <b>Messenger</b> that carries all of the necessary information for the <b>factory</b>
method to create the appropriate <b>Trash</b> object (we’ve started referring
to <i>Messenger</i> as a design pattern, but it’s simple enough that you may
not choose to elevate it to that status). Here’s a simple implementation of <b>Messenger</b>:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>class Messenger {</p>

<p class=Code style='margin-left:0in'>  int type;</p>

<p class=Code style='margin-left:0in'>  // Must change this to add another
type:</p>

<p class=Code style='margin-left:0in'>  static final int MAX_NUM = 4;</p>

<p class=Code style='margin-left:0in'>  double data;</p>

<p class=Code style='margin-left:0in'>  Messenger(int typeNum, double val) {</p>

<p class=Code style='margin-left:0in'>    type = typeNum % MAX_NUM;</p>

<p class=Code style='margin-left:0in'>    data = val;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_436]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_437]#</span>A <b>Messenger</b>
object’s only job is to hold information for the <b>factory(&nbsp;)</b> method.
Now, if there’s a situation in which <b>factory(&nbsp;)</b> needs more or
different information to create a new type of <b>Trash</b> object, the <b>factory(&nbsp;)</b>
interface doesn’t need to be changed. The <b>Messenger</b> class can be changed
by adding new data and new constructors, or in the more typical object-oriented
fashion of subclassing.</p>

<p class=MsoNormal><span style='display:none'>#[BT_438]#</span>The <b>factory(&nbsp;)</b>
method for this simple example looks like this:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>  static Trash factory(Messenger i) {</p>

<p class=Code style='margin-left:0in'>    switch(i.type) {</p>

<p class=Code style='margin-left:0in'>      default: // To quiet the compiler</p>

<p class=Code style='margin-left:0in'>      case 0:</p>

<p class=Code style='margin-left:0in'>        return new Aluminum(i.data);</p>

<p class=Code style='margin-left:0in'>      case 1:</p>

<p class=Code style='margin-left:0in'>        return new Paper(i.data);</p>

<p class=Code style='margin-left:0in'>      case 2:</p>

<p class=Code style='margin-left:0in'>        return new Glass(i.data);</p>

<p class=Code style='margin-left:0in'>      // Two lines here:</p>

<p class=Code style='margin-left:0in'>      case 3: </p>

<p class=Code style='margin-left:0in'>        return new Cardboard(i.data);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_439]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_440]#</span>Here, the
determination of the exact type of object is simple, but you can imagine a more
complicated system in which <b>factory(&nbsp;)</b> uses an elaborate algorithm.
The point is that it’s now hidden away in one place, and you know to come to
this place when you add new types.</p>

<p class=MsoNormal><span style='display:none'>#[BT_441]#</span>The creation of
new objects is now much simpler in <b>main(&nbsp;)</b>:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>    <span lang=SV>for(int i = 0; i &lt;
30; i++)</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>      bin.add(</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>        </span>Trash.factory(</p>

<p class=Code style='margin-left:0in'>          new Messenger(</p>

<p class=Code style='margin-left:0in'>            rand.nextInt(Messenger.MAX_NUM),</p>

<p class=Code style='margin-left:0in'>            rand.nextDouble() * 100)));</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_442]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_443]#</span>A <b>Messenger</b>
object is created to pass the data into <b>factory(&nbsp;)</b>, which in turn
produces some kind of <b>Trash</b> object on the heap and returns the reference
that’s added to the <b>ArrayList</b> <b>bin</b>. Of course, if you change the
quantity and type of argument, this statement will still need to be modified,
but that can be eliminated if the creation of the <b>Messenger</b> object is
automated. For example, an <b>ArrayList</b> of arguments can be passed into the
constructor of a <b>Messenger</b> object (or directly into a <b>factory(&nbsp;)</b>
call, for that matter). This requires that the arguments be parsed and checked
at run time, but it does provide the greatest flexibility.</p>

<p class=MsoNormal><span style='display:none'>#[BT_444]#</span>You can see from
this code what “vector of change” problem the factory is responsible for
solving: if you add new types to the system (the change), the only code that
must be modified is within the factory, so the factory isolates the effect of
that change.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169797"></a><a
name="_Toc476705922"></a><a name="_Toc375545418">A pattern for prototyping
creation</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_445]#</span>A problem with
the design above is that it still requires a central location where all the
types of the objects must be known: inside the <b>factory(&nbsp;)</b> method.
If new types are regularly being added to the system, the <b>factory(&nbsp;)</b>
method must be changed for each new type. When you discover something like
this, it is useful to try to go one step further and move <i>all</i> of the
information about the type—including its creation—into the class representing
that type. This way, the only thing you need to do to add a new type to the system
is to inherit a single class.</p>

<p class=MsoNormal><span style='display:none'>#[BT_446]#</span>To move the
information concerning type creation into each specific type of <b>Trash</b>,<b>
</b>the “prototype” pattern (from the <i>Design Patterns </i>book) will be
used. The general idea is that you have a master sequence of objects, one of
each type you’re interested in making. The objects in this sequence are used <i>only</i>
for making new objects, using an operation that’s not unlike the <b>clone(&nbsp;)</b> scheme built into Java’s root class <b>Object</b>. In this
case, we’ll name the cloning method <b>tClone(&nbsp;)</b>.<b> </b>When you’re
ready to make a new object, presumably you have some sort of information that
establishes the type of object you want to create, then you move through the
master sequence comparing your information with whatever appropriate
information is in the prototype objects in the master sequence. When you find
one that matches your needs, you clone it.</p>

<p class=MsoNormal><span style='display:none'>#[BT_447]#</span>In this scheme
there is no hard-coded information for creation. Each object knows how to
expose appropriate information and how to clone itself. Thus, the <b>factory(&nbsp;)</b>
method doesn’t need to be changed when a new type is added to the system. </p>

<p class=MsoNormal><span style='display:none'>#[BT_448]#</span>One approach to
the problem of prototyping is to add a number of methods to support the
creation of new objects. However, in Java 1.1 there’s already support for
creating new objects if you have a reference to the <b>Class</b> object. With Java 1.1 <i>reflection</i> (introduced in Chapter 12 of <i>Thinking in Java, 2<sup>nd</sup>
edition</i>) you can call a constructor even if you have only a reference to
the <b>Class</b> object. This is the perfect solution for the prototyping
problem.</p>

<p class=MsoNormal><span style='display:none'>#[BT_449]#</span>The list of
prototypes will be represented indirectly by a list of references to all the <b>Class</b>
objects you want to create. In addition, if the prototyping fails, the <b>factory(&nbsp;)</b>
method will assume that it’s because a particular <b>Class</b> object wasn’t in
the list, and it will attempt to load it. By loading the prototypes dynamically
like this, the <b>Trash</b> class doesn’t need to know what types it is working
with, so it doesn’t need any modifications when you add new types. This allows
it to be easily reused throughout the rest of the chapter.</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: refactor:trash:Trash.java</p>

<p class=Code style='margin-left:0in'>// Base class for Trash recycling examples.</p>

<p class=Code style='margin-left:0in'>package refactor.trash;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import java.lang.reflect.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public abstract class Trash {</p>

<p class=Code style='margin-left:0in'>  private double weight;</p>

<p class=Code style='margin-left:0in'>  public Trash(double wt) { weight = wt;
}</p>

<p class=Code style='margin-left:0in'>  public Trash() {}</p>

<p class=Code style='margin-left:0in'>  public abstract double getValue();</p>

<p class=Code style='margin-left:0in'>  public double getWeight() { return
weight; }</p>

<p class=Code style='margin-left:0in'>  // Sums the value of Trash given an</p>

<p class=Code style='margin-left:0in'>  // Iterator to any container of Trash:</p>

<p class=Code style='margin-left:0in'>  public static void sumValue(Iterator
it) {</p>

<p class=Code style='margin-left:0in'>    double val = 0.0f;</p>

<p class=Code style='margin-left:0in'>    while(it.hasNext()) {</p>

<p class=Code style='margin-left:0in'>      // One kind of RTTI: A
dynamically-checked cast</p>

<p class=Code style='margin-left:0in'>      Trash t = (Trash)it.next();</p>

<p class=Code style='margin-left:0in'>      val += t.getWeight() *
t.getValue();</p>

<p class=Code style='margin-left:0in'>      System.out.println(</p>

<p class=Code style='margin-left:0in'>        &quot;weight of &quot; +</p>

<p class=Code style='margin-left:0in'>        // Using RTTI to get type</p>

<p class=Code style='margin-left:0in'>        // information about the class:</p>

<p class=Code style='margin-left:0in'>        t.getClass().getName() + &quot; =
&quot; + t.getWeight());</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Total value
= &quot; + val);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static class Messenger {</p>

<p class=Code style='margin-left:0in'>    public String id;</p>

<p class=Code style='margin-left:0in'>    public double data;</p>

<p class=Code style='margin-left:0in'>    public Messenger(String name, double
val) {</p>

<p class=Code style='margin-left:0in'>      id = name;</p>

<p class=Code style='margin-left:0in'>      data = val;</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  // Remainder of class provides </p>

<p class=Code style='margin-left:0in'>  // support for prototyping:</p>

<p class=Code style='margin-left:0in'>  private static List trashTypes = new
ArrayList();</p>

<p class=Code style='margin-left:0in'>  public static Trash factory(Messenger
info) {</p>

<p class=Code style='margin-left:0in'>    Iterator it = trashTypes.iterator();</p>

<p class=Code style='margin-left:0in'>    while(it.hasNext()) {</p>

<p class=Code style='margin-left:0in'>      // Somehow determine the new type</p>

<p class=Code style='margin-left:0in'>      // to create, and create one:</p>

<p class=Code style='margin-left:0in'>      Class tc = (Class)it.next();</p>

<p class=Code style='margin-left:0in'>      if (tc.getName().indexOf(info.id)
!= -1) {</p>

<p class=Code style='margin-left:0in'>        try {</p>

<p class=Code style='margin-left:0in'>          // Get the dynamic constructor
method</p>

<p class=Code style='margin-left:0in'>          // that takes a double
argument:</p>

<p class=Code style='margin-left:0in'>          Constructor ctor = tc.getConstructor(</p>

<p class=Code style='margin-left:0in'>              new Class[]{ double.class
});</p>

<p class=Code style='margin-left:0in'>          // Call the constructor  </p>

<p class=Code style='margin-left:0in'>          // to create a new object:</p>

<p class=Code style='margin-left:0in'>          return (Trash)ctor.newInstance(</p>

<p class=Code style='margin-left:0in'>            new Object[]{new
Double(info.data)});</p>

<p class=Code style='margin-left:0in'>        } catch(Exception e) {</p>

<p class=Code style='margin-left:0in'>          throw new RuntimeException(</p>

<p class=Code style='margin-left:0in'>            &quot;Cannot Create
Trash&quot;, e);</p>

<p class=Code style='margin-left:0in'>        }</p>

<p class=Code style='margin-left:0in'>      }</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    // Class was not in the list. Try to
load it,</p>

<p class=Code style='margin-left:0in'>    // but it must be in your class path!</p>

<p class=Code style='margin-left:0in'>    try {</p>

<p class=Code style='margin-left:0in'>      System.out.println(&quot;Loading
&quot; + info.id);</p>

<p class=Code style='margin-left:0in'>      trashTypes.add(Class.forName(info.id));</p>

<p class=Code style='margin-left:0in'>    } catch(Exception e) {</p>

<p class=Code style='margin-left:0in'>      throw new
RuntimeException(&quot;Prototype not found&quot;, e);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    // Loaded successfully. </p>

<p class=Code style='margin-left:0in'>    // Recursive call should work:</p>

<p class=Code style='margin-left:0in'>    return factory(info);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_450]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_451]#</span>The basic <b>Trash</b>
class and <b>sumValue(&nbsp;)</b> remain as before. The rest of the class
supports the prototyping pattern. You first see two inner classes (which are made <b>static</b>, so they are inner classes only for code organization purposes)
describing exceptions that can occur. This is followed by an <b>ArrayList </b>called
<b>trashTypes</b>, which is used to hold the <b>Class</b> references.</p>

<p class=MsoNormal><span style='display:none'>#[BT_452]#</span>In <b>Trash.factory(&nbsp;)</b>,
the <b>String</b> inside the <b>Messenger </b>object <b>id </b>(a different
version of the <b>Messenger</b> class than that of the prior discussion)
contains the type name of the <b>Trash </b>to be created; this <b>String</b> is
compared to the <b>Class</b> names in the list. If there’s a match, then that’s
the object to create. Of course, there are many ways to determine what object
you want to make. This one is used so that information read in from a file can
be turned into objects.</p>

<p class=MsoNormal><span style='display:none'>#[BT_453]#</span>Once you’ve
discovered which kind of <b>Trash</b> to create, then the reflection methods come into play. The <b>getConstructor(&nbsp;)</b> method takes an argument that’s an array of <b>Class</b> references. This array
represents the arguments, in their proper order, for the constructor that
you’re looking for. Here, the array is dynamically created using the Java 1.1 array-creation syntax:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>new Class[] {double.class}</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_454]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_455]#</span>This code
assumes that every <b>Trash</b> type has a constructor that takes a <b>double </b>(and
notice that <b>double.class</b> is distinct from <b>Double.class</b>). It’s
also possible, for a more flexible solution, to call <b>getConstructors(&nbsp;)</b>, which returns an array of the possible constructors.</p>

<p class=MsoNormal><span style='display:none'>#[BT_456]#</span>What comes back
from <b>getConstructor(&nbsp;) </b>is a reference to a <b>Constructor</b> object (part of <b>java.lang.reflect</b>). You call the constructor dynamically with
the method <b>newInstance(&nbsp;)</b>, which takes an array of <b>Object</b>
containing the actual arguments. This array is again created using the Java 1.1 syntax:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>new Object[]{new Double(Messenger.data)}</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_457]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_458]#</span>In this case,
however, the <b>double</b> must be placed inside a wrapper class so that it can
be part of this array of objects. The process of calling <b>newInstance(&nbsp;)</b>
extracts the <b>double</b>, but you can see it is a bit confusing—an argument
might be a <b>double </b>or a <b>Double</b>, but when you make the call you
must always pass in a <b>Double</b>. Fortunately, this issue exists only for
the primitive types.</p>

<p class=MsoNormal><span style='display:none'>#[BT_459]#</span>Once you
understand how to do it, the process of creating a new object given only a <b>Class</b>
reference is remarkably simple. Reflection also allows you to call methods in
this same dynamic fashion.</p>

<p class=MsoNormal><span style='display:none'>#[BT_460]#</span>Of course, the
appropriate <b>Class</b> reference might not be in the <b>trashTypes</b> list.
In this case, the <b>return</b> in the inner loop is never executed and you’ll
drop out at the end. Here, the program tries to rectify the situation by
loading the <b>Class</b> object dynamically and adding it to the <b>trashTypes</b>
list. If it still can’t be found something is really wrong, but if the load is
successful then the <b>factory</b> method is called recursively to try again.</p>

<p class=MsoNormal><span style='display:none'>#[BT_461]#</span>As you’ll see,
the beauty of this design is that this code doesn’t need to be changed,
regardless of the different situations it will be used in (assuming that all <b>Trash</b>
subclasses contain a constructor that takes a single <b>double</b> argument).</p>

<h3><a name="_Toc41169798"><b>Trash</b> subclasses</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_462]#</span>To fit into the
prototyping scheme, the only thing that’s required of each new subclass of <b>Trash</b>
is that it contain a constructor that takes a <b>double</b> argument. Java
reflection handles everything else.</p>

<p class=MsoNormal><span style='display:none'>#[BT_463]#</span>Here are the
different types of <b>Trash</b>, each in their own file but part of the <b>Trash</b>
package (again, to facilitate reuse within the chapter):</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: refactor:trash:Aluminum.java </p>

<p class=Code style='margin-left:0in'>// The Aluminum class with prototyping.</p>

<p class=Code style='margin-left:0in'>package refactor.trash;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class Aluminum extends Trash {</p>

<p class=Code style='margin-left:0in'>  private static double val = 1.67f;</p>

<p class=Code style='margin-left:0in'>  public Aluminum(double wt) { super(wt);
}</p>

<p class=Code style='margin-left:0in'>  public double getValue() { return val;
}</p>

<p class=Code style='margin-left:0in'>  public static void setValue(double
newVal) {</p>

<p class=Code style='margin-left:0in'>    val = newVal;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_464]#</span></p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: refactor:trash:Paper.java </p>

<p class=Code style='margin-left:0in'>// The Paper class with prototyping.</p>

<p class=Code style='margin-left:0in'>package refactor.trash;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class Paper extends Trash {</p>

<p class=Code style='margin-left:0in'>  private static double val = 0.10f;</p>

<p class=Code style='margin-left:0in'>  public Paper(double wt) { super(wt); }</p>

<p class=Code style='margin-left:0in'>  public double getValue() { return val;
}</p>

<p class=Code style='margin-left:0in'>  public static void setValue(double
newVal) {</p>

<p class=Code style='margin-left:0in'>    val = newVal;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_465]#</span></p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: refactor:trash:Glass.java </p>

<p class=Code style='margin-left:0in'>// The Glass class with prototyping.</p>

<p class=Code style='margin-left:0in'>package refactor.trash;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class Glass extends Trash {</p>

<p class=Code style='margin-left:0in'>  private static double val = 0.23f;</p>

<p class=Code style='margin-left:0in'>  public Glass(double wt) { super(wt); }</p>

<p class=Code style='margin-left:0in'>  public double getValue() { return val;
}</p>

<p class=Code style='margin-left:0in'>  public static void setValue(double
newVal) {</p>

<p class=Code style='margin-left:0in'>    val = newVal;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_466]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_467]#</span>And here’s a new
type of <b>Trash</b>:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: refactor:trash:Cardboard.java </p>

<p class=Code style='margin-left:0in'>// The Cardboard class with prototyping.</p>

<p class=Code style='margin-left:0in'>package refactor.trash;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class Cardboard extends Trash {</p>

<p class=Code style='margin-left:0in'>  private static double val = 0.23f;</p>

<p class=Code style='margin-left:0in'>  public Cardboard(double wt) {
super(wt); }</p>

<p class=Code style='margin-left:0in'>  public double getValue() { return val;
}</p>

<p class=Code style='margin-left:0in'>  public static void setValue(double
newVal) {</p>

<p class=Code style='margin-left:0in'>    val = newVal;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_468]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_469]#</span>You can see
that, other than the constructor, there’s nothing special about any of these
classes.</p>

<h3><a name="_Toc41169799">Parsing <b>Trash</b> from an external file</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_470]#</span>The information
about <b>Trash</b> objects will be read from an outside file. The file has all
of the necessary information about each piece of trash on a single line in the
form <b>Trash:weight</b>, such as:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//:! refactor:trash:Trash.dat</p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Glass:54</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Paper:22</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Paper:11</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Glass:17</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Aluminum:89</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Paper:88</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Aluminum:76</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Cardboard:96</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Aluminum:25</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Aluminum:34</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Glass:11</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Glass:68</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Glass:43</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Aluminum:27</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Cardboard:44</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Aluminum:18</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Paper:91</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Glass:63</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Glass:50</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Glass:80</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Aluminum:81</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Cardboard:12</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Glass:12</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Glass:54</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Aluminum:36</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Aluminum:93</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Glass:93</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Paper:80</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Glass:36</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Glass:12</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Glass:60</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Paper:66</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Aluminum:36</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>refactor.trash.Cardboard:22</span></p>

<p class=Code style='margin-left:0in'><span style='layout-grid-mode:line'>///:~</span></p>

</div>

<p class=MsoNormal><span style='display:none;layout-grid-mode:line'>#[BT_471]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_472]#</span>Note that the
class path must be included when giving the class names, otherwise the class
will not be found.</p>

<p class=MsoNormal>This file is read using the previously-defined <b>StringList
</b>tool, and each line is picked aparat using <span style='display:none'>#[BT_473]#</span>
the <b>String </b>method <b>indexOf(&nbsp;)</b> to produce the index of the ‘<b>:</b>’.
This is first used with the <b>String </b>method <b>substring(&nbsp;) </b>to extract the name of the trash type, and next to get the
weight that is turned into a <b>double </b>with the <b>static </b><b>Double.valueOf(&nbsp;) </b>method. The <b>trim(&nbsp;)</b> method removes white
space at both ends of a string.</p>

<p class=MsoNormal><span style='display:none'>#[BT_474]#</span>The <b>Trash </b>parser
is placed in a separate file since it will be reused throughout this chapter:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: refactor:trash:ParseTrash.java </p>

<p class=Code style='margin-left:0in'>// Parse file contents into Trash
objects,</p>

<p class=Code style='margin-left:0in'>// placing each into a Fillable holder.</p>

<p class=Code style='margin-left:0in'>package refactor.trash;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import java.io.*;</p>

<p class=Code style='margin-left:0in'>import com.bruceeckel.util.StringList;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class ParseTrash {</p>

<p class=Code style='margin-left:0in'>  public static void </p>

<p class=Code style='margin-left:0in'>  fillBin(String filePath, Fillable bin)
{</p>

<p class=Code style='margin-left:0in'>    Iterator it = new StringList(filePath).iterator();</p>

<p class=Code style='margin-left:0in'>    while(it.hasNext()) {</p>

<p class=Code style='margin-left:0in'>      String line = (String)it.next();</p>

<p class=Code style='margin-left:0in'>      String type = line.substring(0, </p>

<p class=Code style='margin-left:0in'>        line.indexOf(':')).trim();</p>

<p class=Code style='margin-left:0in'>      double weight = Double.valueOf(</p>

<p class=Code style='margin-left:0in'>        line.substring(line.indexOf(':')
+ 1)</p>

<p class=Code style='margin-left:0in'>          .trim()).doubleValue();</p>

<p class=Code style='margin-left:0in'>      bin.addTrash(</p>

<p class=Code style='margin-left:0in'>        Trash.factory(new
Trash.Messenger(type, weight)));</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  // Special case to handle Collection:</p>

<p class=Code style='margin-left:0in'>  public static void </p>

<p class=Code style='margin-left:0in'>  fillBin(String filePath, Collection
bin) {</p>

<p class=Code style='margin-left:0in'>    fillBin(filePath, new
FillableCollection(bin));</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span style='display:none'>#[BT_475]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_476]#</span>In <b>RecycleA.java</b>,
an <b>ArrayList</b> was used to hold the <b>Trash</b> objects. However, other
types of containers can be used as well. To allow for this, the first version
of <b>fillBin(&nbsp;)</b> takes a reference to a <b>Fillable</b>, which is
simply an <b>interface</b> that supports a method called <b>addTrash(&nbsp;)</b>:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: refactor:trash:Fillable.java </p>

<p class=Code style='margin-left:0in'>// Any object that can be filled with
Trash.</p>

<p class=Code style='margin-left:0in'>package refactor.trash;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public interface Fillable { </p>

<p class=Code style='margin-left:0in'>  void addTrash(Trash t); </p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span style='display:none'>#[BT_477]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_478]#</span>Anything that
supports this interface can be used with <b>fillBin</b>. Of course, <b>Collection</b>
doesn’t implement <b>Fillable</b>, so it won’t work. Since <b>Collection</b> is
used in most of the examples, it makes sense to add a second overloaded <b>fillBin(&nbsp;)</b>
method that takes a <b>Collection</b>. Any <b>Collection</b> can then be used
as a <b>Fillable</b> object using an adapter class:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: refactor:trash:FillableCollection.java
</p>

<p class=Code style='margin-left:0in'>// Adapter that makes a Collection
Fillable.</p>

<p class=Code style='margin-left:0in'>package refactor.trash;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class FillableCollection
implements Fillable {</p>

<p class=Code style='margin-left:0in'>  private Collection c;</p>

<p class=Code style='margin-left:0in'>  public FillableCollection(Collection
cc) { c = cc; }</p>

<p class=Code style='margin-left:0in'>  public void addTrash(Trash t) {
c.add(t); }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span style='display:none'>#[BT_479]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_480]#</span>You can see that
the only job of this class is to connect <b>Fillable</b>’s <b>addTrash(&nbsp;)</b>
method to <b>Collection’s</b> <b>add(&nbsp;)</b>. With this class in hand, the
overloaded <b>fillBin(&nbsp;)</b> method can be used with a <b>Collection</b> in
<b>ParseTrash.java</b>:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>  public static void </p>

<p class=Code style='margin-left:0in'>  fillBin(String filePath, Collection
bin) {</p>

<p class=Code style='margin-left:0in'>    fillBin(filePath, new
FillableCollection(bin));</p>

<p class=Code style='margin-left:0in'>  }</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span style='display:none'>#[BT_481]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_482]#</span>This approach
works for any container class that’s used frequently. Alternatively, the container
class can provide its own adapter that implements <b>Fillable</b>. (You’ll see
this later, in <b>DynaTrash.java</b>.)</p>

<h3><a name="_Toc41169800">Recycling with prototyping</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_483]#</span>Now you can see
the revised version of <b>RecycleA.java</b> using the prototyping technique:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: refactor:recycleap:RecycleAP.java </p>

<p class=Code style='margin-left:0in'>// Recycling with RTTI and Prototypes.</p>

<p class=Code style='margin-left:0in'>package refactor.recycleap;</p>

<p class=Code style='margin-left:0in'>import refactor.trash.*;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class RecycleAP extends TestCase 
{</p>

<p class=Code style='margin-left:0in'>  Collection</p>

<p class=Code style='margin-left:0in'>    bin = new ArrayList(), </p>

<p class=Code style='margin-left:0in'>    glassBin = new ArrayList(),</p>

<p class=Code style='margin-left:0in'>    paperBin = new ArrayList(),</p>

<p class=Code style='margin-left:0in'>    alBin = new ArrayList();</p>

<p class=Code style='margin-left:0in'>  public RecycleAP() {</p>

<p class=Code style='margin-left:0in'>    // Fill up the Trash bin:</p>

<p class=Code style='margin-left:0in'>    <span lang=SV>ParseTrash.fillBin(&quot;../trash/Trash.dat&quot;,
bin);</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>  </span>}</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    Iterator sorter = bin.iterator();</p>

<p class=Code style='margin-left:0in'>    // Sort the Trash:</p>

<p class=Code style='margin-left:0in'>    while(sorter.hasNext()) {</p>

<p class=Code style='margin-left:0in'>      Object t = sorter.next();</p>

<p class=Code style='margin-left:0in'>      // RTTI to show class membership:</p>

<p class=Code style='margin-left:0in'>      if(t instanceof Aluminum)</p>

<p class=Code style='margin-left:0in'>        alBin.add(t);</p>

<p class=Code style='margin-left:0in'>      else if(t instanceof Paper)</p>

<p class=Code style='margin-left:0in'>        paperBin.add(t);</p>

<p class=Code style='margin-left:0in'>      else if(t instanceof Glass)</p>

<p class=Code style='margin-left:0in'>        glassBin.add(t);</p>

<p class=Code style='margin-left:0in'>      else</p>

<p class=Code style='margin-left:0in'>        System.err.println(&quot;Unknown
type &quot; + t);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    Trash.sumValue(alBin.iterator());</p>

<p class=Code style='margin-left:0in'>    Trash.sumValue(paperBin.iterator());</p>

<p class=Code style='margin-left:0in'>    Trash.sumValue(glassBin.iterator());</p>

<p class=Code style='margin-left:0in'>    Trash.sumValue(bin.iterator());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>   
junit.textui.TestRunner.run(RecycleAP.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span style='display:none'>#[BT_484]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_485]#</span>All of the <b>Trash</b>
objects, as well as the <b>ParseTrash</b> and support classes, are now part of
the package <b>refactor.</b><b>trash</b>, so they are simply imported.</p>

<p class=MsoNormal><span style='display:none'>#[BT_486]#</span>The process of
opening the data file containing <b>Trash</b> descriptions and the parsing of
that file have been wrapped into the <b>static</b> method <b>ParseTrash.fillBin(&nbsp;)</b>,
so now it’s no longer a part of our design focus. You will see that throughout
the rest of the chapter, no matter what new classes are added, <b>ParseTrash.fillBin(&nbsp;)</b>
will continue to work without change, which indicates a good design.</p>

<p class=MsoNormal><span style='display:none'>#[BT_487]#</span>In terms of object
creation, this design does indeed severely localize the changes you need to
make to add a new type to the system. However, there’s a significant problem in
the use of RTTI that shows up clearly here. The program seems to run fine, and
yet it never detects any cardboard, even though there is cardboard in the list!
This happens <i>because</i> of the use of RTTI, which looks for only the types
that you tell it to look for. The clue that RTTI is being misused is that <i>every type in the system </i>is being tested, rather than a single type
or subset of types. As you will see later, there are ways to use polymorphism
instead when you’re testing for every type. But if you use RTTI a lot in this
fashion, and you add a new type to your system, you can easily forget to make
the necessary changes in your program and produce a difficult-to-find bug. So
it’s worth trying to eliminate RTTI in this case, not just for aesthetic
reasons—it produces more maintainable code.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169801"></a><a
name="_Toc476705923"></a><a name="_Toc375545416">Abstracting usage</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_488]#</span>With creation
out of the way, it’s time to tackle the remainder of the design: where the
classes are used. Since it’s the act of sorting into bins that’s particularly
ugly and exposed, why not take that process and hide it inside a class? This is
the principle of “If you must do something ugly, at least localize the ugliness
inside a class.” It looks like this:</p>

<p class=MsoNormal align=center style='text-align:center'><span
style='display:none'>#[BT_489]#</span><img border=0 width=370 height=106
src="TIPatterns_files/image008.gif"></p>

<p class=MsoNormal><span style='display:none'>#[BT_490]#</span>The <b>TrashSorter</b>
object initialization must now be changed whenever a new type of <b>Trash</b>
is added to the model. You could imagine that the <b>TrashSorter</b> class
might look something like this:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>class TrashSorter extends ArrayList {</p>

<p class=Code style='margin-left:0in'>  void sort(Trash t) { /* ... */ }</p>

<p class=Code style='margin-left:0in'>}</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_491]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_492]#</span>That is, <b>TrashSorter</b>
is an <b>ArrayList</b> of references to <b>ArrayList</b>s of <b>Trash</b>
references, and with <b>add(&nbsp;)</b> you can install another one, like so:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>TrashSorter ts = new TrashSorter();</p>

<p class=Code style='margin-left:0in'>ts.add(new ArrayList());</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_493]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_494]#</span>Now, however, <b>sort(&nbsp;)</b>
becomes a problem. How does the statically-coded method deal with the fact that
a new type has been added? To solve this, the type information must be removed
from <b>sort(&nbsp;)</b> so that all it needs to do is call a generic method
that takes care of the details of type. This, of course, is another way to
describe a dynamically-bound method. So <b>sort(&nbsp;)</b> will simply move
through the sequence and call a dynamically-bound method for each <b>ArrayList</b>.
Since the job of this method is to grab the pieces of trash it is interested
in, it’s called <b>grab(Trash)</b>. The structure now looks like:</p>

<p class=MsoNormal align=center style='text-align:center'><span
style='display:none'>#[BT_495]#</span><img border=0 width=406 height=211
src="TIPatterns_files/image009.gif"></p>

<p class=MsoNormal><b><span style='display:none'>#[BT_496]#</span>TrashSorter</b>
needs to call each <b>grab(&nbsp;)</b> method and get a different result depending
on what type of <b>Trash</b> the current <b>ArrayList</b> is holding. That is,
each <b>ArrayList</b> must be aware of the type it holds. The classic approach
to this problem is to create a base “<b>Trash</b> bin” class and inherit a new
derived class for each different type you want to hold. If Java had a
parameterized type mechanism that would probably be the most straightforward
approach. But rather than hand-coding all the classes that such a mechanism
should be building for us, further observation can produce a better approach.</p>

<p class=MsoNormal><span style='display:none'>#[BT_497]#</span>A basic OOP
design principle is “Use data members for variation in state, use polymorphism for variation in behavior.” Your first thought might be that the <b>grab(&nbsp;)</b>
method certainly behaves differently for an <b>ArrayList</b> that holds <b>Paper</b>
than for one that holds <b>Glass</b>. But what it does is strictly dependent on
the type, and nothing else. This could be interpreted as a different state, and
since Java has a class to represent type (<b>Class</b>) this can be used to
determine the type of <b>Trash</b> a particular <b>Tbin</b> will hold.</p>

<p class=MsoNormal><span style='display:none'>#[BT_498]#</span>The constructor
for this <b>Tbin </b>requires that you hand it the <b>Class</b> of your choice.
This tells the <b>ArrayList</b> what type it is supposed to hold. Then the <b>grab(&nbsp;)</b>
method uses <b>Class BinType</b> and RTTI to see if the <b>Trash</b> object
you’ve handed it matches the type it’s supposed to grab.</p>

<p class=MsoNormal><span style='display:none'>#[BT_499]#</span>Here is the new
version of the program:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: refactor:recycleb:RecycleB.java</p>

<p class=Code style='margin-left:0in'>// Containers that grab objects of
interest.</p>

<p class=Code style='margin-left:0in'>package refactor.recycleb;</p>

<p class=Code style='margin-left:0in'>import refactor.trash.*;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// A container that admits only the right
type</p>

<p class=Code style='margin-left:0in'>// of Trash (established in the
constructor):</p>

<p class=Code style='margin-left:0in'>class Tbin {</p>

<p class=Code style='margin-left:0in'>  private List list = new ArrayList();</p>

<p class=Code style='margin-left:0in'>  private Class type;</p>

<p class=Code style='margin-left:0in'>  public Tbin(Class binType) { type =
binType; }</p>

<p class=Code style='margin-left:0in'>  public boolean grab(Trash t) {</p>

<p class=Code style='margin-left:0in'>    // Comparing class types:</p>

<p class=Code style='margin-left:0in'>    if(t.getClass().equals(type)) {</p>

<p class=Code style='margin-left:0in'>      list.add(t);</p>

<p class=Code style='margin-left:0in'>      return true; // Object grabbed</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    return false; // Object not grabbed</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public Iterator iterator() {</p>

<p class=Code style='margin-left:0in'>    return list.iterator();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class TbinList extends ArrayList {</p>

<p class=Code style='margin-left:0in'>  void sortTrashItem(Trash t) {</p>

<p class=Code style='margin-left:0in'>    Iterator e = iterator(); // Iterate
over self</p>

<p class=Code style='margin-left:0in'>    while(e.hasNext())</p>

<p class=Code style='margin-left:0in'>      if(((Tbin)e.next()).grab(t))
return;</p>

<p class=Code style='margin-left:0in'>    // Need a new Tbin for this type:</p>

<p class=Code style='margin-left:0in'>    add(new Tbin(t.getClass()));</p>

<p class=Code style='margin-left:0in'>    sortTrashItem(t); // Recursive call</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class RecycleB extends TestCase  {</p>

<p class=Code style='margin-left:0in'>  Collection bin = new ArrayList();</p>

<p class=Code style='margin-left:0in'>  TbinList trashBins = new TbinList();</p>

<p class=Code style='margin-left:0in'>  public RecycleB() {</p>

<p class=Code style='margin-left:0in'>    ParseTrash.fillBin(&quot;../trash/Trash.dat&quot;,bin);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    Iterator it = bin.iterator();</p>

<p class=Code style='margin-left:0in'>    while(it.hasNext())</p>

<p class=Code style='margin-left:0in'>     
trashBins.sortTrashItem((Trash)it.next());</p>

<p class=Code style='margin-left:0in'>    Iterator e = trashBins.iterator();</p>

<p class=Code style='margin-left:0in'>    while(e.hasNext())</p>

<p class=Code style='margin-left:0in'>      Trash.sumValue(((Tbin)e.next()).iterator());</p>

<p class=Code style='margin-left:0in'>    Trash.sumValue(bin.iterator());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>   
junit.textui.TestRunner.run(RecycleB.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><b><span style='display:none'>#[BT_501]#</span>Tbin</b>
contains a <b>Class</b> reference <b>type</b> which establishes in the constructor
what what type it should grab. The <b>grab()</b> method checks this type
against the object you pass it. Note that in this design, <b>grab()</b> only
accepts <b>Trash</b> objects so you get compile-time type checking on the base
type, but you could also just accept <b>Object</b> and it would still work.</p>

<p class=MsoNormal><b>T<span style='display:none'>T</span>binList</b> holds a
set of <b>Tbin</b> references, so that <b>sort(&nbsp;)</b> can iterate through
the <b>Tbin</b>s when it’s looking for a match for the <b>Trash</b> object
you’ve handed it. If it doesn’t find a match, it creates a new <b>Tbin</b> for
the type that hasn’t been found, and makes a recursive call to itself – the
next time around, the new bin will be found.</p>

<p class=MsoNormal><b><span style='display:none'>#[BT_502]#</span></b>Notice
the genericity of this code: it doesn’t change at all if new types are added.
If the bulk of your code doesn’t need changing when a new type is added (or
some other change occurs) then you have an easily extensible system.<span
style='display:none'>#[BT_503]#</span></p>

<h2 style='margin-left:40.5pt'><a name="_Toc375545417"></a><a
name="_Toc41169802"></a><a name="_Toc476705924">Multiple dispatching</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_505]#</span>The above design
is certainly satisfactory. Adding new types to the system consists of adding or
modifying distinct classes without causing code changes to be propagated
throughout the system. In addition, RTTI is not “misused” as it was in <b>RecycleA.java</b>.
However, it’s possible to go one step further and take a purist viewpoint about
RTTI and say that it should be eliminated altogether from the operation of
sorting the trash into bins.</p>

<p class=MsoNormal><span style='display:none'>#[BT_506]#</span>To accomplish
this, you must first take the perspective that all type-dependent
activities—such as detecting the type of a piece of trash and putting it into
the appropriate bin—should be controlled through polymorphism and dynamic
binding.</p>

<p class=MsoNormal><span style='display:none'>#[BT_507]#</span>The previous
examples first sorted by type, then acted on sequences of elements that were
all of a particular type. But whenever you find yourself picking out particular
types, stop and think. The whole idea of polymorphism (dynamically-bound method
calls) is to handle type-specific information for you. So why are you hunting
for types?</p>

<p class=MsoNormal><span style='display:none'>#[BT_508]#</span>The answer is
something you probably don’t think about: Java performs only single
dispatching. That is, if you are performing an operation on more than one
object whose type is unknown, Java will invoke the dynamic binding mechanism on
only one of those types. This doesn’t solve the problem, so you end up detecting
some types manually and effectively producing your own dynamic binding
behavior.</p>

<p class=MsoNormal><span style='display:none'>#[BT_509]#</span>The solution is
called <i>multiple dispatching</i>, which means setting up a configuration such
that a single method call produces more than one dynamic method call and thus
determines more than one type in the process. To get this effect, you need to
work with more than one type hierarchy: you’ll need a type hierarchy for each
dispatch. The following example works with two hierarchies: the existing <b>Trash</b>
family and a hierarchy of the types of trash bins that the trash will be placed
into. This second hierarchy isn’t always obvious and in this case it needed to
be created in order to produce multiple dispatching (in this case there will be
only two dispatches, which is referred to as <i>double dispatching</i>).</p>

<h3><a name="_Toc41169803"></a><a name="_Toc476705925">Implementing the double
dispatch</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_510]#</span>Remember that
polymorphism can occur only via method calls, so if you want double dispatching
to occur, there must be two method calls: one used to determine the type within
each hierarchy. In the Trash hierarchy there will be a new method called
addToBin(&nbsp;), which takes an argument of an array of TypedBin. It uses this
array to step through and try to add itself to the appropriate bin, and this is
where you'll see the double dispatch. <img border=0 width=504 height=313
src="TIPatterns_files/image010.gif"></p>

<p class=MsoNormal><span style='display:none'>#[BT_511]#</span>The new
hierarchy is TypedBin, and it contains its own method called add(&nbsp;) that
is also used polymorphically. But here's an additional twist: add(&nbsp;) is
overloaded to take arguments of the different types of trash. So an essential
part of the double dispatching scheme also involves overloading.</p>

<p class=MsoNormal><span style='display:none'>#[BT_512]#</span>Redesigning the
program produces a dilemma: it’s now necessary for the base class <b>Trash</b>
to contain an <b>addToBin(&nbsp;)</b> method. One approach is to copy all of
the code and change the base class. Another approach, which you can take when
you don’t have control of the source code, is to put the <b>addToBin(&nbsp;)</b>
method into an <b>interface</b>, leave <b>Trash</b> alone, and inherit new specific
types of <b>Aluminum</b>, <b>Paper</b>, <b>Glass</b>, and <b>Cardboard</b>.
This is the approach that will be taken here.</p>

<p class=MsoNormal><span style='display:none'>#[BT_513]#</span>Most of the
classes in this design must be <b>public</b>, so they are placed in their own
files. Here’s the interface:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//:
refactor:doubledispatch:TypedBinMember.java</p>

<p class=Code style='margin-left:0in'>// An interface for adding the double </p>

<p class=Code style='margin-left:0in'>// dispatching method to the trash
hierarchy </p>

<p class=Code style='margin-left:0in'>// without modifying the original
hierarchy.</p>

<p class=Code style='margin-left:0in'>package refactor.doubledispatch;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>interface TypedBinMember {</p>

<p class=Code style='margin-left:0in'>  // The new method:</p>

<p class=Code style='margin-left:0in'>  boolean addToBin(TypedBin[] tb);</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_514]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_515]#</span>In each
particular subtype of <b>Aluminum</b>, <b>Paper</b>, <b>Glass,</b> and <b>Cardboard</b>,
the <b>addToBin(&nbsp;)</b> method in the <b>interface TypedBinMember</b> is
implemented, but it <i>looks</i> like the code is exactly the same in each
case:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//:
refactor:doubledispatch:DDAluminum.java</p>

<p class=Code style='margin-left:0in'>// Aluminum for double dispatching.</p>

<p class=Code style='margin-left:0in'>package refactor.doubledispatch;</p>

<p class=Code style='margin-left:0in'>import refactor.trash.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class DDAluminum extends Aluminum </p>

<p class=Code style='margin-left:0in'>    implements TypedBinMember {</p>

<p class=Code style='margin-left:0in'>  public DDAluminum(double wt) {
super(wt); }</p>

<p class=Code style='margin-left:0in'>  public boolean addToBin(TypedBin[] tb)
{</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; tb.length; i++)</p>

<p class=Code style='margin-left:0in'>      if(tb[i].add(this))</p>

<p class=Code style='margin-left:0in'>        return true;</p>

<p class=Code style='margin-left:0in'>    return false;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_516]#</span></p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: refactor:doubledispatch:DDPaper.java</p>

<p class=Code style='margin-left:0in'>// Paper for double dispatching.</p>

<p class=Code style='margin-left:0in'>package refactor.doubledispatch;</p>

<p class=Code style='margin-left:0in'>import refactor.trash.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class DDPaper extends Paper </p>

<p class=Code style='margin-left:0in'>    implements TypedBinMember {</p>

<p class=Code style='margin-left:0in'>  public DDPaper(double wt) { super(wt);
}</p>

<p class=Code style='margin-left:0in'>  public boolean addToBin(TypedBin[] tb)
{</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; tb.length; i++)</p>

<p class=Code style='margin-left:0in'>      if(tb[i].add(this))</p>

<p class=Code style='margin-left:0in'>        return true;</p>

<p class=Code style='margin-left:0in'>    return false;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_517]#</span></p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: refactor:doubledispatch:DDGlass.java</p>

<p class=Code style='margin-left:0in'>// Glass for double dispatching.</p>

<p class=Code style='margin-left:0in'>package refactor.doubledispatch;</p>

<p class=Code style='margin-left:0in'>import refactor.trash.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class DDGlass extends Glass </p>

<p class=Code style='margin-left:0in'>    implements TypedBinMember {</p>

<p class=Code style='margin-left:0in'>  public DDGlass(double wt) { super(wt);
}</p>

<p class=Code style='margin-left:0in'>  public boolean addToBin(TypedBin[] tb)
{</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; tb.length; i++)</p>

<p class=Code style='margin-left:0in'>      if(tb[i].add(this))</p>

<p class=Code style='margin-left:0in'>        return true;</p>

<p class=Code style='margin-left:0in'>    return false;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_518]#</span></p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//:
refactor:doubledispatch:DDCardboard.java</p>

<p class=Code style='margin-left:0in'>// Cardboard for double dispatching.</p>

<p class=Code style='margin-left:0in'>package refactor.doubledispatch;</p>

<p class=Code style='margin-left:0in'>import refactor.trash.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class DDCardboard extends
Cardboard </p>

<p class=Code style='margin-left:0in'>    implements TypedBinMember {</p>

<p class=Code style='margin-left:0in'>  public DDCardboard(double wt) {
super(wt); }</p>

<p class=Code style='margin-left:0in'>  public boolean addToBin(TypedBin[] tb)
{</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; tb.length; i++)</p>

<p class=Code style='margin-left:0in'>      if(tb[i].add(this))</p>

<p class=Code style='margin-left:0in'>        return true;</p>

<p class=Code style='margin-left:0in'>    return false;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_519]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_520]#</span>The code in each
<b>addToBin(&nbsp;) </b>calls <b>add(&nbsp;)</b> for each <b>TypedBin</b>
object in the array. But notice the argument: <b>this</b>. The type of <b>this</b>
is different for each subclass of <b>Trash</b>, so the code is different.
(Although this code will benefit if a parameterized type mechanism is ever
added to Java.) So this is the first part of the double dispatch, because once
you’re inside this method you know you’re <b>Aluminum</b>, or <b>Paper</b>,
etc. During the call to <b>add(&nbsp;)</b>, this information is passed via the
type of <b>this</b>. The compiler resolves the call to the proper overloaded
version of <b>add(&nbsp;)</b>. But<b> </b>since <b>tb[i]</b> produces a
reference to the base type <b>TypedBin</b>,<b> </b>this call will end up
calling a different method depending on the type of <b>TypedBin</b> that’s
currently selected. That is the second dispatch.</p>

<p class=MsoNormal><span style='display:none'>#[BT_521]#</span>Here’s the base
class for <b>TypedBin</b>:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: refactor:doubledispatch:TypedBin.java</p>

<p class=Code style='margin-left:0in'>// A container for the second dispatch.</p>

<p class=Code style='margin-left:0in'>package refactor.doubledispatch;</p>

<p class=Code style='margin-left:0in'>import refactor.trash.*;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public abstract class TypedBin {</p>

<p class=Code style='margin-left:0in'>  Collection c = new ArrayList();</p>

<p class=Code style='margin-left:0in'>  protected boolean addIt(Trash t) {</p>

<p class=Code style='margin-left:0in'>    c.add(t);</p>

<p class=Code style='margin-left:0in'>    return true;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public Iterator iterator() {</p>

<p class=Code style='margin-left:0in'>    return c.iterator();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public boolean add(DDAluminum a) {</p>

<p class=Code style='margin-left:0in'>    return false;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public boolean add(DDPaper a) {</p>

<p class=Code style='margin-left:0in'>    return false;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public boolean add(DDGlass a) {</p>

<p class=Code style='margin-left:0in'>    return false;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public boolean add(DDCardboard a) {</p>

<p class=Code style='margin-left:0in'>    return false;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_522]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_523]#</span>You can see that
the overloaded <b>add(&nbsp;)</b> methods all return <b>false</b>. If the
method is not overloaded in a derived class, it will continue to return <b>false</b>,
and the caller (<b>addToBin(&nbsp;)</b>, in this case) will assume that the
current <b>Trash</b> object has not been added successfully to a container, and
continue searching for the right container.</p>

<p class=MsoNormal><span style='display:none'>#[BT_524]#</span>In each of the
subclasses of <b>TypedBin</b>, only one overloaded method is overridden,
according to the type of bin that’s being created. For example, <b>CardboardBin</b>
overrides <b>add(DDCardboard)</b>. The overridden method adds the trash object
to its container and returns <b>true</b>, while all the rest of the <b>add(&nbsp;)
</b>methods in <b>CardboardBin </b>continue to return <b>false</b>, since they
haven’t been overridden. This is another case in which a parameterized type
mechanism in Java would allow automatic generation of code. (With C++ <b>template</b>s, you wouldn’t have to explicitly write the subclasses or place
the <b>addToBin(&nbsp;)</b> method in <b>Trash</b>.) </p>

<p class=MsoNormal><span style='display:none'>#[BT_525]#</span>Since for this
example the trash types have been customized and placed in a different
directory, you’ll need a different trash data file to make it work. Here’s a
possible <b>DDTrash.dat</b>:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//:! refactor:doubledispatch:DDTrash.dat</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDGlass:54</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDPaper:22</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDPaper:11</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDGlass:17</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDAluminum:89</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDPaper:88</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDAluminum:76</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDCardboard:96</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDAluminum:25</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDAluminum:34</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDGlass:11</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDGlass:68</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDGlass:43</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDAluminum:27</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDCardboard:44</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDAluminum:18</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDPaper:91</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDGlass:63</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDGlass:50</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDGlass:80</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDAluminum:81</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDCardboard:12</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDGlass:12</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDGlass:54</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDAluminum:36</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDAluminum:93</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDGlass:93</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDPaper:80</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDGlass:36</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDGlass:12</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDGlass:60</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDPaper:66</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDAluminum:36</p>

<p class=Code style='margin-left:0in'>refactor.doubledispatch.DDCardboard:22</p>

<p class=Code style='margin-left:0in'>///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_526]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_527]#</span>Here’s the rest
of the program:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//:
refactor:doubledispatch:DoubleDispatch.java</p>

<p class=Code style='margin-left:0in'>// Using multiple dispatching to handle
more</p>

<p class=Code style='margin-left:0in'>// than one unknown type during a method
call.</p>

<p class=Code style='margin-left:0in'>package refactor.doubledispatch;</p>

<p class=Code style='margin-left:0in'>import refactor.trash.*;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class AluminumBin extends TypedBin {</p>

<p class=Code style='margin-left:0in'>  public boolean add(DDAluminum a) {</p>

<p class=Code style='margin-left:0in'>    return addIt(a);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class PaperBin extends TypedBin {</p>

<p class=Code style='margin-left:0in'>  public boolean add(DDPaper a) {</p>

<p class=Code style='margin-left:0in'>    return addIt(a);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class GlassBin extends TypedBin {</p>

<p class=Code style='margin-left:0in'>  public boolean add(DDGlass a) {</p>

<p class=Code style='margin-left:0in'>    return addIt(a);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class CardboardBin extends TypedBin {</p>

<p class=Code style='margin-left:0in'>  public boolean add(DDCardboard a) {</p>

<p class=Code style='margin-left:0in'>    return addIt(a);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class TrashBinSet {</p>

<p class=Code style='margin-left:0in'>  private TypedBin[] binSet = {</p>

<p class=Code style='margin-left:0in'>    new AluminumBin(),</p>

<p class=Code style='margin-left:0in'>    new PaperBin(),</p>

<p class=Code style='margin-left:0in'>    new GlassBin(),</p>

<p class=Code style='margin-left:0in'>    new CardboardBin()</p>

<p class=Code style='margin-left:0in'>  };</p>

<p class=Code style='margin-left:0in'>  public void sortIntoBins(Iterator it) {</p>

<p class=Code style='margin-left:0in'>    while(it.hasNext()) {</p>

<p class=Code style='margin-left:0in'>      TypedBinMember t = (TypedBinMember)it.next();</p>

<p class=Code style='margin-left:0in'>      if(!t.addToBin(binSet))</p>

<p class=Code style='margin-left:0in'>        System.err.println(&quot;Couldn't
add &quot; + t);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public TypedBin[] binSet() { return
binSet; }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class DoubleDispatch extends
TestCase  {</p>

<p class=Code style='margin-left:0in'>  Collection bin = new ArrayList();</p>

<p class=Code style='margin-left:0in'>  TrashBinSet bins = new TrashBinSet();</p>

<p class=Code style='margin-left:0in'>  public DoubleDispatch() {</p>

<p class=Code style='margin-left:0in'>    // ParseTrash still works, without
changes:</p>

<p class=Code style='margin-left:0in'>   
ParseTrash.fillBin(&quot;DDTrash.dat&quot;, bin);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    // Sort from the master bin into </p>

<p class=Code style='margin-left:0in'>    // the individually-typed bins:</p>

<p class=Code style='margin-left:0in'>    bins.sortIntoBins(bin.iterator());</p>

<p class=Code style='margin-left:0in'>    TypedBin[] tb = bins.binSet();</p>

<p class=Code style='margin-left:0in'>    // Perform sumValue for each bin...</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; tb.length; i++)</p>

<p class=Code style='margin-left:0in'>      Trash.sumValue(tb[i].c.iterator());</p>

<p class=Code style='margin-left:0in'>    // ... and for the master bin</p>

<p class=Code style='margin-left:0in'>    Trash.sumValue(bin.iterator());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>   
junit.textui.TestRunner.run(DoubleDispatch.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_528]#</span></p>

<p class=MsoNormal><b><span style='display:none'>#[BT_529]#</span>TrashBinSet</b>
encapsulates all of the different types of <b>TypedBin</b>s, along with the <b>sortIntoBins(&nbsp;)</b>
method, which is where all the double dispatching takes place. You can see that
once the structure is set up, sorting into the various <b>TypedBin</b>s is
remarkably easy. In addition, the efficiency of two dynamic method calls is
probably better than any other way you could sort.</p>

<p class=MsoNormal><span style='display:none'>#[BT_530]#</span>Notice the ease
of use of this system in <b>main(&nbsp;)</b>, as well as the complete independence
of any specific type information within <b>main(&nbsp;)</b>. All other methods
that talk only to the <b>Trash</b> base-class interface will be equally
invulnerable to changes in <b>Trash</b> types.</p>

<p class=MsoNormal><span style='display:none'>#[BT_531]#</span>The changes
necessary to add a new type are relatively isolated: you modify <b>TypedBin</b>,<b>
</b>inherit the new type of <b>Trash</b> with its <b>addToBin(&nbsp;)</b>
method, then inherit a new <b>TypedBin</b> (this is really just a copy and
simple edit), and finally add a new type into the aggregate initialization for <b>TrashBinSet</b>.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169804"></a><a
name="_Toc476705926">The <i>Visitor</i> pattern</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_532]#</span>Now consider
applying a design pattern that has an entirely different goal to the trash
sorting problem.</p>

<p class=MsoNormal><span style='display:none'>#[BT_533]#</span>For this
pattern, we are no longer concerned with optimizing the addition of new types
of <b>Trash </b>to the system. Indeed, this pattern makes adding a new type of <b>Trash
</b><i>more</i> complicated. The assumption is that you have a primary class
hierarchy that is fixed; perhaps it’s from another vendor and you can’t make changes
to that hierarchy. However, you’d like to add new polymorphic methods to that
hierarchy, which means that normally you’d have to add something to the base
class interface. So the dilemma is that you need to add methods to the base
class, but you can’t touch the base class. How do you get around this?</p>

<p class=MsoNormal><span style='display:none'>#[BT_534]#</span>The design
pattern that solves this kind of problem is called a “visitor” (the final one
in the <i>Design Patterns</i> book), and it builds on the double<i> </i>dispatching
scheme shown in the last section.</p>

<p class=MsoNormal><span style='display:none'>#[BT_535]#</span>The visitor pattern allows you to extend the interface of the primary type by creating a
separate class hierarchy of type <b>Visitor </b>to virtualize the operations
performed upon the primary type. The objects of the primary type simply
“accept” the visitor, then call the visitor’s dynamically<b>-</b>bound method.
It looks like this:</p>

<p class=MsoNormal align=center style='text-align:center'><span
style='display:none'>#[BT_536]#</span><img border=0 width=443 height=593
src="TIPatterns_files/image011.gif"></p>

<p class=MsoNormal><span style='display:none'>#[BT_537]#</span>Now, if <b>v</b>
is a <b>Visitable </b>reference to an <b>Aluminum</b> object, the code:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>PriceVisitor pv = new PriceVisitor();</p>

<p class=Code style='margin-left:0in'>v.accept(pv);</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_538]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_539]#</span>uses double
dispatching to cause two polymorphic method calls: the first one to select <b>Aluminum</b>’s
version of <b>accept(&nbsp;)</b>, and the second one within <b>accept(&nbsp;)</b>
when the specific version of <b>visit(&nbsp;)</b> is called dynamically using
the base-class <b>Visitor</b> reference <b>v</b>.</p>

<p class=MsoNormal><span style='display:none'>#[BT_540]#</span>This
configuration means that new functionality can be added to the system in the
form of new subclasses of <b>Visitor</b>. The <b>Trash </b>hierarchy doesn’t
need to be touched. This is the prime benefit of the visitor pattern: you can
add new polymorphic functionality to a class hierarchy without touching that
hierarchy (once the <b>accept(&nbsp;)</b> methods have been installed). Note
that the benefit is helpful here but not exactly what we started out to
accomplish, so at first blush you might decide that this isn’t the desired
solution.</p>

<p class=MsoNormal><span style='display:none'>#[BT_541]#</span>But look at one
thing that’s been accomplished: the visitor solution avoids sorting from the
master <b>Trash</b> sequence into individual typed sequences. Thus, you can
leave everything in the single master sequence and simply pass through that
sequence using the appropriate visitor to accomplish the goal. Although this
behavior seems to be a side effect of visitor, it does give us what we want
(avoiding RTTI).</p>

<p class=MsoNormal><span style='display:none'>#[BT_542]#</span>The double dispatching in the visitor pattern takes care of determining both the type of
<b>Trash </b>and the type of <b>Visitor</b>.<b> </b>In the following example,
there are two implementations of <b>Visitor</b>: <b>PriceVisitor</b> to both determine
and sum the price, and <b>WeightVisitor</b> to keep track of the weights.</p>

<p class=MsoNormal><span style='display:none'>#[BT_543]#</span>You can see all
of this implemented in the new, improved version of the recycling program. </p>

<p class=MsoNormal><span style='display:none'>#[BT_544]#</span>As with <b>DoubleDispatch.java</b>,
the <b>Trash</b> class is left alone and a new interface is created to add the <b>accept(&nbsp;)</b>
method:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: refactor:trashvisitor:Visitable.java</p>

<p class=Code style='margin-left:0in'>// An interface to add visitor
functionality </p>

<p class=Code style='margin-left:0in'>// to the Trash hierarchy without </p>

<p class=Code style='margin-left:0in'>// modifying the base class.</p>

<p class=Code style='margin-left:0in'>package refactor.trashvisitor;</p>

<p class=Code style='margin-left:0in'>import refactor.trash.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>interface Visitable {</p>

<p class=Code style='margin-left:0in'>  // The new method:</p>

<p class=Code style='margin-left:0in'>  void accept(Visitor v);</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_545]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_546]#</span>Since there’s
nothing concrete in the <b>Visitor</b> base class, it can be created as an <b>interface</b>:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: refactor:trashvisitor:Visitor.java</p>

<p class=Code style='margin-left:0in'>// The base interface for visitors.</p>

<p class=Code style='margin-left:0in'>package refactor.trashvisitor;</p>

<p class=Code style='margin-left:0in'>import refactor.trash.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>interface Visitor {</p>

<p class=Code style='margin-left:0in'>  void visit(Aluminum a);</p>

<p class=Code style='margin-left:0in'>  void visit(Paper p);</p>

<p class=Code style='margin-left:0in'>  void visit(Glass g);</p>

<p class=Code style='margin-left:0in'>  void visit(Cardboard c);</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_547]#</span></p>

<h3><a name="_Toc41169805">A Reflective Decorator</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_548]#</span>At this point,
you <i>could </i> follow the same approach that was used for double dispatching
and create new subtypes of <b>Aluminum</b>,<b> Paper</b>,<b> Glass, </b>and<b>
Cardboard</b> that implement the <b>accept(&nbsp;)</b> method. For example, the
new <b>Visitable</b> <b>Aluminum</b> would look like this:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: refactor:trashvisitor:VAluminum.java</p>

<p class=Code style='margin-left:0in'>// Taking the previous approach of
creating a</p>

<p class=Code style='margin-left:0in'>// specialized Aluminum for the visitor
pattern.</p>

<p class=Code style='margin-left:0in'>package refactor.trashvisitor;</p>

<p class=Code style='margin-left:0in'>import refactor.trash.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class VAluminum extends Aluminum </p>

<p class=Code style='margin-left:0in'>    implements Visitable {</p>

<p class=Code style='margin-left:0in'>  public VAluminum(double wt) {
super(wt); }</p>

<p class=Code style='margin-left:0in'>  public void accept(Visitor v) {</p>

<p class=Code style='margin-left:0in'>    v.visit(this);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_549]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_550]#</span>However, we seem
to be encountering an “explosion of interfaces:” basic <b>Trash</b>, special
versions for double dispatching, and now more special versions for visitor. Of
course, this “explosion of interfaces” is arbitrary—one could simply put the
additional methods in the <b>Trash</b> class. If we ignore that we can instead
see an opportunity to use the <i>Decorator</i> pattern: it seems like it should
be possible to create a <i>Decorator</i> that can be wrapped around an ordinary
<b>Trash</b> object and will produce the same interface as <b>Trash</b> and add
the extra <b>accept(&nbsp;)</b> method. In fact, it’s a perfect example of the
value of <i>Decorator</i>.</p>

<p class=MsoNormal><span style='display:none'>#[BT_551]#</span>The double
dispatch creates a problem, however. Since it relies on overloading of both <b>accept(&nbsp;)
</b>and <b>visit(&nbsp;)</b>,<b> </b>it would seem to require specialized code
for each different version of the <b>accept(&nbsp;)</b> method. With C++
templates, this would be fairly easy to accomplish (since templates automatically
generate type-specialized code) but Java has no such mechanism—at least it does
not appear to. However, reflection allows you to determine type information at
run time, and it turns out to solve many problems that would seem to require
templates (albeit not as simply). Here’s the decorator that does the trick<a
href="#_ftn13" name="_ftnref13" title=""><span class=MsoFootnoteReference><span
style='vertical-align:baseline'><span class=MsoFootnoteReference><span
style='font-size:11.0pt;font-family:Georgia;vertical-align:baseline'>[13]</span></span></span></span></a>:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//:
refactor:trashvisitor:VisitableDecorator.java</p>

<p class=Code style='margin-left:0in'>// A decorator that adapts the generic
Trash</p>

<p class=Code style='margin-left:0in'>// classes to the visitor pattern.</p>

<p class=Code style='margin-left:0in'>// [ Use a Dynamic Proxy here?? ]</p>

<p class=Code style='margin-left:0in'>package refactor.trashvisitor;</p>

<p class=Code style='margin-left:0in'>import refactor.trash.*;</p>

<p class=Code style='margin-left:0in'>import java.lang.reflect.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class VisitableDecorator</p>

<p class=Code style='margin-left:0in'>extends Trash implements Visitable {</p>

<p class=Code style='margin-left:0in'>  private Trash delegate;</p>

<p class=Code style='margin-left:0in'>  private Method dispatch;</p>

<p class=Code style='margin-left:0in'>  public VisitableDecorator(Trash t) {</p>

<p class=Code style='margin-left:0in'>    delegate = t;</p>

<p class=Code style='margin-left:0in'>    try {</p>

<p class=Code style='margin-left:0in'>      dispatch = Visitor.class.getMethod
(</p>

<p class=Code style='margin-left:0in'>        &quot;visit&quot;, new Class[] {
t.getClass() }</p>

<p class=Code style='margin-left:0in'>      );</p>

<p class=Code style='margin-left:0in'>    } catch(Exception e) {</p>

<p class=Code style='margin-left:0in'>      throw new RuntimeException(e);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public double getValue() {</p>

<p class=Code style='margin-left:0in'>    return delegate.getValue();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public double getWeight() {</p>

<p class=Code style='margin-left:0in'>    return delegate.getWeight();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void accept(Visitor v) {</p>

<p class=Code style='margin-left:0in'>    try {</p>

<p class=Code style='margin-left:0in'>      dispatch.invoke(v, new
Object[]{delegate});</p>

<p class=Code style='margin-left:0in'>    } catch(Exception e) {</p>

<p class=Code style='margin-left:0in'>      throw new RuntimeException(e);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_552]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_553]#</span>[[ Description
of Reflection use  ]]</p>

<p class=MsoNormal>[[Note that a Dynamic Proxy might also be applied here.]]</p>

<p class=MsoNormal><span style='display:none'>#[BT_554]#</span>The only other
tool we need is a new type of <b>Fillable </b>adapter that automatically
decorates the objects as they are being created from the original <b>Trash.dat</b>
file. But this might as well be a decorator itself, decorating any kind of <b>Fillable</b>:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//:
refactor:trashvisitor:FillableVisitor.java </p>

<p class=Code style='margin-left:0in'>// Adapter Decorator that adds the
visitable </p>

<p class=Code style='margin-left:0in'>// decorator as the Trash objects are </p>

<p class=Code style='margin-left:0in'>// being created.</p>

<p class=Code style='margin-left:0in'>package refactor.trashvisitor;</p>

<p class=Code style='margin-left:0in'>import refactor.trash.*;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class FillableVisitor</p>

<p class=Code style='margin-left:0in'>implements Fillable {</p>

<p class=Code style='margin-left:0in'>  private Fillable f;</p>

<p class=Code style='margin-left:0in'>  public FillableVisitor(Fillable ff) { f
= ff; }</p>

<p class=Code style='margin-left:0in'>  public void addTrash(Trash t) {</p>

<p class=Code style='margin-left:0in'>    f.addTrash(new
VisitableDecorator(t));</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_555]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_556]#</span>Now you can wrap
it around any kind of existing <b>Fillable</b>, or any new ones that haven’t
yet been created.</p>

<p class=MsoNormal><span style='display:none'>#[BT_557]#</span>The rest of the
program creates specific <b>Visitor</b> types and sends them through a single
list of <b>Trash</b> objects:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: refactor:trashvisitor:TrashVisitor.java
</p>

<p class=Code style='margin-left:0in'>// The &quot;visitor&quot; pattern with
VisitableDecorators.</p>

<p class=Code style='margin-left:0in'>package refactor.trashvisitor;</p>

<p class=Code style='margin-left:0in'>import refactor.trash.*;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// Specific group of algorithms packaged</p>

<p class=Code style='margin-left:0in'>// in each implementation of Visitor:</p>

<p class=Code style='margin-left:0in'>class PriceVisitor implements Visitor {</p>

<p class=Code style='margin-left:0in'>  private double alSum; // Aluminum</p>

<p class=Code style='margin-left:0in'>  private double pSum; // Paper</p>

<p class=Code style='margin-left:0in'>  private double gSum; // Glass</p>

<p class=Code style='margin-left:0in'>  private double cSum; // Cardboard</p>

<p class=Code style='margin-left:0in'>  public void visit(Aluminum al) {</p>

<p class=Code style='margin-left:0in'>    double v = al.getWeight() *
al.getValue();</p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      &quot;value of Aluminum= &quot; +
v);</p>

<p class=Code style='margin-left:0in'>    alSum += v;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void visit(Paper p) {</p>

<p class=Code style='margin-left:0in'>    double v = p.getWeight() *
p.getValue();</p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      &quot;value of Paper= &quot; + v);</p>

<p class=Code style='margin-left:0in'>    pSum += v;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void visit(Glass g) {</p>

<p class=Code style='margin-left:0in'>    double v = g.getWeight() *
g.getValue();</p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      &quot;value of Glass= &quot; + v);</p>

<p class=Code style='margin-left:0in'>    gSum += v;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void visit(Cardboard c) {</p>

<p class=Code style='margin-left:0in'>    double v = c.getWeight() *
c.getValue();</p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      &quot;value of Cardboard = &quot; +
v);</p>

<p class=Code style='margin-left:0in'>    cSum += v;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  void total() {</p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      &quot;Total Aluminum: $&quot; +
alSum +</p>

<p class=Code style='margin-left:0in'>      &quot;\n Total Paper: $&quot; +
pSum + </p>

<p class=Code style='margin-left:0in'>      &quot;\nTotal Glass: $&quot; + gSum
+ </p>

<p class=Code style='margin-left:0in'>      &quot;\nTotal Cardboard: $&quot; +
cSum +</p>

<p class=Code style='margin-left:0in'>      &quot;\nTotal: $&quot; + </p>

<p class=Code style='margin-left:0in'>        (alSum + pSum + gSum + cSum));</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>class WeightVisitor implements Visitor {</p>

<p class=Code style='margin-left:0in'>  private double alSum; // Aluminum</p>

<p class=Code style='margin-left:0in'>  private double pSum; // Paper</p>

<p class=Code style='margin-left:0in'>  private double gSum; // Glass</p>

<p class=Code style='margin-left:0in'>  private double cSum; // Cardboard</p>

<p class=Code style='margin-left:0in'>  public void visit(Aluminum al) {</p>

<p class=Code style='margin-left:0in'>    alSum += al.getWeight();</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;weight of
Aluminum = &quot;</p>

<p class=Code style='margin-left:0in'>        + al.getWeight());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void visit(Paper p) {</p>

<p class=Code style='margin-left:0in'>    pSum += p.getWeight();</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;weight of
Paper = &quot;</p>

<p class=Code style='margin-left:0in'>        + p.getWeight());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void visit(Glass g) {</p>

<p class=Code style='margin-left:0in'>    gSum += g.getWeight();</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;weight of
Glass = &quot;</p>

<p class=Code style='margin-left:0in'>        + g.getWeight());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void visit(Cardboard c) {</p>

<p class=Code style='margin-left:0in'>    cSum += c.getWeight();</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;weight of
Cardboard = &quot;</p>

<p class=Code style='margin-left:0in'>        + c.getWeight());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  void total() {</p>

<p class=Code style='margin-left:0in'>    System.out.println(</p>

<p class=Code style='margin-left:0in'>      &quot;Total weight Aluminum: &quot;
+ alSum +</p>

<p class=Code style='margin-left:0in'>      &quot;\nTotal weight Paper: &quot;
+ pSum +</p>

<p class=Code style='margin-left:0in'>      &quot;\nTotal weight Glass: &quot;
+ gSum +</p>

<p class=Code style='margin-left:0in'>      &quot;\nTotal weight Cardboard:
&quot; + cSum +</p>

<p class=Code style='margin-left:0in'>      &quot;\nTotal weight: &quot; +
(alSum + pSum + gSum + cSum));</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class TrashVisitor extends
TestCase  {</p>

<p class=Code style='margin-left:0in'>  Collection bin = new ArrayList();</p>

<p class=Code style='margin-left:0in'>  PriceVisitor pv = new PriceVisitor();</p>

<p class=Code style='margin-left:0in'>  WeightVisitor wv = new WeightVisitor();</p>

<p class=Code style='margin-left:0in'>  public TrashVisitor() {</p>

<p class=Code style='margin-left:0in'>    <span lang=IT>ParseTrash.fillBin(&quot;../trash/Trash.dat&quot;,
</span></p>

<p class=Code style='margin-left:0in'><span lang=IT>      </span>new
FillableVisitor(</p>

<p class=Code style='margin-left:0in'>        new FillableCollection(bin)));</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    Iterator it = bin.iterator();</p>

<p class=Code style='margin-left:0in'>    while(it.hasNext()) {</p>

<p class=Code style='margin-left:0in'>      Visitable v = (Visitable)it.next();</p>

<p class=Code style='margin-left:0in'>      v.accept(pv);</p>

<p class=Code style='margin-left:0in'>      v.accept(wv);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    pv.total();</p>

<p class=Code style='margin-left:0in'>    wv.total();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(TrashVisitor.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_558]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_559]#</span>In <b>Test(&nbsp;)</b>,
note how visitability is added by simply creating a different kind of bin using
the decorator. Also notice that the <b>FillableCollection</b> adapter has the
appearance of being used as a decorator (for <b>ArrayList</b>) in this
situation. However, it completely changes the interface of the <b>ArrayList</b>,
whereas the definition of <i>Decorator</i> is that the interface of the decorated
class must still be there after decoration.</p>

<p class=MsoNormal><span style='display:none'>#[BT_560]#</span>Note that the
shape of the client code (shown in the <b>Test</b> class) has changed again,
from the original approaches to the problem. Now there’s only a single <b>Trash</b>
bin. The two <b>Visitor</b> objects are accepted into every element in the sequence,
and they perform their operations. The visitors keep their own internal data to
tally the total weights and prices.</p>

<p class=MsoNormal><span style='display:none'>#[BT_561]#</span>Finally, there’s
no run time type identification other than the inevitable cast to <b>Trash</b>
when pulling things out of the sequence. This, too, could be eliminated with
the implementation of parameterized types in Java.</p>

<p class=MsoNormal><span style='display:none'>#[BT_562]#</span>One way you can
distinguish this solution from the double dispatching solution described
previously is to note that, in the double dispatching solution, only one of the
overloaded methods, <b>add(&nbsp;)</b>, was overridden when each subclass was
created, while here <i>each</i> one of the overloaded <b>visit(&nbsp;)</b>
methods is overridden in every subclass of <b>Visitor</b>.</p>

<h3><a name="_Toc41169806">More coupling?</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_563]#</span>There’s a lot
more code here, and there’s definite coupling between the <b>Trash</b>
hierarchy and the <b>Visitor</b> hierarchy. However, there’s also high cohesion
within the respective sets of classes: they each do only one thing (<b>Trash </b>describes
Trash, while <b>Visitor </b>describes actions performed on <b>Trash</b>), which
is an indicator of a good design. Of course, in this case it works well only if
you’re adding new <b>Visitor</b>s, but it gets in the way when you add new
types of <b>Trash</b>.</p>

<p class=MsoNormal><span style='display:none'>#[BT_564]#</span>Low coupling
between classes and high cohesion within a class is definitely an important
design goal. Applied mindlessly, though, it can prevent you from achieving a
more elegant design. It seems that some classes inevitably have a certain
intimacy with each other. These often occur in pairs that could perhaps be
called <i>couplets</i>; for example, containers and iterators. The <b>Trash-Visitor</b>
pair above appears to be another such couplet.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc375545419"></a><a
name="_Toc41169807"></a><a name="_Toc476705927">RTTI considered harmful?</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_565]#</span>Various designs
in this chapter attempt to remove RTTI, which might give you the impression
that it’s “considered harmful” (the condemnation used for poor, ill-fated <b>goto</b>,
which was thus never put into Java). This isn’t true; it is the <i>misuse</i> of RTTI that is the problem. The reason our designs removed RTTI is because the
misapplication of that feature prevented extensibility, while the stated goal
was to be able to add a new type to the system with as little impact on
surrounding code as possible. Since RTTI is often misused by having it look for
every single type in your system, it causes code to be non-extensible: when you
add a new type, you have to go hunting for all the code in which RTTI is used,
and if you miss any you won’t get help from the compiler.</p>

<p class=MsoNormal><span style='display:none'>#[BT_566]#</span>However, RTTI
doesn’t automatically create non-extensible code. Let’s revisit the trash
recycler once more. This time, a new tool will be introduced, which I call a <b>TypeMap</b>.
It contains a <b>HashMap</b> that holds <b>ArrayList</b>s, but the interface is
simple: you can <b>add(&nbsp;)</b> a new object, and you can <b>get(&nbsp;)</b>
an <b>ArrayList</b> containing all the objects of a particular type. The keys
for the contained <b>HashMap</b> are the types in the associated <b>ArrayList</b>.
The beauty of this design is that the <b>TypeMap</b> dynamically adds a new
pair whenever it encounters a new type, so whenever you add a new type to the
system (even if you add the new type at run time), it adapts.</p>

<p class=MsoNormal><span style='display:none'>#[BT_567]#</span>Our example will
again build on the structure of the <b>Trash</b> types in <b>package
refactor.Trash</b> (and the <b>Trash.dat</b> file used there can be used here
without change):</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: refactor:dynatrash:DynaTrash.java </p>

<p class=Code style='margin-left:0in'>// Using a Map of Lists and RTTI to
automatically sort </p>

<p class=Code style='margin-left:0in'>// trash into ArrayLists. This solution,
despite the</p>

<p class=Code style='margin-left:0in'>// use of RTTI, is extensible.</p>

<p class=Code style='margin-left:0in'>package refactor.dynatrash;</p>

<p class=Code style='margin-left:0in'>import refactor.trash.*;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import junit.framework.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// Generic TypeMap works in any
situation:</p>

<p class=Code style='margin-left:0in'>class TypeMap {</p>

<p class=Code style='margin-left:0in'>  private Map t = new HashMap();</p>

<p class=Code style='margin-left:0in'>  public void add(Object o) {</p>

<p class=Code style='margin-left:0in'>    Class type = o.getClass();</p>

<p class=Code style='margin-left:0in'>    if(t.containsKey(type))</p>

<p class=Code style='margin-left:0in'>      ((List)t.get(type)).add(o);</p>

<p class=Code style='margin-left:0in'>    else {</p>

<p class=Code style='margin-left:0in'>      List v = new ArrayList();</p>

<p class=Code style='margin-left:0in'>      v.add(o);</p>

<p class=Code style='margin-left:0in'>      t.put(type,v);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public List get(Class type) {</p>

<p class=Code style='margin-left:0in'>    return (List)t.get(type);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public Iterator keys() { </p>

<p class=Code style='margin-left:0in'>    return t.keySet().iterator(); </p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>// Adapter class to allow callbacks</p>

<p class=Code style='margin-left:0in'>// from ParseTrash.fillBin():</p>

<p class=Code style='margin-left:0in'>class TypeMapAdapter implements Fillable
{</p>

<p class=Code style='margin-left:0in'>  TypeMap map;</p>

<p class=Code style='margin-left:0in'>  public TypeMapAdapter(TypeMap tm) { map
= tm; }</p>

<p class=Code style='margin-left:0in'>  public void addTrash(Trash t) {
map.add(t); }</p>

<p class=Code style='margin-left:0in'>}</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class DynaTrash extends TestCase  {</p>

<p class=Code style='margin-left:0in'>  TypeMap bin = new TypeMap();</p>

<p class=Code style='margin-left:0in'>  public DynaTrash() {</p>

<p class=Code style='margin-left:0in'>    <span lang=IT>ParseTrash.fillBin(&quot;../trash/Trash.dat&quot;,
</span></p>

<p class=Code style='margin-left:0in'><span lang=IT>      </span>new
TypeMapAdapter(bin));</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void test() {</p>

<p class=Code style='margin-left:0in'>    Iterator keys = bin.keys();</p>

<p class=Code style='margin-left:0in'>    while(keys.hasNext())</p>

<p class=Code style='margin-left:0in'>      Trash.sumValue(</p>

<p class=Code style='margin-left:0in'>        bin.get((Class)keys.next()).iterator());</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void main(String args[])
{</p>

<p class=Code style='margin-left:0in'>    junit.textui.TestRunner.run(DynaTrash.class);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span style='display:none'>#[BT_568]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_569]#</span>Although
powerful, the definition for <b>TypeMap</b> is simple. It contains a <b>HashMap</b>,
and the <b>add(&nbsp;)</b> method does most of the work. When you <b>add(&nbsp;)</b>
a new object, the reference for the <b>Class</b> object for that type is
extracted. This is used as a key to determine whether an <b>ArrayList</b>
holding objects of that type is already present in the <b>HashMap</b>. If so,
that <b>ArrayList</b> is extracted and the object is added to the <b>ArrayList</b>.
If not, the <b>Class</b> object and a new <b>ArrayList</b> are added as a
key-value pair.</p>

<p class=MsoNormal><span style='display:none'>#[BT_570]#</span>You can get an <b>Iterator</b>
of all the <b>Class</b> objects from <b>keys(&nbsp;)</b>, and use each <b>Class</b>
object to fetch the corresponding <b>ArrayList</b> with <b>get(&nbsp;)</b>. And
that’s all there is to it.</p>

<p class=MsoNormal><span style='display:none'>#[BT_571]#</span>The <b>filler(&nbsp;)</b>
method is interesting because it takes advantage of the design of <b>ParseTrash.fillBin(&nbsp;)</b>,
which doesn’t just try to fill an <b>ArrayList</b> but instead anything that implements
the <b>Fillable</b> interface with its <b>addTrash(&nbsp;)</b> method. All <b>filler(&nbsp;)</b>
needs to do is to return a reference to an <b>interface</b> that implements <b>Fillable</b>,
and then this reference can be used as an argument to <b>fillBin(&nbsp;)</b>
like this:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'><span lang=SV>ParseTrash.fillBin(&quot;Trash.dat&quot;,
bin.filler());</span></p>

</div>

<p class=MsoNormal><span lang=SV>&nbsp;</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_572]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_573]#</span>To produce this
reference, an <i>anonymous inner class</i> (described in Chapter 8 of <i>Thinking
in Java, 2<sup>nd</sup> edition</i>) is used. You never need a named class to
implement <b>Fillable</b>, you just need a reference to an object of that
class, thus this is an appropriate use of anonymous inner classes.</p>

<p class=MsoNormal><span style='display:none'>#[BT_574]#</span>An interesting
thing about this design is that even though it wasn’t created to handle the
sorting, <b>fillBin(&nbsp;)</b> is performing a sort every time it inserts a <b>Trash</b>
object into <b>bin</b>.</p>

<p class=MsoNormal><span style='display:none'>#[BT_575]#</span>Much of <b>class
DynaTrash</b> should be familiar from the previous examples. This time, instead
of placing the new <b>Trash</b> objects into a <b>bin</b> of type <b>ArrayList</b>,
the <b>bin</b> is of type <b>TypeMap</b>, so when the trash is thrown into <b>bin</b>
it’s immediately sorted by <b>TypeMap</b>’s internal sorting mechanism.
Stepping through the <b>TypeMap</b> and operating on each individual <b>ArrayList</b>
becomes a simple matter.</p>

<p class=MsoNormal><span style='display:none'>#[BT_576]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_577]#</span>As you can see,
adding a new type to the system won’t affect this code at all, and the code in <b>TypeMap</b>
is completely independent. This is certainly the smallest solution to the
problem, and arguably the most elegant as well. It does rely heavily on RTTI,
but notice that each key-value pair in the <b>HashMap</b> is looking for only
one type. In addition, there’s no way you can “forget” to add the proper code
to this system when you add a new type, since there isn’t any code you need to
add.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169808"></a><a
name="_Toc476705928">Summary</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_578]#</span>Coming up with a
design such as <b>TrashVisitor.java </b>that contains a larger amount of code
than the earlier designs can seem at first to be counterproductive. It pays to
notice what you’re trying to accomplish with various designs. Design patterns
in general strive to <i>separate the things that change from the things that
stay the same</i>. The “things that change” can refer to many different kinds
of changes. Perhaps the change occurs because the program is placed into a new
environment or because something in the current environment changes (this could
be: “The user wants to add a new shape to the diagram currently on the
screen”). Or, as in this case, the change could be the evolution of the code
body. While previous versions of the trash sorting example emphasized the
addition of new <i>types</i> of <b>Trash </b>to the system, <b>TrashVisitor.java</b>
allows you to easily add new <i>functionality</i> without disturbing the <b>Trash</b>
hierarchy. There’s more code in <b>TrashVisitor.java</b>, but adding new
functionality to <b>Visitor</b> is cheap. If this is something that happens a
lot, then it’s worth the extra effort and code to make it happen more easily.</p>

<p class=MsoNormal><span style='display:none'>#[BT_579]#</span>The discovery of
the vector of change is no trivial matter; it’s not something that an analyst
can usually detect before the program sees its initial design. The necessary
information will probably not appear until later phases in the project:
sometimes only at the design or implementation phases do you discover a deeper
or more subtle need in your system. In the case of adding new types (which was
the focus of most of the “recycle” examples) you might realize that you need a
particular inheritance hierarchy only when you are in the maintenance phase and
you begin extending the system!</p>

<p class=MsoNormal><span style='display:none'>#[BT_580]#</span>One of the most
important things that you’ll learn by studying design patterns seems to be an
about-face from what has been promoted so far in this book. That is: “OOP is
all about polymorphism.” This statement can produce the “two-year-old with a
hammer” syndrome (everything looks like a nail). Put another way, it’s hard
enough to “get” polymorphism, and once you do, you try to cast all your designs
into that one particular mold.</p>

<p class=MsoNormal><span style='display:none'>#[BT_581]#</span>What design
patterns say is that OOP isn’t just about polymorphism. It’s about “separating
the things that change from the things that stay the same.” Polymorphism is an especially important way to do this, and it turns out to be
helpful if the programming language directly supports polymorphism (so you
don’t have to wire it in yourself, which would tend to make it prohibitively
expensive). But design patterns in general show <i>other</i> ways to accomplish
the basic goal, and once your eyes have been opened to this you will begin to
search for more creative designs.</p>

<p class=MsoNormal><span style='display:none'>#[BT_582]#</span>Since the <i>Design
Patterns</i> book came out and made such an impact, people have been searching
for other patterns. You can expect to see more of these appear as time goes on.
Here are some sites recommended by Jim Coplien, of C++ fame (<i>http://www.bell-labs.com/~cope</i>),
who is one of the main proponents of the patterns movement:</p>

<p class=MsoNormal><i><span style='display:none'>#[BT_583]#</span>http://st-www.cs.uiuc.edu/users/patterns<br>
http://c2.com/cgi/wiki<br>
http://c2.com/ppr<br>
http://www.bell-labs.com/people/cope/Patterns/Process/index.html<br>
http://www.bell-labs.com/cgi-user/OrgPatterns/OrgPatterns<br>
http://st-www.cs.uiuc.edu/cgi-bin/wikic/wikic<br>
http://www.cs.wustl.edu/~schmidt/patterns.html<br>
http://www.espinc.com/patterns/overview.html</i></p>

<p class=MsoNormal><span style='display:none'>#[BT_584]#</span>Also note there
has been a yearly conference on design patterns, called PLOP, that produces a
published proceedings, the third of which came out in late 1997 (all published
by Addison-Wesley).</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169809"></a><a
name="_Toc476705929"></a><a name="_Toc375545420">Exercises</a></h2>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>1. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Add a class <b>Plastic</b> to <b>TrashVisitor.java</b>.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>2. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Add a class <b>Plastic</b> to <b>DynaTrash.java</b>.</p>

<p class=Exercises style='text-indent:-.75in'><span style='font-size:12.0pt;
font-family:Verdana'><span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>3. <span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Create a decorator like <b>VisitableDecorator</b>, but for the
multiple dispatching example, along with an “adapter decorator” class like the
one created for <b>VisitableDecorator</b>. Build the rest of the example and
show that it works.</p>

<p class=MsoNormal><span style='display:none'>#[BT_585]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_586]#</span></p>

</div>

<span style='font-size:11.0pt;font-family:Georgia;display:none'><br clear=all
style='page-break-before:always'>
</span>

<div class=Section19>

<h1 style='margin-left:.75in'><a name="_Toc41169810">Projects</a></h1>

<p class=Intro>A number of more challenging projects for you to solve. [[Some of
these may turn into examples in the book, and so at some point might disappear
from here]]</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169811">Rats &amp; Mazes</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_587]#</span>First, create a <i>Blackboard</i>
(cite reference) which is an object on which anyone may record information.
This particular blackboard draws a maze, and is used as information comes back
about the structure of a maze from the rats that are investigating it.</p>

<p class=MsoNormal><span style='display:none'>#[BT_588]#</span>Now create the
maze itself. Like a real maze, this object reveals very little information
about itself — given a coordinate, it will tell you whether there are walls or
spaces in the four directions immediately surrounding that coordinate, but no
more. For starters, read the maze in from a text file but consider hunting on
the internet for a maze-generating algorithm. In any event, the result should
be an object that, given a maze coordinate, will report walls and spaces around
that coordinate. Also, you must be able to ask it for an entry point to the
maze.</p>

<p class=MsoNormal><span style='display:none'>#[BT_589]#</span>Finally, create
the maze-investigating <b>Rat</b> class. Each rat can communicate with both the
blackboard to give the current information and the maze to request new
information based on the current position of the rat. However, each time a rat
reaches a decision point where the maze branches, it creates a new rat to go
down each of the branches. Each rat is driven by its own thread. When a rat
reaches a dead end, it terminates itself after reporting the results of its
final investigation to the blackboard.</p>

<p class=MsoNormal><span style='display:none'>#[BT_590]#</span>The goal is to
completely map the maze, but you must also determine whether the end condition
will be naturally found or whether the blackboard must be responsible for the
decision.</p>

<p class=MsoNormal><span style='display:none'>#[BT_591]#</span>An example
implementation by Jeremy Meyer:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: projects:Maze.java</p>

<p class=Code style='margin-left:0in'>package projects;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>import java.io.*;</p>

<p class=Code style='margin-left:0in'>import java.awt.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class Maze extends Canvas {</p>

<p class=Code style='margin-left:0in'>  private Vector lines; // a line is a
char array</p>

<p class=Code style='margin-left:0in'>  private int width = -1;</p>

<p class=Code style='margin-left:0in'>  private int height = -1;</p>

<p class=Code style='margin-left:0in'>  public static void main (String []
args) </p>

<p class=Code style='margin-left:0in'>  throws IOException {</p>

<p class=Code style='margin-left:0in'>    if (args.length &lt; 1) {</p>

<p class=Code style='margin-left:0in'>      System.out.println(&quot;Enter
filename&quot;);</p>

<p class=Code style='margin-left:0in'>      System.exit(0);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    Maze m = new Maze();</p>

<p class=Code style='margin-left:0in'>    m.load(args[0]);</p>

<p class=Code style='margin-left:0in'>    Frame f = new Frame();</p>

<p class=Code style='margin-left:0in'>    f.setSize(m.width*20, m.height*20);</p>

<p class=Code style='margin-left:0in'>    f.add(m);     </p>

<p class=Code style='margin-left:0in'>    Rat r = new Rat(m, 0, 0);</p>

<p class=Code style='margin-left:0in'>    f.setVisible(true);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public Maze() {</p>

<p class=Code style='margin-left:0in'>    lines = new Vector();</p>

<p class=Code style='margin-left:0in'>    setBackground(Color.lightGray);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  synchronized public boolean </p>

<p class=Code style='margin-left:0in'>  isEmptyXY(int x, int y) {</p>

<p class=Code style='margin-left:0in'>    if (x &lt; 0) x += width;</p>

<p class=Code style='margin-left:0in'>    if (y &lt; 0) y += height; </p>

<p class=Code style='margin-left:0in'>    // Use mod arithmetic to bring rat in
line:</p>

<p class=Code style='margin-left:0in'>    byte[] by = </p>

<p class=Code style='margin-left:0in'>     
(byte[])(lines.elementAt(y%height));  </p>

<p class=Code style='margin-left:0in'>    return by[x%width]==' ';</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  synchronized public void </p>

<p class=Code style='margin-left:0in'>  setXY(int x, int y, byte newByte) {</p>

<p class=Code style='margin-left:0in'>    if (x &lt; 0) x += width;</p>

<p class=Code style='margin-left:0in'>    if (y &lt; 0) y += height; </p>

<p class=Code style='margin-left:0in'>    byte[] by = </p>

<p class=Code style='margin-left:0in'>      (byte[])(lines.elementAt(y%height));</p>

<p class=Code style='margin-left:0in'>    by[x%width] = newByte;</p>

<p class=Code style='margin-left:0in'>    repaint();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void </p>

<p class=Code style='margin-left:0in'>  load(String filename) throws
IOException {</p>

<p class=Code style='margin-left:0in'>    String currentLine = null;</p>

<p class=Code style='margin-left:0in'>    BufferedReader br = new
BufferedReader(</p>

<p class=Code style='margin-left:0in'>      new FileReader(filename));</p>

<p class=Code style='margin-left:0in'>    for(currentLine = br.readLine(); </p>

<p class=Code style='margin-left:0in'>        currentLine != null;</p>

<p class=Code style='margin-left:0in'>        currentLine = br.readLine())  {</p>

<p class=Code style='margin-left:0in'>     
lines.addElement(currentLine.getBytes());       </p>

<p class=Code style='margin-left:0in'>      if(width &lt; 0 || </p>

<p class=Code style='margin-left:0in'>         currentLine.getBytes().length
&gt; width)</p>

<p class=Code style='margin-left:0in'>        width =
currentLine.getBytes().length;</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    height = lines.size();</p>

<p class=Code style='margin-left:0in'>    br.close();</p>

<p class=Code style='margin-left:0in'>  }       </p>

<p class=Code style='margin-left:0in'>  public void update(Graphics g) {
paint(g); }</p>

<p class=Code style='margin-left:0in'>  public void paint (Graphics g) {</p>

<p class=Code style='margin-left:0in'>    int canvasHeight =
this.getBounds().height;</p>

<p class=Code style='margin-left:0in'>    int canvasWidth  =
this.getBounds().width;</p>

<p class=Code style='margin-left:0in'>    if (height &lt; 1 || width &lt; 1) </p>

<p class=Code style='margin-left:0in'>      return; // nothing to do </p>

<p class=Code style='margin-left:0in'>    int width = </p>

<p class=Code style='margin-left:0in'>     
((byte[])(lines.elementAt(0))).length;</p>

<p class=Code style='margin-left:0in'>    for (int y = 0; y &lt; lines.size();
y++) {</p>

<p class=Code style='margin-left:0in'>      byte[] b;</p>

<p class=Code style='margin-left:0in'>      b = (byte[])(lines.elementAt(y));</p>

<p class=Code style='margin-left:0in'>      for (int x = 0; x &lt; width; x++)
{</p>

<p class=Code style='margin-left:0in'>        switch(b[x]) {</p>

<p class=Code style='margin-left:0in'>          case ' ': // empty part of maze</p>

<p class=Code style='margin-left:0in'>            g.setColor(Color.lightGray);</p>

<p class=Code style='margin-left:0in'>            g.fillRect(</p>

<p class=Code style='margin-left:0in'>              x*(canvasWidth/width),</p>

<p class=Code style='margin-left:0in'>              y*(canvasHeight/height),</p>

<p class=Code style='margin-left:0in'>              canvasWidth/width,</p>

<p class=Code style='margin-left:0in'>              canvasHeight/height);</p>

<p class=Code style='margin-left:0in'>            break;</p>

<p class=Code style='margin-left:0in'>          case '*':     // a wall </p>

<p class=Code style='margin-left:0in'>            g.setColor(Color.darkGray);</p>

<p class=Code style='margin-left:0in'>            g.fillRect(</p>

<p class=Code style='margin-left:0in'>              x*(canvasWidth/width),</p>

<p class=Code style='margin-left:0in'>              y*(canvasHeight/height),</p>

<p class=Code style='margin-left:0in'>              (canvasWidth/width)-1,</p>

<p class=Code style='margin-left:0in'>              (canvasHeight/height)-1);</p>

<p class=Code style='margin-left:0in'>            break;</p>

<p class=Code style='margin-left:0in'>          default:      // must be rat</p>

<p class=Code style='margin-left:0in'>            g.setColor(Color.red);</p>

<p class=Code style='margin-left:0in'>           
g.fillOval(x*(canvasWidth/width),</p>

<p class=Code style='margin-left:0in'>            y*(canvasHeight/height),</p>

<p class=Code style='margin-left:0in'>            canvasWidth/width,</p>

<p class=Code style='margin-left:0in'>            canvasHeight/height);</p>

<p class=Code style='margin-left:0in'>            break;              </p>

<p class=Code style='margin-left:0in'>        }      </p>

<p class=Code style='margin-left:0in'>      }     </p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_592]#</span></p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: projects:Rat.java</p>

<p class=Code style='margin-left:0in'>package projects;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class Rat {</p>

<p class=Code style='margin-left:0in'>  static int ratCount = 0;</p>

<p class=Code style='margin-left:0in'>  private Maze prison;</p>

<p class=Code style='margin-left:0in'>  private int vertDir = 0; </p>

<p class=Code style='margin-left:0in'>  private int horizDir = 0;</p>

<p class=Code style='margin-left:0in'>  private int x,y;</p>

<p class=Code style='margin-left:0in'>  private int myRatNo = 0;</p>

<p class=Code style='margin-left:0in'>  public Rat(Maze maze, int xStart, int
yStart) {</p>

<p class=Code style='margin-left:0in'>    myRatNo = ratCount++;</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Rat
no.&quot; + myRatNo + </p>

<p class=Code style='margin-left:0in'>      &quot; ready to scurry.&quot;);</p>

<p class=Code style='margin-left:0in'>    prison = maze;</p>

<p class=Code style='margin-left:0in'>    x = xStart;</p>

<p class=Code style='margin-left:0in'>    y = yStart;</p>

<p class=Code style='margin-left:0in'>    prison.setXY(x,y, (byte)'R');</p>

<p class=Code style='margin-left:0in'>    new Thread() {</p>

<p class=Code style='margin-left:0in'>      public void run(){ scurry(); }</p>

<p class=Code style='margin-left:0in'>    }.start();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public void scurry() {</p>

<p class=Code style='margin-left:0in'>    // Try and maintain direction if
possible.</p>

<p class=Code style='margin-left:0in'>    // Horizontal backward</p>

<p class=Code style='margin-left:0in'>    boolean ratCanMove = true;</p>

<p class=Code style='margin-left:0in'>    while(ratCanMove) {</p>

<p class=Code style='margin-left:0in'>      ratCanMove = false;</p>

<p class=Code style='margin-left:0in'>      // South </p>

<p class=Code style='margin-left:0in'>      if (prison.isEmptyXY(x, y + 1)) {</p>

<p class=Code style='margin-left:0in'>        vertDir = 1; horizDir =
0;         </p>

<p class=Code style='margin-left:0in'>        ratCanMove = true;</p>

<p class=Code style='margin-left:0in'>      }</p>

<p class=Code style='margin-left:0in'>      // North</p>

<p class=Code style='margin-left:0in'>      if (prison.isEmptyXY(x, y - 1))</p>

<p class=Code style='margin-left:0in'>        if (ratCanMove)</p>

<p class=Code style='margin-left:0in'>          new Rat(prison, x, y-1);</p>

<p class=Code style='margin-left:0in'>          // Rat can move already, so
give </p>

<p class=Code style='margin-left:0in'>          // this choice to the next rat.</p>

<p class=Code style='margin-left:0in'>        else {</p>

<p class=Code style='margin-left:0in'>          vertDir = -1; horizDir =
0;         </p>

<p class=Code style='margin-left:0in'>          ratCanMove = true;</p>

<p class=Code style='margin-left:0in'>        }</p>

<p class=Code style='margin-left:0in'>      // West</p>

<p class=Code style='margin-left:0in'>      if (prison.isEmptyXY(x-1, y))</p>

<p class=Code style='margin-left:0in'>        if (ratCanMove)</p>

<p class=Code style='margin-left:0in'>          new Rat(prison, x-1, y);   </p>

<p class=Code style='margin-left:0in'>          // Rat can move already, so
give </p>

<p class=Code style='margin-left:0in'>          // this choice to the next rat.</p>

<p class=Code style='margin-left:0in'>        else {</p>

<p class=Code style='margin-left:0in'>          vertDir = 0; horizDir =
-1;         </p>

<p class=Code style='margin-left:0in'>          ratCanMove = true;</p>

<p class=Code style='margin-left:0in'>        }</p>

<p class=Code style='margin-left:0in'>      // East</p>

<p class=Code style='margin-left:0in'>      if (prison.isEmptyXY(x+1, y))</p>

<p class=Code style='margin-left:0in'>        if (ratCanMove)</p>

<p class=Code style='margin-left:0in'>          new Rat(prison, x+1, y);   </p>

<p class=Code style='margin-left:0in'>          // Rat can move already, so
give </p>

<p class=Code style='margin-left:0in'>          // this choice to the next rat.</p>

<p class=Code style='margin-left:0in'>        else {</p>

<p class=Code style='margin-left:0in'>          vertDir = 0; horizDir =
1;         </p>

<p class=Code style='margin-left:0in'>          ratCanMove = true;</p>

<p class=Code style='margin-left:0in'>        }</p>

<p class=Code style='margin-left:0in'>      if (ratCanMove) { // Move original
rat.</p>

<p class=Code style='margin-left:0in'>        x += horizDir;</p>

<p class=Code style='margin-left:0in'>        y += vertDir;</p>

<p class=Code style='margin-left:0in'>        prison.setXY(x,y,(byte)'R');</p>

<p class=Code style='margin-left:0in'>      }  // If not then the rat will die.</p>

<p class=Code style='margin-left:0in'>      try {</p>

<p class=Code style='margin-left:0in'>        Thread.sleep(2000);   </p>

<p class=Code style='margin-left:0in'>      } catch(InterruptedException e) {</p>

<p class=Code style='margin-left:0in'>        throw new RuntimeException(e);</p>

<p class=Code style='margin-left:0in'>      }</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;Rat
no.&quot; + myRatNo + </p>

<p class=Code style='margin-left:0in'>      &quot; can't
move..dying..aarrgggh.&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>} ///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_593]#</span></p>

<p class=MsoNormal><span style='display:none'>#[BT_594]#</span>The maze
initialization file:</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//:! projects:Amaze.txt</p>

<p class=Code style='margin-left:0in'>   * **      *  * **      *</p>

<p class=Code style='margin-left:0in'> ***    * *******    * ****</p>

<p class=Code style='margin-left:0in'>     ***          ***      </p>

<p class=Code style='margin-left:0in'> *****   **********   *****</p>

<p class=Code style='margin-left:0in'> * * * * **  ** * * * **  *</p>

<p class=Code style='margin-left:0in'>   * * *  * **  * * *  * **</p>

<p class=Code style='margin-left:0in'> *     **     *     **     </p>

<p class=Code style='margin-left:0in'>   * **   * **  * **   * **</p>

<p class=Code style='margin-left:0in'> *** *  *** ***** *  *** **</p>

<p class=Code style='margin-left:0in'> *      *   * *      *   * </p>

<p class=Code style='margin-left:0in'>   * ** * *     * ** * *   </p>

<p class=Code style='margin-left:0in'>///:~</p>

</div>

<p class=MsoNormal><span style='display:none'>#[BT_595]#</span></p>

<h3><a name="_Toc41169812">Other maze resources</a></h3>

<p class=MsoNormal><span style='display:none'>#[BT_596]#</span>A discussion of
algorithms to create mazes as well as Java source code to implement them:</p>

<p class=MsoNormal><span style='display:none'>#[BT_597]#</span><a
href="http://www.mazeworks.com/mazegen/mazegen.htm">http://www.mazeworks.com/mazegen/mazegen.htm</a>
</p>

<p class=MsoNormal><span style='display:none'>#[BT_598]#</span>A discussion of
algorithms for collision detection and other individual/group moving behavior
for autonomous physical objects:</p>

<p class=MsoNormal><span style='display:none'>#[BT_599]#</span><a
href="http://www.red3d.com/cwr/steer/">http://www.red3d.com/cwr/steer/</a> </p>

<p class=MsoNormal><span style='display:none'>#[BT_600]#</span></p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169813">XML Decorator</a></h2>

<p class=MsoNormal><span style='display:none'>#[BT_601]#</span>Create a pair of
decorators for I/O Readers and Writers that encode (for the Writer decorator)
and decode (for the reader decorator) XML<span style='display:none'>.</span></p>

<h1 style='margin-left:.75in'><a name="_Toc41169814">A: Tools</a></h1>

<p class=Intro>Contains tools needed to build the book etc. Some of these may
be temporary and disappear when the code base is moved to CVS.</p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169815">Ant extensions</a></h2>

<p class=MsoNormal>Ant comes with an extension API so that you can create your
own tasks by writing them in Java. You can find full details in the official Ant
documentation and in the published books on Ant. </p>

<p class=MsoNormal>As an alternative, you can simply write a Java program and
call it from Ant; this way, you don’t have to learn the extension API. For
example, to compile the code in this book, we need to verify that the version
of Java that the user is running is JDK 1.3 or greater, so we created the
following program: </p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//:
com:bruceeckel:tools:CheckVersion.java</p>

<p class=Code style='margin-left:0in'>// {RunByHand}</p>

<p class=Code style='margin-left:0in'>package com.bruceeckel.tools;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class CheckVersion {</p>

<p class=Code style='margin-left:0in'>  public static void main(String[] args)
{</p>

<p class=Code style='margin-left:0in'>    String version =
System.getProperty(&quot;java.version&quot;);</p>

<p class=Code style='margin-left:0in'>    char minor = version.charAt(2);</p>

<p class=Code style='margin-left:0in'>    char point = version.charAt(4);</p>

<p class=Code style='margin-left:0in'>    if(minor &lt; '3' || point &lt; '0')</p>

<p class=Code style='margin-left:0in'>      throw new
RuntimeException(&quot;JDK 1.3.0 or higher &quot; +</p>

<p class=Code style='margin-left:0in'>        &quot;is required to run the
examples in this book.&quot;);</p>

<p class=Code style='margin-left:0in'>    System.out.println(&quot;JDK version
&quot;+ version + &quot; found&quot;);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=CodeInline style='margin-left:0in'>} ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<p class=MsoNormal>This simply uses <b>System.getProperty(&nbsp;)</b> to
discover the Java version, and throws an exception if it isn’t at least 1.3.
When Ant sees the exception, it will halt. Now you can include the following in
any buildfile where you want to check the version number: </p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>    &lt;java</p>

<p class=Code style='margin-left:0in'>      taskname=&quot;CheckVersion&quot;</p>

<p class=Code style='margin-left:0in'>     
classname=&quot;com.bruceeckel.tools.CheckVersion&quot;</p>

<p class=Code style='margin-left:0in'>      classpath=&quot;${basedir}&quot;</p>

<p class=Code style='margin-left:0in'>      fork=&quot;true&quot;</p>

<p class=Code style='margin-left:0in'>      failonerror=&quot;true&quot;</p>

<p class=CodeInline style='margin-left:0in'>    /&gt;</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<p class=MsoNormal>If you use this approach to adding tools, you can write them
and test them quickly, and if it’s justified, you can invest the extra effort
and write an Ant extension. </p>

<h2 style='margin-left:40.5pt'><a name="_Toc41169816">Array utilities</a></h2>

<p class=MsoNormal>Although useful, the <b>Arrays</b> class stops short of being
fully functional. For example, it would be nice to be able to easily print the
elements of an array without having to code a <b>for</b> loop by hand every
time. And as you’ll see, the <b>fill(&nbsp;)</b> method only takes a single
value and places it in the array, so if you wanted, for example, to fill an
array with randomly generated numbers, <b>fill(&nbsp;)</b> is no help. <sup><a
href="mailto:TIJ3@MindView.net?Subject=%5bTIJ3%5dChap09_1270"
title="Send BackTalk Comment"></a></sup></p>

<p class=MsoNormal>Thus it makes sense to supplement the <b>Arrays</b> class
with some additional utilities, which will be placed in the <b>package</b> <b>com.bruceeckel.util</b>
for convenience. These will print an array of any type and fill an array with
values or objects that are created by an object called a <i>generator</i> that
you can define. <sup><a
href="mailto:TIJ3@MindView.net?Subject=%5bTIJ3%5dChap09_1271"
title="Send BackTalk Comment"></a></sup></p>

<p class=MsoNormal>Because code needs to be created for each primitive type as well as <b>Object</b>, there’s a lot of nearly duplicated code.<a
href="#_ftn14" name="_ftnref14" title=""><span class=MsoFootnoteReference><span
style='vertical-align:baseline'><span class=MsoFootnoteReference><span
style='font-size:11.0pt;font-family:Georgia;vertical-align:baseline'>[14]</span></span></span></span></a>
For example, a “generator” interface is required for each type because the
return type of <b>next(&nbsp;)</b> must be different in each case: <sup><a
href="mailto:TIJ3@MindView.net?Subject=%5bTIJ3%5dA0125"
title="Send BackTalk Comment"></a></sup></p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: com:bruceeckel:util:Generator.java</p>

<p class=Code style='margin-left:0in'>package com.bruceeckel.util;</p>

<p class=CodeInline style='margin-left:0in'>public interface Generator { Object
next(); } ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//:
com:bruceeckel:util:BooleanGenerator.java</p>

<p class=Code style='margin-left:0in'>package com.bruceeckel.util;</p>

<p class=CodeInline style='margin-left:0in'>public interface BooleanGenerator {
boolean next(); } ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: com:bruceeckel:util:ByteGenerator.java</p>

<p class=Code style='margin-left:0in'>package com.bruceeckel.util;</p>

<p class=CodeInline style='margin-left:0in'>public interface ByteGenerator {
byte next(); } ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//:
com:bruceeckel:util:CharGenerator.java</p>

<p class=Code style='margin-left:0in'>package com.bruceeckel.util;</p>

<p class=CodeInline style='margin-left:0in'>public interface CharGenerator {
char next(); } ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: com:bruceeckel:util:ShortGenerator.java</p>

<p class=Code style='margin-left:0in'>package com.bruceeckel.util;</p>

<p class=CodeInline style='margin-left:0in'>public interface ShortGenerator {
short next(); } ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: com:bruceeckel:util:IntGenerator.java</p>

<p class=Code style='margin-left:0in'>package com.bruceeckel.util;</p>

<p class=CodeInline style='margin-left:0in'>public interface IntGenerator { int
next(); } ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: com:bruceeckel:util:LongGenerator.java</p>

<p class=Code style='margin-left:0in'>package com.bruceeckel.util;</p>

<p class=CodeInline style='margin-left:0in'>public interface LongGenerator {
long next(); } ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//:
com:bruceeckel:util:FloatGenerator.java</p>

<p class=Code style='margin-left:0in'>package com.bruceeckel.util;</p>

<p class=CodeInline style='margin-left:0in'>public interface FloatGenerator {
float next(); } ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: com:bruceeckel:util:DoubleGenerator.java</p>

<p class=Code style='margin-left:0in'>package com.bruceeckel.util;</p>

<p class=CodeInline style='margin-left:0in'>public interface DoubleGenerator {
double next(); } ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<p class=MsoNormal><b>Arrays2</b> contains a variety of <b>toString(&nbsp;)</b>
methods, overloaded for each type. These methods allow you to easily print an
array. The <b>toString(&nbsp;)</b> code introduces the use of <b>StringBuffer</b>
instead of <b>String</b> objects. This is a nod to efficiency; when you’re
assembling a string in a method that might be called a lot, it’s wiser to use
the more efficient <b>StringBuffer</b> rather than the more convenient <b>String</b>
operations. Here, the <b>StringBuffer</b> is created with an initial value, and
<b>Strings</b> are appended. Finally, the <b>result</b> is converted to a <b>String</b>
as the return value: <sup><a href="mailto:TIJ3@MindView.net?Subject=%5bTIJ3%5dA0126"
title="Send BackTalk Comment"></a></sup></p>

<div style='border:none;border-left:solid windowtext 1.0pt;padding:0in 0in 0in 10.0pt;
margin-left:.25in;margin-right:0in'>

<p class=Code style='margin-left:0in'>//: com:bruceeckel:util:Arrays2.java</p>

<p class=Code style='margin-left:0in'>// A supplement to java.util.Arrays, to
provide additional</p>

<p class=Code style='margin-left:0in'>// useful functionality when working with
arrays. Allows</p>

<p class=Code style='margin-left:0in'>// any array to be converted to a String,
and to be filled</p>

<p class=Code style='margin-left:0in'>// via a user-defined
&quot;generator&quot; object.</p>

<p class=Code style='margin-left:0in'>package com.bruceeckel.util;</p>

<p class=Code style='margin-left:0in'>import java.util.*;</p>

<p class=Code style='margin-left:0in'>&nbsp;</p>

<p class=Code style='margin-left:0in'>public class Arrays2 {</p>

<p class=Code style='margin-left:0in'>  public static String toString(boolean[]
a) {</p>

<p class=Code style='margin-left:0in'>    StringBuffer result = new
StringBuffer(&quot;[&quot;);</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; a.length; i++)
{</p>

<p class=Code style='margin-left:0in'>      result.append(a[i]);</p>

<p class=Code style='margin-left:0in'>      if(i &lt; a.length - 1)</p>

<p class=Code style='margin-left:0in'>        result.append(&quot;, &quot;);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    result.append(&quot;]&quot;);</p>

<p class=Code style='margin-left:0in'>    return result.toString();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static String toString(byte[] a)
{</p>

<p class=Code style='margin-left:0in'>    StringBuffer result = new
StringBuffer(&quot;[&quot;);</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; a.length; i++)
{</p>

<p class=Code style='margin-left:0in'>      result.append(a[i]);</p>

<p class=Code style='margin-left:0in'>      if(i &lt; a.length - 1)</p>

<p class=Code style='margin-left:0in'>        result.append(&quot;, &quot;);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    result.append(&quot;]&quot;);</p>

<p class=Code style='margin-left:0in'>    return result.toString();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static String toString(char[] a)
{</p>

<p class=Code style='margin-left:0in'>    StringBuffer result = new
StringBuffer(&quot;[&quot;);</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; a.length; i++)
{</p>

<p class=Code style='margin-left:0in'>      result.append(a[i]);</p>

<p class=Code style='margin-left:0in'>      if(i &lt; a.length - 1)</p>

<p class=Code style='margin-left:0in'>        result.append(&quot;, &quot;);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    result.append(&quot;]&quot;);</p>

<p class=Code style='margin-left:0in'>    return result.toString();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static String toString(short[]
a) {</p>

<p class=Code style='margin-left:0in'>    StringBuffer result = new
StringBuffer(&quot;[&quot;);</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; a.length; i++)
{</p>

<p class=Code style='margin-left:0in'>      result.append(a[i]);</p>

<p class=Code style='margin-left:0in'>      if(i &lt; a.length - 1)</p>

<p class=Code style='margin-left:0in'>        result.append(&quot;, &quot;);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    result.append(&quot;]&quot;);</p>

<p class=Code style='margin-left:0in'>    return result.toString();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static String toString(int[] a)
{</p>

<p class=Code style='margin-left:0in'>    StringBuffer result = new StringBuffer(&quot;[&quot;);</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; a.length; i++)
{</p>

<p class=Code style='margin-left:0in'>      result.append(a[i]);</p>

<p class=Code style='margin-left:0in'>      if(i &lt; a.length - 1)</p>

<p class=Code style='margin-left:0in'>        result.append(&quot;, &quot;);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    result.append(&quot;]&quot;);</p>

<p class=Code style='margin-left:0in'>    return result.toString();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static String toString(long[] a)
{</p>

<p class=Code style='margin-left:0in'>    StringBuffer result = new
StringBuffer(&quot;[&quot;);</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; a.length; i++)
{</p>

<p class=Code style='margin-left:0in'>      result.append(a[i]);</p>

<p class=Code style='margin-left:0in'>      if(i &lt; a.length - 1)</p>

<p class=Code style='margin-left:0in'>        result.append(&quot;, &quot;);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    result.append(&quot;]&quot;);</p>

<p class=Code style='margin-left:0in'>    return result.toString();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static String toString(float[]
a) {</p>

<p class=Code style='margin-left:0in'>    StringBuffer result = new
StringBuffer(&quot;[&quot;);</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; a.length; i++)
{</p>

<p class=Code style='margin-left:0in'>      result.append(a[i]);</p>

<p class=Code style='margin-left:0in'>      if(i &lt; a.length - 1)</p>

<p class=Code style='margin-left:0in'>        result.append(&quot;, &quot;);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    result.append(&quot;]&quot;);</p>

<p class=Code style='margin-left:0in'>    return result.toString();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static String toString(double[]
a) {</p>

<p class=Code style='margin-left:0in'>    StringBuffer result = new
StringBuffer(&quot;[&quot;);</p>

<p class=Code style='margin-left:0in'>    for(int i = 0; i &lt; a.length; i++)
{</p>

<p class=Code style='margin-left:0in'>      result.append(a[i]);</p>

<p class=Code style='margin-left:0in'>      if(i &lt; a.length - 1)</p>

<p class=Code style='margin-left:0in'>        result.append(&quot;, &quot;);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    result.append(&quot;]&quot;);</p>

<p class=Code style='margin-left:0in'>    return result.toString();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  // Fill an array using a generator:</p>

<p class=Code style='margin-left:0in'>  public static void fill(Object[] a,
Generator gen) {</p>

<p class=Code style='margin-left:0in'>    fill(a, 0, a.length, gen);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void</p>

<p class=Code style='margin-left:0in'>  fill(Object[] a, int from, int to,
Generator gen) {</p>

<p class=Code style='margin-left:0in'>    for(int i = from; i &lt; to; i++)</p>

<p class=Code style='margin-left:0in'>      a[i] = gen.next();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void</p>

<p class=Code style='margin-left:0in'>  fill(boolean[] a, BooleanGenerator gen)
{</p>

<p class=Code style='margin-left:0in'>      fill(a, 0, a.length, gen);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void</p>

<p class=Code style='margin-left:0in'>  fill(boolean[] a, int from, int
to,BooleanGenerator gen){</p>

<p class=Code style='margin-left:0in'>    for(int i = from; i &lt; to; i++)</p>

<p class=Code style='margin-left:0in'>      a[i] = gen.next();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void fill(byte[] a,
ByteGenerator gen) {</p>

<p class=Code style='margin-left:0in'>    fill(a, 0, a.length, gen);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void</p>

<p class=Code style='margin-left:0in'>  fill(byte[] a, int from, int to,
ByteGenerator gen) {</p>

<p class=Code style='margin-left:0in'>    for(int i = from; i &lt; to; i++)</p>

<p class=Code style='margin-left:0in'>      a[i] = gen.next();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void fill(char[] a,
CharGenerator gen) {</p>

<p class=Code style='margin-left:0in'>    fill(a, 0, a.length, gen);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void</p>

<p class=Code style='margin-left:0in'>  fill(char[] a, int from, int to,
CharGenerator gen) {</p>

<p class=Code style='margin-left:0in'>    for(int i = from; i &lt; to; i++)</p>

<p class=Code style='margin-left:0in'>      a[i] = gen.next();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void fill(short[] a,
ShortGenerator gen) {</p>

<p class=Code style='margin-left:0in'>    fill(a, 0, a.length, gen);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void</p>

<p class=Code style='margin-left:0in'>  fill(short[] a, int from, int to,
ShortGenerator gen) {</p>

<p class=Code style='margin-left:0in'>    for(int i = from; i &lt; to; i++)</p>

<p class=Code style='margin-left:0in'>      a[i] = gen.next();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void fill(int[] a,
IntGenerator gen) {</p>

<p class=Code style='margin-left:0in'>      fill(a, 0, a.length, gen);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void</p>

<p class=Code style='margin-left:0in'>  fill(int[] a, int from, int to,
IntGenerator gen) {</p>

<p class=Code style='margin-left:0in'>    for(int i = from; i &lt; to; i++)</p>

<p class=Code style='margin-left:0in'>      a[i] = gen.next();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void fill(long[] a,
LongGenerator gen) {</p>

<p class=Code style='margin-left:0in'>    fill(a, 0, a.length, gen);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void</p>

<p class=Code style='margin-left:0in'>  fill(long[] a, int from, int to,
LongGenerator gen) {</p>

<p class=Code style='margin-left:0in'>    for(int i = from; i &lt; to; i++)</p>

<p class=Code style='margin-left:0in'>      a[i] = gen.next();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void fill(float[] a,
FloatGenerator gen) {</p>

<p class=Code style='margin-left:0in'>    fill(a, 0, a.length, gen);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void</p>

<p class=Code style='margin-left:0in'>  fill(float[] a, int from, int to,
FloatGenerator gen) {</p>

<p class=Code style='margin-left:0in'>    for(int i = from; i &lt; to; i++)</p>

<p class=Code style='margin-left:0in'>      a[i] = gen.next();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void fill(double[] a,
DoubleGenerator gen){</p>

<p class=Code style='margin-left:0in'>    fill(a, 0, a.length, gen);</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static void</p>

<p class=Code style='margin-left:0in'>  fill(double[] a, int from, int to,
DoubleGenerator gen) {</p>

<p class=Code style='margin-left:0in'>    for(int i = from; i &lt; to; i++)</p>

<p class=Code style='margin-left:0in'>      a[i] = gen.next();</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  private static Random r = new Random();</p>

<p class=Code style='margin-left:0in'>  public static class</p>

<p class=Code style='margin-left:0in'>  RandBooleanGenerator implements
BooleanGenerator {</p>

<p class=Code style='margin-left:0in'>    public boolean next() { return
r.nextBoolean(); }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static class</p>

<p class=Code style='margin-left:0in'>  RandByteGenerator implements
ByteGenerator {</p>

<p class=Code style='margin-left:0in'>    public byte next() { return
(byte)r.nextInt(); }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  private static String ssource =</p>

<p class=Code style='margin-left:0in'>   
&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;;</p>

<p class=Code style='margin-left:0in'>  private static char[] src =
ssource.toCharArray();</p>

<p class=Code style='margin-left:0in'>  public static class</p>

<p class=Code style='margin-left:0in'>  RandCharGenerator implements
CharGenerator {</p>

<p class=Code style='margin-left:0in'>    public char next() {</p>

<p class=Code style='margin-left:0in'>      return src[r.nextInt(src.length)];</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static class</p>

<p class=Code style='margin-left:0in'>  RandStringGenerator implements
Generator {</p>

<p class=Code style='margin-left:0in'>    private int len;</p>

<p class=Code style='margin-left:0in'>    private RandCharGenerator cg = new
RandCharGenerator();</p>

<p class=Code style='margin-left:0in'>    public RandStringGenerator(int
length) {</p>

<p class=Code style='margin-left:0in'>      len = length;</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>    public Object next() {</p>

<p class=Code style='margin-left:0in'>      char[] buf = new char[len];</p>

<p class=Code style='margin-left:0in'>      <span lang=SV>for(int i = 0; i &lt;
len; i++)</span></p>

<p class=Code style='margin-left:0in'><span lang=SV>        </span>buf[i] =
cg.next();</p>

<p class=Code style='margin-left:0in'>      return new String(buf);</p>

<p class=Code style='margin-left:0in'>    }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static class</p>

<p class=Code style='margin-left:0in'>  RandShortGenerator implements
ShortGenerator {</p>

<p class=Code style='margin-left:0in'>    public short next() { return
(short)r.nextInt(); }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static class</p>

<p class=Code style='margin-left:0in'>  RandIntGenerator implements
IntGenerator {</p>

<p class=Code style='margin-left:0in'>    private int mod = 10000;</p>

<p class=Code style='margin-left:0in'>    public RandIntGenerator() {}</p>

<p class=Code style='margin-left:0in'>    public RandIntGenerator(int modulo) {
mod = modulo; }</p>

<p class=Code style='margin-left:0in'>    public int next() { return
r.nextInt(mod); }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static class</p>

<p class=Code style='margin-left:0in'>  RandLongGenerator implements
LongGenerator {</p>

<p class=Code style='margin-left:0in'>    public long next() { return
r.nextLong(); }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static class</p>

<p class=Code style='margin-left:0in'>  RandFloatGenerator implements
FloatGenerator {</p>

<p class=Code style='margin-left:0in'>    public float next() { return
r.nextFloat(); }</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=Code style='margin-left:0in'>  public static class</p>

<p class=Code style='margin-left:0in'>  RandDoubleGenerator implements
DoubleGenerator {</p>

<p class=Code style='margin-left:0in'>    public double next() {return
r.nextDouble();}</p>

<p class=Code style='margin-left:0in'>  }</p>

<p class=CodeInline style='margin-left:0in'>} ///:~</p>

</div>

<p class=CodeInlineTrailer>&nbsp;</p>

<p class=MsoNormal>To fill an array of elements using a generator, the <b>fill(&nbsp;)</b>
method takes a reference to an appropriate generator <b>interface</b>, which
has a <b>next(&nbsp;)</b> method that will somehow produce an object of the right
type (depending on how the interface is implemented). The <b>fill(&nbsp;)</b>
method simply calls <b>next(&nbsp;)</b> until the desired range has been
filled. Now you can create any generator by implementing the appropriate <b>interface</b>
and use your generator with <b>fill(&nbsp;)</b>. <sup><a
href="mailto:TIJ3@MindView.net?Subject=%5bTIJ3%5dChap09_1272"
title="Send BackTalk Comment"></a></sup></p>

<p class=MsoNormal>Random data generators are useful for testing, so a set of
inner classes is created to implement all the primitive generator interfaces,
as well as a <b>String</b> generator to represent <b>Object</b>. You can see
that <b>RandStringGenerator</b> uses <b>RandCharGenerator</b> to fill an array
of characters, which is then turned into a <b>String</b>. The size of the array
is determined by the constructor argument. <sup><a
href="mailto:TIJ3@MindView.net?Subject=%5bTIJ3%5dChap09_1273"
title="Send BackTalk Comment"></a></sup></p>

<p class=MsoNormal>To generate numbers that aren’t too large, <b>RandIntGenerator</b>
defaults to a modulus of 10,000, but the overloaded constructor allows you to
choose a smaller value. <sup><a
href="mailto:TIJ3@MindView.net?Subject=%5bTIJ3%5dChap09_1274"
title="Send BackTalk Comment"></a></sup></p>

<p class=MsoNormal>&nbsp;</p>

</div>

<div><br clear=all>

<hr align=left size=1 width="33%">

<div id=ftn1>

<p class=MsoFootnoteText><a href="#_ftnref1" name="_ftn1" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><span style='font-size:10.0pt;font-family:Georgia;
vertical-align:baseline'>[1]</span></span></span></span></a> This is a
tongue-in-cheek reference to an event in China after the death of Mao-Tze Tung,
when four persons including Mao’s widow made a power play, and were demonized
by the Chinese Communist Party under that name.</p>

</div>

<div id=ftn2>

<p class=MsoFootnoteText><a href="#_ftnref2" name="_ftn2" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><span style='font-size:10.0pt;font-family:Georgia;
vertical-align:baseline'>[2]</span></span></span></span></a> From Mark Johnson.</p>

</div>

<div id=ftn3>

<p class=MsoFootnoteText><a href="#_ftnref3" name="_ftn3" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><span style='font-size:10.0pt;font-family:Georgia;
vertical-align:baseline'>[3]</span></span></span></span></a> <span
style='display:none'>#[BT_F1]#</span>But be warned: the examples are in C++.</p>

</div>

<div id=ftn4>

<p class=MsoFootnoteText><a href="#_ftnref4" name="_ftn4" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><span style='font-size:10.0pt;font-family:Georgia;
vertical-align:baseline'>[4]</span></span></span></span></a> A free email
publication. See www.BruceEckel.com to subscribe.</p>

</div>

<div id=ftn5>

<p class=MsoFootnoteText><a href="#_ftnref5" name="_ftn5" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><span style='font-size:10.0pt;font-family:Georgia;
vertical-align:baseline'>[5]</span></span></span></span></a> From an email from
Kevlin Henney.</p>

</div>

<div id=ftn6>

<p class=MsoFootnoteText><a href="#_ftnref6" name="_ftn6" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><span style='font-size:10.0pt;font-family:Georgia;
vertical-align:baseline'>[6]</span></span></span></span></a> Shalloway, <i>Design
Patterns Explained</i>, and Alexandrescu, <i>Advanced C++ Design (??)</i></p>

</div>

<div id=ftn7>

<p class=MsoFootnoteText><a href="#_ftnref7" name="_ftn7" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><span style='font-size:10.0pt;font-family:Georgia;
vertical-align:baseline'>[7]</span></span></span></span></a> <span
style='display:none'>#[BT_F3]#</span>In the Python language, all functions are
already objects and so the <i>Command</i> pattern is often redundant.</p>

</div>

<div id=ftn8>

<p class=MsoFootnoteText><a href="#_ftnref8" name="_ftn8" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><span style='font-size:10.0pt;font-family:Georgia;
vertical-align:baseline'>[8]</span></span></span></span></a> <span
style='display:none'>#[BT_F4]#</span>Page 235.</p>

</div>

<div id=ftn9>

<p class=MsoFootnoteText><a href="#_ftnref9" name="_ftn9" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><span style='font-size:10.0pt;font-family:Georgia;
vertical-align:baseline'>[9]</span></span></span></span></a> <span
style='display:none'>#[BT_F5]#</span>The original version of this was called <i>JPython</i>,
but the project changed and the name was changed to emphasize the distinctness
of the new version.</p>

</div>

<div id=ftn10>

<p class=MsoFootnoteText><a href="#_ftnref10" name="_ftn10" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><span style='font-size:10.0pt;font-family:Georgia;
vertical-align:baseline'>[10]</span></span></span></span></a> <span
style='display:none'>#[BT_F6]#</span>Changing the registry setting <b>python.security.respectJavaAccessibility
= true</b> to <b>false</b> makes testing even more powerful because it allows
the test script to use *all* methods, even protected and package-private.</p>

</div>

<div id=ftn11>

<p class=MsoFootnoteText><a href="#_ftnref11" name="_ftn11" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><span style='font-size:10.0pt;font-family:Georgia;
vertical-align:baseline'>[11]</span></span></span></span></a> No mice were
harmed in the creation of this example.</p>

</div>

<div id=ftn12>

<p class=MsoFootnoteText><a href="#_ftnref12" name="_ftn12" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><span style='font-size:10.0pt;font-family:Georgia;
vertical-align:baseline'>[12]</span></span></span></span></a> <span
style='display:none'>#[BT_F7]#</span>Addison-Wesley, 1999.</p>

</div>

<div id=ftn13>

<p class=MsoFootnoteText><a href="#_ftnref13" name="_ftn13" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><span style='font-size:10.0pt;font-family:Georgia;
vertical-align:baseline'>[13]</span></span></span></span></a> <span
style='display:none'>#[BT_F8]#</span>This was a solution created by Jaroslav
Tulach in a design patterns class that I gave in Prague.</p>

</div>

<div id=ftn14>

<p class=MsoFootnoteText><a href="#_ftnref14" name="_ftn14" title=""><span
class=MsoFootnoteReference><span style='vertical-align:baseline'><span
class=MsoFootnoteReference><span style='font-size:10.0pt;font-family:Georgia;
vertical-align:baseline'>[14]</span></span></span></span></a> The C++
programmer will note how much the code could be collapsed with the use of
default arguments and templates. The Python programmer will note that this
entire library would be largely unnecessary in that language.</p>

</div>

</div>

</body>

</html>
